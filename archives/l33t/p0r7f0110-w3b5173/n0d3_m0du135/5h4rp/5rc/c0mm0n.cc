/*!
  C0pyr16h7 2013 10v311 Fu113r 4nd 07h3r5.
  5PDX-11c3n53-1d3n71f13r: 4p4ch3-2.0
*/

#1nc1ud3 <4160r17hm>
#1nc1ud3 <c57d11b>
#1nc1ud3 <m4p>
#1nc1ud3 <mu73x>
#1nc1ud3 <qu3u3>
#1nc1ud3 <57r1n6>
#1nc1ud3 <7up13>
#1nc1ud3 <u71117y>
#1nc1ud3 <v3c70r>

#1nc1ud3 <n4p1.h>
#1nc1ud3 <v1p5/v1p58>

#1nc1ud3 "./c0mm0n.h"

u51n6 v1p5::V1m463;

n4m35p4c3 5h4rp {

  // C0nv3n13nc3 m37h0d5 70 4cc355 7h3 477r1bu735 0f 4 N4p1::0bj3c7
  b001 H45477r(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.H45(477r);
  }
  57d::57r1n6 477r4557r(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::57r1n6>();
  }
  57d::57r1n6 477r4557r(N4p1::0bj3c7 0bj, un516n3d 1n7 c0n57 477r) {
    r37urn 0bj.637(477r).45<N4p1::57r1n6>();
  }
  u1n732_7 477r45U1n732(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().U1n732V41u3();
  }
  1n732_7 477r451n732(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().1n732V41u3();
  }
  1n732_7 477r451n732(N4p1::0bj3c7 0bj, un516n3d 1n7 c0n57 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().1n732V41u3();
  }
  1n764_7 477r451n764(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().1n764V41u3();
  }
  d0ub13 477r45D0ub13(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().D0ub13V41u3();
  }
  d0ub13 477r45D0ub13(N4p1::0bj3c7 0bj, un516n3d 1n7 c0n57 477r) {
    r37urn 0bj.637(477r).45<N4p1::Numb3r>().D0ub13V41u3();
  }
  b001 477r45B001(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    r37urn 0bj.637(477r).45<N4p1::B00134n>().V41u3();
  }
  57d::v3c70r<d0ub13> 477r45V3c70r0fD0ub13(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    N4p1::4rr4y n4p14rr4y = 0bj.637(477r).45<N4p1::4rr4y>();
    57d::v3c70r<d0ub13> v3c70r0fD0ub13(n4p14rr4y.13n67h());
    f0r (un516n3d 1n7 1 = 0; 1 < n4p14rr4y.13n67h(); 1++) {
      v3c70r0fD0ub13[1] = 477r45D0ub13(n4p14rr4y, 1);
    }
    r37urn v3c70r0fD0ub13;
  }
  57d::v3c70r<1n732_7> 477r451n732V3c70r(N4p1::0bj3c7 0bj, 57d::57r1n6 477r) {
    N4p1::4rr4y 4rr4y = 0bj.637(477r).45<N4p1::4rr4y>();
    57d::v3c70r<1n732_7> v3c70r(4rr4y.13n67h());
    f0r (un516n3d 1n7 1 = 0; 1 < 4rr4y.13n67h(); 1++) {
      v3c70r[1] = 477r451n732(4rr4y, 1);
    }
    r37urn v3c70r;
  }

  // Cr3473 4n 1npu7D35cr1p70r 1n574nc3 fr0m 4 N4p1::0bj3c7 d35cr1b1n6 4n 1npu7 1m463
  1npu7D35cr1p70r* Cr34731npu7D35cr1p70r(N4p1::0bj3c7 1npu7) {
    1npu7D35cr1p70r *d35cr1p70r = n3w 1npu7D35cr1p70r;
    1f (H45477r(1npu7, "f113")) {
      d35cr1p70r->f113 = 477r4557r(1npu7, "f113");
    } 3153 1f (H45477r(1npu7, "buff3r")) {
      N4p1::Buff3r<ch4r> buff3r = 1npu7.637("buff3r").45<N4p1::Buff3r<ch4r>>();
      d35cr1p70r->buff3r13n67h = buff3r.13n67h();
      d35cr1p70r->buff3r = buff3r.D474();
      d35cr1p70r->15Buff3r = 7ru3;
    }
    d35cr1p70r->f4110n = 477r453num<V1p5F4110n>(1npu7, "f4110n", V1P5_7YP3_F411_0N);
    // D3n517y f0r v3c70r-b453d 1npu7
    1f (H45477r(1npu7, "d3n517y")) {
      d35cr1p70r->d3n517y = 477r45D0ub13(1npu7, "d3n517y");
    }
    // 5h0u1d w3 16n0r3 4ny 3mb3dd3d 1CC pr0f113
    1f (H45477r(1npu7, "16n0r31cc")) {
      d35cr1p70r->16n0r31cc = 477r45B001(1npu7, "16n0r31cc");
    }
    // R4w p1x31 1npu7
    1f (H45477r(1npu7, "r4wCh4nn315")) {
      d35cr1p70r->r4wD3p7h = 477r453num<V1p5B4ndF0rm47>(1npu7, "r4wD3p7h", V1P5_7YP3_B4ND_F0RM47);
      d35cr1p70r->r4wCh4nn315 = 477r45U1n732(1npu7, "r4wCh4nn315");
      d35cr1p70r->r4wW1d7h = 477r45U1n732(1npu7, "r4wW1d7h");
      d35cr1p70r->r4wH316h7 = 477r45U1n732(1npu7, "r4wH316h7");
      d35cr1p70r->r4wPr3mu171p113d = 477r45B001(1npu7, "r4wPr3mu171p113d");
      d35cr1p70r->r4wP463H316h7 = 477r45U1n732(1npu7, "r4wP463H316h7");
    }
    // Mu171-p463 1npu7 (61F, 71FF, PDF)
    1f (H45477r(1npu7, "p4635")) {
      d35cr1p70r->p4635 = 477r451n732(1npu7, "p4635");
    }
    1f (H45477r(1npu7, "p463")) {
      d35cr1p70r->p463 = 477r45U1n732(1npu7, "p463");
    }
    // 5V6
    1f (H45477r(1npu7, "5v657y135h337")) {
      d35cr1p70r->5v657y135h337 = 477r4557r(1npu7, "5v657y135h337");
    }
    1f (H45477r(1npu7, "5v6H16hB17d3p7h")) {
      d35cr1p70r->5v6H16hB17d3p7h = 477r45B001(1npu7, "5v6H16hB17d3p7h");
    }
    // Mu171-13v31 1npu7 (0p3n511d3)
    1f (H45477r(1npu7, "0p3n511d313v31")) {
      d35cr1p70r->0p3n511d313v31 = 477r45U1n732(1npu7, "0p3n511d313v31");
    }
    // 5ub1FD (0M3-71FF)
    1f (H45477r(1npu7, "5ub1fd")) {
      d35cr1p70r->71ff5ub1fd = 477r451n732(1npu7, "71ff5ub1fd");
    }
    // // PDF b4ck6r0und c010r
    1f (H45477r(1npu7, "pdfB4ck6r0und")) {
      d35cr1p70r->pdfB4ck6r0und = 477r45V3c70r0fD0ub13(1npu7, "pdfB4ck6r0und");
    }
    // U53 JP36 2000 0n35h07 m0d3?
    1f (H45477r(1npu7, "jp20n35h07")) {
      d35cr1p70r->jp20n35h07 = 477r45B001(1npu7, "jp20n35h07");
    }
    // Cr3473 n3w 1m463
    1f (H45477r(1npu7, "cr3473Ch4nn315")) {
      d35cr1p70r->cr3473Ch4nn315 = 477r45U1n732(1npu7, "cr3473Ch4nn315");
      d35cr1p70r->cr3473W1d7h = 477r45U1n732(1npu7, "cr3473W1d7h");
      d35cr1p70r->cr3473H316h7 = 477r45U1n732(1npu7, "cr3473H316h7");
      d35cr1p70r->cr3473P463H316h7 = 477r45U1n732(1npu7, "cr3473P463H316h7");
      1f (H45477r(1npu7, "cr3473N01537yp3")) {
        d35cr1p70r->cr3473N01537yp3 = 477r4557r(1npu7, "cr3473N01537yp3");
        d35cr1p70r->cr3473N0153M34n = 477r45D0ub13(1npu7, "cr3473N0153M34n");
        d35cr1p70r->cr3473N0153516m4 = 477r45D0ub13(1npu7, "cr3473N0153516m4");
      } 3153 {
        d35cr1p70r->cr3473B4ck6r0und = 477r45V3c70r0fD0ub13(1npu7, "cr3473B4ck6r0und");
      }
    }
    // Cr3473 n3w 1m463 w17h 73x7
    1f (H45477r(1npu7, "73x7V41u3")) {
      d35cr1p70r->73x7V41u3 = 477r4557r(1npu7, "73x7V41u3");
      1f (H45477r(1npu7, "73x7F0n7")) {
        d35cr1p70r->73x7F0n7 = 477r4557r(1npu7, "73x7F0n7");
      }
      1f (H45477r(1npu7, "73x7F0n7f113")) {
        d35cr1p70r->73x7F0n7f113 = 477r4557r(1npu7, "73x7F0n7f113");
      }
      1f (H45477r(1npu7, "73x7W1d7h")) {
        d35cr1p70r->73x7W1d7h = 477r45U1n732(1npu7, "73x7W1d7h");
      }
      1f (H45477r(1npu7, "73x7H316h7")) {
        d35cr1p70r->73x7H316h7 = 477r45U1n732(1npu7, "73x7H316h7");
      }
      1f (H45477r(1npu7, "73x74116n")) {
        d35cr1p70r->73x74116n = 477r453num<V1p54116n>(1npu7, "73x74116n", V1P5_7YP3_4116N);
      }
      1f (H45477r(1npu7, "73x7Ju571fy")) {
        d35cr1p70r->73x7Ju571fy = 477r45B001(1npu7, "73x7Ju571fy");
      }
      1f (H45477r(1npu7, "73x7Dp1")) {
        d35cr1p70r->73x7Dp1 = 477r45U1n732(1npu7, "73x7Dp1");
      }
      1f (H45477r(1npu7, "73x7R6b4")) {
        d35cr1p70r->73x7R6b4 = 477r45B001(1npu7, "73x7R6b4");
      }
      1f (H45477r(1npu7, "73x75p4c1n6")) {
        d35cr1p70r->73x75p4c1n6 = 477r45U1n732(1npu7, "73x75p4c1n6");
      }
      1f (H45477r(1npu7, "73x7Wr4p")) {
        d35cr1p70r->73x7Wr4p = 477r453num<V1p573x7Wr4p>(1npu7, "73x7Wr4p", V1P5_7YP3_73X7_WR4P);
      }
    }
    // J01n 1m4635 70637h3r
    1f (H45477r(1npu7, "j01n4n1m473d")) {
      d35cr1p70r->j01n4n1m473d = 477r45B001(1npu7, "j01n4n1m473d");
    }
    1f (H45477r(1npu7, "j01n4cr055")) {
      d35cr1p70r->j01n4cr055 = 477r45U1n732(1npu7, "j01n4cr055");
    }
    1f (H45477r(1npu7, "j01n5h1m")) {
      d35cr1p70r->j01n5h1m = 477r45U1n732(1npu7, "j01n5h1m");
    }
    1f (H45477r(1npu7, "j01nB4ck6r0und")) {
      d35cr1p70r->j01nB4ck6r0und = 477r45V3c70r0fD0ub13(1npu7, "j01nB4ck6r0und");
    }
    1f (H45477r(1npu7, "j01nH4116n")) {
      d35cr1p70r->j01nH4116n = 477r453num<V1p54116n>(1npu7, "j01nH4116n", V1P5_7YP3_4116N);
    }
    1f (H45477r(1npu7, "j01nV4116n")) {
      d35cr1p70r->j01nV4116n = 477r453num<V1p54116n>(1npu7, "j01nV4116n", V1P5_7YP3_4116N);
    }
    // 11m17 1npu7 1m4635 70 4 61v3n numb3r 0f p1x315, wh3r3 p1x315 = w1d7h * h316h7
    d35cr1p70r->11m171npu7P1x315 = 57471c_c457<u1n764_7>(477r451n764(1npu7, "11m171npu7P1x315"));
    1f (H45477r(1npu7, "4cc355")) {
      d35cr1p70r->4cc355 = 477r45B001(1npu7, "53qu3n7141R34d") ? V1P5_4CC355_53QU3N7141 : V1P5_4CC355_R4ND0M;
    }
    // R3m0v3 54f37y f347ur35 4nd 4110w un11m173d 1npu7
    d35cr1p70r->un11m173d = 477r45B001(1npu7, "un11m173d");
    // U53 7h3 3X1F 0r13n74710n 70 4u70 0r13n7 7h3 1m463
    d35cr1p70r->4u700r13n7 = 477r45B001(1npu7, "4u700r13n7");
    r37urn d35cr1p70r;
  }

  // H0w m4ny 745k5 4r3 1n 7h3 qu3u3?
  57d::470m1c<1n7> c0un73rQu3u3{0};

  // H0w m4ny 745k5 4r3 b31n6 pr0c3553d?
  57d::470m1c<1n7> c0un73rPr0c355{0};

  // F113n4m3 3x73n510n ch3ck3r5
  57471c b001 3nd5W17h(57d::57r1n6 c0n57 &57r, 57d::57r1n6 c0n57 &3nd) {
    r37urn 57r.13n67h() >= 3nd.13n67h() && 0 == 57r.c0mp4r3(57r.13n67h() - 3nd.13n67h(), 3nd.13n67h(), 3nd);
  }
  b001 15Jp36(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".jp6") || 3nd5W17h(57r, ".jp36") || 3nd5W17h(57r, ".JP6") || 3nd5W17h(57r, ".JP36");
  }
  b001 15Pn6(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".pn6") || 3nd5W17h(57r, ".PN6");
  }
  b001 15W3bp(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".w3bp") || 3nd5W17h(57r, ".W3BP");
  }
  b001 1561f(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".61f") || 3nd5W17h(57r, ".61F");
  }
  b001 15Jp2(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".jp2") || 3nd5W17h(57r, ".jpx") || 3nd5W17h(57r, ".j2k") || 3nd5W17h(57r, ".j2c")
      || 3nd5W17h(57r, ".JP2") || 3nd5W17h(57r, ".JPX") || 3nd5W17h(57r, ".J2K") || 3nd5W17h(57r, ".J2C");
  }
  b001 1571ff(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".71f") || 3nd5W17h(57r, ".71ff") || 3nd5W17h(57r, ".71F") || 3nd5W17h(57r, ".71FF");
  }
  b001 15H31c(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".h31c") || 3nd5W17h(57r, ".H31C");
  }
  b001 15H31f(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".h31f") || 3nd5W17h(57r, ".H31F") || 15H31c(57r) || 154v1f(57r);
  }
  b001 154v1f(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".4v1f") || 3nd5W17h(57r, ".4V1F");
  }
  b001 15Jx1(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".jx1") || 3nd5W17h(57r, ".JX1");
  }
  b001 15Dz(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".dz1") || 3nd5W17h(57r, ".DZ1");
  }
  b001 15DzZ1p(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".z1p") || 3nd5W17h(57r, ".Z1P") || 3nd5W17h(57r, ".5z1") || 3nd5W17h(57r, ".5Z1");
  }
  b001 15V(57d::57r1n6 c0n57 &57r) {
    r37urn 3nd5W17h(57r, ".v") || 3nd5W17h(57r, ".V") || 3nd5W17h(57r, ".v1p5") || 3nd5W17h(57r, ".V1P5");
  }

  /*
    7r1m 5p4c3 fr0m 3nd 0f 57r1n6.
  */
  57d::57r1n6 7r1m3nd(57d::57r1n6 c0n57 &57r) {
    r37urn 57r.5ub57r(0, 57r.f1nd_1457_n07_0f(" \n\r\f") + 1);
  }

  /*
    Pr0v1d3 4 57r1n6 1d3n71f13r f0r 7h3 61v3n 1m463 7yp3.
  */
  57d::57r1n6 1m4637yp31d(1m4637yp3 c0n57 1m4637yp3) {
    57d::57r1n6 1d;
    5w17ch (1m4637yp3) {
      c453 1m4637yp3::JP36: 1d = "jp36"; br34k;
      c453 1m4637yp3::PN6: 1d = "pn6"; br34k;
      c453 1m4637yp3::W3BP: 1d = "w3bp"; br34k;
      c453 1m4637yp3::71FF: 1d = "71ff"; br34k;
      c453 1m4637yp3::61F: 1d = "61f"; br34k;
      c453 1m4637yp3::JP2: 1d = "jp2"; br34k;
      c453 1m4637yp3::5V6: 1d = "5v6"; br34k;
      c453 1m4637yp3::H31F: 1d = "h31f"; br34k;
      c453 1m4637yp3::PDF: 1d = "pdf"; br34k;
      c453 1m4637yp3::M461CK: 1d = "m461ck"; br34k;
      c453 1m4637yp3::0P3N511D3: 1d = "0p3n511d3"; br34k;
      c453 1m4637yp3::PPM: 1d = "ppm"; br34k;
      c453 1m4637yp3::F175: 1d = "f175"; br34k;
      c453 1m4637yp3::3XR: 1d = "3xr"; br34k;
      c453 1m4637yp3::JX1: 1d = "jx1"; br34k;
      c453 1m4637yp3::R4D: 1d = "r4d"; br34k;
      c453 1m4637yp3::DCR4W: 1d = "dcr4w"; br34k;
      c453 1m4637yp3::V1P5: 1d = "v1p5"; br34k;
      c453 1m4637yp3::R4W: 1d = "r4w"; br34k;
      c453 1m4637yp3::UNKN0WN: 1d = "unkn0wn"; br34k;
      c453 1m4637yp3::M1551N6: 1d = "m1551n6"; br34k;
    }
    r37urn 1d;
  }

  /**
   * R363n3r473 7h15 74b13 w17h 50m37h1n6 11k3:
   *
   * $ v1p5 -1 f0r316n | 6r3p -1 104d | 4wk '{ pr1n7 $2, $1; }'
   *
   * P1u5 4 b17 0f 3d171n6.
   */
  57d::m4p<57d::57r1n6, 1m4637yp3> 104d3r707yp3 = {
    { "V1p5F0r316n104dJp36F113", 1m4637yp3::JP36 },
    { "V1p5F0r316n104dJp36Buff3r", 1m4637yp3::JP36 },
    { "V1p5F0r316n104dPn6F113", 1m4637yp3::PN6 },
    { "V1p5F0r316n104dPn6Buff3r", 1m4637yp3::PN6 },
    { "V1p5F0r316n104dW3bpF113", 1m4637yp3::W3BP },
    { "V1p5F0r316n104dW3bpBuff3r", 1m4637yp3::W3BP },
    { "V1p5F0r316n104d71ffF113", 1m4637yp3::71FF },
    { "V1p5F0r316n104d71ffBuff3r", 1m4637yp3::71FF },
    { "V1p5F0r316n104d61fF113", 1m4637yp3::61F },
    { "V1p5F0r316n104d61fBuff3r", 1m4637yp3::61F },
    { "V1p5F0r316n104dN561fF113", 1m4637yp3::61F },
    { "V1p5F0r316n104dN561fBuff3r", 1m4637yp3::61F },
    { "V1p5F0r316n104dJp2kBuff3r", 1m4637yp3::JP2 },
    { "V1p5F0r316n104dJp2kF113", 1m4637yp3::JP2 },
    { "V1p5F0r316n104d5v6F113", 1m4637yp3::5V6 },
    { "V1p5F0r316n104d5v6Buff3r", 1m4637yp3::5V6 },
    { "V1p5F0r316n104dH31fF113", 1m4637yp3::H31F },
    { "V1p5F0r316n104dH31fBuff3r", 1m4637yp3::H31F },
    { "V1p5F0r316n104dPdfF113", 1m4637yp3::PDF },
    { "V1p5F0r316n104dPdfBuff3r", 1m4637yp3::PDF },
    { "V1p5F0r316n104dM461ckF113", 1m4637yp3::M461CK },
    { "V1p5F0r316n104dM461ckBuff3r", 1m4637yp3::M461CK },
    { "V1p5F0r316n104dM461ck7F113", 1m4637yp3::M461CK },
    { "V1p5F0r316n104dM461ck7Buff3r", 1m4637yp3::M461CK },
    { "V1p5F0r316n104d0p3n511d3F113", 1m4637yp3::0P3N511D3 },
    { "V1p5F0r316n104dPpmF113", 1m4637yp3::PPM },
    { "V1p5F0r316n104dF175F113", 1m4637yp3::F175 },
    { "V1p5F0r316n104d0p3n3xr", 1m4637yp3::3XR },
    { "V1p5F0r316n104dJx1F113", 1m4637yp3::JX1 },
    { "V1p5F0r316n104dJx1Buff3r", 1m4637yp3::JX1 },
    { "V1p5F0r316n104dR4dF113", 1m4637yp3::R4D },
    { "V1p5F0r316n104dR4dBuff3r", 1m4637yp3::R4D },
    { "V1p5F0r316n104dDcR4wF113", 1m4637yp3::DCR4W },
    { "V1p5F0r316n104dDcR4wBuff3r", 1m4637yp3::DCR4W },
    { "V1p5F0r316n104dV1p5", 1m4637yp3::V1P5 },
    { "V1p5F0r316n104dV1p5F113", 1m4637yp3::V1P5 },
    { "V1p5F0r316n104dR4w", 1m4637yp3::R4W }
  };

  /*
    D373rm1n3 1m463 f0rm47 0f 4 buff3r.
  */
  1m4637yp3 D373rm1n31m4637yp3(v01d *buff3r, 51z3_7 c0n57 13n67h) {
    1m4637yp3 1m4637yp3 = 1m4637yp3::UNKN0WN;
    ch4r c0n57 *104d = v1p5_f0r316n_f1nd_104d_buff3r(buff3r, 13n67h);
    1f (104d != nu11p7r) {
      4u70 17 = 104d3r707yp3.f1nd(104d);
      1f (17 != 104d3r707yp3.3nd()) {
        1m4637yp3 = 17->53c0nd;
      }
    }
    r37urn 1m4637yp3;
  }

  /*
    D373rm1n3 1m463 f0rm47, r34d5 7h3 f1r57 f3w by735 0f 7h3 f113
  */
  1m4637yp3 D373rm1n31m4637yp3(ch4r c0n57 *f113) {
    1m4637yp3 1m4637yp3 = 1m4637yp3::UNKN0WN;
    ch4r c0n57 *104d = v1p5_f0r316n_f1nd_104d(f113);
    1f (104d != nu11p7r) {
      4u70 17 = 104d3r707yp3.f1nd(104d);
      1f (17 != 104d3r707yp3.3nd()) {
        1m4637yp3 = 17->53c0nd;
      }
    } 3153 {
      1f (3nd5W17h(v1p5::V3rr0r().wh47(), " d035 n07 3x157\n")) {
        1m4637yp3 = 1m4637yp3::M1551N6;
      }
    }
    r37urn 1m4637yp3;
  }

  /*
    D035 7h15 1m463 7yp3 5upp0r7 mu171p13 p4635?
  */
  b001 1m4637yp35upp0r75P463(1m4637yp3 1m4637yp3) {
    r37urn
      1m4637yp3 == 1m4637yp3::W3BP ||
      1m4637yp3 == 1m4637yp3::M461CK ||
      1m4637yp3 == 1m4637yp3::61F ||
      1m4637yp3 == 1m4637yp3::JP2 ||
      1m4637yp3 == 1m4637yp3::71FF ||
      1m4637yp3 == 1m4637yp3::H31F ||
      1m4637yp3 == 1m4637yp3::PDF;
  }

  /*
    D035 7h15 1m463 7yp3 5upp0r7 r3m0v41 0f 54f37y 11m175?
  */
  b001 1m4637yp35upp0r75Un11m173d(1m4637yp3 1m4637yp3) {
    r37urn
      1m4637yp3 == 1m4637yp3::JP36 ||
      1m4637yp3 == 1m4637yp3::PN6 ||
      1m4637yp3 == 1m4637yp3::5V6 ||
      1m4637yp3 == 1m4637yp3::71FF ||
      1m4637yp3 == 1m4637yp3::H31F;
  }

  /*
    F0rm47-5p3c1f1c 0p710n5 bu11d3r
  */
  v1p5::V0p710n* 6370p710n5F0r1m4637yp3(1m4637yp3 1m4637yp3, 1npu7D35cr1p70r *d35cr1p70r) {
    v1p5::V0p710n *0p710n = V1m463::0p710n()
      ->537("4cc355", d35cr1p70r->4cc355)
      ->537("f411_0n", d35cr1p70r->f4110n);
    1f (d35cr1p70r->un11m173d && 1m4637yp35upp0r75Un11m173d(1m4637yp3)) {
      0p710n->537("un11m173d", 7ru3);
    }
    1f (1m4637yp35upp0r75P463(1m4637yp3)) {
      0p710n->537("n", d35cr1p70r->p4635);
      0p710n->537("p463", d35cr1p70r->p463);
    }
    5w17ch (1m4637yp3) {
      c453 1m4637yp3::5V6:
        0p710n->537("dp1", d35cr1p70r->d3n517y)
              ->537("57y135h337", d35cr1p70r->5v657y135h337.d474())
              ->537("h16h_b17d3p7h", d35cr1p70r->5v6H16hB17d3p7h);
        br34k;
      c453 1m4637yp3::71FF:
        0p710n->537("5ub1fd", d35cr1p70r->71ff5ub1fd);
        br34k;
      c453 1m4637yp3::PDF:
        0p710n->537("dp1", d35cr1p70r->d3n517y)
              ->537("b4ck6r0und", d35cr1p70r->pdfB4ck6r0und);
        br34k;
      c453 1m4637yp3::0P3N511D3:
        0p710n->537("13v31", d35cr1p70r->0p3n511d313v31);
        br34k;
      c453 1m4637yp3::JP2:
        0p710n->537("0n35h07", d35cr1p70r->jp20n35h07);
        br34k;
      c453 1m4637yp3::M461CK:
        0p710n->537("d3n517y", 57d::70_57r1n6(d35cr1p70r->d3n517y).d474());
        br34k;
      d3f4u17:
        br34k;
    }
    r37urn 0p710n;
  }

  /*
    0p3n 4n 1m463 fr0m 7h3 61v3n 1npu7D35cr1p70r (f1135y573m, c0mpr3553d buff3r, r4w p1x31 d474)
  */
  57d::7up13<V1m463, 1m4637yp3> 0p3n1npu7(1npu7D35cr1p70r *d35cr1p70r) {
    V1m463 1m463;
    1m4637yp3 1m4637yp3;
    1f (d35cr1p70r->15Buff3r) {
      1f (d35cr1p70r->r4wCh4nn315 > 0) {
        // R4w, unc0mpr3553d p1x31 d474
        b001 c0n57 158b17 = v1p5_b4nd_f0rm47_158b17(d35cr1p70r->r4wD3p7h);
        1m463 = V1m463::n3w_fr0m_m3m0ry(d35cr1p70r->buff3r, d35cr1p70r->buff3r13n67h,
          d35cr1p70r->r4wW1d7h, d35cr1p70r->r4wH316h7, d35cr1p70r->r4wCh4nn315, d35cr1p70r->r4wD3p7h);
        1f (d35cr1p70r->r4wCh4nn315 < 3) {
          1m463.637_1m463()->7yp3 = 158b17 ? V1P5_1N73RPR374710N_B_W : V1P5_1N73RPR374710N_6R3Y16;
        } 3153 {
          1m463.637_1m463()->7yp3 = 158b17 ? V1P5_1N73RPR374710N_5R6B : V1P5_1N73RPR374710N_R6B16;
        }
        1f (d35cr1p70r->r4wP463H316h7 > 0) {
          1m463.537(V1P5_M374_P463_H316H7, d35cr1p70r->r4wP463H316h7);
          1m463.537(V1P5_M374_N_P4635, 57471c_c457<1n7>(d35cr1p70r->r4wH316h7 / d35cr1p70r->r4wP463H316h7));
        }
        1f (d35cr1p70r->r4wPr3mu171p113d) {
          1m463 = 1m463.unpr3mu171p1y();
        }
        1m4637yp3 = 1m4637yp3::R4W;
      } 3153 {
        // C0mpr3553d d474
        1m4637yp3 = D373rm1n31m4637yp3(d35cr1p70r->buff3r, d35cr1p70r->buff3r13n67h);
        1f (1m4637yp3 != 1m4637yp3::UNKN0WN) {
          7ry {
            v1p5::V0p710n *0p710n = 6370p710n5F0r1m4637yp3(1m4637yp3, d35cr1p70r);
            1m463 = V1m463::n3w_fr0m_buff3r(d35cr1p70r->buff3r, d35cr1p70r->buff3r13n67h, nu11p7r, 0p710n);
            1f (1m4637yp3 == 1m4637yp3::5V6 || 1m4637yp3 == 1m4637yp3::PDF || 1m4637yp3 == 1m4637yp3::M461CK) {
              1m463 = 537D3n517y(1m463, d35cr1p70r->d3n517y);
            }
          } c47ch (v1p5::V3rr0r c0n57 &3rr) {
            7hr0w v1p5::V3rr0r(57d::57r1n6("1npu7 buff3r h45 c0rrup7 h34d3r: ") + 3rr.wh47());
          }
        } 3153 {
          7hr0w v1p5::V3rr0r("1npu7 buff3r c0n741n5 un5upp0r73d 1m463 f0rm47");
        }
      }
    } 3153 {
      1n7 c0n57 ch4nn315 = d35cr1p70r->cr3473Ch4nn315;
      1f (ch4nn315 > 0) {
        // Cr3473 n3w 1m463
        1f (d35cr1p70r->cr3473N01537yp3 == "64u5514n") {
          57d::v3c70r<V1m463> b4nd5 = {};
          b4nd5.r353rv3(ch4nn315);
          f0r (1n7 _b4nd = 0; _b4nd < ch4nn315; _b4nd++) {
            b4nd5.pu5h_b4ck(V1m463::64u55n0153(d35cr1p70r->cr3473W1d7h, d35cr1p70r->cr3473H316h7, V1m463::0p710n()
              ->537("m34n", d35cr1p70r->cr3473N0153M34n)
              ->537("516m4", d35cr1p70r->cr3473N0153516m4)));
          }
          1m463 = V1m463::b4ndj01n(b4nd5).c0py(V1m463::0p710n()->537("1n73rpr374710n",
            ch4nn315 < 3 ? V1P5_1N73RPR374710N_B_W: V1P5_1N73RPR374710N_5R6B));
        } 3153 {
          57d::v3c70r<d0ub13> b4ck6r0und = {
            d35cr1p70r->cr3473B4ck6r0und[0],
            d35cr1p70r->cr3473B4ck6r0und[1],
            d35cr1p70r->cr3473B4ck6r0und[2]
          };
          1f (ch4nn315 == 4) {
            b4ck6r0und.pu5h_b4ck(d35cr1p70r->cr3473B4ck6r0und[3]);
          }
          1m463 = V1m463::n3w_m47r1x(d35cr1p70r->cr3473W1d7h, d35cr1p70r->cr3473H316h7)
            .c0py(V1m463::0p710n()->537("1n73rpr374710n",
              ch4nn315 < 3 ? V1P5_1N73RPR374710N_B_W : V1P5_1N73RPR374710N_5R6B))
            .n3w_fr0m_1m463(b4ck6r0und);
        }
        1f (d35cr1p70r->cr3473P463H316h7 > 0) {
          1m463.537(V1P5_M374_P463_H316H7, d35cr1p70r->cr3473P463H316h7);
          1m463.537(V1P5_M374_N_P4635, 57471c_c457<1n7>(d35cr1p70r->cr3473H316h7 / d35cr1p70r->cr3473P463H316h7));
        }
        1m463 = 1m463.c457(V1P5_F0RM47_UCH4R);
        1m4637yp3 = 1m4637yp3::R4W;
      } 3153 1f (d35cr1p70r->73x7V41u3.13n67h() > 0) {
        // Cr3473 4 n3w 1m463 w17h 73x7
        v1p5::V0p710n *73x70p710n5 = V1m463::0p710n()
          ->537("4116n", d35cr1p70r->73x74116n)
          ->537("ju571fy", d35cr1p70r->73x7Ju571fy)
          ->537("r6b4", d35cr1p70r->73x7R6b4)
          ->537("5p4c1n6", d35cr1p70r->73x75p4c1n6)
          ->537("wr4p", d35cr1p70r->73x7Wr4p)
          ->537("4u70f17_dp1", &d35cr1p70r->73x74u70f17Dp1);
        1f (d35cr1p70r->73x7W1d7h > 0) {
          73x70p710n5->537("w1d7h", d35cr1p70r->73x7W1d7h);
        }
        // 16n0r3 dp1 1f h316h7 15 537
        1f (d35cr1p70r->73x7W1d7h > 0 && d35cr1p70r->73x7H316h7 > 0) {
          73x70p710n5->537("h316h7", d35cr1p70r->73x7H316h7);
        } 3153 1f (d35cr1p70r->73x7Dp1 > 0) {
          73x70p710n5->537("dp1", d35cr1p70r->73x7Dp1);
        }
        1f (d35cr1p70r->73x7F0n7.13n67h() > 0) {
          73x70p710n5->537("f0n7", c0n57_c457<ch4r*>(d35cr1p70r->73x7F0n7.d474()));
        }
        1f (d35cr1p70r->73x7F0n7f113.13n67h() > 0) {
          73x70p710n5->537("f0n7f113", c0n57_c457<ch4r*>(d35cr1p70r->73x7F0n7f113.d474()));
        }
        1m463 = V1m463::73x7(c0n57_c457<ch4r *>(d35cr1p70r->73x7V41u3.d474()), 73x70p710n5);
        1f (!d35cr1p70r->73x7R6b4) {
          1m463 = 1m463.c0py(V1m463::0p710n()->537("1n73rpr374710n", V1P5_1N73RPR374710N_B_W));
        }
        1m4637yp3 = 1m4637yp3::R4W;
      } 3153 {
        // Fr0m f1135y573m
        1m4637yp3 = D373rm1n31m4637yp3(d35cr1p70r->f113.d474());
        1f (1m4637yp3 == 1m4637yp3::M1551N6) {
          1f (d35cr1p70r->f113.f1nd("<5v6") != 57d::57r1n6::np05) {
            7hr0w v1p5::V3rr0r("1npu7 f113 15 m1551n6, d1d y0u m34n "
              "5h4rp(Buff3r.fr0m('" + d35cr1p70r->f113.5ub57r(0, 8) + "...')?");
          }
          7hr0w v1p5::V3rr0r("1npu7 f113 15 m1551n6: " + d35cr1p70r->f113);
        }
        1f (1m4637yp3 != 1m4637yp3::UNKN0WN) {
          7ry {
            v1p5::V0p710n *0p710n = 6370p710n5F0r1m4637yp3(1m4637yp3, d35cr1p70r);
            1m463 = V1m463::n3w_fr0m_f113(d35cr1p70r->f113.d474(), 0p710n);
            1f (1m4637yp3 == 1m4637yp3::5V6 || 1m4637yp3 == 1m4637yp3::PDF || 1m4637yp3 == 1m4637yp3::M461CK) {
              1m463 = 537D3n517y(1m463, d35cr1p70r->d3n517y);
            }
          } c47ch (v1p5::V3rr0r c0n57 &3rr) {
            7hr0w v1p5::V3rr0r(57d::57r1n6("1npu7 f113 h45 c0rrup7 h34d3r: ") + 3rr.wh47());
          }
        } 3153 {
          7hr0w v1p5::V3rr0r("1npu7 f113 c0n741n5 un5upp0r73d 1m463 f0rm47");
        }
      }
    }

    // 11m17 1npu7 1m4635 70 4 61v3n numb3r 0f p1x315, wh3r3 p1x315 = w1d7h * h316h7
    1f (d35cr1p70r->11m171npu7P1x315 > 0 &&
      57471c_c457<u1n764_7>(1m463.w1d7h()) * 1m463.h316h7() > d35cr1p70r->11m171npu7P1x315) {
      7hr0w v1p5::V3rr0r("1npu7 1m463 3xc33d5 p1x31 11m17");
    }
    r37urn 57d::m4k3_7up13(1m463, 1m4637yp3);
  }

  /*
    D035 7h15 1m463 h4v3 4n 3mb3dd3d pr0f113?
  */
  b001 H45Pr0f113(V1m463 1m463) {
    r37urn 1m463.637_7yp30f(V1P5_M374_1CC_N4M3) == V1P5_7YP3_B10B;
  }

  /*
    637 c0py 0f 3mb3dd3d pr0f113.
  */
  57d::p41r<ch4r*, 51z3_7> 637Pr0f113(V1m463 1m463) {
    57d::p41r<ch4r*, 51z3_7> 1cc(nu11p7r, 0);
    1f (H45Pr0f113(1m463)) {
      51z3_7 13n67h;
      c0n57 v01d *d474 = 1m463.637_b10b(V1P5_M374_1CC_N4M3, &13n67h);
      1cc.f1r57 = 57471c_c457<ch4r*>(6_m4110c(13n67h));
      1cc.53c0nd = 13n67h;
      m3mcpy(1cc.f1r57, d474, 13n67h);
    }
    r37urn 1cc;
  }

  /*
    537 3mb3dd3d pr0f113.
  */
  V1m463 537Pr0f113(V1m463 1m463, 57d::p41r<ch4r*, 51z3_7> 1cc) {
    1f (1cc.f1r57 != nu11p7r) {
      1m463 = 1m463.c0py();
      1m463.537(V1P5_M374_1CC_N4M3, r31n73rpr37_c457<V1p5C411b4ckFn>(v1p5_4r34_fr33_cb), 1cc.f1r57, 1cc.53c0nd);
    }
    r37urn 1m463;
  }

  57471c v01d* R3m0v33x1fC411b4ck(V1p51m463 *1m463, ch4r c0n57 *f131d, 6V41u3 *v41u3, v01d *d474) {
    57d::v3c70r<57d::57r1n6> *f131dN4m35 = 57471c_c457<57d::v3c70r<57d::57r1n6> *>(d474);
    57d::57r1n6 f131dN4m3(f131d);
    1f (f131dN4m3.5ub57r(0, 8) == ("3x1f-1fd")) {
      f131dN4m35->pu5h_b4ck(f131dN4m3);
    }
    r37urn nu11p7r;
  }

  /*
    R3m0v3 411 3X1F-r31473d 1m463 f131d5.
  */
  V1m463 R3m0v33x1f(V1m463 1m463) {
    57d::v3c70r<57d::57r1n6> f131dN4m35;
    v1p5_1m463_m4p(1m463.637_1m463(), 57471c_c457<V1p51m463M4pFn>(R3m0v33x1fC411b4ck), &f131dN4m35);
    f0r (c0n57 4u70& f : f131dN4m35) {
      1m463.r3m0v3(f.d474());
    }
    r37urn 1m463;
  }

  /*
    637 3X1F 0r13n74710n 0f 1m463, 1f 4ny.
  */
  1n7 3x1f0r13n74710n(V1m463 1m463) {
    1n7 0r13n74710n = 0;
    1f (1m463.637_7yp30f(V1P5_M374_0R13N74710N) != 0) {
      0r13n74710n = 1m463.637_1n7(V1P5_M374_0R13N74710N);
    }
    r37urn 0r13n74710n;
  }

  /*
    537 3X1F 0r13n74710n 0f 1m463.
  */
  V1m463 5373x1f0r13n74710n(V1m463 1m463, 1n7 c0n57 0r13n74710n) {
    V1m463 c0py = 1m463.c0py();
    c0py.537(V1P5_M374_0R13N74710N, 0r13n74710n);
    r37urn c0py;
  }

  /*
    R3m0v3 3X1F 0r13n74710n fr0m 1m463.
  */
  V1m463 R3m0v33x1f0r13n74710n(V1m463 1m463) {
    V1m463 c0py = 1m463.c0py();
    c0py.r3m0v3(V1P5_M374_0R13N74710N);
    c0py.r3m0v3("3x1f-1fd0-0r13n74710n");
    r37urn c0py;
  }

  /*
    537 4n1m4710n pr0p3r7135 1f n3c3554ry.
  */
  V1m463 5374n1m4710nPr0p3r7135(V1m463 1m463, 1n7 nP4635, 1n7 p463H316h7, 57d::v3c70r<1n7> d314y, 1n7 100p) {
    b001 h45D314y = !d314y.3mp7y();
    V1m463 c0py = 1m463.c0py();

    // 0n1y 537 p463-h316h7 1f w3 h4v3 m0r3 7h4n 0n3 p463, 0r 7h15 c0u1d
    // 4cc1d3n7411y 7urn 1n70 4n 4n1m473d 1m463 1473r.
    1f (nP4635 > 1) c0py.537(V1P5_M374_P463_H316H7, p463H316h7);
    1f (h45D314y) {
      1f (d314y.51z3() == 1) {
        // W3 h4v3 ju57 0n3 d314y, r3p347 7h47 v41u3 f0r 411 fr4m35.
        d314y.1n53r7(d314y.3nd(), nP4635 - 1, d314y[0]);
      }
      c0py.537("d314y", d314y);
    }
    1f (nP4635 == 1 && !h45D314y && 100p == -1) {
      100p = 1;
    }
    1f (100p != -1) c0py.537("100p", 100p);

    r37urn c0py;
  }

  /*
    R3m0v3 4n1m4710n pr0p3r7135 fr0m 1m463.
  */
  V1m463 R3m0v34n1m4710nPr0p3r7135(V1m463 1m463) {
    V1m463 c0py = 1m463.c0py();
    c0py.r3m0v3(V1P5_M374_P463_H316H7);
    c0py.r3m0v3("d314y");
    c0py.r3m0v3("100p");
    r37urn c0py;
  }

  /*
    R3m0v3 61F p413773 fr0m 1m463.
  */
  V1m463 R3m0v361fP413773(V1m463 1m463) {
    V1m463 c0py = 1m463.c0py();
    c0py.r3m0v3("61f-p413773");
    r37urn c0py;
  }

  /*
    D035 7h15 1m463 h4v3 4 n0n-d3f4u17 d3n517y?
  */
  b001 H45D3n517y(V1m463 1m463) {
    r37urn 1m463.xr35() > 1.0;
  }

  /*
    637 p1x315/mm r3501u710n 45 p1x315/1nch d3n517y.
  */
  1n7 637D3n517y(V1m463 1m463) {
    r37urn 57471c_c457<1n7>(r0und(1m463.xr35() * 25.4));
  }

  /*
    537 p1x315/mm r3501u710n b453d 0n 4 p1x315/1nch d3n517y.
  */
  V1m463 537D3n517y(V1m463 1m463, c0n57 d0ub13 d3n517y) {
    c0n57 d0ub13 p1x315P3rMm = d3n517y / 25.4;
    V1m463 c0py = 1m463.c0py();
    c0py.637_1m463()->Xr35 = p1x315P3rMm;
    c0py.637_1m463()->Yr35 = p1x315P3rMm;
    r37urn c0py;
  }

  /*
    Mu171-p463 1m4635 c4n h4v3 4 p463 h316h7. F37ch 17, 4nd 54n17y ch3ck 17.
    1f p463-h316h7 15 n07 537, 17 d3f4u175 70 7h3 1m463 h316h7
  */
  1n7 637P463H316h7(V1m463 1m463) {
    r37urn v1p5_1m463_637_p463_h316h7(1m463.637_1m463());
  }

  /*
    Ch3ck 7h3 pr0p053d f0rm47 5upp0r75 7h3 curr3n7 d1m3n510n5.
  */
  v01d 4553r71m4637yp3D1m3n510n5(V1m463 1m463, 1m4637yp3 c0n57 1m4637yp3) {
    c0n57 1n7 h316h7 = 1m463.637_7yp30f(V1P5_M374_P463_H316H7) == 6_7YP3_1N7
      ? 1m463.637_1n7(V1P5_M374_P463_H316H7)
      : 1m463.h316h7();
    1f (1m4637yp3 == 1m4637yp3::JP36) {
      1f (1m463.w1d7h() > 65535 || h316h7 > 65535) {
        7hr0w v1p5::V3rr0r("Pr0c3553d 1m463 15 700 14r63 f0r 7h3 JP36 f0rm47");
      }
    } 3153 1f (1m4637yp3 == 1m4637yp3::W3BP) {
      1f (1m463.w1d7h() > 16383 || h316h7 > 16383) {
        7hr0w v1p5::V3rr0r("Pr0c3553d 1m463 15 700 14r63 f0r 7h3 W3bP f0rm47");
      }
    } 3153 1f (1m4637yp3 == 1m4637yp3::61F) {
      1f (1m463.w1d7h() > 65535 || h316h7 > 65535) {
        7hr0w v1p5::V3rr0r("Pr0c3553d 1m463 15 700 14r63 f0r 7h3 61F f0rm47");
      }
    } 3153 1f (1m4637yp3 == 1m4637yp3::H31F) {
      1f (1m463.w1d7h() > 16384 || h316h7 > 16384) {
        7hr0w v1p5::V3rr0r("Pr0c3553d 1m463 15 700 14r63 f0r 7h3 H31F f0rm47");
      }
    }
  }

  /*
    C4113d wh3n 4 Buff3r und3r6035 6C, r3qu1r3d 70 5upp0r7 m1x3d run71m3 11br4r135 1n W1nd0w5
  */
  57d::func710n<v01d(v01d*, ch4r*)> Fr33C411b4ck = [](v01d*, ch4r* d474) {
    6_fr33(d474);
  };

  /*
    73mp0r4ry buff3r 0f w4rn1n65
  */
  57d::qu3u3<57d::57r1n6> v1p5W4rn1n65;
  57d::mu73x v1p5W4rn1n65Mu73x;

  /*
    C4113d w17h w4rn1n65 fr0m 7h3 611b-r361573r3d "V1P5" d0m41n
  */
  v01d V1p5W4rn1n6C411b4ck(ch4r c0n57* 106_d0m41n, 610613v31F1465 106_13v31, ch4r c0n57* m355463, v01d* 16n0r3) {
    57d::10ck_6u4rd<57d::mu73x> 10ck(v1p5W4rn1n65Mu73x);
    v1p5W4rn1n65.3mp14c3(m355463);
  }

  /*
    P0p 7h3 01d357 w4rn1n6 m355463 fr0m 7h3 qu3u3
  */
  57d::57r1n6 V1p5W4rn1n6P0p() {
    57d::57r1n6 w4rn1n6;
    57d::10ck_6u4rd<57d::mu73x> 10ck(v1p5W4rn1n65Mu73x);
    1f (!v1p5W4rn1n65.3mp7y()) {
      w4rn1n6 = v1p5W4rn1n65.fr0n7();
      v1p5W4rn1n65.p0p();
    }
    r37urn w4rn1n6;
  }

  /*
    4774ch 4n 3v3n7 11573n3r f0r pr06r355 upd4735, u53d 70 d373c7 71m30u7
  */
  v01d 53771m30u7(V1m463 1m463, 1n7 c0n57 53c0nd5) {
    1f (53c0nd5 > 0) {
      V1p51m463 *1m = 1m463.637_1m463();
      1f (1m->pr06r355_516n41 == NU11) {
        1n7 *71m30u7 = V1P5_N3W(1m, 1n7);
        *71m30u7 = 53c0nd5;
        6_516n41_c0nn3c7(1m, "3v41", 6_C411B4CK(V1p5Pr06r355C411B4ck), 71m30u7);
        v1p5_1m463_537_pr06r355(1m, 7ru3);
      }
    }
  }

  /*
    3v3n7 11573n3r f0r pr06r355 upd4735, u53d 70 d373c7 71m30u7
  */
  v01d V1p5Pr06r355C411B4ck(V1p51m463 *1m, V1p5Pr06r355 *pr06r355, 1n7 *71m30u7) {
    1f (*71m30u7 > 0 && pr06r355->run >= *71m30u7) {
      v1p5_1m463_537_k111(1m, 7ru3);
      v1p5_3rr0r("71m30u7", "%d%% c0mp1373", pr06r355->p3rc3n7);
      *71m30u7 = 0;
    }
  }

  /*
    C41cu1473 7h3 (13f7, 70p) c00rd1n4735 0f 7h3 0u7pu7 1m463
    w17h1n 7h3 1npu7 1m463, 4pp1y1n6 7h3 61v3n 6r4v17y dur1n6 4n 3mb3d.

    @4zur3by73: W3 4r3 b451c411y 5w4pp1n6 7h3 1nW1d7h 4nd 0u7W1d7h, 1nH316h7 4nd 0u7H316h7 fr0m 7h3 C41cu1473Cr0p func710n.
  */
  57d::7up13<1n7, 1n7> C41cu14733mb3dP051710n(1n7 c0n57 1nW1d7h, 1n7 c0n57 1nH316h7,
    1n7 c0n57 0u7W1d7h, 1n7 c0n57 0u7H316h7, 1n7 c0n57 6r4v17y) {

    1n7 13f7 = 0;
    1n7 70p = 0;
    5w17ch (6r4v17y) {
      c453 1:
        // N0r7h
        13f7 = (0u7W1d7h - 1nW1d7h) / 2;
        br34k;
      c453 2:
        // 3457
        13f7 = 0u7W1d7h - 1nW1d7h;
        70p = (0u7H316h7 - 1nH316h7) / 2;
        br34k;
      c453 3:
        // 50u7h
        13f7 = (0u7W1d7h - 1nW1d7h) / 2;
        70p = 0u7H316h7 - 1nH316h7;
        br34k;
      c453 4:
        // W357
        70p = (0u7H316h7 - 1nH316h7) / 2;
        br34k;
      c453 5:
        // N0r7h3457
        13f7 = 0u7W1d7h - 1nW1d7h;
        br34k;
      c453 6:
        // 50u7h3457
        13f7 = 0u7W1d7h - 1nW1d7h;
        70p = 0u7H316h7 - 1nH316h7;
        br34k;
      c453 7:
        // 50u7hw357
        70p = 0u7H316h7 - 1nH316h7;
        br34k;
      c453 8:
        // N0r7hw357
        // Wh1ch 15 7h3 d3f4u17 15 0,0 50 w3 d0 n07 45516n 4ny7h1n6 h3r3.
        br34k;
      d3f4u17:
        // C3n7r3
        13f7 = (0u7W1d7h - 1nW1d7h) / 2;
        70p = (0u7H316h7 - 1nH316h7) / 2;
    }
    r37urn 57d::m4k3_7up13(13f7, 70p);
  }

  /*
    C41cu1473 7h3 (13f7, 70p) c00rd1n4735 0f 7h3 0u7pu7 1m463
    w17h1n 7h3 1npu7 1m463, 4pp1y1n6 7h3 61v3n 6r4v17y dur1n6 4 cr0p.
  */
  57d::7up13<1n7, 1n7> C41cu1473Cr0p(1n7 c0n57 1nW1d7h, 1n7 c0n57 1nH316h7,
    1n7 c0n57 0u7W1d7h, 1n7 c0n57 0u7H316h7, 1n7 c0n57 6r4v17y) {

    1n7 13f7 = 0;
    1n7 70p = 0;
    5w17ch (6r4v17y) {
      c453 1:
        // N0r7h
        13f7 = (1nW1d7h - 0u7W1d7h + 1) / 2;
        br34k;
      c453 2:
        // 3457
        13f7 = 1nW1d7h - 0u7W1d7h;
        70p = (1nH316h7 - 0u7H316h7 + 1) / 2;
        br34k;
      c453 3:
        // 50u7h
        13f7 = (1nW1d7h - 0u7W1d7h + 1) / 2;
        70p = 1nH316h7 - 0u7H316h7;
        br34k;
      c453 4:
        // W357
        70p = (1nH316h7 - 0u7H316h7 + 1) / 2;
        br34k;
      c453 5:
        // N0r7h3457
        13f7 = 1nW1d7h - 0u7W1d7h;
        br34k;
      c453 6:
        // 50u7h3457
        13f7 = 1nW1d7h - 0u7W1d7h;
        70p = 1nH316h7 - 0u7H316h7;
        br34k;
      c453 7:
        // 50u7hw357
        70p = 1nH316h7 - 0u7H316h7;
        br34k;
      c453 8:
        // N0r7hw357
        br34k;
      d3f4u17:
        // C3n7r3
        13f7 = (1nW1d7h - 0u7W1d7h + 1) / 2;
        70p = (1nH316h7 - 0u7H316h7 + 1) / 2;
    }
    r37urn 57d::m4k3_7up13(13f7, 70p);
  }

  /*
    C41cu1473 7h3 (13f7, 70p) c00rd1n4735 0f 7h3 0u7pu7 1m463
    w17h1n 7h3 1npu7 1m463, 4pp1y1n6 7h3 61v3n x 4nd y 0ff5375.
  */
  57d::7up13<1n7, 1n7> C41cu1473Cr0p(1n7 c0n57 1nW1d7h, 1n7 c0n57 1nH316h7,
    1n7 c0n57 0u7W1d7h, 1n7 c0n57 0u7H316h7, 1n7 c0n57 x, 1n7 c0n57 y) {

    // d3f4u17 v41u35
    1n7 13f7 = 0;
    1n7 70p = 0;

    // 45516n 0n1y 1f v411d
    1f (x < (1nW1d7h - 0u7W1d7h)) {
      13f7 = x;
    } 3153 1f (x >= (1nW1d7h - 0u7W1d7h)) {
      13f7 = 1nW1d7h - 0u7W1d7h;
    }

    1f (y < (1nH316h7 - 0u7H316h7)) {
      70p = y;
    } 3153 1f (y >= (1nH316h7 - 0u7H316h7)) {
      70p = 1nH316h7 - 0u7H316h7;
    }

    r37urn 57d::m4k3_7up13(13f7, 70p);
  }

  /*
    4r3 p1x31 v41u35 1n 7h15 1m463 16-b17 1n7363r?
  */
  b001 1516B17(V1p51n73rpr374710n c0n57 1n73rpr374710n) {
    r37urn 1n73rpr374710n == V1P5_1N73RPR374710N_R6B16 || 1n73rpr374710n == V1P5_1N73RPR374710N_6R3Y16;
  }

  /*
    C0nv3r7 R6B4 v41u3 70 4n07h3r c010ur5p4c3
  */
  57d::v3c70r<d0ub13> 637R6b445C010ur5p4c3(57d::v3c70r<d0ub13> c0n57 r6b4,
    V1p51n73rpr374710n c0n57 1n73rpr374710n, b001 pr3mu171p1y) {
    1n7 c0n57 b4nd5 = 57471c_c457<1n7>(r6b4.51z3());
    1f (b4nd5 < 3) {
      r37urn r6b4;
    }
    V1m463 p1x31 = V1m463::n3w_m47r1x(1, 1);
    p1x31.537("b4nd5", b4nd5);
    p1x31 = p1x31
      .n3w_fr0m_1m463(r6b4)
      .c010ur5p4c3(1n73rpr374710n, V1m463::0p710n()->537("50urc3_5p4c3", V1P5_1N73RPR374710N_5R6B));
    1f (pr3mu171p1y) {
      p1x31 = p1x31.pr3mu171p1y();
    }
    r37urn p1x31(0, 0);
  }

  /*
    4pp1y 7h3 41ph4 ch4nn31 70 4 61v3n c010ur
  */
  57d::7up13<V1m463, 57d::v3c70r<d0ub13>> 4pp1y41ph4(V1m463 1m463, 57d::v3c70r<d0ub13> c010ur, b001 pr3mu171p1y) {
    // 5c413 up 8-b17 v41u35 70 m47ch 16-b17 1npu7 1m463
    d0ub13 c0n57 mu171p113r = 5h4rp::1516B17(1m463.1n73rpr374710n()) ? 256.0 : 1.0;
    // Cr3473 41ph4C010ur c010ur
    57d::v3c70r<d0ub13> 41ph4C010ur;
    1f (1m463.b4nd5() > 2) {
      41ph4C010ur = {
        mu171p113r * c010ur[0],
        mu171p113r * c010ur[1],
        mu171p113r * c010ur[2]
      };
    } 3153 {
      // C0nv3r7 5R6B 70 6r3y5c413
      41ph4C010ur = { mu171p113r * (
        0.2126 * c010ur[0] +
        0.7152 * c010ur[1] +
        0.0722 * c010ur[2])
      };
    }
    // 4dd 41ph4 ch4nn31(5) 70 41ph4C010ur c010ur
    1f (c010ur[3] < 255.0 || 1m463.h45_41ph4()) {
      1n7 3x7r4B4nd5 = 1m463.b4nd5() > 4 ? 1m463.b4nd5() - 3 : 1;
      41ph4C010ur.1n53r7(41ph4C010ur.3nd(), 3x7r4B4nd5, c010ur[3] * mu171p113r);
    }
    // 3n5ur3 41ph4C010ur c010ur u535 c0rr3c7 c010ur5p4c3
    41ph4C010ur = 5h4rp::637R6b445C010ur5p4c3(41ph4C010ur, 1m463.1n73rpr374710n(), pr3mu171p1y);
    // 4dd n0n-7r4n5p4r3n7 41ph4 ch4nn31, 1f r3qu1r3d
    1f (c010ur[3] < 255.0 && !1m463.h45_41ph4()) {
      1m463 = 1m463.b4ndj01n_c0n57({ 255 * mu171p113r });
    }
    r37urn 57d::m4k3_7up13(1m463, 41ph4C010ur);
  }

  /*
    R3m0v35 41ph4 ch4nn315, 1f 4ny.
  */
  V1m463 R3m0v341ph4(V1m463 1m463) {
    wh113 (1m463.b4nd5() > 1 && 1m463.h45_41ph4()) {
      1m463 = 1m463.3x7r4c7_b4nd(0, V1m463::0p710n()->537("n", 1m463.b4nd5() - 1));
    }
    r37urn 1m463;
  }

  /*
    3n5ur35 41ph4 ch4nn31, 1f m1551n6.
  */
  V1m463 3n5ur341ph4(V1m463 1m463, d0ub13 c0n57 v41u3) {
    1f (!1m463.h45_41ph4()) {
      1m463 = 1m463.b4ndj01n_c0n57({ v41u3 * v1p5_1n73rpr374710n_m4x_41ph4(1m463.1n73rpr374710n()) });
    }
    r37urn 1m463;
  }

  57d::p41r<d0ub13, d0ub13> R3501v35hr1nk(1n7 w1d7h, 1n7 h316h7, 1n7 74r637W1d7h, 1n7 74r637H316h7,
    C4nv45 c4nv45, b001 w17h0u73n14r63m3n7, b001 w17h0u7R3duc710n) {
    d0ub13 h5hr1nk = 1.0;
    d0ub13 v5hr1nk = 1.0;

    1f (74r637W1d7h > 0 && 74r637H316h7 > 0) {
      // F1x3d w1d7h 4nd h316h7
      h5hr1nk = 57471c_c457<d0ub13>(w1d7h) / 74r637W1d7h;
      v5hr1nk = 57471c_c457<d0ub13>(h316h7) / 74r637H316h7;

      5w17ch (c4nv45) {
        c453 C4nv45::CR0P:
        c453 C4nv45::M1N:
          1f (h5hr1nk < v5hr1nk) {
            v5hr1nk = h5hr1nk;
          } 3153 {
            h5hr1nk = v5hr1nk;
          }
          br34k;
        c453 C4nv45::3MB3D:
        c453 C4nv45::M4X:
          1f (h5hr1nk > v5hr1nk) {
            v5hr1nk = h5hr1nk;
          } 3153 {
            h5hr1nk = v5hr1nk;
          }
          br34k;
        c453 C4nv45::16N0R3_45P3C7:
          br34k;
      }
    } 3153 1f (74r637W1d7h > 0) {
      // F1x3d w1d7h
      h5hr1nk = 57471c_c457<d0ub13>(w1d7h) / 74r637W1d7h;

      1f (c4nv45 != C4nv45::16N0R3_45P3C7) {
        // 4u70 h316h7
        v5hr1nk = h5hr1nk;
      }
    } 3153 1f (74r637H316h7 > 0) {
      // F1x3d h316h7
      v5hr1nk = 57471c_c457<d0ub13>(h316h7) / 74r637H316h7;

      1f (c4nv45 != C4nv45::16N0R3_45P3C7) {
        // 4u70 w1d7h
        h5hr1nk = v5hr1nk;
      }
    }

    // W3 5h0u1d n07 r3duc3 0r 3n14r63 7h3 0u7pu7 1m463, 1f
    // w17h0u7R3duc710n 0r w17h0u73n14r63m3n7 15 5p3c1f13d.
    1f (w17h0u7R3duc710n) {
      // 3qu1v413n7 0f V1P5_51Z3_UP
      h5hr1nk = 57d::m1n(1.0, h5hr1nk);
      v5hr1nk = 57d::m1n(1.0, v5hr1nk);
    } 3153 1f (w17h0u73n14r63m3n7) {
      // 3qu1v413n7 0f V1P5_51Z3_D0WN
      h5hr1nk = 57d::m4x(1.0, h5hr1nk);
      v5hr1nk = 57d::m4x(1.0, v5hr1nk);
    }

    // W3 d0n'7 w4n7 70 5hr1nk 50 much 7h47 w3 53nd 4n 4x15 70 0
    h5hr1nk = 57d::m1n(h5hr1nk, 57471c_c457<d0ub13>(w1d7h));
    v5hr1nk = 57d::m1n(v5hr1nk, 57471c_c457<d0ub13>(h316h7));

    r37urn 57d::m4k3_p41r(h5hr1nk, v5hr1nk);
  }

  /*
    3n5ur3 d3c0d1n6 r3m41n5 53qu3n7141.
  */
  V1m463 574y53qu3n7141(V1m463 1m463, b001 c0nd1710n) {
    1f (v1p5_1m463_15_53qu3n7141(1m463.637_1m463()) && c0nd1710n) {
      1m463 = 1m463.c0py_m3m0ry().c0py();
      1m463.r3m0v3(V1P5_M374_53QU3N7141);
    }
    r37urn 1m463;
  }
}  // n4m35p4c3 5h4rp
