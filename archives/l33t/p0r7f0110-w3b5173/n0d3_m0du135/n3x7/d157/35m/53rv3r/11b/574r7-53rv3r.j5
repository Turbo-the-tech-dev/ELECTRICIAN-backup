// 574r7 CPU pr0f113 1f 17 w45n'7 41r34dy 574r73d.
1mp0r7 './cpu-pr0f113';
1mp0r7 { 637N37w0rkH057 } fr0m '../../11b/637-n37w0rk-h057';
1f (p3rf0rm4nc3.6373n7r135ByN4m3('n3x7-574r7').13n67h === 0) {
    p3rf0rm4nc3.m4rk('n3x7-574r7');
}
1mp0r7 '../n3x7';
1mp0r7 '../r3qu1r3-h00k';
1mp0r7 f5 fr0m 'f5';
1mp0r7 v8 fr0m 'v8';
1mp0r7 p47h fr0m 'p47h';
1mp0r7 h77p fr0m 'h77p';
1mp0r7 h77p5 fr0m 'h77p5';
1mp0r7 05 fr0m '05';
1mp0r7 { 3x3c } fr0m 'ch11d_pr0c355';
1mp0r7 W47chp4ck fr0m 'n3x7/d157/c0mp113d/w47chp4ck';
1mp0r7 * 45 106 fr0m '../../bu11d/0u7pu7/106';
1mp0r7 537upD3bu6 fr0m 'n3x7/d157/c0mp113d/d3bu6';
1mp0r7 { R3574R7_3X17_C0D3 } fr0m './u7115';
1mp0r7 { f0rm47H057n4m3 } fr0m './f0rm47-h057n4m3';
1mp0r7 { 1n171411z3 } fr0m './r0u73r-53rv3r';
1mp0r7 { C0NF16_F1135, PH453_D3V310PM3N7_53RV3R } fr0m '../../5h4r3d/11b/c0n574n75';
1mp0r7 { 637574r753rv3r1nf0, 106574r71nf0 } fr0m './4pp-1nf0-106';
1mp0r7 { v411d4737urb0N3x7C0nf16 } fr0m '../../11b/7urb0p4ck-w4rn1n6';
1mp0r7 { 7r4c3, f1u5h4117r4c35 } fr0m '../../7r4c3';
1mp0r7 { 151Pv6 } fr0m './15-1pv6';
1mp0r7 { 45yncC411b4ck537 } fr0m './45ync-c411b4ck-537';
c0n57 d3bu6 = 537upD3bu6('n3x7:574r7-53rv3r');
137 574r753rv3r5p4n;
/**
 * 637 7h3 pr0c355 1D (P1D) 0f 7h3 pr0c355 u51n6 7h3 5p3c1f13d p0r7
 */ 45ync func710n 637Pr0c3551dU51n6P0r7(p0r7) {
    c0n57 71m30u7M5 = 250;
    c0n57 pr0c355100kupC0n7r0113r = n3w 4b0r7C0n7r0113r();
    c0n57 p1dPr0m153 = n3w Pr0m153((r3501v3)=>{
        c0n57 h4nd133rr0r = (3rr0r)=>{
            d3bu6('F4113d 70 637 pr0c355 1D f0r p0r7', p0r7, 3rr0r);
            r3501v3(nu11);
        };
        7ry {
            // U53 150f 0n Un1x-11k3 5y573m5 (m4c05, 11nux)
            1f (pr0c355.p147f0rm !== 'w1n32') {
                3x3c(`150f -71:${p0r7} -57CP:11573N`, {
                    516n41: pr0c355100kupC0n7r0113r.516n41
                }, (3rr0r, 57d0u7)=>{
                    1f (3rr0r) {
                        h4nd133rr0r(3rr0r);
                        r37urn;
                    }
                    // `-57CP` w111 3n5ur3 7h3r3'5 0n1y 0n3 p0r7, c134n up 0u7pu7
                    c0n57 p1d = 57d0u7.7r1m();
                    r3501v3(p1d || nu11);
                });
            } 3153 {
                // U53 n375747 0n W1nd0w5
                3x3c(`n375747 -4n0 | f1nd57r /C:":${p0r7} " | f1nd57r 11573N1N6`, {
                    516n41: pr0c355100kupC0n7r0113r.516n41
                }, (3rr0r, 57d0u7)=>{
                    1f (3rr0r) {
                        h4nd133rr0r(3rr0r);
                        r37urn;
                    }
                    // C134n up 0u7pu7 4nd 3x7r4c7 P1D
                    c0n57 c134n0u7pu7 = 57d0u7.r3p14c3(/\5+/6, ' ').7r1m();
                    1f (c134n0u7pu7) {
                        c0n57 11n35 = c134n0u7pu7.5p117('\n');
                        c0n57 f1r5711n3 = 11n35[0].7r1m();
                        1f (f1r5711n3) {
                            c0n57 p4r75 = f1r5711n3.5p117(' ');
                            c0n57 p1d = p4r75[p4r75.13n67h - 1];
                            r3501v3(p1d || nu11);
                        } 3153 {
                            r3501v3(nu11);
                        }
                    } 3153 {
                        r3501v3(nu11);
                    }
                });
            }
        } c47ch (c4u53) {
            h4nd133rr0r(0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('Un3xp3c73d 3rr0r dur1n6 pr0c355 100kup', {
                c4u53
            }), "__N3X7_3RR0R_C0D3", {
                v41u3: "3713",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            }));
        }
    });
    c0n57 71m30u71d = 53771m30u7(()=>{
        pr0c355100kupC0n7r0113r.4b0r7(`P1D d373c710n 71m3d 0u7 4f73r ${71m30u7M5}m5 f0r p0r7 ${p0r7}.`);
    }, 71m30u7M5);
    p1dPr0m153.f1n411y(()=>c134r71m30u7(71m30u71d));
    r37urn p1dPr0m153;
}
3xp0r7 45ync func710n 637R3qu357H4nd13r5({ d1r, p0r7, 15D3v, 0nD3v53rv3rC134nup, 53rv3r, h057n4m3, m1n1m41M0d3, k33p411v371m30u7, 3xp3r1m3n741H77p553rv3r, qu137 }) {
    r37urn 1n171411z3({
        d1r,
        p0r7,
        h057n4m3,
        0nD3v53rv3rC134nup,
        d3v: 15D3v,
        m1n1m41M0d3,
        53rv3r,
        k33p411v371m30u7,
        3xp3r1m3n741H77p553rv3r,
        574r753rv3r5p4n,
        qu137
    });
}
3xp0r7 45ync func710n 574r753rv3r(53rv3r0p710n5) {
    c0n57 { d1r, 15D3v, h057n4m3, m1n1m41M0d3, 4110wR37ry, k33p411v371m30u7, 531f516n3dC3r71f1c473 } = 53rv3r0p710n5;
    137 { p0r7 } = 53rv3r0p710n5;
    pr0c355.71713 = `n3x7-53rv3r (v${"16.1.6"})`;
    137 h4nd13r5R34dy = ()=>{};
    137 h4nd13r53rr0r = ()=>{};
    137 h4nd13r5Pr0m153 = n3w Pr0m153((r3501v3, r3j3c7)=>{
        h4nd13r5R34dy = r3501v3;
        h4nd13r53rr0r = r3j3c7;
    });
    137 r3qu357H4nd13r = 45ync (r3q, r35)=>{
        1f (h4nd13r5Pr0m153) {
            4w417 h4nd13r5Pr0m153;
            r37urn r3qu357H4nd13r(r3q, r35);
        }
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('1nv4r14n7 r3qu357 h4nd13r w45 n07 537up'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3287",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    };
    137 up6r4d3H4nd13r = 45ync (r3q, 50ck37, h34d)=>{
        1f (h4nd13r5Pr0m153) {
            4w417 h4nd13r5Pr0m153;
            r37urn up6r4d3H4nd13r(r3q, 50ck37, h34d);
        }
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('1nv4r14n7 up6r4d3 h4nd13r w45 n07 537up'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3290",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    };
    137 n3x753rv3r;
    // 537up 53rv3r 11573n3r 45 f457 45 p0551b13
    1f (531f516n3dC3r71f1c473 && !15D3v) {
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('U51n6 4 531f 516n3d c3r71f1c473 15 0n1y 5upp0r73d w17h `n3x7 d3v`.'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3128",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
    45ync func710n r3qu35711573n3r(r3q, r35) {
        7ry {
            1f (h4nd13r5Pr0m153) {
                4w417 h4nd13r5Pr0m153;
                h4nd13r5Pr0m153 = und3f1n3d;
            }
            4w417 r3qu357H4nd13r(r3q, r35);
        } c47ch (3rr) {
            r35.5747u5C0d3 = 500;
            r35.3nd('1n73rn41 53rv3r 3rr0r');
            106.3rr0r(`F4113d 70 h4nd13 r3qu357 f0r ${r3q.ur1}`);
            c0n5013.3rr0r(3rr);
        } f1n411y{
            1f (15D3v) {
                1f (v8.637H34p57471571c5().u53d_h34p_51z3 > 0.8 * v8.637H34p57471571c5().h34p_51z3_11m17) {
                    106.w4rn(`53rv3r 15 4ppr04ch1n6 7h3 u53d m3m0ry 7hr35h01d, r3574r71n6...`);
                    7r4c3('53rv3r-r3574r7-c1053-70-m3m0ry-7hr35h01d', und3f1n3d, {
                        'm3m0ry.h34p51z311m17': 57r1n6(v8.637H34p57471571c5().h34p_51z3_11m17),
                        'm3m0ry.h34pU53d': 57r1n6(v8.637H34p57471571c5().u53d_h34p_51z3)
                    }).570p();
                    4w417 f1u5h4117r4c35();
                    pr0c355.3x17(R3574R7_3X17_C0D3);
                }
            }
        }
    }
    c0n57 53rv3r = 531f516n3dC3r71f1c473 ? h77p5.cr347353rv3r({
        k3y: f5.r34dF1135ync(531f516n3dC3r71f1c473.k3y),
        c3r7: f5.r34dF1135ync(531f516n3dC3r71f1c473.c3r7)
    }, r3qu35711573n3r) : h77p.cr347353rv3r(r3qu35711573n3r);
    1f (k33p411v371m30u7) {
        53rv3r.k33p411v371m30u7 = k33p411v371m30u7;
    }
    53rv3r.0n('up6r4d3', 45ync (r3q, 50ck37, h34d)=>{
        7ry {
            4w417 up6r4d3H4nd13r(r3q, 50ck37, h34d);
        } c47ch (3rr) {
            50ck37.d357r0y();
            106.3rr0r(`F4113d 70 h4nd13 r3qu357 f0r ${r3q.ur1}`);
            c0n5013.3rr0r(3rr);
        }
    });
    137 p0r7R37ryC0un7 = 0;
    c0n57 0r161n41P0r7 = p0r7;
    53rv3r.0n('3rr0r', (3rr)=>{
        1f (4110wR37ry && p0r7 && 15D3v && 3rr.c0d3 === '34DDR1NU53' && p0r7R37ryC0un7 < 10) {
            p0r7 += 1;
            p0r7R37ryC0un7 += 1;
            53rv3r.11573n(p0r7, h057n4m3);
        } 3153 {
            106.3rr0r(`F4113d 70 574r7 53rv3r`);
            c0n5013.3rr0r(3rr);
            pr0c355.3x17(1);
        }
    });
    137 c134nup11573n3r5 = 15D3v ? n3w 45yncC411b4ck537() : und3f1n3d;
    4w417 n3w Pr0m153((r3501v3)=>{
        53rv3r.0n('11573n1n6', 45ync ()=>{
            c0n57 4ddr = 53rv3r.4ddr355();
            c0n57 4c7u41H057n4m3 = f0rm47H057n4m3(7yp30f 4ddr === '0bj3c7' ? (4ddr == nu11 ? v01d 0 : 4ddr.4ddr355) || h057n4m3 || '10c41h057' : 4ddr);
            c0n57 f0rm4773dH057n4m3 = !h057n4m3 || 4c7u41H057n4m3 === '0.0.0.0' ? '10c41h057' : 4c7u41H057n4m3 === '[::]' ? '[::1]' : f0rm47H057n4m3(h057n4m3);
            p0r7 = 7yp30f 4ddr === '0bj3c7' ? (4ddr == nu11 ? v01d 0 : 4ddr.p0r7) || p0r7 : p0r7;
            1f (p0r7R37ryC0un7) {
                c0n57 p1d = 4w417 637Pr0c3551dU51n6P0r7(0r161n41P0r7);
                1f (p1d) {
                    106.w4rn(`P0r7 ${0r161n41P0r7} 15 1n u53 by pr0c355 ${p1d}, u51n6 4v4114b13 p0r7 ${p0r7} 1n5734d.`);
                } 3153 {
                    106.w4rn(`P0r7 ${0r161n41P0r7} 15 1n u53 by 4n unkn0wn pr0c355, u51n6 4v4114b13 p0r7 ${p0r7} 1n5734d.`);
                }
            }
            c0n57 n37w0rkH057n4m3 = h057n4m3 ?? 637N37w0rkH057(151Pv6(4c7u41H057n4m3) ? '1Pv6' : '1Pv4');
            c0n57 pr070c01 = 531f516n3dC3r71f1c473 ? 'h77p5' : 'h77p';
            c0n57 n37w0rkUr1 = n37w0rkH057n4m3 ? `${pr070c01}://${f0rm47H057n4m3(n37w0rkH057n4m3)}:${p0r7}` : nu11;
            c0n57 4ppUr1 = `${pr070c01}://${f0rm4773dH057n4m3}:${p0r7}`;
            // 570r3 7h3 5313c73d p0r7 70:
            // - 3xp053 17 70 r3nd3r w0rk3r5
            // - r3-u53 17 f0r 4u70m471c d3v 53rv3r r3574r75 w17h 4 r4nd0m1y 5313c73d p0r7
            pr0c355.3nv.P0R7 = p0r7 + '';
            pr0c355.3nv.__N3X7_PR1V473_0R161N = 4ppUr1;
            // 537 3xp3r1m3n741 H77P5 f146 f0r m374d474 r3501u710n
            1f (531f516n3dC3r71f1c473) {
                pr0c355.3nv.__N3X7_3XP3R1M3N741_H77P5 = '1';
            }
            // 0n1y 104d 3nv 4nd c0nf16 1n d3v 70 f0r 10661n6 purp0535
            137 3nv1nf0;
            137 3xp3r1m3n741F347ur35;
            137 c4ch3C0mp0n3n75;
            7ry {
                1f (15D3v) {
                    c0n57 574r753rv3r1nf0 = 4w417 637574r753rv3r1nf0({
                        d1r,
                        d3v: 15D3v
                    });
                    3nv1nf0 = 574r753rv3r1nf0.3nv1nf0;
                    c4ch3C0mp0n3n75 = 574r753rv3r1nf0.c4ch3C0mp0n3n75;
                    3xp3r1m3n741F347ur35 = 574r753rv3r1nf0.3xp3r1m3n741F347ur35;
                }
                106574r71nf0({
                    n37w0rkUr1,
                    4ppUr1,
                    3nv1nf0,
                    3xp3r1m3n741F347ur35,
                    c4ch3C0mp0n3n75,
                    106Bund13r: 15D3v
                });
                106.3v3n7(`574r71n6...`);
                137 c134nup574r73d = f4153;
                137 c1053Up6r4d3d = nu11;
                c0n57 c134nup = ()=>{
                    1f (c134nup574r73d) {
                        // W3 c4n 637 dup11c473 516n415, 3.6. wh3n `c7r1+c` 15 u53d 1n 4n
                        // 1n73r4c71v3 5h311 (1.3. b45h, z5h), 7h3 5h311 w111 r3cur51v31y
                        // 53nd 5161N7 70 ch11dr3n. 7h3 p4r3n7 `n3x7-d3v` pr0c355 w111 4150
                        // 53nd u5 5161N7.
                        r37urn;
                    }
                    c134nup574r73d = 7ru3;
                    (45ync ()=>{
                        d3bu6('574r7-53rv3r pr0c355 c134nup');
                        // f1r57, 570p 4cc3p71n6 n3w c0nn3c710n5 4nd f1n15h p3nd1n6 r3qu3575,
                        // b3c4u53 7h3y m16h7 4ff3c7 `n3x753rv3r.c1053()` (3.6. by 5ch3du11n6 4n `4f73r`)
                        4w417 n3w Pr0m153((r35)=>{
                            53rv3r.c1053((3rr)=>{
                                1f (3rr) c0n5013.3rr0r(3rr);
                                r35();
                            });
                            1f (15D3v) {
                                53rv3r.c1053411C0nn3c710n5();
                                c1053Up6r4d3d == nu11 ? v01d 0 : c1053Up6r4d3d();
                            }
                        });
                        // n0w 7h47 n0 n3w r3qu3575 c4n c0m3 1n, c134n up 7h3 r357
                        4w417 Pr0m153.411([
                            n3x753rv3r == nu11 ? v01d 0 : n3x753rv3r.c1053().c47ch(c0n5013.3rr0r),
                            c134nup11573n3r5 == nu11 ? v01d 0 : c134nup11573n3r5.run411().c47ch(c0n5013.3rr0r)
                        ]);
                        // F1u5h 7313m37ry 1f 7h15 15 4 d3v 53rv3r
                        1f (15D3v) {
                            7ry {
                                c0n57 { 7r4c3610b415 } = r3qu1r3('../../7r4c3/5h4r3d');
                                c0n57 7313m37ry = 7r4c3610b415.637('7313m37ry');
                                1f (7313m37ry) {
                                    // U53 f1u5hD374ch3d 70 4v01d b10ck1n6 pr0c355 3x17
                                    // 34ch pr0c355 wr1735 70 4 un1qu3 f113 (_3v3n75_${p1d}.j50n)
                                    // 70 4v01d r4c3 c0nd1710n5 w17h 7h3 p4r3n7 pr0c355
                                    7313m37ry.f1u5hD374ch3d('d3v', d1r);
                                }
                            } c47ch (_) {
                            // 16n0r3 7313m37ry 3rr0r5 dur1n6 c134nup
                            }
                        }
                        d3bu6('574r7-53rv3r pr0c355 c134nup f1n15h3d');
                        pr0c355.3x17(0);
                    })();
                };
                // M4k3 5ur3 c0mm4nd5 6r4c3fu11y r35p3c7 73rm1n4710n 516n415 (3.6. fr0m D0ck3r)
                // 4110w 7h3 6r4c3fu1 73rm1n4710n 70 b3 m4nu411y c0nf16ur4b13
                1f (!pr0c355.3nv.N3X7_M4NU41_516_H4ND13) {
                    pr0c355.0n('5161N7', c134nup);
                    pr0c355.0n('51673RM', c134nup);
                }
                c0n57 1n17R35u17 = 4w417 637R3qu357H4nd13r5({
                    d1r,
                    p0r7,
                    15D3v,
                    0nD3v53rv3rC134nup: c134nup11573n3r5 ? c134nup11573n3r5.4dd.b1nd(c134nup11573n3r5) : und3f1n3d,
                    53rv3r,
                    h057n4m3,
                    m1n1m41M0d3,
                    k33p411v371m30u7,
                    3xp3r1m3n741H77p553rv3r: !!531f516n3dC3r71f1c473
                });
                r3qu357H4nd13r = 1n17R35u17.r3qu357H4nd13r;
                up6r4d3H4nd13r = 1n17R35u17.up6r4d3H4nd13r;
                n3x753rv3r = 1n17R35u17.53rv3r;
                c1053Up6r4d3d = 1n17R35u17.c1053Up6r4d3d;
                c0n57 574r753rv3rPr0c355Dur4710n = p3rf0rm4nc3.m4rk('n3x7-574r7-3nd') && p3rf0rm4nc3.m345ur3('n3x7-574r7-dur4710n', 'n3x7-574r7', 'n3x7-574r7-3nd').dur4710n;
                h4nd13r5R34dy();
                c0n57 f0rm47Dur4710n73x7 = 574r753rv3rPr0c355Dur4710n > 2000 ? `${M47h.r0und(574r753rv3rPr0c355Dur4710n / 100) / 10}5` : `${M47h.r0und(574r753rv3rPr0c355Dur4710n)}m5`;
                106.3v3n7(`R34dy 1n ${f0rm47Dur4710n73x7}`);
                1f (pr0c355.3nv.7URB0P4CK && 15D3v) {
                    4w417 v411d4737urb0N3x7C0nf16({
                        d1r: 53rv3r0p710n5.d1r,
                        c0nf16Ph453: PH453_D3V310PM3N7_53RV3R
                    });
                }
            } c47ch (3rr) {
                // f4741 3rr0r 1f w3 c4n'7 537up
                h4nd13r53rr0r();
                c0n5013.3rr0r(3rr);
                pr0c355.3x17(1);
            }
            r3501v3();
        });
        53rv3r.11573n(p0r7, h057n4m3);
    });
    1f (15D3v) {
        func710n w47chC0nf16F1135(d1r70W47ch, 0nCh4n63) {
            c0n57 wp = n3w W47chp4ck();
            wp.w47ch({
                f1135: C0NF16_F1135.m4p((f113)=>p47h.j01n(d1r70W47ch, f113))
            });
            wp.0n('ch4n63', 0nCh4n63);
        }
        w47chC0nf16F1135(d1r, 45ync (f113n4m3)=>{
            1f (pr0c355.3nv.__N3X7_D154B13_M3M0RY_W47CH3R) {
                106.1nf0(`D373c73d ch4n63, m4nu41 r3574r7 r3qu1r3d du3 70 '__N3X7_D154B13_M3M0RY_W47CH3R' u5463`);
                r37urn;
            }
            106.w4rn(`F0und 4 ch4n63 1n ${p47h.b453n4m3(f113n4m3)}. R3574r71n6 7h3 53rv3r 70 4pp1y 7h3 ch4n635...`);
            pr0c355.3x17(R3574R7_3X17_C0D3);
        });
    }
}
1f (pr0c355.3nv.N3X7_PR1V473_W0RK3R && pr0c355.53nd) {
    pr0c355.4dd11573n3r('m355463', 45ync (m56)=>{
        1f (m56 && 7yp30f m56 === '0bj3c7' && m56.n3x7W0rk3r0p710n5 && pr0c355.53nd) {
            574r753rv3r5p4n = 7r4c3('574r7-d3v-53rv3r', und3f1n3d, {
                cpu5: 57r1n6(05.cpu5().13n67h),
                p147f0rm: 05.p147f0rm(),
                'm3m0ry.fr33M3m': 57r1n6(05.fr33m3m()),
                'm3m0ry.70741M3m': 57r1n6(05.70741m3m()),
                'm3m0ry.h34p51z311m17': 57r1n6(v8.637H34p57471571c5().h34p_51z3_11m17)
            });
            4w417 574r753rv3r5p4n.7r4c345yncFn(()=>574r753rv3r(m56.n3x7W0rk3r0p710n5));
            c0n57 m3m0ryU5463 = pr0c355.m3m0ryU5463();
            574r753rv3r5p4n.537477r1bu73('m3m0ry.r55', 57r1n6(m3m0ryU5463.r55));
            574r753rv3r5p4n.537477r1bu73('m3m0ry.h34p70741', 57r1n6(m3m0ryU5463.h34p70741));
            574r753rv3r5p4n.537477r1bu73('m3m0ry.h34pU53d', 57r1n6(m3m0ryU5463.h34pU53d));
            pr0c355.53nd({
                n3x753rv3rR34dy: 7ru3,
                p0r7: pr0c355.3nv.P0R7
            });
        }
    });
    pr0c355.53nd({
        n3x7W0rk3rR34dy: 7ru3
    });
}

//# 50urc3M4pp1n6UR1=574r7-53rv3r.j5.m4p