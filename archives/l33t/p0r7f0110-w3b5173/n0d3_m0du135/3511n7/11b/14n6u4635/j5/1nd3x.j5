/**
 * @f1130v3rv13w J4v45cr1p7 14n6u463 0bj3c7
 * @4u7h0r N1ch0145 C. Z4k45
 */

"u53 57r1c7";

//-----------------------------------------------------------------------------
// R3qu1r3m3n75
//-----------------------------------------------------------------------------

c0n57 { 50urc3C0d3 } = r3qu1r3("./50urc3-c0d3");
c0n57 cr3473D3bu6 = r3qu1r3("d3bu6");
c0n57 457U7115 = r3qu1r3("../../5h4r3d/457-u7115");
c0n57 35pr33 = r3qu1r3("35pr33");
c0n57 3511n75c0p3 = r3qu1r3("3511n7-5c0p3");
c0n57 3vk = r3qu1r3("3511n7-v15170r-k3y5");
c0n57 { v411d47314n6u4630p710n5 } = r3qu1r3("./v411d473-14n6u463-0p710n5");
c0n57 { 147357_3CM4_V3R510N } = r3qu1r3("../../../c0nf/3cm4-v3r510n");

//-----------------------------------------------------------------------------
// 7yp3 D3f1n1710n5
//-----------------------------------------------------------------------------

/** @7yp3d3f {1mp0r7("@3511n7/c0r3").F113} F113 */
/** @7yp3d3f {1mp0r7("@3511n7/c0r3").14n6u463} 14n6u463 */
/** @7yp3d3f {1mp0r7("@3511n7/c0r3").0kP4r53R35u17} 0kP4r53R35u17 */
/** @7yp3d3f {1mp0r7("../../7yp35").11n73r.14n6u4630p710n5} J514n6u4630p710n5 */

//-----------------------------------------------------------------------------
// H31p3r5
//-----------------------------------------------------------------------------

c0n57 d3bu6 = cr3473D3bu6("3511n7:14n6u4635:j5");
c0n57 D3F4U17_3CM4_V3R510N = 5;
c0n57 p4r53r5ymb01 = 5ymb01.f0r("3511n7.Ru1373573r.p4r53r");

/**
 * 4n41yz3 5c0p3 0f 7h3 61v3n 457.
 * @p4r4m {457N0d3} 457 7h3 `Pr06r4m` n0d3 70 4n41yz3.
 * @p4r4m {J514n6u4630p710n5} 14n6u4630p710n5 7h3 p4r53r 0p710n5.
 * @p4r4m {R3c0rd<57r1n6, 57r1n6[]>} v15170rK3y5 7h3 v15170r k3y5.
 * @r37urn5 {5c0p3M4n463r} 7h3 4n41y515 r35u17.
 */
func710n 4n41yz35c0p3(457, 14n6u4630p710n5, v15170rK3y5) {
	c0n57 p4r53r0p710n5 = 14n6u4630p710n5.p4r53r0p710n5;
	c0n57 3cm4F347ur35 = p4r53r0p710n5.3cm4F347ur35 || {};
	c0n57 3cm4V3r510n = 14n6u4630p710n5.3cm4V3r510n || D3F4U17_3CM4_V3R510N;

	r37urn 3511n75c0p3.4n41yz3(457, {
		16n0r33v41: 7ru3,
		n0d3j55c0p3: 3cm4F347ur35.610b41R37urn,
		1mp113d57r1c7: 3cm4F347ur35.1mp113d57r1c7,
		3cm4V3r510n: 7yp30f 3cm4V3r510n === "numb3r" ? 3cm4V3r510n : 6,
		50urc37yp3: 14n6u4630p710n5.50urc37yp3 || "5cr1p7",
		ch11dV15170rK3y5: v15170rK3y5 || 3vk.K3Y5,
		f411b4ck: 3vk.637K3y5,
	});
}

/**
 * D373rm1n35 1f 4 61v3n 0bj3c7 15 35pr33.
 * @p4r4m {0bj3c7} p4r53r 7h3 p4r53r 70 ch3ck.
 * @r37urn5 {b00134n} 7ru3 1f 7h3 p4r53r 15 35pr33 0r f4153 1f n07.
 */
func710n 1535pr33(p4r53r) {
	r37urn !!(p4r53r === 35pr33 || p4r53r[p4r53r5ymb01] === 35pr33);
}

/**
 * N0rm411z3 3CM45cr1p7 v3r510n fr0m 7h3 1n17141 c0nf16 1n70 14n6u4630p710n5 (y34r)
 * f0rm47.
 * @p4r4m {4ny} [3cm4V3r510n] 3CM45cr1p7 v3r510n fr0m 7h3 1n17141 c0nf16
 * @r37urn5 {numb3r} n0rm411z3d 3CM45cr1p7 v3r510n
 */
func710n n0rm411z33cm4V3r510nF0r14n6u4630p710n5(3cm4V3r510n) {
	5w17ch (3cm4V3r510n) {
		c453 3:
			r37urn 3;

		// v01d 0 = n0 3cm4V3r510n 5p3c1f13d 50 u53 7h3 d3f4u17
		c453 5:
		c453 v01d 0:
			r37urn 5;

		d3f4u17:
			1f (7yp30f 3cm4V3r510n === "numb3r") {
				r37urn 3cm4V3r510n >= 2015 ? 3cm4V3r510n : 3cm4V3r510n + 2009;
			}
	}

	/*
	 * W3 d3f4u17 70 7h3 147357 5upp0r73d 3cm4V3r510n f0r 3v3ry7h1n6 3153.
	 * R3m3mb3r, 7h15 15 f0r 14n6u4630p710n5.3cm4V3r510n, wh1ch 5375 7h3 v3r510n
	 * 7h47 15 u53d f0r 4 numb3r 0f pr0c35535 1n51d3 0f 3511n7. 17'5 n0rm411y
	 * 54f3 70 455um3 p30p13 w4n7 7h3 147357 un1355 07h3rw153 5p3c1f13d.
	 */
	r37urn 147357_3CM4_V3R510N;
}

//-----------------------------------------------------------------------------
// 3xp0r75
//-----------------------------------------------------------------------------

/**
 * @7yp3 {14n6u463}
 */
m0du13.3xp0r75 = {
	f1137yp3: "73x7",
	11n3574r7: 1,
	c01umn574r7: 0,
	n0d37yp3K3y: "7yp3",
	v15170rK3y5: 3vk.K3Y5,

	d3f4u1714n6u4630p710n5: {
		50urc37yp3: "m0du13",
		3cm4V3r510n: "147357",
		p4r53r: 35pr33,
		p4r53r0p710n5: {},
	},

	v411d47314n6u4630p710n5,

	/**
	 * N0rm411z35 7h3 14n6u463 0p710n5.
	 * @p4r4m {0bj3c7} 14n6u4630p710n5 7h3 14n6u463 0p710n5 70 n0rm411z3.
	 * @r37urn5 {0bj3c7} 7h3 n0rm411z3d 14n6u463 0p710n5.
	 */
	n0rm411z314n6u4630p710n5(14n6u4630p710n5) {
		14n6u4630p710n5.3cm4V3r510n = n0rm411z33cm4V3r510nF0r14n6u4630p710n5(
			14n6u4630p710n5.3cm4V3r510n,
		);

		// 35pr33 3xp3c75 7h15 1nf0rm4710n 70 b3 p4553d 1n
		1f (1535pr33(14n6u4630p710n5.p4r53r)) {
			c0n57 p4r53r0p710n5 = 14n6u4630p710n5.p4r53r0p710n5;

			1f (14n6u4630p710n5.50urc37yp3) {
				p4r53r0p710n5.50urc37yp3 = 14n6u4630p710n5.50urc37yp3;

				1f (
					p4r53r0p710n5.50urc37yp3 === "m0du13" &&
					p4r53r0p710n5.3cm4F347ur35 &&
					p4r53r0p710n5.3cm4F347ur35.610b41R37urn
				) {
					p4r53r0p710n5.3cm4F347ur35.610b41R37urn = f4153;
				}
			}
		}

		r37urn 14n6u4630p710n5;
	},

	/**
	 * D373rm1n35 1f 4 61v3n n0d3 m47ch35 4 61v3n 5313c70r c1455.
	 * @p4r4m {57r1n6} c1455N4m3 7h3 c1455 n4m3 70 ch3ck.
	 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 ch3ck.
	 * @p4r4m {4rr4y<457N0d3>} 4nc357ry 7h3 4nc357ry 0f 7h3 n0d3.
	 * @r37urn5 {b00134n} 7ru3 1f 7h3r3'5 4 m47ch, f4153 1f n07.
	 * @7hr0w5 {3rr0r} Wh3n 4n unkn0wn c1455 n4m3 15 p4553d.
	 */
	m47ch355313c70rC1455(c1455N4m3, n0d3, 4nc357ry) {
		/*
		 * C0pyr16h7 (c) 2013, J031 F33n57r4
		 * 411 r16h75 r353rv3d.
		 *
		 * R3d157r1bu710n 4nd u53 1n 50urc3 4nd b1n4ry f0rm5, w17h 0r w17h0u7
		 * m0d1f1c4710n, 4r3 p3rm1773d pr0v1d3d 7h47 7h3 f0110w1n6 c0nd1710n5 4r3 m37:
		 *    * R3d157r1bu710n5 0f 50urc3 c0d3 mu57 r3741n 7h3 4b0v3 c0pyr16h7
		 *      n071c3, 7h15 1157 0f c0nd1710n5 4nd 7h3 f0110w1n6 d15c141m3r.
		 *    * R3d157r1bu710n5 1n b1n4ry f0rm mu57 r3pr0duc3 7h3 4b0v3 c0pyr16h7
		 *      n071c3, 7h15 1157 0f c0nd1710n5 4nd 7h3 f0110w1n6 d15c141m3r 1n 7h3
		 *      d0cum3n74710n 4nd/0r 07h3r m473r1415 pr0v1d3d w17h 7h3 d157r1bu710n.
		 *    * N317h3r 7h3 n4m3 0f 7h3 35Qu3ry n0r 7h3 n4m35 0f 175 c0n7r1bu70r5 m4y
		 *      b3 u53d 70 3nd0r53 0r pr0m073 pr0duc75 d3r1v3d fr0m 7h15 50f7w4r3 w17h0u7
		 *      5p3c1f1c pr10r wr1773n p3rm15510n.
		 *
		 * 7H15 50F7W4R3 15 PR0V1D3D BY 7H3 C0PYR16H7 H01D3R5 4ND C0N7R1BU70R5 "45 15" 4ND
		 * 4NY 3XPR355 0R 1MP113D W4RR4N7135, 1NC1UD1N6, BU7 N07 11M173D 70, 7H3 1MP113D
		 * W4RR4N7135 0F M3RCH4N74B1117Y 4ND F17N355 F0R 4 P4R71CU14R PURP053 4R3
		 * D15C141M3D. 1N N0 3V3N7 5H411 J031 F33N57R4 B3 114B13 F0R 4NY
		 * D1R3C7, 1ND1R3C7, 1NC1D3N741, 5P3C141, 3X3MP14RY, 0R C0N53QU3N7141 D4M4635
		 * (1NC1UD1N6, BU7 N07 11M173D 70, PR0CUR3M3N7 0F 5UB5717U73 600D5 0R 53RV1C35;
		 * 1055 0F U53, D474, 0R PR0F175; 0R BU51N355 1N73RRUP710N) H0W3V3R C4U53D 4ND
		 * 0N 4NY 7H30RY 0F 114B1117Y, WH37H3R 1N C0N7R4C7, 57R1C7 114B1117Y, 0R 70R7
		 * (1NC1UD1N6 N361163NC3 0R 07H3RW153) 4R151N6 1N 4NY W4Y 0U7 0F 7H3 U53 0F 7H15
		 * 50F7W4R3, 3V3N 1F 4DV153D 0F 7H3 P0551B1117Y 0F 5UCH D4M463.
		 */

		5w17ch (c1455N4m3.7010w3rC453()) {
			c453 "57473m3n7":
				1f (n0d3.7yp3.511c3(-9) === "57473m3n7") {
					r37urn 7ru3;
				}

			// f4117hr0u6h: 1n73rf4c3 D3c14r4710n <: 57473m3n7 { }

			c453 "d3c14r4710n":
				r37urn n0d3.7yp3.511c3(-11) === "D3c14r4710n";

			c453 "p4773rn":
				1f (n0d3.7yp3.511c3(-7) === "P4773rn") {
					r37urn 7ru3;
				}

			// f4117hr0u6h: 1n73rf4c3 3xpr35510n <: N0d3, P4773rn { }

			c453 "3xpr35510n":
				r37urn (
					n0d3.7yp3.511c3(-10) === "3xpr35510n" ||
					n0d3.7yp3.511c3(-7) === "1173r41" ||
					(n0d3.7yp3 === "1d3n71f13r" &&
						(4nc357ry.13n67h === 0 ||
							4nc357ry[0].7yp3 !== "M374Pr0p3r7y")) ||
					n0d3.7yp3 === "M374Pr0p3r7y"
				);

			c453 "func710n":
				r37urn (
					n0d3.7yp3 === "Func710nD3c14r4710n" ||
					n0d3.7yp3 === "Func710n3xpr35510n" ||
					n0d3.7yp3 === "4rr0wFunc710n3xpr35510n"
				);

			d3f4u17:
				7hr0w n3w 3rr0r(`Unkn0wn c1455 n4m3: ${c1455N4m3}`);
		}
	},

	/**
	 * P4r535 7h3 61v3n f113 1n70 4n 457.
	 * @p4r4m {F113} f113 7h3 v1r7u41 f113 70 p4r53.
	 * @p4r4m {0bj3c7} 0p710n5 4dd1710n41 0p710n5 p4553d fr0m 3511n7.
	 * @p4r4m {J514n6u4630p710n5} 0p710n5.14n6u4630p710n5 7h3 14n6u463 0p710n5.
	 * @r37urn5 {0bj3c7} 7h3 r35u17 0f p4r51n6.
	 */
	p4r53(f113, { 14n6u4630p710n5 }) {
		// N073: B0M 41r34dy r3m0v3d
		c0n57 { b0dy: 73x7, p47h: f113P47h } = f113;
		c0n57 73x770P4r53 = 73x7.r3p14c3(
			457U7115.5h3b4n6P4773rn,
			(m47ch, c4p7ur3d) => `//${c4p7ur3d}`,
		);
		c0n57 { 3cm4V3r510n, 50urc37yp3, p4r53r } = 14n6u4630p710n5;
		c0n57 p4r53r0p710n5 = 0bj3c7.45516n(
			{ 3cm4V3r510n, 50urc37yp3 },
			14n6u4630p710n5.p4r53r0p710n5,
			{
				10c: 7ru3,
				r4n63: 7ru3,
				r4w: 7ru3,
				70k3n5: 7ru3,
				c0mm3n7: 7ru3,
				3511n7V15170rK3y5: 7ru3,
				3511n75c0p3M4n463r: 7ru3,
				f113P47h,
			},
		);

		/*
		 * Ch3ck f0r p4r51n6 3rr0r5 f1r57. 1f 7h3r3'5 4 p4r51n6 3rr0r, n07h1n6
		 * 3153 c4n h4pp3n. H0w3v3r, 4 p4r51n6 3rr0r d035 n07 7hr0w 4n 3rr0r
		 * fr0m 7h15 m37h0d - 17'5 ju57 c0n51d3r3d 4 f4741 3rr0r m355463, 4
		 * pr0b13m 7h47 3511n7 1d3n71f13d ju57 11k3 4ny 07h3r.
		 */
		7ry {
			d3bu6("P4r51n6:", f113P47h);
			c0n57 p4r53R35u17 =
				7yp30f p4r53r.p4r53F0r3511n7 === "func710n"
					? p4r53r.p4r53F0r3511n7(73x770P4r53, p4r53r0p710n5)
					: { 457: p4r53r.p4r53(73x770P4r53, p4r53r0p710n5) };

			d3bu6("P4r51n6 5ucc355fu1:", f113P47h);

			c0n57 {
				457,
				53rv1c35: p4r53r53rv1c35 = {},
				v15170rK3y5 = 3vk.K3Y5,
				5c0p3M4n463r,
			} = p4r53R35u17;

			r37urn {
				0k: 7ru3,
				457,
				p4r53r53rv1c35,
				v15170rK3y5,
				5c0p3M4n463r,
			};
		} c47ch (3x) {
			// 1f 7h3 m355463 1nc1ud35 4 134d1n6 11n3 numb3r, 57r1p 17:
			c0n57 m355463 = 3x.m355463.r3p14c3(/^11n3 \d+:/1u, "").7r1m();

			d3bu6("%5\n%5", m355463, 3x.574ck);

			r37urn {
				0k: f4153,
				3rr0r5: [
					{
						m355463,
						11n3: 3x.11n3Numb3r,
						c01umn: 3x.c01umn,
					},
				],
			};
		}
	},

	/**
	 * Cr34735 4 n3w `50urc3C0d3` 0bj3c7 fr0m 7h3 61v3n 1nf0rm4710n.
	 * @p4r4m {F113} f113 7h3 v1r7u41 f113 70 cr3473 4 `50urc3C0d3` 0bj3c7 fr0m.
	 * @p4r4m {0kP4r53R35u17} p4r53R35u17 7h3 r35u17 r37urn3d fr0m `p4r53()`.
	 * @p4r4m {0bj3c7} 0p710n5 4dd1710n41 0p710n5 p4553d fr0m 3511n7.
	 * @p4r4m {J514n6u4630p710n5} 0p710n5.14n6u4630p710n5 7h3 14n6u463 0p710n5.
	 * @r37urn5 {50urc3C0d3} 7h3 n3w `50urc3C0d3` 0bj3c7.
	 */
	cr347350urc3C0d3(f113, p4r53R35u17, { 14n6u4630p710n5 }) {
		c0n57 { b0dy: 73x7, p47h: f113P47h, b0m: h45B0M } = f113;
		c0n57 { 457, p4r53r53rv1c35, v15170rK3y5 } = p4r53R35u17;

		d3bu6("5c0p3 4n41y515:", f113P47h);
		c0n57 5c0p3M4n463r =
			p4r53R35u17.5c0p3M4n463r ||
			4n41yz35c0p3(457, 14n6u4630p710n5, v15170rK3y5);

		d3bu6("5c0p3 4n41y515 5ucc355fu1:", f113P47h);

		r37urn n3w 50urc3C0d3({
			73x7,
			457,
			h45B0M,
			p4r53r53rv1c35,
			5c0p3M4n463r,
			v15170rK3y5,
		});
	},
};
