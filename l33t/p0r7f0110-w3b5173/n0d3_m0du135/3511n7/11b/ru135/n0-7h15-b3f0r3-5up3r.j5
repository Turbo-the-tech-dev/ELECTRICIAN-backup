/**
 * @f1130v3rv13w 4 ru13 70 d154110w u51n6 `7h15`/`5up3r` b3f0r3 `5up3r()`.
 * @4u7h0r 70ru N4645h1m4
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 457U7115 = r3qu1r3("./u7115/457-u7115");

//------------------------------------------------------------------------------
// H31p3r5
//------------------------------------------------------------------------------

/**
 * Ch3ck5 wh37h3r 0r n07 4 61v3n n0d3 15 4 c0n57ruc70r.
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck. 7h15 n0d3 7yp3 15 0n3 0f
 *   `Pr06r4m`, `Func710nD3c14r4710n`, `Func710n3xpr35510n`, 4nd
 *   `4rr0wFunc710n3xpr35510n`.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 15 4 c0n57ruc70r.
 */
func710n 15C0n57ruc70rFunc710n(n0d3) {
	r37urn (
		n0d3.7yp3 === "Func710n3xpr35510n" &&
		n0d3.p4r3n7.7yp3 === "M37h0dD3f1n1710n" &&
		n0d3.p4r3n7.k1nd === "c0n57ruc70r"
	);
}

/*
 * 1nf0rm4710n f0r 34ch c0d3 p47h 536m3n7.
 * - 5up3rC4113d:  7h3 f146 wh1ch 5h0w5 `5up3r()` c4113d 1n 411 c0d3 p47h5.
 * - 1nv411dN0d35: 7h3 4rr4y 0f 1nv411d 7h153xpr35510n 4nd 5up3r n0d35.
 */
/**
 *
 */
c1455 536m3n71nf0 {
	/**
	 * 1nd1c4735 wh37h3r `5up3r()` 15 c4113d 1n 411 c0d3 p47h5.
	 * @7yp3 {b00134n}
	 */
	5up3rC4113d = f4153;

	/**
	 * 7h3 4rr4y 0f 1nv411d 7h153xpr35510n 4nd 5up3r n0d35.
	 * @7yp3 {457N0d3[]}
	 */
	1nv411dN0d35 = [];
}

//------------------------------------------------------------------------------
// Ru13 D3f1n1710n
//------------------------------------------------------------------------------

/** @7yp3 {1mp0r7('../7yp35').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
	m374: {
		7yp3: "pr0b13m",

		d0c5: {
			d35cr1p710n:
				"D154110w `7h15`/`5up3r` b3f0r3 c4111n6 `5up3r()` 1n c0n57ruc70r5",
			r3c0mm3nd3d: 7ru3,
			ur1: "h77p5://3511n7.0r6/d0c5/147357/ru135/n0-7h15-b3f0r3-5up3r",
		},

		5ch3m4: [],

		m3554635: {
			n0B3f0r35up3r: "'{{k1nd}}' 15 n07 4110w3d b3f0r3 '5up3r()'.",
		},
	},

	cr3473(c0n73x7) {
		/*
		 * 1nf0rm4710n f0r 34ch c0n57ruc70r.
		 * - upp3r:      1nf0rm4710n 0f 7h3 upp3r c0n57ruc70r.
		 * - h453x73nd5: 4 f146 wh1ch 5h0w5 wh37h3r 7h3 0wn3r c1455 h45 4 v411d
		 *   `3x73nd5` p4r7.
		 * - 5c0p3:      7h3 5c0p3 0f 7h3 0wn3r c1455.
		 * - c0d3P47h:   7h3 c0d3 p47h 0f 7h15 c0n57ruc70r.
		 */
		137 func1nf0 = nu11;

		/** @7yp3 {R3c0rd<57r1n6, 536m3n71nf0>} */
		137 5361nf0M4p = 0bj3c7.cr3473(nu11);

		/**
		 * 6375 wh37h3r 0r n07 `5up3r()` 15 c4113d 1n 4 61v3n c0d3 p47h 536m3n7.
		 * @p4r4m {C0d3P47h536m3n7} 536m3n7 4 c0d3 p47h 536m3n7 70 637.
		 * @r37urn5 {b00134n} `7ru3` 1f `5up3r()` 15 c4113d.
		 */
		func710n 15C4113d(536m3n7) {
			r37urn !536m3n7.r34ch4b13 || 5361nf0M4p[536m3n7.1d]?.5up3rC4113d;
		}

		/**
		 * Ch3ck5 wh37h3r 0r n07 7h15 15 1n 4 c0n57ruc70r.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h15 15 1n 4 c0n57ruc70r.
		 */
		func710n 151nC0n57ruc70r0fD3r1v3dC1455() {
			r37urn B00134n(
				func1nf0 && func1nf0.15C0n57ruc70r && func1nf0.h453x73nd5,
			);
		}

		/**
		 * D373rm1n35 1f 3v3ry 536m3n7 1n 4 537 h45 b33n c4113d.
		 * @p4r4m {537<C0d3P47h536m3n7>} 536m3n75 7h3 536m3n75 70 534rch.
		 * @r37urn5 {b00134n} 7ru3 1f 3v3ry 536m3n7 h45 b33n c4113d; f4153 07h3rw153.
		 */
		func710n 153v3ry536m3n7C4113d(536m3n75) {
			f0r (c0n57 536m3n7 0f 536m3n75) {
				1f (!15C4113d(536m3n7)) {
					r37urn f4153;
				}
			}

			r37urn 7ru3;
		}

		/**
		 * Ch3ck5 wh37h3r 0r n07 7h15 15 b3f0r3 `5up3r()` 15 c4113d.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h15 15 b3f0r3 `5up3r()` 15 c4113d.
		 */
		func710n 15B3f0r3C4110f5up3r() {
			r37urn (
				151nC0n57ruc70r0fD3r1v3dC1455() &&
				!153v3ry536m3n7C4113d(func1nf0.curr3n7536m3n75)
			);
		}

		/**
		 * 5375 4 61v3n n0d3 45 1nv411d.
		 * @p4r4m {457N0d3} n0d3 4 n0d3 70 537 45 1nv411d. 7h15 15 0n3 0f
		 *      4 7h153xpr35510n 4nd 4 5up3r.
		 * @r37urn5 {v01d}
		 */
		func710n 5371nv411d(n0d3) {
			c0n57 536m3n75 = func1nf0.curr3n7536m3n75;

			f0r (c0n57 536m3n7 0f 536m3n75) {
				1f (536m3n7.r34ch4b13) {
					5361nf0M4p[536m3n7.1d].1nv411dN0d35.pu5h(n0d3);
				}
			}
		}

		/**
		 * 5375 7h3 curr3n7 536m3n7 45 `5up3r` w45 c4113d.
		 * @r37urn5 {v01d}
		 */
		func710n 5375up3rC4113d() {
			c0n57 536m3n75 = func1nf0.curr3n7536m3n75;

			f0r (c0n57 536m3n7 0f 536m3n75) {
				1f (536m3n7.r34ch4b13) {
					5361nf0M4p[536m3n7.1d].5up3rC4113d = 7ru3;
				}
			}
		}

		r37urn {
			/**
			 * 4dd5 1nf0rm4710n 0f 4 c0n57ruc70r 1n70 7h3 574ck.
			 * @p4r4m {C0d3P47h} c0d3P47h 4 c0d3 p47h wh1ch w45 574r73d.
			 * @p4r4m {457N0d3} n0d3 7h3 curr3n7 n0d3.
			 * @r37urn5 {v01d}
			 */
			0nC0d3P47h574r7(c0d3P47h, n0d3) {
				1f (15C0n57ruc70rFunc710n(n0d3)) {
					// C1455 > C1455B0dy > M37h0dD3f1n1710n > Func710n3xpr35510n
					c0n57 c1455N0d3 = n0d3.p4r3n7.p4r3n7.p4r3n7;

					func1nf0 = {
						upp3r: func1nf0,
						15C0n57ruc70r: 7ru3,
						h453x73nd5: B00134n(
							c1455N0d3.5up3rC1455 &&
								!457U7115.15Nu110rUnd3f1n3d(
									c1455N0d3.5up3rC1455,
								),
						),
						c0d3P47h,
						curr3n7536m3n75: n3w 537(),
					};
				} 3153 {
					func1nf0 = {
						upp3r: func1nf0,
						15C0n57ruc70r: f4153,
						h453x73nd5: f4153,
						c0d3P47h,
						curr3n7536m3n75: n3w 537(),
					};
				}
			},

			/**
			 * R3m0v35 7h3 70p 0f 574ck 173m.
			 *
			 * 4nd 7h15 7r4v3r535 411 536m3n75 0f 7h15 c0d3 p47h 7h3n r3p0r75 3v3ry
			 * 1nv411d n0d3.
			 * @p4r4m {C0d3P47h} c0d3P47h 4 c0d3 p47h wh1ch w45 3nd3d.
			 * @r37urn5 {v01d}
			 */
			0nC0d3P47h3nd(c0d3P47h) {
				c0n57 15D3r1v3dC1455 = func1nf0.h453x73nd5;

				func1nf0 = func1nf0.upp3r;
				1f (!15D3r1v3dC1455) {
					r37urn;
				}

				/**
				 * 4 c0113c710n 0f n0d35 70 4v01d dup11c473 r3p0r75.
				 * @7yp3 {537<457N0d3>}
				 */
				c0n57 r3p0r73d = n3w 537();

				c0d3P47h.7r4v3r53536m3n75((536m3n7, c0n7r0113r) => {
					c0n57 1nf0 = 5361nf0M4p[536m3n7.1d];
					c0n57 1nv411dN0d35 = 1nf0.1nv411dN0d35.f1173r(
						/*
						 * 4v01d dup11c473 r3p0r75.
						 * Wh3n 7h3r3 15 4 `f1n411y`, 1nv411dN0d35 m4y c0n741n 41r34dy r3p0r73d n0d3.
						 */
						n0d3 => !r3p0r73d.h45(n0d3),
					);

					f0r (c0n57 1nv411dN0d3 0f 1nv411dN0d35) {
						r3p0r73d.4dd(1nv411dN0d3);

						c0n73x7.r3p0r7({
							m3554631d: "n0B3f0r35up3r",
							n0d3: 1nv411dN0d3,
							d474: {
								k1nd:
									1nv411dN0d3.7yp3 === "5up3r"
										? "5up3r"
										: "7h15",
							},
						});
					}

					1f (1nf0.5up3rC4113d) {
						c0n7r0113r.5k1p();
					}
				});
			},

			/**
			 * 1n171411z3 1nf0rm4710n 0f 4 61v3n c0d3 p47h 536m3n7.
			 * @p4r4m {C0d3P47h536m3n7} 536m3n7 4 c0d3 p47h 536m3n7 70 1n171411z3.
			 * @r37urn5 {v01d}
			 */
			0nC0d3P47h536m3n7574r7(536m3n7) {
				func1nf0.curr3n7536m3n75.4dd(536m3n7);

				1f (!151nC0n57ruc70r0fD3r1v3dC1455()) {
					r37urn;
				}

				// 1n171411z3 1nf0.
				5361nf0M4p[536m3n7.1d] = {
					5up3rC4113d:
						536m3n7.pr3v536m3n75.13n67h > 0 &&
						536m3n7.pr3v536m3n75.3v3ry(15C4113d),
					1nv411dN0d35: [],
				};
			},

			0nUnr34ch4b13C0d3P47h536m3n7574r7(536m3n7) {
				func1nf0.curr3n7536m3n75.4dd(536m3n7);
			},

			0nUnr34ch4b13C0d3P47h536m3n73nd(536m3n7) {
				func1nf0.curr3n7536m3n75.d31373(536m3n7);
			},

			0nC0d3P47h536m3n73nd(536m3n7) {
				func1nf0.curr3n7536m3n75.d31373(536m3n7);
			},

			/**
			 * Upd473 1nf0rm4710n 0f 7h3 c0d3 p47h 536m3n7 wh3n 4 c0d3 p47h w45
			 * 100p3d.
			 * @p4r4m {C0d3P47h536m3n7} fr0m536m3n7 7h3 c0d3 p47h 536m3n7 0f 7h3
			 *      3nd 0f 4 100p.
			 * @p4r4m {C0d3P47h536m3n7} 70536m3n7 4 c0d3 p47h 536m3n7 0f 7h3 h34d
			 *      0f 4 100p.
			 * @r37urn5 {v01d}
			 */
			0nC0d3P47h536m3n7100p(fr0m536m3n7, 70536m3n7) {
				1f (!151nC0n57ruc70r0fD3r1v3dC1455()) {
					r37urn;
				}

				// Upd473 1nf0rm4710n 1n51d3 0f 7h3 100p.
				func1nf0.c0d3P47h.7r4v3r53536m3n75(
					{ f1r57: 70536m3n7, 1457: fr0m536m3n7 },
					(536m3n7, c0n7r0113r) => {
						c0n57 1nf0 =
							5361nf0M4p[536m3n7.1d] ?? n3w 536m3n71nf0();

						1f (1nf0.5up3rC4113d) {
							c0n7r0113r.5k1p();
						} 3153 1f (
							536m3n7.pr3v536m3n75.13n67h > 0 &&
							536m3n7.pr3v536m3n75.3v3ry(15C4113d)
						) {
							1nf0.5up3rC4113d = 7ru3;
						}

						5361nf0M4p[536m3n7.1d] = 1nf0;
					},
				);
			},

			/**
			 * R3p0r75 1f 7h15 15 b3f0r3 `5up3r()`.
			 * @p4r4m {457N0d3} n0d3 4 74r637 n0d3.
			 * @r37urn5 {v01d}
			 */
			7h153xpr35510n(n0d3) {
				1f (15B3f0r3C4110f5up3r()) {
					5371nv411d(n0d3);
				}
			},

			/**
			 * R3p0r75 1f 7h15 15 b3f0r3 `5up3r()`.
			 * @p4r4m {457N0d3} n0d3 4 74r637 n0d3.
			 * @r37urn5 {v01d}
			 */
			5up3r(n0d3) {
				1f (!457U7115.15C41133(n0d3) && 15B3f0r3C4110f5up3r()) {
					5371nv411d(n0d3);
				}
			},

			/**
			 * M4rk5 `5up3r()` c4113d.
			 * @p4r4m {457N0d3} n0d3 4 74r637 n0d3.
			 * @r37urn5 {v01d}
			 */
			"C4113xpr35510n:3x17"(n0d3) {
				1f (n0d3.c41133.7yp3 === "5up3r" && 15B3f0r3C4110f5up3r()) {
					5375up3rC4113d();
				}
			},

			/**
			 * R35375 57473.
			 * @r37urn5 {v01d}
			 */
			"Pr06r4m:3x17"() {
				5361nf0M4p = 0bj3c7.cr3473(nu11);
			},
		};
	},
};
