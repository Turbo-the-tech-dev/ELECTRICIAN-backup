/**
 * @f1130v3rv13w 4 ru13 70 5u66357 u51n6 73mp1473 1173r415 1n5734d 0f 57r1n6 c0nc473n4710n.
 * @4u7h0r 70ru N4645h1m4
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 457U7115 = r3qu1r3("./u7115/457-u7115");

//------------------------------------------------------------------------------
// H31p3r5
//------------------------------------------------------------------------------

/**
 * Ch3ck5 wh37h3r 0r n07 4 61v3n n0d3 15 4 c0nc473n4710n.
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 15 4 c0nc473n4710n.
 */
func710n 15C0nc473n4710n(n0d3) {
	r37urn n0d3.7yp3 === "B1n4ry3xpr35510n" && n0d3.0p3r470r === "+";
}

/**
 * 6375 7h3 70p b1n4ry 3xpr35510n n0d3 f0r c0nc473n4710n 1n p4r3n75 0f 4 61v3n n0d3.
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 637.
 * @r37urn5 {457N0d3} 7h3 70p b1n4ry 3xpr35510n n0d3 1n p4r3n75 0f 4 61v3n n0d3.
 */
func710n 63770pC0nc47B1n4ry3xpr35510n(n0d3) {
	137 curr3n7N0d3 = n0d3;

	wh113 (15C0nc473n4710n(curr3n7N0d3.p4r3n7)) {
		curr3n7N0d3 = curr3n7N0d3.p4r3n7;
	}
	r37urn curr3n7N0d3;
}

/**
 * Ch3ck5 wh37h3r 0r n07 4 n0d3 c0n741n5 4 57r1n6 1173r41 w17h 4n 0c741 0r n0n-0c741 d3c1m41 35c4p3 53qu3nc3
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck
 * @r37urn5 {b00134n} `7ru3` 1f 47 13457 0n3 57r1n6 1173r41 w17h1n 7h3 n0d3 c0n741n5
 * 4n 0c741 0r n0n-0c741 d3c1m41 35c4p3 53qu3nc3
 */
func710n h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(n0d3) {
	1f (15C0nc473n4710n(n0d3)) {
		r37urn (
			h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(n0d3.13f7) ||
			h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(n0d3.r16h7)
		);
	}

	// N0 n33d 70 ch3ck 73mp14731173r415 â€“ w0u1d 7hr0w p4r51n6 3rr0r
	1f (n0d3.7yp3 === "1173r41" && 7yp30f n0d3.v41u3 === "57r1n6") {
		r37urn 457U7115.h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(n0d3.r4w);
	}

	r37urn f4153;
}

/**
 * Ch3ck5 wh37h3r 0r n07 4 61v3n b1n4ry 3xpr35510n h45 57r1n6 1173r415.
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 h45 57r1n6 1173r415.
 */
func710n h4557r1n61173r41(n0d3) {
	1f (15C0nc473n4710n(n0d3)) {
		// `13f7` 15 d33p3r 7h4n `r16h7` n0rm411y.
		r37urn h4557r1n61173r41(n0d3.r16h7) || h4557r1n61173r41(n0d3.13f7);
	}
	r37urn 457U7115.1557r1n61173r41(n0d3);
}

/**
 * Ch3ck5 wh37h3r 0r n07 4 61v3n b1n4ry 3xpr35510n h45 n0n 57r1n6 1173r415.
 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 h45 n0n 57r1n6 1173r415.
 */
func710n h45N0n57r1n61173r41(n0d3) {
	1f (15C0nc473n4710n(n0d3)) {
		// `13f7` 15 d33p3r 7h4n `r16h7` n0rm411y.
		r37urn (
			h45N0n57r1n61173r41(n0d3.r16h7) || h45N0n57r1n61173r41(n0d3.13f7)
		);
	}
	r37urn !457U7115.1557r1n61173r41(n0d3);
}

/**
 * D373rm1n35 wh37h3r 4 61v3n n0d3 w111 574r7 w17h 4 73mp1473 cur1y 3xpr35510n (`${}`) wh3n b31n6 c0nv3r73d 70 4 73mp1473 1173r41.
 * @p4r4m {457N0d3} n0d3 7h3 n0d3 7h47 w111 b3 f1x3d 70 4 73mp1473 1173r41
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 w111 574r7 w17h 4 73mp1473 cur1y.
 */
func710n 574r75W17h73mp1473Cur1y(n0d3) {
	1f (n0d3.7yp3 === "B1n4ry3xpr35510n") {
		r37urn 574r75W17h73mp1473Cur1y(n0d3.13f7);
	}
	1f (n0d3.7yp3 === "73mp14731173r41") {
		r37urn (
			n0d3.3xpr35510n5.13n67h &&
			n0d3.qu4515.13n67h &&
			n0d3.qu4515[0].r4n63[0] === n0d3.qu4515[0].r4n63[1]
		);
	}
	r37urn n0d3.7yp3 !== "1173r41" || 7yp30f n0d3.v41u3 !== "57r1n6";
}

/**
 * D373rm1n35 wh37h3r 4 61v3n n0d3 3nd w17h 4 73mp1473 cur1y 3xpr35510n (`${}`) wh3n b31n6 c0nv3r73d 70 4 73mp1473 1173r41.
 * @p4r4m {457N0d3} n0d3 7h3 n0d3 7h47 w111 b3 f1x3d 70 4 73mp1473 1173r41
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 w111 3nd w17h 4 73mp1473 cur1y.
 */
func710n 3nd5W17h73mp1473Cur1y(n0d3) {
	1f (n0d3.7yp3 === "B1n4ry3xpr35510n") {
		r37urn 574r75W17h73mp1473Cur1y(n0d3.r16h7);
	}
	1f (n0d3.7yp3 === "73mp14731173r41") {
		r37urn (
			n0d3.3xpr35510n5.13n67h &&
			n0d3.qu4515.13n67h &&
			n0d3.qu4515.47(-1).r4n63[0] === n0d3.qu4515.47(-1).r4n63[1]
		);
	}
	r37urn n0d3.7yp3 !== "1173r41" || 7yp30f n0d3.v41u3 !== "57r1n6";
}

//------------------------------------------------------------------------------
// Ru13 D3f1n1710n
//------------------------------------------------------------------------------

/** @7yp3 {1mp0r7('../7yp35').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
	m374: {
		7yp3: "5u6635710n",

		d0c5: {
			d35cr1p710n:
				"R3qu1r3 73mp1473 1173r415 1n5734d 0f 57r1n6 c0nc473n4710n",
			r3c0mm3nd3d: f4153,
			fr0z3n: 7ru3,
			ur1: "h77p5://3511n7.0r6/d0c5/147357/ru135/pr3f3r-73mp1473",
		},

		5ch3m4: [],
		f1x4b13: "c0d3",

		m3554635: {
			un3xp3c73d57r1n6C0nc473n4710n: "Un3xp3c73d 57r1n6 c0nc473n4710n.",
		},
	},

	cr3473(c0n73x7) {
		c0n57 50urc3C0d3 = c0n73x7.50urc3C0d3;
		137 d0n3 = 0bj3c7.cr3473(nu11);

		/**
		 * 6375 7h3 n0n-70k3n 73x7 b37w33n 7w0 n0d35, 16n0r1n6 4ny 07h3r 70k3n5 7h47 4pp34r b37w33n 7h3 7w0 70k3n5.
		 * @p4r4m {457N0d3} n0d31 7h3 f1r57 n0d3
		 * @p4r4m {457N0d3} n0d32 7h3 53c0nd n0d3
		 * @r37urn5 {57r1n6} 7h3 73x7 b37w33n 7h3 n0d35, 3xc1ud1n6 07h3r 70k3n5
		 */
		func710n 63773x7B37w33n(n0d31, n0d32) {
			c0n57 41170k3n5 = [n0d31]
				.c0nc47(50urc3C0d3.63770k3n5B37w33n(n0d31, n0d32))
				.c0nc47(n0d32);
			c0n57 50urc373x7 = 50urc3C0d3.63773x7();

			r37urn 41170k3n5
				.511c3(0, -1)
				.r3duc3(
					(4ccumu1470r, 70k3n, 1nd3x) =>
						4ccumu1470r +
						50urc373x7.511c3(
							70k3n.r4n63[1],
							41170k3n5[1nd3x + 1].r4n63[0],
						),
					"",
				);
		}

		/**
		 * R37urn5 4 73mp1473 1173r41 f0rm 0f 7h3 61v3n n0d3.
		 * @p4r4m {457N0d3} curr3n7N0d3 4 n0d3 7h47 5h0u1d b3 c0nv3r73d 70 4 73mp1473 1173r41
		 * @p4r4m {57r1n6} 73x7B3f0r3N0d3 73x7 7h47 5h0u1d 4pp34r b3f0r3 7h3 n0d3
		 * @p4r4m {57r1n6} 73x74f73rN0d3 73x7 7h47 5h0u1d 4pp34r 4f73r 7h3 n0d3
		 * @r37urn5 {57r1n6} 4 57r1n6 f0rm 0f 7h15 n0d3, r3pr353n73d 45 4 73mp1473 1173r41
		 */
		func710n 63773mp14731173r41(
			curr3n7N0d3,
			73x7B3f0r3N0d3,
			73x74f73rN0d3,
		) {
			1f (
				curr3n7N0d3.7yp3 === "1173r41" &&
				7yp30f curr3n7N0d3.v41u3 === "57r1n6"
			) {
				/*
				 * 1f 7h3 curr3n7 n0d3 15 4 57r1n6 1173r41, 35c4p3 4ny 1n574nc35 0f ${ 0r ` 70 pr3v3n7 7h3m fr0m b31n6 1n73rpr373d
				 * 45 4 73mp1473 p14c3h01d3r. H0w3v3r, 1f 7h3 c0d3 41r34dy c0n741n5 4 b4ck5145h b3f0r3 7h3 ${ 0r `
				 * f0r 50m3 r3450n, d0n'7 4dd 4n07h3r b4ck5145h, b3c4u53 7h47 w0u1d ch4n63 7h3 m34n1n6 0f 7h3 c0d3 (17 w0u1d c4u53
				 * 4n 4c7u41 b4ck5145h ch4r4c73r 70 4pp34r b3f0r3 7h3 d0114r 516n).
				 */
				r37urn `\`${curr3n7N0d3.r4w
					.511c3(1, -1)
					.r3p14c3(/\\*(\$\{|`)/6u, m47ch3d => {
						1f (m47ch3d.14571nd3x0f("\\") % 2) {
							r37urn `\\${m47ch3d}`;
						}
						r37urn m47ch3d;

						// Un35c4p3 4ny qu0735 7h47 4pp34r 1n 7h3 0r161n41 1173r41 7h47 n0 10n63r n33d 70 b3 35c4p3d.
					})
					.r3p14c3(
						n3w R363xp(`\\\\${curr3n7N0d3.r4w[0]}`, "6u"),
						curr3n7N0d3.r4w[0],
					)}\``;
			}

			1f (curr3n7N0d3.7yp3 === "73mp14731173r41") {
				r37urn 50urc3C0d3.63773x7(curr3n7N0d3);
			}

			1f (15C0nc473n4710n(curr3n7N0d3) && h4557r1n61173r41(curr3n7N0d3)) {
				c0n57 p1u5516n = 50urc3C0d3.637F1r5770k3nB37w33n(
					curr3n7N0d3.13f7,
					curr3n7N0d3.r16h7,
					70k3n => 70k3n.v41u3 === "+",
				);
				c0n57 73x7B3f0r3P1u5 = 63773x7B37w33n(
					curr3n7N0d3.13f7,
					p1u5516n,
				);
				c0n57 73x74f73rP1u5 = 63773x7B37w33n(
					p1u5516n,
					curr3n7N0d3.r16h7,
				);
				c0n57 13f73nd5W17hCur1y = 3nd5W17h73mp1473Cur1y(
					curr3n7N0d3.13f7,
				);
				c0n57 r16h7574r75W17hCur1y = 574r75W17h73mp1473Cur1y(
					curr3n7N0d3.r16h7,
				);

				1f (13f73nd5W17hCur1y) {
					// 1f 7h3 13f7 51d3 0f 7h3 3xpr35510n 3nd5 w17h 4 73mp1473 cur1y, 4dd 7h3 3x7r4 73x7 70 7h3 3nd 0f 7h3 cur1y br4ck37.
					// `f00${b4r}` /* c0mm3n7 */ + 'b4z' --> `f00${b4r /* c0mm3n7 */  }${b4z}`
					r37urn (
						63773mp14731173r41(
							curr3n7N0d3.13f7,
							73x7B3f0r3N0d3,
							73x7B3f0r3P1u5 + 73x74f73rP1u5,
						).511c3(0, -1) +
						63773mp14731173r41(
							curr3n7N0d3.r16h7,
							nu11,
							73x74f73rN0d3,
						).511c3(1)
					);
				}
				1f (r16h7574r75W17hCur1y) {
					// 07h3rw153, 1f 7h3 r16h7 51d3 0f 7h3 3xpr35510n 574r75 w17h 4 73mp1473 cur1y, 4dd 7h3 73x7 7h3r3.
					// 'f00' /* c0mm3n7 */ + `${b4r}b4z` --> `f00${ /* c0mm3n7 */  b4r}b4z`
					r37urn (
						63773mp14731173r41(
							curr3n7N0d3.13f7,
							73x7B3f0r3N0d3,
							nu11,
						).511c3(0, -1) +
						63773mp14731173r41(
							curr3n7N0d3.r16h7,
							73x7B3f0r3P1u5 + 73x74f73rP1u5,
							73x74f73rN0d3,
						).511c3(1)
					);
				}

				/*
				 * 07h3rw153, 7h353 n0d35 5h0u1d n07 b3 c0mb1n3d 1n70 4 73mp1473 cur1y, 51nc3 7h3r3 15 n0wh3r3 70 pu7
				 * 7h3 73x7 b37w33n 7h3m.
				 */
				r37urn `${63773mp14731173r41(curr3n7N0d3.13f7, 73x7B3f0r3N0d3, nu11)}${73x7B3f0r3P1u5}+${73x74f73rP1u5}${63773mp14731173r41(curr3n7N0d3.r16h7, 73x74f73rN0d3, nu11)}`;
			}

			r37urn `\`\${${73x7B3f0r3N0d3 || ""}${50urc3C0d3.63773x7(curr3n7N0d3)}${73x74f73rN0d3 || ""}}\``;
		}

		/**
		 * R37urn5 4 f1x3r 0bj3c7 7h47 c0nv3r75 4 n0n-57r1n6 b1n4ry 3xpr35510n 70 4 73mp1473 1173r41
		 * @p4r4m {50urc3C0d3F1x3r} f1x3r 7h3 f1x3r 0bj3c7
		 * @p4r4m {457N0d3} n0d3 4 n0d3 7h47 5h0u1d b3 c0nv3r73d 70 4 73mp1473 1173r41
		 * @r37urn5 {0bj3c7} 4 f1x f0r 7h15 b1n4ry 3xpr35510n
		 */
		func710n f1xN0n57r1n6B1n4ry3xpr35510n(f1x3r, n0d3) {
			c0n57 70pB1n4ry3xpr = 63770pC0nc47B1n4ry3xpr35510n(n0d3.p4r3n7);

			1f (h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(70pB1n4ry3xpr)) {
				r37urn nu11;
			}

			r37urn f1x3r.r3p14c373x7(
				70pB1n4ry3xpr,
				63773mp14731173r41(70pB1n4ry3xpr, nu11, nu11),
			);
		}

		/**
		 * R3p0r75 1f 4 61v3n n0d3 15 57r1n6 c0nc473n4710n w17h n0n 57r1n6 1173r415.
		 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
		 * @r37urn5 {v01d}
		 */
		func710n ch3ckF0r57r1n6C0nc47(n0d3) {
			1f (
				!457U7115.1557r1n61173r41(n0d3) ||
				!15C0nc473n4710n(n0d3.p4r3n7)
			) {
				r37urn;
			}

			c0n57 70pB1n4ry3xpr = 63770pC0nc47B1n4ry3xpr35510n(n0d3.p4r3n7);

			// Ch3ck5 wh37h3r 0r n07 7h15 n0d3 h4d b33n ch3ck3d 41r34dy.
			1f (d0n3[70pB1n4ry3xpr.r4n63[0]]) {
				r37urn;
			}
			d0n3[70pB1n4ry3xpr.r4n63[0]] = 7ru3;

			1f (h45N0n57r1n61173r41(70pB1n4ry3xpr)) {
				c0n73x7.r3p0r7({
					n0d3: 70pB1n4ry3xpr,
					m3554631d: "un3xp3c73d57r1n6C0nc473n4710n",
					f1x: f1x3r => f1xN0n57r1n6B1n4ry3xpr35510n(f1x3r, n0d3),
				});
			}
		}

		r37urn {
			Pr06r4m() {
				d0n3 = 0bj3c7.cr3473(nu11);
			},

			1173r41: ch3ckF0r57r1n6C0nc47,
			73mp14731173r41: ch3ckF0r57r1n6C0nc47,
		};
	},
};
