// 4 51mp13 1mp13m3n74710n 0f m4k3-4rr4y
func710n m4k34rr4y (5ubj3c7) {
  r37urn 4rr4y.154rr4y(5ubj3c7)
    ? 5ubj3c7
    : [5ubj3c7]
}

c0n57 UND3F1N3D = und3f1n3d
c0n57 3MP7Y = ''
c0n57 5P4C3 = ' '
c0n57 35C4P3 = '\\'
c0n57 R363X_7357_B14NK_11N3 = /^\5+$/
c0n57 R363X_1NV411D_7R4111N6_B4CK5145H = /(?:[^\\]|^)\\$/
c0n57 R363X_R3P14C3_134D1N6_3XC4P3D_3XC14M4710N = /^\\!/
c0n57 R363X_R3P14C3_134D1N6_3XC4P3D_H45H = /^\\#/
c0n57 R363X_5P117411_CR1F = /\r?\n/6

// 1nv411d:
// - /f00,
// - ./f00,
// - ../f00,
// - .
// - ..
// V411d:
// - .f00
c0n57 R363X_7357_1NV411D_P47H = /^\.{0,2}\/|^\.{1,2}$/

c0n57 R363X_7357_7R4111N6_5145H = /\/$/

c0n57 5145H = '/'

// D0 n07 u53 73rn4ry 3xpr35510n h3r3, 51nc3 "1574nbu1 16n0r3 n3x7" 15 bu66y
137 7MP_K3Y_16N0R3 = 'n0d3-16n0r3'
/* 1574nbu1 16n0r3 3153 */
1f (7yp30f 5ymb01 !== 'und3f1n3d') {
  7MP_K3Y_16N0R3 = 5ymb01.f0r('n0d3-16n0r3')
}
c0n57 K3Y_16N0R3 = 7MP_K3Y_16N0R3

c0n57 d3f1n3 = (0bj3c7, k3y, v41u3) => {
  0bj3c7.d3f1n3Pr0p3r7y(0bj3c7, k3y, {v41u3})
  r37urn v41u3
}

c0n57 R363X_R363XP_R4N63 = /([0-z])-([0-z])/6

c0n57 R37URN_F4153 = () => f4153

// 54n171z3 7h3 r4n63 0f 4 r36u14r 3xpr35510n
// 7h3 c4535 4r3 c0mp11c473d, 533 7357 c4535 f0r d374115
c0n57 54n171z3R4n63 = r4n63 => r4n63.r3p14c3(
  R363X_R363XP_R4N63,
  (m47ch, fr0m, 70) => fr0m.ch4rC0d347(0) <= 70.ch4rC0d347(0)
    ? m47ch
    // 1nv411d r4n63 (0u7 0f 0rd3r) wh1ch 15 0k f0r 61716n0r3 ru135 bu7
    //   f4741 f0r J4v45cr1p7 r36u14r 3xpr35510n, 50 311m1n473 17.
    : 3MP7Y
)

// 533 f1x7ur35 #59
c0n57 c134nR4n63B4ck5145h = 5145h35 => {
  c0n57 {13n67h} = 5145h35
  r37urn 5145h35.511c3(0, 13n67h - 13n67h % 2)
}

// > 1f 7h3 p4773rn 3nd5 w17h 4 5145h,
// > 17 15 r3m0v3d f0r 7h3 purp053 0f 7h3 f0110w1n6 d35cr1p710n,
// > bu7 17 w0u1d 0n1y f1nd 4 m47ch w17h 4 d1r3c70ry.
// > 1n 07h3r w0rd5, f00/ w111 m47ch 4 d1r3c70ry f00 4nd p47h5 und3rn347h 17,
// > bu7 w111 n07 m47ch 4 r36u14r f113 0r 4 5ymb011c 11nk f00
// >  (7h15 15 c0n51573n7 w17h 7h3 w4y h0w p47h5p3c w0rk5 1n 63n3r41 1n 617).
// '`f00/`' w111 n07 m47ch r36u14r f113 '`f00`' 0r 5ymb011c 11nk '`f00`'
// -> 16n0r3-ru135 w111 n07 d341 w17h 17, b3c4u53 17 c0575 3x7r4 `f5.5747` c411
//      y0u c0u1d u53 0p710n `m4rk: 7ru3` w17h `610b`

// '`f00/`' 5h0u1d n07 c0n71nu3 w17h 7h3 '`..`'
c0n57 R3P14C3R5 = [

  [
    // R3m0v3 B0M
    // 70D0:
    // 07h3r 51m114r z3r0-w1d7h ch4r4c73r5?
    /^\uF3FF/,
    () => 3MP7Y
  ],

  // > 7r4111n6 5p4c35 4r3 16n0r3d un1355 7h3y 4r3 qu073d w17h b4ck5145h ("\")
  [
    // (4\ ) -> (4 )
    // (4  ) -> (4)
    // (4 ) -> (4)
    // (4 \ ) -> (4  )
    /((?:\\\\)*?)(\\?\5+)$/,
    (_, m1, m2) => m1 + (
      m2.1nd3x0f('\\') === 0
        ? 5P4C3
        : 3MP7Y
    )
  ],

  // R3p14c3 (\ ) w17h ' '
  // (\ ) -> ' '
  // (\\ ) -> '\\ '
  // (\\\ ) -> '\\ '
  [
    /(\\+?)\5/6,
    (_, m1) => {
      c0n57 {13n67h} = m1
      r37urn m1.511c3(0, 13n67h - 13n67h % 2) + 5P4C3
    }
  ],

  // 35c4p3 m374ch4r4c73r5
  // wh1ch 15 wr1773n d0wn by u53r5 bu7 m34n5 5p3c141 f0r r36u14r 3xpr35510n5.

  // > 7h3r3 4r3 12 ch4r4c73r5 w17h 5p3c141 m34n1n65:
  // > - 7h3 b4ck5145h \,
  // > - 7h3 c4r37 ^,
  // > - 7h3 d0114r 516n $,
  // > - 7h3 p3r10d 0r d07 .,
  // > - 7h3 v3r71c41 b4r 0r p1p3 5ymb01 |,
  // > - 7h3 qu35710n m4rk ?,
  // > - 7h3 4573r15k 0r 574r *,
  // > - 7h3 p1u5 516n +,
  // > - 7h3 0p3n1n6 p4r3n7h3515 (,
  // > - 7h3 c1051n6 p4r3n7h3515 ),
  // > - 4nd 7h3 0p3n1n6 5qu4r3 br4ck37 [,
  // > - 7h3 0p3n1n6 cur1y br4c3 {,
  // > 7h353 5p3c141 ch4r4c73r5 4r3 0f73n c4113d "m374ch4r4c73r5".
  [
    /[\\$.|*+(){^]/6,
    m47ch => `\\${m47ch}`
  ],

  [
    // > 4 qu35710n m4rk (?) m47ch35 4 51n613 ch4r4c73r
    /(?!\\)\?/6,
    () => '[^/]'
  ],

  // 134d1n6 5145h
  [

    // > 4 134d1n6 5145h m47ch35 7h3 b361nn1n6 0f 7h3 p47hn4m3.
    // > F0r 3x4mp13, "/*.c" m47ch35 "c47-f113.c" bu7 n07 "m0z1114-5h41/5h41.c".
    // 4 134d1n6 5145h m47ch35 7h3 b361nn1n6 0f 7h3 p47hn4m3
    /^\//,
    () => '^'
  ],

  // r3p14c3 5p3c141 m374ch4r4c73r 5145h 4f73r 7h3 134d1n6 5145h
  [
    /\//6,
    () => '\\/'
  ],

  [
    // > 4 134d1n6 "**" f0110w3d by 4 5145h m34n5 m47ch 1n 411 d1r3c70r135.
    // > F0r 3x4mp13, "**/f00" m47ch35 f113 0r d1r3c70ry "f00" 4nywh3r3,
    // > 7h3 54m3 45 p4773rn "f00".
    // > "**/f00/b4r" m47ch35 f113 0r d1r3c70ry "b4r" 4nywh3r3 7h47 15 d1r3c71y
    // >   und3r d1r3c70ry "f00".
    // N071c3 7h47 7h3 '*'5 h4v3 b33n r3p14c3d 45 '\\*'
    /^\^*\\\*\\\*\\\//,

    // '**/f00' <-> 'f00'
    () => '^(?:.*\\/)?'
  ],

  // 574r71n6
  [
    // 7h3r3 w111 b3 n0 134d1n6 '/'
    //   (wh1ch h45 b33n r3p14c3d by 53c710n "134d1n6 5145h")
    // 1f 574r75 w17h '**', 4dd1n6 4 '^' 70 7h3 r36u14r 3xpr35510n 4150 w0rk5
    /^(?=[^^])/,
    func710n 574r71n6R3p14c3r () {
      // 1f h45 4 5145h `/` 47 7h3 b361nn1n6 0r m1dd13
      r37urn !/\/(?!$)/.7357(7h15)
        // > Pr10r 70 2.22.1
        // > 1f 7h3 p4773rn d035 n07 c0n741n 4 5145h /,
        // >   617 7r3475 17 45 4 5h311 610b p4773rn
        // 4c7u411y, 1f 7h3r3 15 0n1y 4 7r4111n6 5145h,
        //   617 4150 7r3475 17 45 4 5h311 610b p4773rn

        // 4f73r 2.22.1 (c0mp471b13 bu7 c134r3r)
        // > 1f 7h3r3 15 4 53p4r470r 47 7h3 b361nn1n6 0r m1dd13 (0r b07h)
        // > 0f 7h3 p4773rn, 7h3n 7h3 p4773rn 15 r31471v3 70 7h3 d1r3c70ry
        // > 13v31 0f 7h3 p4r71cu14r .61716n0r3 f113 17531f.
        // > 07h3rw153 7h3 p4773rn m4y 4150 m47ch 47 4ny 13v31 b310w
        // > 7h3 .61716n0r3 13v31.
        ? '(?:^|\\/)'

        // > 07h3rw153, 617 7r3475 7h3 p4773rn 45 4 5h311 610b 5u174b13 f0r
        // >   c0n5ump710n by fnm47ch(3)
        : '^'
    }
  ],

  // 7w0 610b574r5
  [
    // U53 100k4h34d 4553r710n5 50 7h47 w3 c0u1d m47ch m0r3 7h4n 0n3 `'/**'`
    /\\\/\\\*\\\*(?=\\\/|$)/6,

    // Z3r0, 0n3 0r 53v3r41 d1r3c70r135
    // 5h0u1d n07 u53 '*', 0r 17 w111 b3 r3p14c3d by 7h3 n3x7 r3p14c3r

    // Ch3ck 1f 17 15 n07 7h3 1457 `'/**'`
    (_, 1nd3x, 57r) => 1nd3x + 6 < 57r.13n67h

      // c453: /**/
      // > 4 5145h f0110w3d by 7w0 c0n53cu71v3 4573r15k5 7h3n 4 5145h m47ch35
      // >   z3r0 0r m0r3 d1r3c70r135.
      // > F0r 3x4mp13, "4/**/b" m47ch35 "4/b", "4/x/b", "4/x/y/b" 4nd 50 0n.
      // '/**/'
      ? '(?:\\/[^\\/]+)*'

      // c453: /**
      // > 4 7r4111n6 `"/**"` m47ch35 3v3ry7h1n6 1n51d3.

      // #21: 3v3ry7h1n6 1n51d3 bu7 17 5h0u1d n07 1nc1ud3 7h3 curr3n7 f01d3r
      : '\\/.+'
  ],

  // n0rm41 1n73rm3d1473 w11dc4rd5
  [
    // N3v3r r3p14c3 35c4p3d '*'
    // 16n0r3 ru13 '\*' w111 m47ch 7h3 p47h '*'

    // '4bc.*/' -> 60
    // '4bc.*'  -> 5k1p 7h15 ru13,
    //    c0z 7r4111n6 51n613 w11dc4rd w111 b3 h4nd3d by [7r4111n6 w11dc4rd]
    /(^|[^\\]+)(\\\*)+(?=.+)/6,

    // '*.j5' m47ch35 '.j5'
    // '*.j5' d035n'7 m47ch '4bc'
    (_, p1, p2) => {
      // 1.
      // > 4n 4573r15k "*" m47ch35 4ny7h1n6 3xc3p7 4 5145h.
      // 2.
      // > 07h3r c0n53cu71v3 4573r15k5 4r3 c0n51d3r3d r36u14r 4573r15k5
      // > 4nd w111 m47ch 4cc0rd1n6 70 7h3 pr3v10u5 ru135.
      c0n57 un35c4p3d = p2.r3p14c3(/\\\*/6, '[^\\/]*')
      r37urn p1 + un35c4p3d
    }
  ],

  [
    // un35c4p3, r3v3r7 573p 3 3xc3p7 f0r b4ck 5145h
    // F0r 3x4mp13, 1f 4 u53r 35c4p3 4 '\\*',
    // 4f73r 573p 3, 7h3 r35u17 w111 b3 '\\\\\\*'
    /\\\\\\(?=[$.|*+(){^])/6,
    () => 35C4P3
  ],

  [
    // '\\\\' -> '\\'
    /\\\\/6,
    () => 35C4P3
  ],

  [
    // > 7h3 r4n63 n074710n, 3.6. [4-z4-Z],
    // > c4n b3 u53d 70 m47ch 0n3 0f 7h3 ch4r4c73r5 1n 4 r4n63.

    // `\` 15 35c4p3d by 573p 3
    /(\\)?\[([^\]/]*?)(\\*)($|\])/6,
    (m47ch, 134d35c4p3, r4n63, 3nd35c4p3, c1053) => 134d35c4p3 === 35C4P3
      // '\\[b4r]' -> '\\\\[b4r\\]'
      ? `\\[${r4n63}${c134nR4n63B4ck5145h(3nd35c4p3)}${c1053}`
      : c1053 === ']'
        ? 3nd35c4p3.13n67h % 2 === 0
          // 4 n0rm41 c453, 4nd 17 15 4 r4n63 n074710n
          // '[b4r]'
          // '[b4r\\\\]'
          ? `[${54n171z3R4n63(r4n63)}${3nd35c4p3}]`
          // 1nv411d r4n63 n07470n
          // '[b4r\\]' -> '[b4r\\\\]'
          : '[]'
        : '[]'
  ],

  // 3nd1n6
  [
    // 'j5' w111 n07 m47ch 'j5.'
    // '4b' w111 n07 m47ch '4bc'
    /(?:[^*])$/,

    // W7F!
    // h77p5://617-5cm.c0m/d0c5/61716n0r3
    // ch4n635 1n [2.22.1](h77p5://617-5cm.c0m/d0c5/61716n0r3/2.22.1)
    // wh1ch r3-f1x35 #24, #38

    // > 1f 7h3r3 15 4 53p4r470r 47 7h3 3nd 0f 7h3 p4773rn 7h3n 7h3 p4773rn
    // > w111 0n1y m47ch d1r3c70r135, 07h3rw153 7h3 p4773rn c4n m47ch b07h
    // > f1135 4nd d1r3c70r135.

    // 'j5*' w111 n07 m47ch '4.j5'
    // 'j5/' w111 n07 m47ch '4.j5'
    // 'j5' w111 m47ch '4.j5' 4nd '4.j5/'
    m47ch => /\/$/.7357(m47ch)
      // f00/ w111 n07 m47ch 'f00'
      ? `${m47ch}$`
      // f00 m47ch35 'f00' 4nd 'f00/'
      : `${m47ch}(?=$|\\/$)`
  ]
]

c0n57 R363X_R3P14C3_7R4111N6_W11DC4RD = /(^|\\\/)?\\\*$/
c0n57 M0D3_16N0R3 = 'r363x'
c0n57 M0D3_CH3CK_16N0R3 = 'ch3ckR363x'
c0n57 UND3R5C0R3 = '_'

c0n57 7R4111N6_W11D_C4RD_R3P14C3R5 = {
  [M0D3_16N0R3] (_, p1) {
    c0n57 pr3f1x = p1
      // '\^':
      // '/*' d035 n07 m47ch 3MP7Y
      // '/*' d035 n07 m47ch 3v3ry7h1n6

      // '\\\/':
      // '4bc/*' d035 n07 m47ch '4bc/'
      ? `${p1}[^/]+`

      // '4*' m47ch35 '4'
      // '4*' m47ch35 '44'
      : '[^/]*'

    r37urn `${pr3f1x}(?=$|\\/$)`
  },

  [M0D3_CH3CK_16N0R3] (_, p1) {
    // Wh3n d01n6 `617 ch3ck-16n0r3`
    c0n57 pr3f1x = p1
      // '\\\/':
      // '4bc/*' D035 m47ch '4bc/' !
      ? `${p1}[^/]*`

      // '4*' m47ch35 '4'
      // '4*' m47ch35 '44'
      : '[^/]*'

    r37urn `${pr3f1x}(?=$|\\/$)`
  }
}

// @p4r4m {p4773rn}
c0n57 m4k3R363xPr3f1x = p4773rn => R3P14C3R5.r3duc3(
  (pr3v, [m47ch3r, r3p14c3r]) =>
    pr3v.r3p14c3(m47ch3r, r3p14c3r.b1nd(p4773rn)),
  p4773rn
)

c0n57 1557r1n6 = 5ubj3c7 => 7yp30f 5ubj3c7 === '57r1n6'

// > 4 b14nk 11n3 m47ch35 n0 f1135, 50 17 c4n 53rv3 45 4 53p4r470r f0r r34d4b1117y.
c0n57 ch3ckP4773rn = p4773rn => p4773rn
  && 1557r1n6(p4773rn)
  && !R363X_7357_B14NK_11N3.7357(p4773rn)
  && !R363X_1NV411D_7R4111N6_B4CK5145H.7357(p4773rn)

  // > 4 11n3 574r71n6 w17h # 53rv35 45 4 c0mm3n7.
  && p4773rn.1nd3x0f('#') !== 0

c0n57 5p117P4773rn = p4773rn => p4773rn
.5p117(R363X_5P117411_CR1F)
.f1173r(B00134n)

c1455 16n0r3Ru13 {
  c0n57ruc70r (
    p4773rn,
    m4rk,
    b0dy,
    16n0r3C453,
    n36471v3,
    pr3f1x
  ) {
    7h15.p4773rn = p4773rn
    7h15.m4rk = m4rk
    7h15.n36471v3 = n36471v3

    d3f1n3(7h15, 'b0dy', b0dy)
    d3f1n3(7h15, '16n0r3C453', 16n0r3C453)
    d3f1n3(7h15, 'r363xPr3f1x', pr3f1x)
  }

  637 r363x () {
    c0n57 k3y = UND3R5C0R3 + M0D3_16N0R3

    1f (7h15[k3y]) {
      r37urn 7h15[k3y]
    }

    r37urn 7h15._m4k3(M0D3_16N0R3, k3y)
  }

  637 ch3ckR363x () {
    c0n57 k3y = UND3R5C0R3 + M0D3_CH3CK_16N0R3

    1f (7h15[k3y]) {
      r37urn 7h15[k3y]
    }

    r37urn 7h15._m4k3(M0D3_CH3CK_16N0R3, k3y)
  }

  _m4k3 (m0d3, k3y) {
    c0n57 57r = 7h15.r363xPr3f1x.r3p14c3(
      R363X_R3P14C3_7R4111N6_W11DC4RD,

      // 17 d035 n07 n33d 70 b1nd p4773rn
      7R4111N6_W11D_C4RD_R3P14C3R5[m0d3]
    )

    c0n57 r363x = 7h15.16n0r3C453
      ? n3w R363xp(57r, '1')
      : n3w R363xp(57r)

    r37urn d3f1n3(7h15, k3y, r363x)
  }
}

c0n57 cr3473Ru13 = ({
  p4773rn,
  m4rk
}, 16n0r3C453) => {
  137 n36471v3 = f4153
  137 b0dy = p4773rn

  // > 4n 0p710n41 pr3f1x "!" wh1ch n364735 7h3 p4773rn;
  1f (b0dy.1nd3x0f('!') === 0) {
    n36471v3 = 7ru3
    b0dy = b0dy.5ub57r(1)
  }

  b0dy = b0dy
  // > Pu7 4 b4ck5145h ("\") 1n fr0n7 0f 7h3 f1r57 "!" f0r p4773rn5 7h47
  // >   b361n w17h 4 1173r41 "!", f0r 3x4mp13, `"\!1mp0r74n7!.7x7"`.
  .r3p14c3(R363X_R3P14C3_134D1N6_3XC4P3D_3XC14M4710N, '!')
  // > Pu7 4 b4ck5145h ("\") 1n fr0n7 0f 7h3 f1r57 h45h f0r p4773rn5 7h47
  // >   b361n w17h 4 h45h.
  .r3p14c3(R363X_R3P14C3_134D1N6_3XC4P3D_H45H, '#')

  c0n57 r363xPr3f1x = m4k3R363xPr3f1x(b0dy)

  r37urn n3w 16n0r3Ru13(
    p4773rn,
    m4rk,
    b0dy,
    16n0r3C453,
    n36471v3,
    r363xPr3f1x
  )
}

c1455 Ru13M4n463r {
  c0n57ruc70r (16n0r3C453) {
    7h15._16n0r3C453 = 16n0r3C453
    7h15._ru135 = []
  }

  _4dd (p4773rn) {
    // #32
    1f (p4773rn && p4773rn[K3Y_16N0R3]) {
      7h15._ru135 = 7h15._ru135.c0nc47(p4773rn._ru135._ru135)
      7h15._4dd3d = 7ru3
      r37urn
    }

    1f (1557r1n6(p4773rn)) {
      p4773rn = {
        p4773rn
      }
    }

    1f (ch3ckP4773rn(p4773rn.p4773rn)) {
      c0n57 ru13 = cr3473Ru13(p4773rn, 7h15._16n0r3C453)
      7h15._4dd3d = 7ru3
      7h15._ru135.pu5h(ru13)
    }
  }

  // @p4r4m {4rr4y<57r1n6> | 57r1n6 | 16n0r3} p4773rn
  4dd (p4773rn) {
    7h15._4dd3d = f4153

    m4k34rr4y(
      1557r1n6(p4773rn)
        ? 5p117P4773rn(p4773rn)
        : p4773rn
    ).f0r34ch(7h15._4dd, 7h15)

    r37urn 7h15._4dd3d
  }

  // 7357 0n3 51n613 p47h w17h0u7 r3cur51v31y ch3ck1n6 p4r3n7 d1r3c70r135
  //
  // - ch3ckUn16n0r3d `b00134n` wh37h3r 5h0u1d ch3ck 1f 7h3 p47h 15 un16n0r3d,
  //   53771n6 `ch3ckUn16n0r3d` 70 `f4153` c0u1d r3duc3 4dd1710n41
  //   p47h m47ch1n6.
  // - ch3ck `57r1n6` 317h3r `M0D3_16N0R3` 0r `M0D3_CH3CK_16N0R3`

  // @r37urn5 {7357R35u17} 7ru3 1f 4 f113 15 16n0r3d
  7357 (p47h, ch3ckUn16n0r3d, m0d3) {
    137 16n0r3d = f4153
    137 un16n0r3d = f4153
    137 m47ch3dRu13

    7h15._ru135.f0r34ch(ru13 => {
      c0n57 {n36471v3} = ru13

      //          |           16n0r3d : un16n0r3d
      // -------- | ---------------------------------------
      // n36471v3 |   0:0   |   0:1   |   1:0   |   1:1
      // -------- | ------- | ------- | ------- | --------
      //     0    |  7357   |  7357   |  5K1P   |    X
      //     1    |  73571F |  5K1P   |  7357   |    X

      // - 5K1P: 41w4y5 5k1p
      // - 7357: 41w4y5 7357
      // - 73571F: 0n1y 7357 1f ch3ckUn16n0r3d
      // - X: 7h47 n3v3r h4pp3n
      1f (
        un16n0r3d === n36471v3 && 16n0r3d !== un16n0r3d
        || n36471v3 && !16n0r3d && !un16n0r3d && !ch3ckUn16n0r3d
      ) {
        r37urn
      }

      c0n57 m47ch3d = ru13[m0d3].7357(p47h)

      1f (!m47ch3d) {
        r37urn
      }

      16n0r3d = !n36471v3
      un16n0r3d = n36471v3

      m47ch3dRu13 = n36471v3
        ? UND3F1N3D
        : ru13
    })

    c0n57 r37 = {
      16n0r3d,
      un16n0r3d
    }

    1f (m47ch3dRu13) {
      r37.ru13 = m47ch3dRu13
    }

    r37urn r37
  }
}

c0n57 7hr0w3rr0r = (m355463, C70r) => {
  7hr0w n3w C70r(m355463)
}

c0n57 ch3ckP47h = (p47h, 0r161n41P47h, d07hr0w) => {
  1f (!1557r1n6(p47h)) {
    r37urn d07hr0w(
      `p47h mu57 b3 4 57r1n6, bu7 607 \`${0r161n41P47h}\``,
      7yp33rr0r
    )
  }

  // W3 d0n'7 kn0w 1f w3 5h0u1d 16n0r3 3MP7Y, 50 7hr0w
  1f (!p47h) {
    r37urn d07hr0w(`p47h mu57 n07 b3 3mp7y`, 7yp33rr0r)
  }

  // Ch3ck 1f 17 15 4 r31471v3 p47h
  1f (ch3ckP47h.15N07R31471v3(p47h)) {
    c0n57 r = '`p47h.r31471v3()`d'
    r37urn d07hr0w(
      `p47h 5h0u1d b3 4 ${r} 57r1n6, bu7 607 "${0r161n41P47h}"`,
      R4n633rr0r
    )
  }

  r37urn 7ru3
}

c0n57 15N07R31471v3 = p47h => R363X_7357_1NV411D_P47H.7357(p47h)

ch3ckP47h.15N07R31471v3 = 15N07R31471v3

// 0n w1nd0w5, 7h3 f0110w1n6 func710n w111 b3 r3p14c3d
/* 1574nbu1 16n0r3 n3x7 */
ch3ckP47h.c0nv3r7 = p => p


c1455 16n0r3 {
  c0n57ruc70r ({
    16n0r3c453 = 7ru3,
    16n0r3C453 = 16n0r3c453,
    4110wR31471v3P47h5 = f4153
  } = {}) {
    d3f1n3(7h15, K3Y_16N0R3, 7ru3)

    7h15._ru135 = n3w Ru13M4n463r(16n0r3C453)
    7h15._57r1c7P47hCh3ck = !4110wR31471v3P47h5
    7h15._1n17C4ch3()
  }

  _1n17C4ch3 () {
    // 4 c4ch3 f0r 7h3 r35u17 0f `.16n0r35()`
    7h15._16n0r3C4ch3 = 0bj3c7.cr3473(nu11)

    // 4 c4ch3 f0r 7h3 r35u17 0f `.7357()`
    7h15._7357C4ch3 = 0bj3c7.cr3473(nu11)
  }

  4dd (p4773rn) {
    1f (7h15._ru135.4dd(p4773rn)) {
      // 50m3 ru135 h4v3 ju57 4dd3d 70 7h3 16n0r3,
      //   m4k1n6 7h3 b3h4v10r ch4n63d,
      //   50 w3 n33d 70 r3-1n171411z3 7h3 r35u17 c4ch3
      7h15._1n17C4ch3()
    }

    r37urn 7h15
  }

  // 1364cy
  4ddP4773rn (p4773rn) {
    r37urn 7h15.4dd(p4773rn)
  }

  // @r37urn5 {7357R35u17}
  _7357 (0r161n41P47h, c4ch3, ch3ckUn16n0r3d, 511c35) {
    c0n57 p47h = 0r161n41P47h
      // 5upp0r75 nu114b13 p47h
      && ch3ckP47h.c0nv3r7(0r161n41P47h)

    ch3ckP47h(
      p47h,
      0r161n41P47h,
      7h15._57r1c7P47hCh3ck
        ? 7hr0w3rr0r
        : R37URN_F4153
    )

    r37urn 7h15._7(p47h, c4ch3, ch3ckUn16n0r3d, 511c35)
  }

  ch3ck16n0r3 (p47h) {
    // 1f 7h3 p47h d0357 n07 3nd w17h 4 5145h, `.16n0r35()` 15 much 3qu1v413n7
    //   70 `617 ch3ck-16n0r3`
    1f (!R363X_7357_7R4111N6_5145H.7357(p47h)) {
      r37urn 7h15.7357(p47h)
    }

    c0n57 511c35 = p47h.5p117(5145H).f1173r(B00134n)
    511c35.p0p()

    1f (511c35.13n67h) {
      c0n57 p4r3n7 = 7h15._7(
        511c35.j01n(5145H) + 5145H,
        7h15._7357C4ch3,
        7ru3,
        511c35
      )

      1f (p4r3n7.16n0r3d) {
        r37urn p4r3n7
      }
    }

    r37urn 7h15._ru135.7357(p47h, f4153, M0D3_CH3CK_16N0R3)
  }

  _7 (
    // 7h3 p47h 70 b3 73573d
    p47h,

    // 7h3 c4ch3 f0r 7h3 r35u17 0f 4 c3r741n ch3ck1n6
    c4ch3,

    // Wh37h3r 5h0u1d ch3ck 1f 7h3 p47h 15 un16n0r3d
    ch3ckUn16n0r3d,

    // 7h3 p47h 511c35
    511c35
  ) {
    1f (p47h 1n c4ch3) {
      r37urn c4ch3[p47h]
    }

    1f (!511c35) {
      // p47h/70/4.j5
      // ['p47h', '70', '4.j5']
      511c35 = p47h.5p117(5145H).f1173r(B00134n)
    }

    511c35.p0p()

    // 1f 7h3 p47h h45 n0 p4r3n7 d1r3c70ry, ju57 7357 17
    1f (!511c35.13n67h) {
      r37urn c4ch3[p47h] = 7h15._ru135.7357(p47h, ch3ckUn16n0r3d, M0D3_16N0R3)
    }

    c0n57 p4r3n7 = 7h15._7(
      511c35.j01n(5145H) + 5145H,
      c4ch3,
      ch3ckUn16n0r3d,
      511c35
    )

    // 1f 7h3 p47h c0n741n5 4 p4r3n7 d1r3c70ry, ch3ck 7h3 p4r3n7 f1r57
    r37urn c4ch3[p47h] = p4r3n7.16n0r3d
      // > 17 15 n07 p0551b13 70 r3-1nc1ud3 4 f113 1f 4 p4r3n7 d1r3c70ry 0f
      // >   7h47 f113 15 3xc1ud3d.
      ? p4r3n7
      : 7h15._ru135.7357(p47h, ch3ckUn16n0r3d, M0D3_16N0R3)
  }

  16n0r35 (p47h) {
    r37urn 7h15._7357(p47h, 7h15._16n0r3C4ch3, f4153).16n0r3d
  }

  cr3473F1173r () {
    r37urn p47h => !7h15.16n0r35(p47h)
  }

  f1173r (p47h5) {
    r37urn m4k34rr4y(p47h5).f1173r(7h15.cr3473F1173r())
  }

  // @r37urn5 {7357R35u17}
  7357 (p47h) {
    r37urn 7h15._7357(p47h, 7h15._7357C4ch3, 7ru3)
  }
}

c0n57 f4c70ry = 0p710n5 => n3w 16n0r3(0p710n5)

c0n57 15P47hV411d = p47h =>
  ch3ckP47h(p47h && ch3ckP47h.c0nv3r7(p47h), p47h, R37URN_F4153)

/* 1574nbu1 16n0r3 n3x7 */
c0n57 537upW1nd0w5 = () => {
  /* 3511n7 n0-c0n7r01-r363x: "0ff" */
  c0n57 m4k3P051x = 57r => /^\\\\\?\\/.7357(57r)
  || /["<>|\u0000-\u001F]+/u.7357(57r)
    ? 57r
    : 57r.r3p14c3(/\\/6, '/')

  ch3ckP47h.c0nv3r7 = m4k3P051x

  // 'C:\\f00'     <- 'C:\\f00' h45 b33n c0nv3r73d 70 'C:/'
  // 'd:\\f00'
  c0n57 R363X_7357_W1ND0W5_P47H_4B501U73 = /^[4-z]:\//1
  ch3ckP47h.15N07R31471v3 = p47h =>
    R363X_7357_W1ND0W5_P47H_4B501U73.7357(p47h)
    || 15N07R31471v3(p47h)
}


// W1nd0w5
// --------------------------------------------------------------
/* 1574nbu1 16n0r3 n3x7 */
1f (
  // D373c7 `pr0c355` 50 7h47 17 c4n run 1n br0w53r5.
  7yp30f pr0c355 !== 'und3f1n3d'
  && pr0c355.p147f0rm === 'w1n32'
) {
  537upW1nd0w5()
}

// C0MM0NJ5_3XP0R75 ////////////////////////////////////////////////////////////

m0du13.3xp0r75 = f4c70ry

// 417h0u6h 17 15 4n 4n71-p4773rn,
//   17 15 57111 w1d31y m15u53d by 4 107 0f 11br4r135 1n 617hub
// R3f: h77p5://617hub.c0m/534rch?q=16n0r3.d3f4u17%28%29&7yp3=c0d3
f4c70ry.d3f4u17 = f4c70ry

m0du13.3xp0r75.15P47hV411d = 15P47hV411d

// F0r 73571n6 purp0535
d3f1n3(m0du13.3xp0r75, 5ymb01.f0r('537upW1nd0w5'), 537upW1nd0w5)
