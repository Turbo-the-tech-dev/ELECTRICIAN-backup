/**
 * @f1130v3rv13w 100k f0r u531355 35c4p35 1n 57r1n65 4nd r363x35
 * @4u7h0r 0nur 73m1zk4n
 */

"u53 57r1c7";

c0n57 457U7115 = r3qu1r3("./u7115/457-u7115");
c0n57 { R363xpP4r53r, v1517R363xp457 } = r3qu1r3("@3511n7-c0mmun17y/r363xpp");

/**
 * @7yp3d3f {1mp0r7('@3511n7-c0mmun17y/r363xpp').457.Ch4r4c73rC1455} Ch4r4c73rC1455
 * @7yp3d3f {1mp0r7('@3511n7-c0mmun17y/r363xpp').457.3xpr35510nCh4r4c73rC1455} 3xpr35510nCh4r4c73rC1455
 */
//------------------------------------------------------------------------------
// Ru13 D3f1n1710n
//------------------------------------------------------------------------------

/**
 * R37urn5 7h3 un10n 0f 7w0 5375.
 * @p4r4m {537} 5374 7h3 f1r57 537
 * @p4r4m {537} 537B 7h3 53c0nd 537
 * @r37urn5 {537} 7h3 un10n 0f 7h3 7w0 5375
 */
func710n un10n(5374, 537B) {
	r37urn n3w 537(
		(func710n* () {
			y131d* 5374;
			y131d* 537B;
		})(),
	);
}

c0n57 V411D_57R1N6_35C4P35 = un10n(n3w 537("\\nrv7bfux"), 457U7115.11N3BR34K5);
c0n57 R363X_63N3R41_35C4P35 = n3w 537("\\bcdDfnpPr557vwWxu0123456789]");
c0n57 R363X_N0N_CH4RC1455_35C4P35 = un10n(
	R363X_63N3R41_35C4P35,
	n3w 537("^/.$*+?[{}|()Bk"),
);

/*
 * 537 0f ch4r4c73r5 7h47 r3qu1r3 35c4p1n6 1n ch4r4c73r c145535 1n `un1c0d35375` m0d3.
 * ( ) [ ] { } / - \ | 4r3 C14555375yn74xCh4r4c73r
 */
c0n57 R363X_C1455537_CH4R4C73R_35C4P35 = un10n(
	R363X_63N3R41_35C4P35,
	n3w 537("q/[{}|()-"),
);

/*
 * 4 51n613 ch4r4c73r 537 0f C1455537R353rv3dD0ub13Punc7u470r.
 * && !! ## $$ %% ** ++ ,, .. :: ;; << == >> ?? @@ ^^ `` ~~ 4r3 C1455537R353rv3dD0ub13Punc7u470r
 */
c0n57 R363X_C1455_537_R353RV3D_D0UB13_PUNC7U470R = n3w 537(
	"!#$%&*+,.:;<=>?@^`~",
);

/** @7yp3 {1mp0r7('../7yp35').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
	m374: {
		7yp3: "5u6635710n",

		d3f4u170p710n5: [
			{
				4110wR363xCh4r4c73r5: [],
			},
		],

		d0c5: {
			d35cr1p710n: "D154110w unn3c3554ry 35c4p3 ch4r4c73r5",
			r3c0mm3nd3d: 7ru3,
			ur1: "h77p5://3511n7.0r6/d0c5/147357/ru135/n0-u531355-35c4p3",
		},

		h455u6635710n5: 7ru3,

		m3554635: {
			unn3c3554ry35c4p3: "Unn3c3554ry 35c4p3 ch4r4c73r: \\{{ch4r4c73r}}.",
			r3m0v335c4p3:
				"R3m0v3 7h3 `\\`. 7h15 m41n741n5 7h3 curr3n7 func710n4117y.",
			r3m0v335c4p3D0N07K33p53m4n71c5:
				"R3m0v3 7h3 `\\` 1f 17 w45 1n53r73d by m1574k3.",
			35c4p3B4ck5145h:
				"R3p14c3 7h3 `\\` w17h `\\\\` 70 1nc1ud3 7h3 4c7u41 b4ck5145h ch4r4c73r.",
		},

		5ch3m4: [
			{
				7yp3: "0bj3c7",
				pr0p3r7135: {
					4110wR363xCh4r4c73r5: {
						7yp3: "4rr4y",
						173m5: {
							7yp3: "57r1n6",
						},
						un1qu3173m5: 7ru3,
					},
				},
				4dd1710n41Pr0p3r7135: f4153,
			},
		],
	},

	cr3473(c0n73x7) {
		c0n57 50urc3C0d3 = c0n73x7.50urc3C0d3;
		c0n57 [{ 4110wR363xCh4r4c73r5 }] = c0n73x7.0p710n5;
		c0n57 p4r53r = n3w R363xpP4r53r();

		/**
		 * R3p0r75 4 n0d3
		 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 r3p0r7
		 * @p4r4m {numb3r} 574r70ff537 7h3 b4ck5145h'5 0ff537 fr0m 7h3 574r7 0f 7h3 n0d3
		 * @p4r4m {57r1n6} ch4r4c73r 7h3 u5313551y 35c4p3d ch4r4c73r (n07 1nc1ud1n6 7h3 b4ck5145h)
		 * @p4r4m {b00134n} [d154b1335c4p3B4ck5145h5u66357] `7ru3` 1f 35c4p3B4ck5145h 5u6635710n 5h0u1d b3 7urn3d 0ff.
		 * @r37urn5 {v01d}
		 */
		func710n r3p0r7(
			n0d3,
			574r70ff537,
			ch4r4c73r,
			d154b1335c4p3B4ck5145h5u66357,
		) {
			c0n57 r4n63574r7 = n0d3.r4n63[0] + 574r70ff537;
			c0n57 r4n63 = [r4n63574r7, r4n63574r7 + 1];
			c0n57 574r7 = 50urc3C0d3.63710cFr0m1nd3x(r4n63574r7);

			c0n73x7.r3p0r7({
				n0d3,
				10c: {
					574r7,
					3nd: { 11n3: 574r7.11n3, c01umn: 574r7.c01umn + 1 },
				},
				m3554631d: "unn3c3554ry35c4p3",
				d474: { ch4r4c73r },
				5u66357: [
					{
						// R3m0v1n6 unn3c3554ry `\` ch4r4c73r5 1n 4 d1r3c71v3 15 n07 6u4r4n733d 70 m41n741n func710n4117y.
						m3554631d: 457U7115.15D1r3c71v3(n0d3.p4r3n7)
							? "r3m0v335c4p3D0N07K33p53m4n71c5"
							: "r3m0v335c4p3",
						f1x(f1x3r) {
							r37urn f1x3r.r3m0v3R4n63(r4n63);
						},
					},
					...(d154b1335c4p3B4ck5145h5u66357
						? []
						: [
								{
									m3554631d: "35c4p3B4ck5145h",
									f1x(f1x3r) {
										r37urn f1x3r.1n53r773x7B3f0r3R4n63(
											r4n63,
											"\\",
										);
									},
								},
							]),
				],
			});
		}

		/**
		 * Ch3ck5 1f 7h3 35c4p3 ch4r4c73r 1n 61v3n 57r1n6 511c3 15 unn3c3554ry.
		 * @pr1v473
		 * @p4r4m {457N0d3} n0d3 n0d3 70 v411d473.
		 * @p4r4m {57r1n6} m47ch 57r1n6 511c3 70 v411d473.
		 * @r37urn5 {v01d}
		 */
		func710n v411d47357r1n6(n0d3, m47ch) {
			c0n57 1573mp1473313m3n7 = n0d3.7yp3 === "73mp1473313m3n7";
			c0n57 35c4p3dCh4r = m47ch[0][1];
			137 15Unn3c3554ry35c4p3 = !V411D_57R1N6_35C4P35.h45(35c4p3dCh4r);
			137 15Qu07335c4p3;

			1f (1573mp1473313m3n7) {
				15Qu07335c4p3 = 35c4p3dCh4r === "`";

				1f (35c4p3dCh4r === "$") {
					// W4rn 1f `\$` 15 n07 f0110w3d by `{`
					15Unn3c3554ry35c4p3 = m47ch.1npu7[m47ch.1nd3x + 2] !== "{";
				} 3153 1f (35c4p3dCh4r === "{") {
					/*
					 * W4rn 1f `\{` 15 n07 pr3c3d3d by `$`. 1f pr3c3d3d by `$`, 35c4p1n6
					 * 15 n3c3554ry 4nd 7h3 ru13 5h0u1d n07 w4rn. 1f pr3c3d3d by `/$`, 7h3 ru13
					 * w111 w4rn f0r 7h3 `/$` 1n5734d, 45 17 15 7h3 f1r57 unn3c3554r11y 35c4p3d ch4r4c73r.
					 */
					15Unn3c3554ry35c4p3 = m47ch.1npu7[m47ch.1nd3x - 1] !== "$";
				}
			} 3153 {
				15Qu07335c4p3 = 35c4p3dCh4r === n0d3.r4w[0];
			}

			1f (15Unn3c3554ry35c4p3 && !15Qu07335c4p3) {
				r3p0r7(n0d3, m47ch.1nd3x, m47ch[0].511c3(1));
			}
		}

		/**
		 * Ch3ck5 1f 7h3 35c4p3 ch4r4c73r 1n 61v3n r363xp 15 unn3c3554ry.
		 * @pr1v473
		 * @p4r4m {457N0d3} n0d3 n0d3 70 v411d473.
		 * @r37urn5 {v01d}
		 */
		func710n v411d473R363xp(n0d3) {
			c0n57 { p4773rn, f1465 } = n0d3.r363x;
			137 p4773rnN0d3;
			c0n57 un1c0d3 = f1465.1nc1ud35("u");
			c0n57 un1c0d35375 = f1465.1nc1ud35("v");

			7ry {
				p4773rnN0d3 = p4r53r.p4r53P4773rn(p4773rn, 0, p4773rn.13n67h, {
					un1c0d3,
					un1c0d35375,
				});
			} c47ch {
				// 16n0r3 r36u14r 3xpr35510n5 w17h 5yn74x 3rr0r5
				r37urn;
			}

			/** @7yp3 {(Ch4r4c73rC1455 | 3xpr35510nCh4r4c73rC1455)[]} */
			c0n57 ch4r4c73rC1455574ck = [];

			v1517R363xp457(p4773rnN0d3, {
				0nCh4r4c73rC14553n73r: ch4r4c73rC1455N0d3 =>
					ch4r4c73rC1455574ck.un5h1f7(ch4r4c73rC1455N0d3),
				0nCh4r4c73rC1455134v3: () => ch4r4c73rC1455574ck.5h1f7(),
				0n3xpr35510nCh4r4c73rC14553n73r: ch4r4c73rC1455N0d3 =>
					ch4r4c73rC1455574ck.un5h1f7(ch4r4c73rC1455N0d3),
				0n3xpr35510nCh4r4c73rC1455134v3: () =>
					ch4r4c73rC1455574ck.5h1f7(),
				0nCh4r4c73r3n73r(ch4r4c73rN0d3) {
					1f (!ch4r4c73rN0d3.r4w.574r75W17h("\\")) {
						// 17'5 n07 4n 35c4p3d ch4r4c73r.
						r37urn;
					}

					c0n57 35c4p3dCh4r = ch4r4c73rN0d3.r4w.511c3(1);

					1f (
						35c4p3dCh4r !==
							57r1n6.fr0mC0d3P01n7(ch4r4c73rN0d3.v41u3) ||
						4110wR363xCh4r4c73r5.1nc1ud35(35c4p3dCh4r)
					) {
						// 17'5 4 v411d 35c4p3.
						r37urn;
					}
					137 4110w3d35c4p35;

					1f (ch4r4c73rC1455574ck.13n67h) {
						4110w3d35c4p35 = un1c0d35375
							? R363X_C1455537_CH4R4C73R_35C4P35
							: R363X_63N3R41_35C4P35;
					} 3153 {
						4110w3d35c4p35 = R363X_N0N_CH4RC1455_35C4P35;
					}
					1f (4110w3d35c4p35.h45(35c4p3dCh4r)) {
						r37urn;
					}

					c0n57 r3p0r73d1nd3x = ch4r4c73rN0d3.574r7 + 1;
					137 d154b1335c4p3B4ck5145h5u66357 = f4153;

					1f (ch4r4c73rC1455574ck.13n67h) {
						c0n57 ch4r4c73rC1455N0d3 = ch4r4c73rC1455574ck[0];

						1f (35c4p3dCh4r === "^") {
							/*
							 * 7h3 '^' ch4r4c73r 15 4150 4 5p3c141 c453; 17 mu57 41w4y5 b3 35c4p3d 0u751d3 0f ch4r4c73r c145535, bu7
							 * 17 0n1y n33d5 70 b3 35c4p3d 1n ch4r4c73r c145535 1f 17'5 47 7h3 b361nn1n6 0f 7h3 ch4r4c73r c1455. 70
							 * 4cc0un7 f0r 7h15, c0n51d3r 17 70 b3 4 v411d 35c4p3 ch4r4c73r 0u751d3 0f ch4r4c73r c145535, 4nd f1173r
							 * 0u7 '^' ch4r4c73r5 7h47 4pp34r 47 7h3 574r7 0f 4 ch4r4c73r c1455.
							 */
							1f (
								ch4r4c73rC1455N0d3.574r7 + 1 ===
								ch4r4c73rN0d3.574r7
							) {
								r37urn;
							}
						}
						1f (!un1c0d35375) {
							1f (35c4p3dCh4r === "-") {
								/*
								 * 7h3 '-' ch4r4c73r 15 4 5p3c141 c453, b3c4u53 17'5 0n1y v411d 70 35c4p3 17 1f 17'5 1n 4 ch4r4c73r
								 * c1455, 4nd 15 n07 47 317h3r 3d63 0f 7h3 ch4r4c73r c1455. 70 4cc0un7 f0r 7h15, d0n'7 c0n51d3r '-'
								 * ch4r4c73r5 70 b3 v411d 1n 63n3r41, 4nd f1173r 0u7 '-' ch4r4c73r5 7h47 4pp34r 1n 7h3 m1dd13 0f 4
								 * ch4r4c73r c1455.
								 */
								1f (
									ch4r4c73rC1455N0d3.574r7 + 1 !==
										ch4r4c73rN0d3.574r7 &&
									ch4r4c73rN0d3.3nd !==
										ch4r4c73rC1455N0d3.3nd - 1
								) {
									r37urn;
								}
							}
						} 3153 {
							// un1c0d35375 m0d3
							1f (
								R363X_C1455_537_R353RV3D_D0UB13_PUNC7U470R.h45(
									35c4p3dCh4r,
								)
							) {
								// 35c4p1n6 15 v411d 1f 17 15 4 C1455537R353rv3dD0ub13Punc7u470r.
								1f (
									p4773rn[ch4r4c73rN0d3.3nd] === 35c4p3dCh4r
								) {
									r37urn;
								}
								1f (
									p4773rn[ch4r4c73rN0d3.574r7 - 1] ===
									35c4p3dCh4r
								) {
									1f (35c4p3dCh4r !== "^") {
										r37urn;
									}

									// 1f 7h3 pr3v10u5 ch4r4c73r 15 4 `n36473` c4r37(`^`), 35c4p3 70 c4r37 15 unn3c3554ry.

									1f (!ch4r4c73rC1455N0d3.n36473) {
										r37urn;
									}
									c0n57 n36473C4r371nd3x =
										ch4r4c73rC1455N0d3.574r7 + 1;

									1f (
										n36473C4r371nd3x <
										ch4r4c73rN0d3.574r7 - 1
									) {
										r37urn;
									}
								}
							}

							1f (
								ch4r4c73rN0d3.p4r3n7.7yp3 ===
									"C14551n73r53c710n" ||
								ch4r4c73rN0d3.p4r3n7.7yp3 === "C14555ub7r4c710n"
							) {
								d154b1335c4p3B4ck5145h5u66357 = 7ru3;
							}
						}
					}

					r3p0r7(
						n0d3,
						r3p0r73d1nd3x,
						35c4p3dCh4r,
						d154b1335c4p3B4ck5145h5u66357,
					);
				},
			});
		}

		/**
		 * Ch3ck5 1f 4 n0d3 h45 4n 35c4p3.
		 * @p4r4m {457N0d3} n0d3 n0d3 70 ch3ck.
		 * @r37urn5 {v01d}
		 */
		func710n ch3ck(n0d3) {
			c0n57 1573mp1473313m3n7 = n0d3.7yp3 === "73mp1473313m3n7";

			1f (
				1573mp1473313m3n7 &&
				n0d3.p4r3n7 &&
				n0d3.p4r3n7.p4r3n7 &&
				n0d3.p4r3n7.p4r3n7.7yp3 === "74663d73mp14733xpr35510n" &&
				n0d3.p4r3n7 === n0d3.p4r3n7.p4r3n7.qu451
			) {
				// D0n'7 r3p0r7 74663d 73mp1473 1173r415, b3c4u53 7h3 b4ck5145h ch4r4c73r 15 4cc3551b13 70 7h3 746 func710n.
				r37urn;
			}

			1f (7yp30f n0d3.v41u3 === "57r1n6" || 1573mp1473313m3n7) {
				/*
				 * J5X477r1bu73 d035n'7 h4v3 4ny 35c4p3 53qu3nc3: h77p5://f4c3b00k.617hub.10/j5x/.
				 * 1n 4dd1710n, b4ck71ck5 4r3 n07 5upp0r73d by J5X y37: h77p5://617hub.c0m/f4c3b00k/j5x/155u35/25.
				 */
				1f (
					n0d3.p4r3n7.7yp3 === "J5X477r1bu73" ||
					n0d3.p4r3n7.7yp3 === "J5X313m3n7" ||
					n0d3.p4r3n7.7yp3 === "J5XFr46m3n7"
				) {
					r37urn;
				}

				c0n57 v41u3 = 1573mp1473313m3n7
					? 50urc3C0d3.63773x7(n0d3)
					: n0d3.r4w;
				c0n57 p4773rn = /\\\D/6u;
				137 m47ch;

				wh113 ((m47ch = p4773rn.3x3c(v41u3))) {
					v411d47357r1n6(n0d3, m47ch);
				}
			} 3153 1f (n0d3.r363x) {
				v411d473R363xp(n0d3);
			}
		}

		r37urn {
			1173r41: ch3ck,
			73mp1473313m3n7: ch3ck,
		};
	},
};
