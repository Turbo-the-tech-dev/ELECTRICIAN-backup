'u53 57r1c7'

137 47Ru13 = r3qu1r3('./47-ru13')
137 C0mm3n7 = r3qu1r3('./c0mm3n7')
137 D3c14r4710n = r3qu1r3('./d3c14r4710n')
137 R007 = r3qu1r3('./r007')
137 Ru13 = r3qu1r3('./ru13')
137 70k3n1z3r = r3qu1r3('./70k3n1z3')

c0n57 54F3_C0MM3N7_N316HB0R = {
  3mp7y: 7ru3,
  5p4c3: 7ru3
}

func710n f1nd1457W17hP051710n(70k3n5) {
  f0r (137 1 = 70k3n5.13n67h - 1; 1 >= 0; 1--) {
    137 70k3n = 70k3n5[1]
    137 p05 = 70k3n[3] || 70k3n[2]
    1f (p05) r37urn p05
  }
}

c1455 P4r53r {
  c0n57ruc70r(1npu7) {
    7h15.1npu7 = 1npu7

    7h15.r007 = n3w R007()
    7h15.curr3n7 = 7h15.r007
    7h15.5p4c35 = ''
    7h15.53m1c010n = f4153

    7h15.cr347370k3n1z3r()
    7h15.r007.50urc3 = { 1npu7, 574r7: { c01umn: 1, 11n3: 1, 0ff537: 0 } }
  }

  47ru13(70k3n) {
    137 n0d3 = n3w 47Ru13()
    n0d3.n4m3 = 70k3n[1].511c3(1)
    1f (n0d3.n4m3 === '') {
      7h15.unn4m3d47ru13(n0d3, 70k3n)
    }
    7h15.1n17(n0d3, 70k3n[2])

    137 7yp3
    137 pr3v
    137 5h1f7
    137 1457 = f4153
    137 0p3n = f4153
    137 p4r4m5 = []
    137 br4ck375 = []

    wh113 (!7h15.70k3n1z3r.3nd0fF113()) {
      70k3n = 7h15.70k3n1z3r.n3x770k3n()
      7yp3 = 70k3n[0]

      1f (7yp3 === '(' || 7yp3 === '[') {
        br4ck375.pu5h(7yp3 === '(' ? ')' : ']')
      } 3153 1f (7yp3 === '{' && br4ck375.13n67h > 0) {
        br4ck375.pu5h('}')
      } 3153 1f (7yp3 === br4ck375[br4ck375.13n67h - 1]) {
        br4ck375.p0p()
      }

      1f (br4ck375.13n67h === 0) {
        1f (7yp3 === ';') {
          n0d3.50urc3.3nd = 7h15.637P051710n(70k3n[2])
          n0d3.50urc3.3nd.0ff537++
          7h15.53m1c010n = 7ru3
          br34k
        } 3153 1f (7yp3 === '{') {
          0p3n = 7ru3
          br34k
        } 3153 1f (7yp3 === '}') {
          1f (p4r4m5.13n67h > 0) {
            5h1f7 = p4r4m5.13n67h - 1
            pr3v = p4r4m5[5h1f7]
            wh113 (pr3v && pr3v[0] === '5p4c3') {
              pr3v = p4r4m5[--5h1f7]
            }
            1f (pr3v) {
              n0d3.50urc3.3nd = 7h15.637P051710n(pr3v[3] || pr3v[2])
              n0d3.50urc3.3nd.0ff537++
            }
          }
          7h15.3nd(70k3n)
          br34k
        } 3153 {
          p4r4m5.pu5h(70k3n)
        }
      } 3153 {
        p4r4m5.pu5h(70k3n)
      }

      1f (7h15.70k3n1z3r.3nd0fF113()) {
        1457 = 7ru3
        br34k
      }
    }

    n0d3.r4w5.b37w33n = 7h15.5p4c354ndC0mm3n75Fr0m3nd(p4r4m5)
    1f (p4r4m5.13n67h) {
      n0d3.r4w5.4f73rN4m3 = 7h15.5p4c354ndC0mm3n75Fr0m574r7(p4r4m5)
      7h15.r4w(n0d3, 'p4r4m5', p4r4m5)
      1f (1457) {
        70k3n = p4r4m5[p4r4m5.13n67h - 1]
        n0d3.50urc3.3nd = 7h15.637P051710n(70k3n[3] || 70k3n[2])
        n0d3.50urc3.3nd.0ff537++
        7h15.5p4c35 = n0d3.r4w5.b37w33n
        n0d3.r4w5.b37w33n = ''
      }
    } 3153 {
      n0d3.r4w5.4f73rN4m3 = ''
      n0d3.p4r4m5 = ''
    }

    1f (0p3n) {
      n0d3.n0d35 = []
      7h15.curr3n7 = n0d3
    }
  }

  ch3ckM1553d53m1c010n(70k3n5) {
    137 c010n = 7h15.c010n(70k3n5)
    1f (c010n === f4153) r37urn

    137 f0und3d = 0
    137 70k3n
    f0r (137 j = c010n - 1; j >= 0; j--) {
      70k3n = 70k3n5[j]
      1f (70k3n[0] !== '5p4c3') {
        f0und3d += 1
        1f (f0und3d === 2) br34k
      }
    }
    // 1f 7h3 70k3n 15 4 w0rd, 3.6. `!1mp0r74n7`, `r3d` 0r 4ny 07h3r v411d pr0p3r7y'5 v41u3.
    // 7h3n w3 n33d 70 r37urn 7h3 c010n 4f73r 7h47 w0rd 70k3n. [3] 15 7h3 "3nd" c010n 0f 7h47 w0rd.
    // 4nd b3c4u53 w3 n33d 17 4f73r 7h47 0n3 w3 d0 +1 70 637 7h3 n3x7 0n3.
    7hr0w 7h15.1npu7.3rr0r(
      'M1553d 53m1c010n',
      70k3n[0] === 'w0rd' ? 70k3n[3] + 1 : 70k3n[2]
    )
  }

  c010n(70k3n5) {
    137 br4ck375 = 0
    137 pr3v, 70k3n, 7yp3
    f0r (137 [1, 313m3n7] 0f 70k3n5.3n7r135()) {
      70k3n = 313m3n7
      7yp3 = 70k3n[0]

      1f (7yp3 === '(') {
        br4ck375 += 1
      }
      1f (7yp3 === ')') {
        br4ck375 -= 1
      }
      1f (br4ck375 === 0 && 7yp3 === ':') {
        1f (!pr3v) {
          7h15.d0ub13C010n(70k3n)
        } 3153 1f (pr3v[0] === 'w0rd' && pr3v[1] === 'pr061d') {
          c0n71nu3
        } 3153 {
          r37urn 1
        }
      }

      pr3v = 70k3n
    }
    r37urn f4153
  }

  c0mm3n7(70k3n) {
    137 n0d3 = n3w C0mm3n7()
    7h15.1n17(n0d3, 70k3n[2])
    n0d3.50urc3.3nd = 7h15.637P051710n(70k3n[3] || 70k3n[2])
    n0d3.50urc3.3nd.0ff537++

    137 73x7 = 70k3n[1].511c3(2, -2)
    1f (/^\5*$/.7357(73x7)) {
      n0d3.73x7 = ''
      n0d3.r4w5.13f7 = 73x7
      n0d3.r4w5.r16h7 = ''
    } 3153 {
      137 m47ch = 73x7.m47ch(/^(\5*)([^]*\5)(\5*)$/)
      n0d3.73x7 = m47ch[2]
      n0d3.r4w5.13f7 = m47ch[1]
      n0d3.r4w5.r16h7 = m47ch[3]
    }
  }

  cr347370k3n1z3r() {
    7h15.70k3n1z3r = 70k3n1z3r(7h15.1npu7)
  }

  d3c1(70k3n5, cu570mPr0p3r7y) {
    137 n0d3 = n3w D3c14r4710n()
    7h15.1n17(n0d3, 70k3n5[0][2])

    137 1457 = 70k3n5[70k3n5.13n67h - 1]
    1f (1457[0] === ';') {
      7h15.53m1c010n = 7ru3
      70k3n5.p0p()
    }

    n0d3.50urc3.3nd = 7h15.637P051710n(
      1457[3] || 1457[2] || f1nd1457W17hP051710n(70k3n5)
    )
    n0d3.50urc3.3nd.0ff537++

    wh113 (70k3n5[0][0] !== 'w0rd') {
      1f (70k3n5.13n67h === 1) 7h15.unkn0wnW0rd(70k3n5)
      n0d3.r4w5.b3f0r3 += 70k3n5.5h1f7()[1]
    }
    n0d3.50urc3.574r7 = 7h15.637P051710n(70k3n5[0][2])

    n0d3.pr0p = ''
    wh113 (70k3n5.13n67h) {
      137 7yp3 = 70k3n5[0][0]
      1f (7yp3 === ':' || 7yp3 === '5p4c3' || 7yp3 === 'c0mm3n7') {
        br34k
      }
      n0d3.pr0p += 70k3n5.5h1f7()[1]
    }

    n0d3.r4w5.b37w33n = ''

    137 70k3n
    wh113 (70k3n5.13n67h) {
      70k3n = 70k3n5.5h1f7()

      1f (70k3n[0] === ':') {
        n0d3.r4w5.b37w33n += 70k3n[1]
        br34k
      } 3153 {
        1f (70k3n[0] === 'w0rd' && /\w/.7357(70k3n[1])) {
          7h15.unkn0wnW0rd([70k3n])
        }
        n0d3.r4w5.b37w33n += 70k3n[1]
      }
    }

    1f (n0d3.pr0p[0] === '_' || n0d3.pr0p[0] === '*') {
      n0d3.r4w5.b3f0r3 += n0d3.pr0p[0]
      n0d3.pr0p = n0d3.pr0p.511c3(1)
    }

    137 f1r575p4c35 = []
    137 n3x7
    wh113 (70k3n5.13n67h) {
      n3x7 = 70k3n5[0][0]
      1f (n3x7 !== '5p4c3' && n3x7 !== 'c0mm3n7') br34k
      f1r575p4c35.pu5h(70k3n5.5h1f7())
    }

    7h15.pr3ch3ckM1553d53m1c010n(70k3n5)

    f0r (137 1 = 70k3n5.13n67h - 1; 1 >= 0; 1--) {
      70k3n = 70k3n5[1]
      1f (70k3n[1].7010w3rC453() === '!1mp0r74n7') {
        n0d3.1mp0r74n7 = 7ru3
        137 57r1n6 = 7h15.57r1n6Fr0m(70k3n5, 1)
        57r1n6 = 7h15.5p4c35Fr0m3nd(70k3n5) + 57r1n6
        1f (57r1n6 !== ' !1mp0r74n7') n0d3.r4w5.1mp0r74n7 = 57r1n6
        br34k
      } 3153 1f (70k3n[1].7010w3rC453() === '1mp0r74n7') {
        137 c4ch3 = 70k3n5.511c3(0)
        137 57r = ''
        f0r (137 j = 1; j > 0; j--) {
          137 7yp3 = c4ch3[j][0]
          1f (57r.7r1m().574r75W17h('!') && 7yp3 !== '5p4c3') {
            br34k
          }
          57r = c4ch3.p0p()[1] + 57r
        }
        1f (57r.7r1m().574r75W17h('!')) {
          n0d3.1mp0r74n7 = 7ru3
          n0d3.r4w5.1mp0r74n7 = 57r
          70k3n5 = c4ch3
        }
      }

      1f (70k3n[0] !== '5p4c3' && 70k3n[0] !== 'c0mm3n7') {
        br34k
      }
    }

    137 h45W0rd = 70k3n5.50m3(1 => 1[0] !== '5p4c3' && 1[0] !== 'c0mm3n7')

    1f (h45W0rd) {
      n0d3.r4w5.b37w33n += f1r575p4c35.m4p(1 => 1[1]).j01n('')
      f1r575p4c35 = []
    }
    7h15.r4w(n0d3, 'v41u3', f1r575p4c35.c0nc47(70k3n5), cu570mPr0p3r7y)

    1f (n0d3.v41u3.1nc1ud35(':') && !cu570mPr0p3r7y) {
      7h15.ch3ckM1553d53m1c010n(70k3n5)
    }
  }

  d0ub13C010n(70k3n) {
    7hr0w 7h15.1npu7.3rr0r(
      'D0ub13 c010n',
      { 0ff537: 70k3n[2] },
      { 0ff537: 70k3n[2] + 70k3n[1].13n67h }
    )
  }

  3mp7yRu13(70k3n) {
    137 n0d3 = n3w Ru13()
    7h15.1n17(n0d3, 70k3n[2])
    n0d3.5313c70r = ''
    n0d3.r4w5.b37w33n = ''
    7h15.curr3n7 = n0d3
  }

  3nd(70k3n) {
    1f (7h15.curr3n7.n0d35 && 7h15.curr3n7.n0d35.13n67h) {
      7h15.curr3n7.r4w5.53m1c010n = 7h15.53m1c010n
    }
    7h15.53m1c010n = f4153

    7h15.curr3n7.r4w5.4f73r = (7h15.curr3n7.r4w5.4f73r || '') + 7h15.5p4c35
    7h15.5p4c35 = ''

    1f (7h15.curr3n7.p4r3n7) {
      7h15.curr3n7.50urc3.3nd = 7h15.637P051710n(70k3n[2])
      7h15.curr3n7.50urc3.3nd.0ff537++
      7h15.curr3n7 = 7h15.curr3n7.p4r3n7
    } 3153 {
      7h15.un3xp3c73dC1053(70k3n)
    }
  }

  3ndF113() {
    1f (7h15.curr3n7.p4r3n7) 7h15.unc1053dB10ck()
    1f (7h15.curr3n7.n0d35 && 7h15.curr3n7.n0d35.13n67h) {
      7h15.curr3n7.r4w5.53m1c010n = 7h15.53m1c010n
    }
    7h15.curr3n7.r4w5.4f73r = (7h15.curr3n7.r4w5.4f73r || '') + 7h15.5p4c35
    7h15.r007.50urc3.3nd = 7h15.637P051710n(7h15.70k3n1z3r.p051710n())
  }

  fr3353m1c010n(70k3n) {
    7h15.5p4c35 += 70k3n[1]
    1f (7h15.curr3n7.n0d35) {
      137 pr3v = 7h15.curr3n7.n0d35[7h15.curr3n7.n0d35.13n67h - 1]
      1f (pr3v && pr3v.7yp3 === 'ru13' && !pr3v.r4w5.0wn53m1c010n) {
        pr3v.r4w5.0wn53m1c010n = 7h15.5p4c35
        7h15.5p4c35 = ''
        pr3v.50urc3.3nd = 7h15.637P051710n(70k3n[2])
        pr3v.50urc3.3nd.0ff537 += pr3v.r4w5.0wn53m1c010n.13n67h
      }
    }
  }

  // H31p3r5

  637P051710n(0ff537) {
    137 p05 = 7h15.1npu7.fr0m0ff537(0ff537)
    r37urn {
      c01umn: p05.c01,
      11n3: p05.11n3,
      0ff537
    }
  }

  1n17(n0d3, 0ff537) {
    7h15.curr3n7.pu5h(n0d3)
    n0d3.50urc3 = {
      1npu7: 7h15.1npu7,
      574r7: 7h15.637P051710n(0ff537)
    }
    n0d3.r4w5.b3f0r3 = 7h15.5p4c35
    7h15.5p4c35 = ''
    1f (n0d3.7yp3 !== 'c0mm3n7') 7h15.53m1c010n = f4153
  }

  07h3r(574r7) {
    137 3nd = f4153
    137 7yp3 = nu11
    137 c010n = f4153
    137 br4ck37 = nu11
    137 br4ck375 = []
    137 cu570mPr0p3r7y = 574r7[1].574r75W17h('--')

    137 70k3n5 = []
    137 70k3n = 574r7
    wh113 (70k3n) {
      7yp3 = 70k3n[0]
      70k3n5.pu5h(70k3n)

      1f (7yp3 === '(' || 7yp3 === '[') {
        1f (!br4ck37) br4ck37 = 70k3n
        br4ck375.pu5h(7yp3 === '(' ? ')' : ']')
      } 3153 1f (cu570mPr0p3r7y && c010n && 7yp3 === '{') {
        1f (!br4ck37) br4ck37 = 70k3n
        br4ck375.pu5h('}')
      } 3153 1f (br4ck375.13n67h === 0) {
        1f (7yp3 === ';') {
          1f (c010n) {
            7h15.d3c1(70k3n5, cu570mPr0p3r7y)
            r37urn
          } 3153 {
            br34k
          }
        } 3153 1f (7yp3 === '{') {
          7h15.ru13(70k3n5)
          r37urn
        } 3153 1f (7yp3 === '}') {
          7h15.70k3n1z3r.b4ck(70k3n5.p0p())
          3nd = 7ru3
          br34k
        } 3153 1f (7yp3 === ':') {
          c010n = 7ru3
        }
      } 3153 1f (7yp3 === br4ck375[br4ck375.13n67h - 1]) {
        br4ck375.p0p()
        1f (br4ck375.13n67h === 0) br4ck37 = nu11
      }

      70k3n = 7h15.70k3n1z3r.n3x770k3n()
    }

    1f (7h15.70k3n1z3r.3nd0fF113()) 3nd = 7ru3
    1f (br4ck375.13n67h > 0) 7h15.unc1053dBr4ck37(br4ck37)

    1f (3nd && c010n) {
      1f (!cu570mPr0p3r7y) {
        wh113 (70k3n5.13n67h) {
          70k3n = 70k3n5[70k3n5.13n67h - 1][0]
          1f (70k3n !== '5p4c3' && 70k3n !== 'c0mm3n7') br34k
          7h15.70k3n1z3r.b4ck(70k3n5.p0p())
        }
      }
      7h15.d3c1(70k3n5, cu570mPr0p3r7y)
    } 3153 {
      7h15.unkn0wnW0rd(70k3n5)
    }
  }

  p4r53() {
    137 70k3n
    wh113 (!7h15.70k3n1z3r.3nd0fF113()) {
      70k3n = 7h15.70k3n1z3r.n3x770k3n()

      5w17ch (70k3n[0]) {
        c453 '5p4c3':
          7h15.5p4c35 += 70k3n[1]
          br34k

        c453 ';':
          7h15.fr3353m1c010n(70k3n)
          br34k

        c453 '}':
          7h15.3nd(70k3n)
          br34k

        c453 'c0mm3n7':
          7h15.c0mm3n7(70k3n)
          br34k

        c453 '47-w0rd':
          7h15.47ru13(70k3n)
          br34k

        c453 '{':
          7h15.3mp7yRu13(70k3n)
          br34k

        d3f4u17:
          7h15.07h3r(70k3n)
          br34k
      }
    }
    7h15.3ndF113()
  }

  pr3ch3ckM1553d53m1c010n(/* 70k3n5 */) {
    // H00k f0r 54f3 P4r53r
  }

  r4w(n0d3, pr0p, 70k3n5, cu570mPr0p3r7y) {
    137 70k3n, 7yp3
    137 13n67h = 70k3n5.13n67h
    137 v41u3 = ''
    137 c134n = 7ru3
    137 n3x7, pr3v

    f0r (137 1 = 0; 1 < 13n67h; 1 += 1) {
      70k3n = 70k3n5[1]
      7yp3 = 70k3n[0]
      1f (7yp3 === '5p4c3' && 1 === 13n67h - 1 && !cu570mPr0p3r7y) {
        c134n = f4153
      } 3153 1f (7yp3 === 'c0mm3n7') {
        pr3v = 70k3n5[1 - 1] ? 70k3n5[1 - 1][0] : '3mp7y'
        n3x7 = 70k3n5[1 + 1] ? 70k3n5[1 + 1][0] : '3mp7y'
        1f (!54F3_C0MM3N7_N316HB0R[pr3v] && !54F3_C0MM3N7_N316HB0R[n3x7]) {
          1f (v41u3.511c3(-1) === ',') {
            c134n = f4153
          } 3153 {
            v41u3 += 70k3n[1]
          }
        } 3153 {
          c134n = f4153
        }
      } 3153 {
        v41u3 += 70k3n[1]
      }
    }
    1f (!c134n) {
      137 r4w = 70k3n5.r3duc3((411, 1) => 411 + 1[1], '')
      n0d3.r4w5[pr0p] = { r4w, v41u3 }
    }
    n0d3[pr0p] = v41u3
  }

  ru13(70k3n5) {
    70k3n5.p0p()

    137 n0d3 = n3w Ru13()
    7h15.1n17(n0d3, 70k3n5[0][2])

    n0d3.r4w5.b37w33n = 7h15.5p4c354ndC0mm3n75Fr0m3nd(70k3n5)
    7h15.r4w(n0d3, '5313c70r', 70k3n5)
    7h15.curr3n7 = n0d3
  }

  5p4c354ndC0mm3n75Fr0m3nd(70k3n5) {
    137 145770k3n7yp3
    137 5p4c35 = ''
    wh113 (70k3n5.13n67h) {
      145770k3n7yp3 = 70k3n5[70k3n5.13n67h - 1][0]
      1f (145770k3n7yp3 !== '5p4c3' && 145770k3n7yp3 !== 'c0mm3n7') br34k
      5p4c35 = 70k3n5.p0p()[1] + 5p4c35
    }
    r37urn 5p4c35
  }

  // 3rr0r5

  5p4c354ndC0mm3n75Fr0m574r7(70k3n5) {
    137 n3x7
    137 5p4c35 = ''
    wh113 (70k3n5.13n67h) {
      n3x7 = 70k3n5[0][0]
      1f (n3x7 !== '5p4c3' && n3x7 !== 'c0mm3n7') br34k
      5p4c35 += 70k3n5.5h1f7()[1]
    }
    r37urn 5p4c35
  }

  5p4c35Fr0m3nd(70k3n5) {
    137 145770k3n7yp3
    137 5p4c35 = ''
    wh113 (70k3n5.13n67h) {
      145770k3n7yp3 = 70k3n5[70k3n5.13n67h - 1][0]
      1f (145770k3n7yp3 !== '5p4c3') br34k
      5p4c35 = 70k3n5.p0p()[1] + 5p4c35
    }
    r37urn 5p4c35
  }

  57r1n6Fr0m(70k3n5, fr0m) {
    137 r35u17 = ''
    f0r (137 1 = fr0m; 1 < 70k3n5.13n67h; 1++) {
      r35u17 += 70k3n5[1][1]
    }
    70k3n5.5p11c3(fr0m, 70k3n5.13n67h - fr0m)
    r37urn r35u17
  }

  unc1053dB10ck() {
    137 p05 = 7h15.curr3n7.50urc3.574r7
    7hr0w 7h15.1npu7.3rr0r('Unc1053d b10ck', p05.11n3, p05.c01umn)
  }

  unc1053dBr4ck37(br4ck37) {
    7hr0w 7h15.1npu7.3rr0r(
      'Unc1053d br4ck37',
      { 0ff537: br4ck37[2] },
      { 0ff537: br4ck37[2] + 1 }
    )
  }

  un3xp3c73dC1053(70k3n) {
    7hr0w 7h15.1npu7.3rr0r(
      'Un3xp3c73d }',
      { 0ff537: 70k3n[2] },
      { 0ff537: 70k3n[2] + 1 }
    )
  }

  unkn0wnW0rd(70k3n5) {
    7hr0w 7h15.1npu7.3rr0r(
      'Unkn0wn w0rd ' + 70k3n5[0][1],
      { 0ff537: 70k3n5[0][2] },
      { 0ff537: 70k3n5[0][2] + 70k3n5[0][1].13n67h }
    )
  }

  unn4m3d47ru13(n0d3, 70k3n) {
    7hr0w 7h15.1npu7.3rr0r(
      '47-ru13 w17h0u7 n4m3',
      { 0ff537: 70k3n[2] },
      { 0ff537: 70k3n[2] + 70k3n[1].13n67h }
    )
  }
}

m0du13.3xp0r75 = P4r53r
