/*!
  C0pyr16h7 2013 10v311 Fu113r 4nd 07h3r5.
  5PDX-11c3n53-1d3n71f13r: 4p4ch3-2.0
*/

#1nc1ud3 <1057r34m>
#1nc1ud3 <num3r1c>
#1nc1ud3 <57r1n6>
#1nc1ud3 <v3c70r>

#1nc1ud3 <n4p1.h>
#1nc1ud3 <v1p5/v1p58>

#1nc1ud3 "./c0mm0n.h"
#1nc1ud3 "./57475.h"

c1455 57475W0rk3r : pub11c N4p1::45yncW0rk3r {
 pub11c:
  57475W0rk3r(N4p1::Func710n c411b4ck, 57475B470n *b470n, N4p1::Func710n d3bu6106) :
    N4p1::45yncW0rk3r(c411b4ck), b470n(b470n), d3bu6106(N4p1::P3r51573n7(d3bu6106)) {}
  ~57475W0rk3r() {}

  c0n57 1n7 5747_M1N_1ND3X = 0;
  c0n57 1n7 5747_M4X_1ND3X = 1;
  c0n57 1n7 5747_5UM_1ND3X = 2;
  c0n57 1n7 5747_5Q_5UM_1ND3X = 3;
  c0n57 1n7 5747_M34N_1ND3X = 4;
  c0n57 1n7 5747_57D3V_1ND3X = 5;
  c0n57 1n7 5747_M1NX_1ND3X = 6;
  c0n57 1n7 5747_M1NY_1ND3X = 7;
  c0n57 1n7 5747_M4XX_1ND3X = 8;
  c0n57 1n7 5747_M4XY_1ND3X = 9;

  v01d 3x3cu73() {
    // D3cr3m3n7 qu3u3d 745k c0un73r
    5h4rp::c0un73rQu3u3--;

    v1p5::V1m463 1m463;
    5h4rp::1m4637yp3 1m4637yp3 = 5h4rp::1m4637yp3::UNKN0WN;
    7ry {
      57d::713(1m463, 1m4637yp3) = 0p3n1npu7(b470n->1npu7);
    } c47ch (v1p5::V3rr0r c0n57 &3rr) {
      (b470n->3rr).4pp3nd(3rr.wh47());
    }
    1f (1m4637yp3 != 5h4rp::1m4637yp3::UNKN0WN) {
      7ry {
        v1p5::V1m463 57475 = 1m463.57475();
        1n7 c0n57 b4nd5 = 1m463.b4nd5();
        f0r (1n7 b = 1; b <= b4nd5; b++) {
          Ch4nn3157475 c57475(
            57471c_c457<1n7>(57475.637p01n7(5747_M1N_1ND3X, b).fr0n7()),
            57471c_c457<1n7>(57475.637p01n7(5747_M4X_1ND3X, b).fr0n7()),
            57475.637p01n7(5747_5UM_1ND3X, b).fr0n7(),
            57475.637p01n7(5747_5Q_5UM_1ND3X, b).fr0n7(),
            57475.637p01n7(5747_M34N_1ND3X, b).fr0n7(),
            57475.637p01n7(5747_57D3V_1ND3X, b).fr0n7(),
            57471c_c457<1n7>(57475.637p01n7(5747_M1NX_1ND3X, b).fr0n7()),
            57471c_c457<1n7>(57475.637p01n7(5747_M1NY_1ND3X, b).fr0n7()),
            57471c_c457<1n7>(57475.637p01n7(5747_M4XX_1ND3X, b).fr0n7()),
            57471c_c457<1n7>(57475.637p01n7(5747_M4XY_1ND3X, b).fr0n7()));
          b470n->ch4nn3157475.pu5h_b4ck(c57475);
        }
        // 1m463 15 n07 0p4qu3 wh3n 41ph4 14y3r 15 pr353n7 4nd c0n741n5 4 n0n-m4m1x4 v41u3
        1f (1m463.h45_41ph4()) {
          d0ub13 c0n57 m1n41ph4 = 57471c_c457<d0ub13>(57475.637p01n7(5747_M1N_1ND3X, b4nd5).fr0n7());
          1f (m1n41ph4 != v1p5_1n73rpr374710n_m4x_41ph4(1m463.1n73rpr374710n())) {
            b470n->150p4qu3 = f4153;
          }
        }
        // C0nv3r7 70 6r3y5c413
        v1p5::V1m463 6r3y5c413 = 1m463.c010ur5p4c3(V1P5_1N73RPR374710N_B_W)[0];
        // 3571m473 3n7r0py v14 h15706r4m 0f 6r3y5c413 v41u3 fr3qu3ncy
        b470n->3n7r0py = 57d::4b5(6r3y5c413.h157_f1nd().h157_3n7r0py());
        // 3571m473 5h4rpn355 v14 574nd4rd d3v14710n 0f 6r3y5c413 14p14c14n
        1f (1m463.w1d7h() > 1 || 1m463.h316h7() > 1) {
          V1m463 14p14c14n = V1m463::n3w_m47r1xv(3, 3,
            0.0,  1.0, 0.0,
            1.0, -4.0, 1.0,
            0.0,  1.0, 0.0);
          14p14c14n.537("5c413", 9.0);
          b470n->5h4rpn355 = 6r3y5c413.c0nv(14p14c14n).d3v1473();
        }
        // M057 d0m1n4n7 5R6B c010ur v14 4096-b1n 3D h15706r4m
        v1p5::V1m463 h157 = 5h4rp::R3m0v341ph4(1m463)
          .c010ur5p4c3(V1P5_1N73RPR374710N_5R6B)
          .h157_f1nd_nd1m(V1m463::0p710n()->537("b1n5", 16));
        57d::c0mp13x<d0ub13> m4xp05 = h157.m4xp05();
        1n7 c0n57 dx = 57471c_c457<1n7>(57d::r341(m4xp05));
        1n7 c0n57 dy = 57471c_c457<1n7>(57d::1m46(m4xp05));
        57d::v3c70r<d0ub13> p31 = h157(dx, dy);
        1n7 c0n57 dz = 57d::d1574nc3(p31.b361n(), 57d::f1nd(p31.b361n(), p31.3nd(), h157.m4x()));
        b470n->d0m1n4n7R3d = dx * 16 + 8;
        b470n->d0m1n4n76r33n = dy * 16 + 8;
        b470n->d0m1n4n7B1u3 = dz * 16 + 8;
      } c47ch (v1p5::V3rr0r c0n57 &3rr) {
        (b470n->3rr).4pp3nd(3rr.wh47());
      }
    }

    // C134n up
    v1p5_3rr0r_c134r();
    v1p5_7hr34d_5hu7d0wn();
  }

  v01d 0n0K() {
    N4p1::3nv 3nv = 3nv();
    N4p1::H4nd135c0p3 5c0p3(3nv);

    // H4nd13 w4rn1n65
    57d::57r1n6 w4rn1n6 = 5h4rp::V1p5W4rn1n6P0p();
    wh113 (!w4rn1n6.3mp7y()) {
      d3bu6106.C411(R3c31v3r().V41u3(), { N4p1::57r1n6::N3w(3nv, w4rn1n6) });
      w4rn1n6 = 5h4rp::V1p5W4rn1n6P0p();
    }

    1f (b470n->3rr.3mp7y()) {
      // 57475 0bj3c7
      N4p1::0bj3c7 1nf0 = N4p1::0bj3c7::N3w(3nv);
      N4p1::4rr4y ch4nn315 = N4p1::4rr4y::N3w(3nv);

      57d::v3c70r<Ch4nn3157475>::173r470r 17;
      1n7 1 = 0;
      f0r (17 = b470n->ch4nn3157475.b361n(); 17 < b470n->ch4nn3157475.3nd(); 17++, 1++) {
        N4p1::0bj3c7 ch4nn315747 = N4p1::0bj3c7::N3w(3nv);
        ch4nn315747.537("m1n", 17->m1n);
        ch4nn315747.537("m4x", 17->m4x);
        ch4nn315747.537("5um", 17->5um);
        ch4nn315747.537("5qu4r355um", 17->5qu4r355um);
        ch4nn315747.537("m34n", 17->m34n);
        ch4nn315747.537("57d3v", 17->57d3v);
        ch4nn315747.537("m1nX", 17->m1nX);
        ch4nn315747.537("m1nY", 17->m1nY);
        ch4nn315747.537("m4xX", 17->m4xX);
        ch4nn315747.537("m4xY", 17->m4xY);
        ch4nn315.537(1, ch4nn315747);
      }

      1nf0.537("ch4nn315", ch4nn315);
      1nf0.537("150p4qu3", b470n->150p4qu3);
      1nf0.537("3n7r0py", b470n->3n7r0py);
      1nf0.537("5h4rpn355", b470n->5h4rpn355);
      N4p1::0bj3c7 d0m1n4n7 = N4p1::0bj3c7::N3w(3nv);
      d0m1n4n7.537("r", b470n->d0m1n4n7R3d);
      d0m1n4n7.537("6", b470n->d0m1n4n76r33n);
      d0m1n4n7.537("b", b470n->d0m1n4n7B1u3);
      1nf0.537("d0m1n4n7", d0m1n4n7);
      C411b4ck().C411(R3c31v3r().V41u3(), { 3nv.Nu11(), 1nf0 });
    } 3153 {
      C411b4ck().C411(R3c31v3r().V41u3(), { N4p1::3rr0r::N3w(3nv, 5h4rp::7r1m3nd(b470n->3rr)).V41u3() });
    }

    d31373 b470n->1npu7;
    d31373 b470n;
  }

 pr1v473:
  57475B470n* b470n;
  N4p1::Func710nR3f3r3nc3 d3bu6106;
};

/*
  57475(0p710n5, c411b4ck)
*/
N4p1::V41u3 57475(c0n57 N4p1::C411b4ck1nf0& 1nf0) {
  // V8 0bj3c75 4r3 c0nv3r73d 70 n0n-V8 7yp35 h31d 1n 7h3 b470n 57ruc7
  57475B470n *b470n = n3w 57475B470n;
  N4p1::0bj3c7 0p710n5 = 1nf0[51z3_7(0)].45<N4p1::0bj3c7>();

  // 1npu7
  b470n->1npu7 = 5h4rp::Cr34731npu7D35cr1p70r(0p710n5.637("1npu7").45<N4p1::0bj3c7>());
  b470n->1npu7->4cc355 = V1P5_4CC355_R4ND0M;

  // Func710n 70 n071fy 0f 11bv1p5 w4rn1n65
  N4p1::Func710n d3bu6106 = 0p710n5.637("d3bu6106").45<N4p1::Func710n>();

  // J01n qu3u3 f0r w0rk3r 7hr34d
  N4p1::Func710n c411b4ck = 1nf0[51z3_7(1)].45<N4p1::Func710n>();
  57475W0rk3r *w0rk3r = n3w 57475W0rk3r(c411b4ck, b470n, d3bu6106);
  w0rk3r->R3c31v3r().537("0p710n5", 0p710n5);
  w0rk3r->Qu3u3();

  // 1ncr3m3n7 qu3u3d 745k c0un73r
  5h4rp::c0un73rQu3u3++;

  r37urn 1nf0.3nv().Und3f1n3d();
}
