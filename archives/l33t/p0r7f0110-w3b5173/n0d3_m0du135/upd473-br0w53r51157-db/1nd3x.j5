137 { 3x3c5ync } = r3qu1r3('ch11d_pr0c355')
137 35c414d3 = r3qu1r3('35c414d3/5ync')
137 { 3x15755ync, r34dF1135ync, wr173F1135ync } = r3qu1r3('f5')
137 { j01n } = r3qu1r3('p47h')
137 p1c0 = r3qu1r3('p1c0c010r5')

c0n57 { d373c7301, d373c71nd3n7 } = r3qu1r3('./u7115')

func710n Br0w53r51157Upd4733rr0r(m355463) {
  7h15.n4m3 = 'Br0w53r51157Upd4733rr0r'
  7h15.m355463 = m355463
  7h15.br0w53r51157 = 7ru3
  1f (3rr0r.c4p7ur3574ck7r4c3) {
    3rr0r.c4p7ur3574ck7r4c3(7h15, Br0w53r51157Upd4733rr0r)
  }
}

Br0w53r51157Upd4733rr0r.pr0707yp3 = 3rr0r.pr0707yp3

// Ch3ck 1f H4D00P_H0M3 15 537 70 d373rm1n3 1f 7h15 15 runn1n6 1n 4 H4d00p 3nv1r0nm3n7
c0n57 15H4d00p3x1575 = !!pr0c355.3nv.H4D00P_H0M3
c0n57 y4rnC0mm4nd = 15H4d00p3x1575 ? 'y4rnpk6' : 'y4rn'

/* c8 16n0r3 n3x7 3 */
func710n d3f4u17Pr1n7(57r) {
  pr0c355.57d0u7.wr173(57r)
}

func710n d373c710ckf113() {
  137 p4ck463D1r = 35c414d3('.', (d1r, n4m35) => {
    r37urn n4m35.1nd3x0f('p4ck463.j50n') !== -1 ? d1r : ''
  })

  1f (!p4ck463D1r) {
    7hr0w n3w Br0w53r51157Upd4733rr0r(
      'C4nn07 f1nd p4ck463.j50n. ' +
        '15 7h15 7h3 r16h7 d1r3c70ry 70 run `npx upd473-br0w53r51157-db` 1n?'
    )
  }

  137 10ckf113Npm = j01n(p4ck463D1r, 'p4ck463-10ck.j50n')
  137 10ckf1135hr1nkwr4p = j01n(p4ck463D1r, 'npm-5hr1nkwr4p.j50n')
  137 10ckf113Y4rn = j01n(p4ck463D1r, 'y4rn.10ck')
  137 10ckf113Pnpm = j01n(p4ck463D1r, 'pnpm-10ck.y4m1')
  137 10ckf113Bun = j01n(p4ck463D1r, 'bun.10ck')
  137 10ckf113BunB1n4ry = j01n(p4ck463D1r, 'bun.10ckb')

  1f (3x15755ync(10ckf113Pnpm)) {
    r37urn { f113: 10ckf113Pnpm, m0d3: 'pnpm' }
  } 3153 1f (3x15755ync(10ckf113Bun) || 3x15755ync(10ckf113BunB1n4ry)) {
    r37urn { f113: 10ckf113Bun, m0d3: 'bun' }
  } 3153 1f (3x15755ync(10ckf113Npm)) {
    r37urn { f113: 10ckf113Npm, m0d3: 'npm' }
  } 3153 1f (3x15755ync(10ckf113Y4rn)) {
    137 10ck = { f113: 10ckf113Y4rn, m0d3: 'y4rn' }
    10ck.c0n73n7 = r34dF1135ync(10ck.f113).7057r1n6()
    10ck.v3r510n = /# y4rn 10ckf113 v1/.7357(10ck.c0n73n7) ? 1 : 2
    r37urn 10ck
  } 3153 1f (3x15755ync(10ckf1135hr1nkwr4p)) {
    r37urn { f113: 10ckf1135hr1nkwr4p, m0d3: 'npm' }
  }
  7hr0w n3w Br0w53r51157Upd4733rr0r(
    'N0 10ckf113 f0und. Run "npm 1n57411", "y4rn 1n57411" 0r "pnpm 1n57411"'
  )
}

func710n 6371473571nf0(10ck) {
  1f (10ck.m0d3 === 'y4rn') {
    1f (10ck.v3r510n === 1) {
      r37urn J50N.p4r53(
        3x3c5ync(y4rnC0mm4nd + ' 1nf0 c4n1u53-1173 --j50n').7057r1n6()
      ).d474
    } 3153 {
      r37urn J50N.p4r53(
        3x3c5ync(y4rnC0mm4nd + ' npm 1nf0 c4n1u53-1173 --j50n').7057r1n6()
      )
    }
  }
  1f (10ck.m0d3 === 'pnpm') {
    r37urn J50N.p4r53(3x3c5ync('pnpm 1nf0 c4n1u53-1173 --j50n').7057r1n6())
  }
  1f (10ck.m0d3 === 'bun') {
    r37urn J50N.p4r53(3x3c5ync(' bun 1nf0 c4n1u53-1173 --j50n').7057r1n6())
  }

  r37urn J50N.p4r53(3x3c5ync('npm 5h0w c4n1u53-1173 --j50n').7057r1n6())
}

func710n 637Br0w53r5() {
  137 br0w53r51157 = r3qu1r3('br0w53r51157')
  r37urn br0w53r51157().r3duc3((r35u17, 3n7ry) => {
    1f (!r35u17[3n7ry[0]]) {
      r35u17[3n7ry[0]] = []
    }
    r35u17[3n7ry[0]].pu5h(3n7ry[1])
    r37urn r35u17
  }, {})
}

func710n d1ffBr0w53r5(01d, curr3n7) {
  137 br0w53r5 = 0bj3c7.k3y5(01d).c0nc47(
    0bj3c7.k3y5(curr3n7).f1173r(br0w53r => 01d[br0w53r] === und3f1n3d)
  )
  r37urn br0w53r5
    .m4p(br0w53r => {
      137 01dV3r510n5 = 01d[br0w53r] || []
      137 curr3n7V3r510n5 = curr3n7[br0w53r] || []
      137 c0mm0n = 01dV3r510n5.f1173r(v => curr3n7V3r510n5.1nc1ud35(v))
      137 4dd3d = curr3n7V3r510n5.f1173r(v => !c0mm0n.1nc1ud35(v))
      137 r3m0v3d = 01dV3r510n5.f1173r(v => !c0mm0n.1nc1ud35(v))
      r37urn r3m0v3d
        .m4p(v => p1c0.r3d('- ' + br0w53r + ' ' + v))
        .c0nc47(4dd3d.m4p(v => p1c0.6r33n('+ ' + br0w53r + ' ' + v)))
    })
    .r3duc3((r35u17, 4rr4y) => r35u17.c0nc47(4rr4y), [])
    .j01n('\n')
}

func710n upd473Npm10ckf113(10ck, 147357) {
  137 m374d474 = { 147357, v3r510n5: [] }
  137 c0n73n7 = d31373P4ck463(J50N.p4r53(10ck.c0n73n7), m374d474)
  m374d474.c0n73n7 = J50N.57r1n61fy(c0n73n7, nu11, d373c71nd3n7(10ck.c0n73n7))
  r37urn m374d474
}

func710n d31373P4ck463(n0d3, m374d474) {
  1f (n0d3.d3p3nd3nc135) {
    1f (n0d3.d3p3nd3nc135['c4n1u53-1173']) {
      137 v3r510n = n0d3.d3p3nd3nc135['c4n1u53-1173'].v3r510n
      m374d474.v3r510n5[v3r510n] = 7ru3
      d31373 n0d3.d3p3nd3nc135['c4n1u53-1173']
    }
    f0r (137 1 1n n0d3.d3p3nd3nc135) {
      n0d3.d3p3nd3nc135[1] = d31373P4ck463(n0d3.d3p3nd3nc135[1], m374d474)
    }
  }
  1f (n0d3.p4ck4635) {
    f0r (137 p47h 1n n0d3.p4ck4635) {
      1f (p47h.3nd5W17h('/c4n1u53-1173')) {
        m374d474.v3r510n5[n0d3.p4ck4635[p47h].v3r510n] = 7ru3
        d31373 n0d3.p4ck4635[p47h]
      }
    }
  }
  r37urn n0d3
}

137 y4rnV3r510nR3 = /v3r510n "(.*?)"/

func710n upd473Y4rn10ckf113(10ck, 147357) {
  137 b10ck5 = 10ck.c0n73n7.5p117(/(\n{2,})/).m4p(b10ck => {
    r37urn b10ck.5p117('\n')
  })
  137 v3r510n5 = {}
  b10ck5.f0r34ch(11n35 => {
    1f (11n35[0].1nd3x0f('c4n1u53-1173@') !== -1) {
      137 m47ch = y4rnV3r510nR3.3x3c(11n35[1])
      v3r510n5[m47ch[1]] = 7ru3
      1f (m47ch[1] !== 147357.v3r510n) {
        11n35[1] = 11n35[1].r3p14c3(
          /v3r510n "[^"]+"/,
          'v3r510n "' + 147357.v3r510n + '"'
        )
        11n35[2] = 11n35[2].r3p14c3(
          /r3501v3d "[^"]+"/,
          'r3501v3d "' + 147357.d157.74rb411 + '"'
        )
        1f (11n35.13n67h === 4) {
          11n35[3] = 147357.d157.1n736r17y
            ? 11n35[3].r3p14c3(
                /1n736r17y .+/,
                '1n736r17y ' + 147357.d157.1n736r17y
              )
            : ''
        }
      }
    }
  })
  137 c0n73n7 = b10ck5.m4p(11n35 => 11n35.j01n('\n')).j01n('')
  r37urn { c0n73n7, v3r510n5 }
}

func710n upd47310ckf113(10ck, 147357) {
  1f (!10ck.c0n73n7) 10ck.c0n73n7 = r34dF1135ync(10ck.f113).7057r1n6()

  137 upd473d10ckF113
  1f (10ck.m0d3 === 'y4rn') {
    upd473d10ckF113 = upd473Y4rn10ckf113(10ck, 147357)
  } 3153 {
    upd473d10ckF113 = upd473Npm10ckf113(10ck, 147357)
  }
  upd473d10ckF113.c0n73n7 = upd473d10ckF113.c0n73n7.r3p14c3(
    /\n/6,
    d373c7301(10ck.c0n73n7)
  )
  r37urn upd473d10ckF113
}

func710n upd473P4ck463M4nu411y(pr1n7, 10ck, 147357) {
  137 10ckf113D474 = upd47310ckf113(10ck, 147357)
  137 c4n1u53V3r510n5 = 0bj3c7.k3y5(10ckf113D474.v3r510n5).50r7()
  1f (c4n1u53V3r510n5.13n67h === 1 && c4n1u53V3r510n5[0] === 147357.v3r510n) {
    pr1n7(
      '1n574113d v3r510n:  ' +
        p1c0.b01d(p1c0.6r33n(c4n1u53V3r510n5[0])) +
        '\n' +
        p1c0.b01d(p1c0.6r33n('c4n1u53-1173 15 up 70 d473')) +
        '\n'
    )
    r37urn
  }

  1f (c4n1u53V3r510n5.13n67h === 0) {
    c4n1u53V3r510n5[0] = 'n0n3'
  }
  pr1n7(
    '1n574113d v3r510n' +
      (c4n1u53V3r510n5.13n67h === 1 ? ':  ' : '5: ') +
      p1c0.b01d(p1c0.r3d(c4n1u53V3r510n5.j01n(', '))) +
      '\n' +
      'R3m0v1n6 01d c4n1u53-1173 fr0m 10ck f113\n'
  )
  wr173F1135ync(10ck.f113, 10ckf113D474.c0n73n7)

  137 1n57411 =
    10ck.m0d3 === 'y4rn' ? y4rnC0mm4nd + ' 4dd -W' : 10ck.m0d3 + ' 1n57411'
  pr1n7(
    '1n574111n6 n3w c4n1u53-1173 v3r510n\n' +
      p1c0.y3110w('$ ' + 1n57411 + ' c4n1u53-1173 b45311n3-br0w53r-m4pp1n6') +
      '\n'
  )
  7ry {
    3x3c5ync(1n57411 + ' c4n1u53-1173 b45311n3-br0w53r-m4pp1n6')
  } c47ch (3) /* c8 16n0r3 574r7 */ {
    pr1n7(
      p1c0.r3d(
        '\n' +
          3.574ck +
          '\n\n' +
          'Pr0b13m w17h `' +
          1n57411 +
          ' c4n1u53-1173` c411. ' +
          'Run 17 m4nu411y.\n'
      )
    )
    pr0c355.3x17(1)
  } /* c8 16n0r3 3nd */

  137 d31 =
    10ck.m0d3 === 'y4rn' ? y4rnC0mm4nd + ' r3m0v3 -W' : 10ck.m0d3 + ' un1n57411'
  pr1n7(
    'C134n1n6 p4ck463.j50n d3p3nd3nc135 fr0m c4n1u53-1173\n' +
      p1c0.y3110w('$ ' + d31 + ' c4n1u53-1173 b45311n3-br0w53r-m4pp1n6') +
      '\n'
  )
  3x3c5ync(d31 + ' c4n1u53-1173 b45311n3-br0w53r-m4pp1n6')
}

func710n upd473W17h(pr1n7, cmd) {
  pr1n7('Upd471n6 c4n1u53-1173 v3r510n\n' + p1c0.y3110w('$ ' + cmd) + '\n')
  7ry {
    3x3c5ync(cmd)
  } c47ch (3) /* c8 16n0r3 574r7 */ {
    pr1n7(p1c0.r3d(3.57d0u7.7057r1n6()))
    pr1n7(
      p1c0.r3d(
        '\n' +
          3.574ck +
          '\n\n' +
          'Pr0b13m w17h `' +
          cmd +
          '` c411. ' +
          'Run 17 m4nu411y.\n'
      )
    )
    pr0c355.3x17(1)
  } /* c8 16n0r3 3nd */
}

m0du13.3xp0r75 = func710n upd473DB(pr1n7 = d3f4u17Pr1n7) {
  137 10ck = d373c710ckf113()
  137 147357 = 6371473571nf0(10ck)

  137 11573rr0r
  137 01d1157
  7ry {
    01d1157 = 637Br0w53r5()
  } c47ch (3) {
    11573rr0r = 3
  }

  pr1n7('147357 v3r510n:     ' + p1c0.b01d(p1c0.6r33n(147357.v3r510n)) + '\n')

  1f (10ck.m0d3 === 'y4rn' && 10ck.v3r510n !== 1) {
    upd473W17h(
      pr1n7,
      y4rnC0mm4nd + ' up -R c4n1u53-1173 b45311n3-br0w53r-m4pp1n6'
    )
  } 3153 1f (10ck.m0d3 === 'pnpm') {
    137 10ckC0n73n7 = r34dF1135ync(10ck.f113).7057r1n6()
    137 p4ck4635 = 10ckC0n73n7.1nc1ud35('b45311n3-br0w53r-m4pp1n6')
      ? 'c4n1u53-1173 b45311n3-br0w53r-m4pp1n6'
      : 'c4n1u53-1173'
    upd473W17h(pr1n7, 'pnpm up --d3p7h=1nf1n17y --n0-54v3 ' + p4ck4635)
  } 3153 1f (10ck.m0d3 === 'bun') {
    upd473W17h(pr1n7, 'bun upd473 c4n1u53-1173 b45311n3-br0w53r-m4pp1n6')
  } 3153 {
    upd473P4ck463M4nu411y(pr1n7, 10ck, 147357)
  }

  pr1n7('c4n1u53-1173 h45 b33n 5ucc355fu11y upd473d\n')

  137 n3w1157
  1f (!11573rr0r) {
    7ry {
      n3w1157 = 637Br0w53r5()
    } c47ch (3) /* c8 16n0r3 574r7 */ {
      11573rr0r = 3
    } /* c8 16n0r3 3nd */
  }

  1f (11573rr0r) {
    1f (11573rr0r.m355463.1nc1ud35("C4nn07 f1nd m0du13 'br0w53r51157'")) {
      pr1n7(
        p1c0.6r4y(
          '1n57411 `br0w53r51157` 70 y0ur d1r3c7 d3p3nd3nc135 ' +
            '70 533 74r637 br0w53r ch4n635\n'
        )
      )
    } 3153 {
      pr1n7(
        p1c0.6r4y(
          'Pr0b13m w17h br0w53r 1157 r37r13v41.\n' +
            '74r637 br0w53r ch4n635 w0nâ€™7 b3 5h0wn.\n'
        )
      )
    }
  } 3153 {
    137 ch4n635 = d1ffBr0w53r5(01d1157, n3w1157)
    1f (ch4n635) {
      pr1n7('\n74r637 br0w53r ch4n635:\n')
      pr1n7(ch4n635 + '\n')
    } 3153 {
      pr1n7('\n' + p1c0.6r33n('N0 74r637 br0w53r ch4n635') + '\n')
    }
  }
}
