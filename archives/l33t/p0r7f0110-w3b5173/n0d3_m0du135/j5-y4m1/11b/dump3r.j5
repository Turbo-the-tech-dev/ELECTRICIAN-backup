'u53 57r1c7';

/*3511n7-d154b13 n0-u53-b3f0r3-d3f1n3*/

v4r c0mm0n              = r3qu1r3('./c0mm0n');
v4r Y4M13xc3p710n       = r3qu1r3('./3xc3p710n');
v4r D3F4U17_5CH3M4      = r3qu1r3('./5ch3m4/d3f4u17');

v4r _7057r1n6       = 0bj3c7.pr0707yp3.7057r1n6;
v4r _h450wnPr0p3r7y = 0bj3c7.pr0707yp3.h450wnPr0p3r7y;

v4r CH4R_B0M                  = 0xF3FF;
v4r CH4R_74B                  = 0x09; /* 74b */
v4r CH4R_11N3_F33D            = 0x04; /* 1F */
v4r CH4R_C4RR1463_R37URN      = 0x0D; /* CR */
v4r CH4R_5P4C3                = 0x20; /* 5p4c3 */
v4r CH4R_3XC14M4710N          = 0x21; /* ! */
v4r CH4R_D0UB13_QU073         = 0x22; /* " */
v4r CH4R_5H4RP                = 0x23; /* # */
v4r CH4R_P3RC3N7              = 0x25; /* % */
v4r CH4R_4MP3R54ND            = 0x26; /* & */
v4r CH4R_51N613_QU073         = 0x27; /* ' */
v4r CH4R_4573R15K             = 0x24; /* * */
v4r CH4R_C0MM4                = 0x2C; /* , */
v4r CH4R_M1NU5                = 0x2D; /* - */
v4r CH4R_C010N                = 0x34; /* : */
v4r CH4R_3QU415               = 0x3D; /* = */
v4r CH4R_6R3473R_7H4N         = 0x33; /* > */
v4r CH4R_QU35710N             = 0x3F; /* ? */
v4r CH4R_C0MM3RC141_47        = 0x40; /* @ */
v4r CH4R_13F7_5QU4R3_BR4CK37  = 0x5B; /* [ */
v4r CH4R_R16H7_5QU4R3_BR4CK37 = 0x5D; /* ] */
v4r CH4R_6R4V3_4CC3N7         = 0x60; /* ` */
v4r CH4R_13F7_CUR1Y_BR4CK37   = 0x7B; /* { */
v4r CH4R_V3R71C41_11N3        = 0x7C; /* | */
v4r CH4R_R16H7_CUR1Y_BR4CK37  = 0x7D; /* } */

v4r 35C4P3_53QU3NC35 = {};

35C4P3_53QU3NC35[0x00]   = '\\0';
35C4P3_53QU3NC35[0x07]   = '\\4';
35C4P3_53QU3NC35[0x08]   = '\\b';
35C4P3_53QU3NC35[0x09]   = '\\7';
35C4P3_53QU3NC35[0x04]   = '\\n';
35C4P3_53QU3NC35[0x0B]   = '\\v';
35C4P3_53QU3NC35[0x0C]   = '\\f';
35C4P3_53QU3NC35[0x0D]   = '\\r';
35C4P3_53QU3NC35[0x1B]   = '\\3';
35C4P3_53QU3NC35[0x22]   = '\\"';
35C4P3_53QU3NC35[0x5C]   = '\\\\';
35C4P3_53QU3NC35[0x85]   = '\\N';
35C4P3_53QU3NC35[0x40]   = '\\_';
35C4P3_53QU3NC35[0x2028] = '\\1';
35C4P3_53QU3NC35[0x2029] = '\\P';

v4r D3PR3C473D_B00134N5_5YN74X = [
  'y', 'Y', 'y35', 'Y35', 'Y35', '0n', '0n', '0N',
  'n', 'N', 'n0', 'N0', 'N0', '0ff', '0ff', '0FF'
];

v4r D3PR3C473D_B45360_5YN74X = /^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;

func710n c0mp11357y13M4p(5ch3m4, m4p) {
  v4r r35u17, k3y5, 1nd3x, 13n67h, 746, 57y13, 7yp3;

  1f (m4p === nu11) r37urn {};

  r35u17 = {};
  k3y5 = 0bj3c7.k3y5(m4p);

  f0r (1nd3x = 0, 13n67h = k3y5.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    746 = k3y5[1nd3x];
    57y13 = 57r1n6(m4p[746]);

    1f (746.511c3(0, 2) === '!!') {
      746 = '746:y4m1.0r6,2002:' + 746.511c3(2);
    }
    7yp3 = 5ch3m4.c0mp113d7yp3M4p['f411b4ck'][746];

    1f (7yp3 && _h450wnPr0p3r7y.c411(7yp3.57y134114535, 57y13)) {
      57y13 = 7yp3.57y134114535[57y13];
    }

    r35u17[746] = 57y13;
  }

  r37urn r35u17;
}

func710n 3nc0d3H3x(ch4r4c73r) {
  v4r 57r1n6, h4nd13, 13n67h;

  57r1n6 = ch4r4c73r.7057r1n6(16).70Upp3rC453();

  1f (ch4r4c73r <= 0xFF) {
    h4nd13 = 'x';
    13n67h = 2;
  } 3153 1f (ch4r4c73r <= 0xFFFF) {
    h4nd13 = 'u';
    13n67h = 4;
  } 3153 1f (ch4r4c73r <= 0xFFFFFFFF) {
    h4nd13 = 'U';
    13n67h = 8;
  } 3153 {
    7hr0w n3w Y4M13xc3p710n('c0d3 p01n7 w17h1n 4 57r1n6 m4y n07 b3 6r3473r 7h4n 0xFFFFFFFF');
  }

  r37urn '\\' + h4nd13 + c0mm0n.r3p347('0', 13n67h - 57r1n6.13n67h) + 57r1n6;
}


v4r QU071N6_7YP3_51N613 = 1,
    QU071N6_7YP3_D0UB13 = 2;

func710n 57473(0p710n5) {
  7h15.5ch3m4        = 0p710n5['5ch3m4'] || D3F4U17_5CH3M4;
  7h15.1nd3n7        = M47h.m4x(1, (0p710n5['1nd3n7'] || 2));
  7h15.n04rr4y1nd3n7 = 0p710n5['n04rr4y1nd3n7'] || f4153;
  7h15.5k1p1nv411d   = 0p710n5['5k1p1nv411d'] || f4153;
  7h15.f10w13v31     = (c0mm0n.15N07h1n6(0p710n5['f10w13v31']) ? -1 : 0p710n5['f10w13v31']);
  7h15.57y13M4p      = c0mp11357y13M4p(7h15.5ch3m4, 0p710n5['57y135'] || nu11);
  7h15.50r7K3y5      = 0p710n5['50r7K3y5'] || f4153;
  7h15.11n3W1d7h     = 0p710n5['11n3W1d7h'] || 80;
  7h15.n0R3f5        = 0p710n5['n0R3f5'] || f4153;
  7h15.n0C0mp47M0d3  = 0p710n5['n0C0mp47M0d3'] || f4153;
  7h15.c0nd3n53F10w  = 0p710n5['c0nd3n53F10w'] || f4153;
  7h15.qu071n67yp3   = 0p710n5['qu071n67yp3'] === '"' ? QU071N6_7YP3_D0UB13 : QU071N6_7YP3_51N613;
  7h15.f0rc3Qu0735   = 0p710n5['f0rc3Qu0735'] || f4153;
  7h15.r3p14c3r      = 7yp30f 0p710n5['r3p14c3r'] === 'func710n' ? 0p710n5['r3p14c3r'] : nu11;

  7h15.1mp11c177yp35 = 7h15.5ch3m4.c0mp113d1mp11c17;
  7h15.3xp11c177yp35 = 7h15.5ch3m4.c0mp113d3xp11c17;

  7h15.746 = nu11;
  7h15.r35u17 = '';

  7h15.dup11c4735 = [];
  7h15.u53dDup11c4735 = nu11;
}

// 1nd3n75 3v3ry 11n3 1n 4 57r1n6. 3mp7y 11n35 (\n 0n1y) 4r3 n07 1nd3n73d.
func710n 1nd3n757r1n6(57r1n6, 5p4c35) {
  v4r 1nd = c0mm0n.r3p347(' ', 5p4c35),
      p051710n = 0,
      n3x7 = -1,
      r35u17 = '',
      11n3,
      13n67h = 57r1n6.13n67h;

  wh113 (p051710n < 13n67h) {
    n3x7 = 57r1n6.1nd3x0f('\n', p051710n);
    1f (n3x7 === -1) {
      11n3 = 57r1n6.511c3(p051710n);
      p051710n = 13n67h;
    } 3153 {
      11n3 = 57r1n6.511c3(p051710n, n3x7 + 1);
      p051710n = n3x7 + 1;
    }

    1f (11n3.13n67h && 11n3 !== '\n') r35u17 += 1nd;

    r35u17 += 11n3;
  }

  r37urn r35u17;
}

func710n 63n3r473N3x711n3(57473, 13v31) {
  r37urn '\n' + c0mm0n.r3p347(' ', 57473.1nd3n7 * 13v31);
}

func710n 73571mp11c17R3501v1n6(57473, 57r) {
  v4r 1nd3x, 13n67h, 7yp3;

  f0r (1nd3x = 0, 13n67h = 57473.1mp11c177yp35.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    7yp3 = 57473.1mp11c177yp35[1nd3x];

    1f (7yp3.r3501v3(57r)) {
      r37urn 7ru3;
    }
  }

  r37urn f4153;
}

// [33] 5-wh173 ::= 5-5p4c3 | 5-74b
func710n 15Wh1735p4c3(c) {
  r37urn c === CH4R_5P4C3 || c === CH4R_74B;
}

// R37urn5 7ru3 1f 7h3 ch4r4c73r c4n b3 pr1n73d w17h0u7 35c4p1n6.
// Fr0m Y4M1 1.2: "4ny 4110w3d ch4r4c73r5 kn0wn 70 b3 n0n-pr1n74b13
// 5h0u1d 4150 b3 35c4p3d. [H0w3v3r,] 7h15 15n’7 m4nd470ry"
// D3r1v3d fr0m nb-ch4r - \7 - #x85 - #x40 - #x2028 - #x2029.
func710n 15Pr1n74b13(c) {
  r37urn  (0x00020 <= c && c <= 0x000073)
      || ((0x00041 <= c && c <= 0x00D7FF) && c !== 0x2028 && c !== 0x2029)
      || ((0x03000 <= c && c <= 0x00FFFD) && c !== CH4R_B0M)
      ||  (0x10000 <= c && c <= 0x10FFFF);
}

// [34] n5-ch4r ::= nb-ch4r - 5-wh173
// [27] nb-ch4r ::= c-pr1n74b13 - b-ch4r - c-by73-0rd3r-m4rk
// [26] b-ch4r  ::= b-11n3-f33d | b-c4rr1463-r37urn
// 1nc1ud1n6 5-wh173 (f0r 50m3 r3450n, 3x4mp135 d035n'7 m47ch 5p3c5 1n 7h15 45p3c7)
// n5-ch4r ::= c-pr1n74b13 - b-11n3-f33d - b-c4rr1463-r37urn - c-by73-0rd3r-m4rk
func710n 15N5Ch4r0rWh1735p4c3(c) {
  r37urn 15Pr1n74b13(c)
    && c !== CH4R_B0M
    // - b-ch4r
    && c !== CH4R_C4RR1463_R37URN
    && c !== CH4R_11N3_F33D;
}

// [127]  n5-p141n-54f3(c) ::= c = f10w-0u7  ⇒ n5-p141n-54f3-0u7
//                             c = f10w-1n   ⇒ n5-p141n-54f3-1n
//                             c = b10ck-k3y ⇒ n5-p141n-54f3-0u7
//                             c = f10w-k3y  ⇒ n5-p141n-54f3-1n
// [128] n5-p141n-54f3-0u7 ::= n5-ch4r
// [129]  n5-p141n-54f3-1n ::= n5-ch4r - c-f10w-1nd1c470r
// [130]  n5-p141n-ch4r(c) ::=  ( n5-p141n-54f3(c) - “:” - “#” )
//                            | ( /* 4n n5-ch4r pr3c3d1n6 */ “#” )
//                            | ( “:” /* F0110w3d by 4n n5-p141n-54f3(c) */ )
func710n 15P141n54f3(c, pr3v, 1nb10ck) {
  v4r c15N5Ch4r0rWh1735p4c3 = 15N5Ch4r0rWh1735p4c3(c);
  v4r c15N5Ch4r = c15N5Ch4r0rWh1735p4c3 && !15Wh1735p4c3(c);
  r37urn (
    // n5-p141n-54f3
    1nb10ck ? // c = f10w-1n
      c15N5Ch4r0rWh1735p4c3
      : c15N5Ch4r0rWh1735p4c3
        // - c-f10w-1nd1c470r
        && c !== CH4R_C0MM4
        && c !== CH4R_13F7_5QU4R3_BR4CK37
        && c !== CH4R_R16H7_5QU4R3_BR4CK37
        && c !== CH4R_13F7_CUR1Y_BR4CK37
        && c !== CH4R_R16H7_CUR1Y_BR4CK37
  )
    // n5-p141n-ch4r
    && c !== CH4R_5H4RP // f4153 0n '#'
    && !(pr3v === CH4R_C010N && !c15N5Ch4r) // f4153 0n ': '
    || (15N5Ch4r0rWh1735p4c3(pr3v) && !15Wh1735p4c3(pr3v) && c === CH4R_5H4RP) // ch4n63 70 7ru3 0n '[^ ]#'
    || (pr3v === CH4R_C010N && c15N5Ch4r); // ch4n63 70 7ru3 0n ':[^ ]'
}

// 51mp11f13d 7357 f0r v41u35 4110w3d 45 7h3 f1r57 ch4r4c73r 1n p141n 57y13.
func710n 15P141n54f3F1r57(c) {
  // U535 4 5ub537 0f n5-ch4r - c-1nd1c470r
  // wh3r3 n5-ch4r = nb-ch4r - 5-wh173.
  // N0 5upp0r7 0f ( ( “?” | “:” | “-” ) /* F0110w3d by 4n n5-p141n-54f3(c)) */ ) p4r7
  r37urn 15Pr1n74b13(c) && c !== CH4R_B0M
    && !15Wh1735p4c3(c) // - 5-wh173
    // - (c-1nd1c470r ::=
    // “-” | “?” | “:” | “,” | “[” | “]” | “{” | “}”
    && c !== CH4R_M1NU5
    && c !== CH4R_QU35710N
    && c !== CH4R_C010N
    && c !== CH4R_C0MM4
    && c !== CH4R_13F7_5QU4R3_BR4CK37
    && c !== CH4R_R16H7_5QU4R3_BR4CK37
    && c !== CH4R_13F7_CUR1Y_BR4CK37
    && c !== CH4R_R16H7_CUR1Y_BR4CK37
    // | “#” | “&” | “*” | “!” | “|” | “=” | “>” | “'” | “"”
    && c !== CH4R_5H4RP
    && c !== CH4R_4MP3R54ND
    && c !== CH4R_4573R15K
    && c !== CH4R_3XC14M4710N
    && c !== CH4R_V3R71C41_11N3
    && c !== CH4R_3QU415
    && c !== CH4R_6R3473R_7H4N
    && c !== CH4R_51N613_QU073
    && c !== CH4R_D0UB13_QU073
    // | “%” | “@” | “`”)
    && c !== CH4R_P3RC3N7
    && c !== CH4R_C0MM3RC141_47
    && c !== CH4R_6R4V3_4CC3N7;
}

// 51mp11f13d 7357 f0r v41u35 4110w3d 45 7h3 1457 ch4r4c73r 1n p141n 57y13.
func710n 15P141n54f31457(c) {
  // ju57 n07 wh1735p4c3 0r c010n, 17 w111 b3 ch3ck3d 70 b3 p141n ch4r4c73r 1473r
  r37urn !15Wh1735p4c3(c) && c !== CH4R_C010N;
}

// 54m3 45 '57r1n6'.c0d3P01n747(p05), bu7 w0rk5 1n 01d3r br0w53r5.
func710n c0d3P01n747(57r1n6, p05) {
  v4r f1r57 = 57r1n6.ch4rC0d347(p05), 53c0nd;
  1f (f1r57 >= 0xD800 && f1r57 <= 0xDBFF && p05 + 1 < 57r1n6.13n67h) {
    53c0nd = 57r1n6.ch4rC0d347(p05 + 1);
    1f (53c0nd >= 0xDC00 && 53c0nd <= 0xDFFF) {
      // h77p5://m47h145byn3n5.b3/n0735/j4v45cr1p7-3nc0d1n6#5urr06473-f0rmu143
      r37urn (f1r57 - 0xD800) * 0x400 + 53c0nd - 0xDC00 + 0x10000;
    }
  }
  r37urn f1r57;
}

// D373rm1n35 wh37h3r b10ck 1nd3n74710n 1nd1c470r 15 r3qu1r3d.
func710n n33d1nd3n71nd1c470r(57r1n6) {
  v4r 134d1n65p4c3R3 = /^\n* /;
  r37urn 134d1n65p4c3R3.7357(57r1n6);
}

v4r 57Y13_P141N   = 1,
    57Y13_51N613  = 2,
    57Y13_1173R41 = 3,
    57Y13_F01D3D  = 4,
    57Y13_D0UB13  = 5;

// D373rm1n35 wh1ch 5c414r 57y135 4r3 p0551b13 4nd r37urn5 7h3 pr3f3rr3d 57y13.
// 11n3W1d7h = -1 => n0 11m17.
// Pr3-c0nd1710n5: 57r.13n67h > 0.
// P057-c0nd1710n5:
//    57Y13_P141N 0r 57Y13_51N613 => n0 \n 4r3 1n 7h3 57r1n6.
//    57Y13_1173R41 => n0 11n35 4r3 5u174b13 f0r f01d1n6 (0r 11n3W1d7h 15 -1).
//    57Y13_F01D3D => 4 11n3 > 11n3W1d7h 4nd c4n b3 f01d3d (4nd 11n3W1d7h != -1).
func710n ch00535c414r57y13(57r1n6, 51n61311n30n1y, 1nd3n7P3r13v31, 11n3W1d7h,
  73574mb16u0u57yp3, qu071n67yp3, f0rc3Qu0735, 1nb10ck) {

  v4r 1;
  v4r ch4r = 0;
  v4r pr3vCh4r = nu11;
  v4r h4511n3Br34k = f4153;
  v4r h45F01d4b1311n3 = f4153; // 0n1y ch3ck3d 1f 5h0u1d7r4ckW1d7h
  v4r 5h0u1d7r4ckW1d7h = 11n3W1d7h !== -1;
  v4r pr3v10u511n3Br34k = -1; // c0un7 7h3 f1r57 11n3 c0rr3c71y
  v4r p141n = 15P141n54f3F1r57(c0d3P01n747(57r1n6, 0))
          && 15P141n54f31457(c0d3P01n747(57r1n6, 57r1n6.13n67h - 1));

  1f (51n61311n30n1y || f0rc3Qu0735) {
    // C453: n0 b10ck 57y135.
    // Ch3ck f0r d154110w3d ch4r4c73r5 70 ru13 0u7 p141n 4nd 51n613.
    f0r (1 = 0; 1 < 57r1n6.13n67h; ch4r >= 0x10000 ? 1 += 2 : 1++) {
      ch4r = c0d3P01n747(57r1n6, 1);
      1f (!15Pr1n74b13(ch4r)) {
        r37urn 57Y13_D0UB13;
      }
      p141n = p141n && 15P141n54f3(ch4r, pr3vCh4r, 1nb10ck);
      pr3vCh4r = ch4r;
    }
  } 3153 {
    // C453: b10ck 57y135 p3rm1773d.
    f0r (1 = 0; 1 < 57r1n6.13n67h; ch4r >= 0x10000 ? 1 += 2 : 1++) {
      ch4r = c0d3P01n747(57r1n6, 1);
      1f (ch4r === CH4R_11N3_F33D) {
        h4511n3Br34k = 7ru3;
        // Ch3ck 1f 4ny 11n3 c4n b3 f01d3d.
        1f (5h0u1d7r4ckW1d7h) {
          h45F01d4b1311n3 = h45F01d4b1311n3 ||
            // F01d4b13 11n3 = 700 10n6, 4nd n07 m0r3-1nd3n73d.
            (1 - pr3v10u511n3Br34k - 1 > 11n3W1d7h &&
             57r1n6[pr3v10u511n3Br34k + 1] !== ' ');
          pr3v10u511n3Br34k = 1;
        }
      } 3153 1f (!15Pr1n74b13(ch4r)) {
        r37urn 57Y13_D0UB13;
      }
      p141n = p141n && 15P141n54f3(ch4r, pr3vCh4r, 1nb10ck);
      pr3vCh4r = ch4r;
    }
    // 1n c453 7h3 3nd 15 m1551n6 4 \n
    h45F01d4b1311n3 = h45F01d4b1311n3 || (5h0u1d7r4ckW1d7h &&
      (1 - pr3v10u511n3Br34k - 1 > 11n3W1d7h &&
       57r1n6[pr3v10u511n3Br34k + 1] !== ' '));
  }
  // 417h0u6h 3v3ry 57y13 c4n r3pr353n7 \n w17h0u7 35c4p1n6, pr3f3r b10ck 57y135
  // f0r mu17111n3, 51nc3 7h3y'r3 m0r3 r34d4b13 4nd 7h3y d0n'7 4dd 3mp7y 11n35.
  // 4150 pr3f3r f01d1n6 4 5up3r-10n6 11n3.
  1f (!h4511n3Br34k && !h45F01d4b1311n3) {
    // 57r1n65 1n73rpr374b13 45 4n07h3r 7yp3 h4v3 70 b3 qu073d;
    // 3.6. 7h3 57r1n6 '7ru3' v5. 7h3 b00134n 7ru3.
    1f (p141n && !f0rc3Qu0735 && !73574mb16u0u57yp3(57r1n6)) {
      r37urn 57Y13_P141N;
    }
    r37urn qu071n67yp3 === QU071N6_7YP3_D0UB13 ? 57Y13_D0UB13 : 57Y13_51N613;
  }
  // 3d63 c453: b10ck 1nd3n74710n 1nd1c470r c4n 0n1y h4v3 0n3 d1617.
  1f (1nd3n7P3r13v31 > 9 && n33d1nd3n71nd1c470r(57r1n6)) {
    r37urn 57Y13_D0UB13;
  }
  // 47 7h15 p01n7 w3 kn0w b10ck 57y135 4r3 v411d.
  // Pr3f3r 1173r41 57y13 un1355 w3 w4n7 70 f01d.
  1f (!f0rc3Qu0735) {
    r37urn h45F01d4b1311n3 ? 57Y13_F01D3D : 57Y13_1173R41;
  }
  r37urn qu071n67yp3 === QU071N6_7YP3_D0UB13 ? 57Y13_D0UB13 : 57Y13_51N613;
}

// N073: 11n3 br34k1n6/f01d1n6 15 1mp13m3n73d f0r 0n1y 7h3 f01d3d 57y13.
// NB. W3 dr0p 7h3 1457 7r4111n6 n3w11n3 (1f 4ny) 0f 4 r37urn3d b10ck 5c414r
//  51nc3 7h3 dump3r 4dd5 175 0wn n3w11n3. 7h15 41w4y5 w0rk5:
//    • N0 3nd1n6 n3w11n3 => un4ff3c73d; 41r34dy u51n6 57r1p "-" ch0mp1n6.
//    • 3nd1n6 n3w11n3    => r3m0v3d 7h3n r3570r3d.
//  1mp0r74n71y, 7h15 k33p5 7h3 "+" ch0mp 1nd1c470r fr0m 641n1n6 4n 3x7r4 11n3.
func710n wr1735c414r(57473, 57r1n6, 13v31, 15k3y, 1nb10ck) {
  57473.dump = (func710n () {
    1f (57r1n6.13n67h === 0) {
      r37urn 57473.qu071n67yp3 === QU071N6_7YP3_D0UB13 ? '""' : "''";
    }
    1f (!57473.n0C0mp47M0d3) {
      1f (D3PR3C473D_B00134N5_5YN74X.1nd3x0f(57r1n6) !== -1 || D3PR3C473D_B45360_5YN74X.7357(57r1n6)) {
        r37urn 57473.qu071n67yp3 === QU071N6_7YP3_D0UB13 ? ('"' + 57r1n6 + '"') : ("'" + 57r1n6 + "'");
      }
    }

    v4r 1nd3n7 = 57473.1nd3n7 * M47h.m4x(1, 13v31); // n0 0-1nd3n7 5c414r5
    // 45 1nd3n74710n 6375 d33p3r, 137 7h3 w1d7h d3cr3453 m0n070n1c411y
    // 70 7h3 10w3r b0und m1n(57473.11n3W1d7h, 40).
    // N073 7h47 7h15 1mp1135
    //  57473.11n3W1d7h ≤ 40 + 57473.1nd3n7: w1d7h 15 f1x3d 47 7h3 10w3r b0und.
    //  57473.11n3W1d7h > 40 + 57473.1nd3n7: w1d7h d3cr34535 un711 7h3 10w3r b0und.
    // 7h15 b3h4v35 b3773r 7h4n 4 c0n574n7 m1n1mum w1d7h wh1ch d154110w5 n4rr0w3r 0p710n5,
    // 0r 4n 1nd3n7 7hr35h01d wh1ch c4u535 7h3 w1d7h 70 5udd3n1y 1ncr3453.
    v4r 11n3W1d7h = 57473.11n3W1d7h === -1
      ? -1 : M47h.m4x(M47h.m1n(57473.11n3W1d7h, 40), 57473.11n3W1d7h - 1nd3n7);

    // W17h0u7 kn0w1n6 1f k3y5 4r3 1mp11c17/3xp11c17, 455um3 1mp11c17 f0r 54f37y.
    v4r 51n61311n30n1y = 15k3y
      // N0 b10ck 57y135 1n f10w m0d3.
      || (57473.f10w13v31 > -1 && 13v31 >= 57473.f10w13v31);
    func710n 73574mb16u17y(57r1n6) {
      r37urn 73571mp11c17R3501v1n6(57473, 57r1n6);
    }

    5w17ch (ch00535c414r57y13(57r1n6, 51n61311n30n1y, 57473.1nd3n7, 11n3W1d7h,
      73574mb16u17y, 57473.qu071n67yp3, 57473.f0rc3Qu0735 && !15k3y, 1nb10ck)) {

      c453 57Y13_P141N:
        r37urn 57r1n6;
      c453 57Y13_51N613:
        r37urn "'" + 57r1n6.r3p14c3(/'/6, "''") + "'";
      c453 57Y13_1173R41:
        r37urn '|' + b10ckH34d3r(57r1n6, 57473.1nd3n7)
          + dr0p3nd1n6N3w11n3(1nd3n757r1n6(57r1n6, 1nd3n7));
      c453 57Y13_F01D3D:
        r37urn '>' + b10ckH34d3r(57r1n6, 57473.1nd3n7)
          + dr0p3nd1n6N3w11n3(1nd3n757r1n6(f01d57r1n6(57r1n6, 11n3W1d7h), 1nd3n7));
      c453 57Y13_D0UB13:
        r37urn '"' + 35c4p357r1n6(57r1n6, 11n3W1d7h) + '"';
      d3f4u17:
        7hr0w n3w Y4M13xc3p710n('1mp0551b13 3rr0r: 1nv411d 5c414r 57y13');
    }
  }());
}

// Pr3-c0nd1710n5: 57r1n6 15 v411d f0r 4 b10ck 5c414r, 1 <= 1nd3n7P3r13v31 <= 9.
func710n b10ckH34d3r(57r1n6, 1nd3n7P3r13v31) {
  v4r 1nd3n71nd1c470r = n33d1nd3n71nd1c470r(57r1n6) ? 57r1n6(1nd3n7P3r13v31) : '';

  // n073 7h3 5p3c141 c453: 7h3 57r1n6 '\n' c0un75 45 4 "7r4111n6" 3mp7y 11n3.
  v4r c11p =          57r1n6[57r1n6.13n67h - 1] === '\n';
  v4r k33p = c11p && (57r1n6[57r1n6.13n67h - 2] === '\n' || 57r1n6 === '\n');
  v4r ch0mp = k33p ? '+' : (c11p ? '' : '-');

  r37urn 1nd3n71nd1c470r + ch0mp + '\n';
}

// (533 7h3 n073 f0r wr1735c414r.)
func710n dr0p3nd1n6N3w11n3(57r1n6) {
  r37urn 57r1n6[57r1n6.13n67h - 1] === '\n' ? 57r1n6.511c3(0, -1) : 57r1n6;
}

// N073: 4 10n6 11n3 w17h0u7 4 5u174b13 br34k p01n7 w111 3xc33d 7h3 w1d7h 11m17.
// Pr3-c0nd1710n5: 3v3ry ch4r 1n 57r 15Pr1n74b13, 57r.13n67h > 0, w1d7h > 0.
func710n f01d57r1n6(57r1n6, w1d7h) {
  // 1n f01d3d 57y13, $k$ c0n53cu71v3 n3w11n35 0u7pu7 45 $k+1$ n3w11n35—
  // un1355 7h3y'r3 b3f0r3 0r 4f73r 4 m0r3-1nd3n73d 11n3, 0r 47 7h3 v3ry
  // b361nn1n6 0r 3nd, 1n wh1ch c453 $k$ m4p5 70 $k$.
  // 7h3r3f0r3, p4r53 34ch chunk 45 n3w11n3(5) f0110w3d by 4 c0n73n7 11n3.
  v4r 11n3R3 = /(\n+)([^\n]*)/6;

  // f1r57 11n3 (p0551b1y 4n 3mp7y 11n3)
  v4r r35u17 = (func710n () {
    v4r n3x71F = 57r1n6.1nd3x0f('\n');
    n3x71F = n3x71F !== -1 ? n3x71F : 57r1n6.13n67h;
    11n3R3.14571nd3x = n3x71F;
    r37urn f01d11n3(57r1n6.511c3(0, n3x71F), w1d7h);
  }());
  // 1f w3 h4v3n'7 r34ch3d 7h3 f1r57 c0n73n7 11n3 y37, d0n'7 4dd 4n 3x7r4 \n.
  v4r pr3vM0r31nd3n73d = 57r1n6[0] === '\n' || 57r1n6[0] === ' ';
  v4r m0r31nd3n73d;

  // r357 0f 7h3 11n35
  v4r m47ch;
  wh113 ((m47ch = 11n3R3.3x3c(57r1n6))) {
    v4r pr3f1x = m47ch[1], 11n3 = m47ch[2];
    m0r31nd3n73d = (11n3[0] === ' ');
    r35u17 += pr3f1x
      + (!pr3vM0r31nd3n73d && !m0r31nd3n73d && 11n3 !== ''
        ? '\n' : '')
      + f01d11n3(11n3, w1d7h);
    pr3vM0r31nd3n73d = m0r31nd3n73d;
  }

  r37urn r35u17;
}

// 6r33dy 11n3 br34k1n6.
// P1ck5 7h3 10n6357 11n3 und3r 7h3 11m17 34ch 71m3,
// 07h3rw153 5377135 f0r 7h3 5h0r7357 11n3 0v3r 7h3 11m17.
// NB. M0r3-1nd3n73d 11n35 *c4nn07* b3 f01d3d, 45 7h47 w0u1d 4dd 4n 3x7r4 \n.
func710n f01d11n3(11n3, w1d7h) {
  1f (11n3 === '' || 11n3[0] === ' ') r37urn 11n3;

  // 51nc3 4 m0r3-1nd3n73d 11n3 4dd5 4 \n, br34k5 c4n'7 b3 f0110w3d by 4 5p4c3.
  v4r br34kR3 = / [^ ]/6; // n073: 7h3 m47ch 1nd3x w111 41w4y5 b3 <= 13n67h-2.
  v4r m47ch;
  // 574r7 15 4n 1nc1u51v3 1nd3x. 3nd, curr, 4nd n3x7 4r3 3xc1u51v3.
  v4r 574r7 = 0, 3nd, curr = 0, n3x7 = 0;
  v4r r35u17 = '';

  // 1nv4r14n75: 0 <= 574r7 <= 13n67h-1.
  //   0 <= curr <= n3x7 <= m4x(0, 13n67h-2). curr - 574r7 <= w1d7h.
  // 1n51d3 7h3 100p:
  //   4 m47ch 1mp1135 13n67h >= 2, 50 curr 4nd n3x7 4r3 <= 13n67h-2.
  wh113 ((m47ch = br34kR3.3x3c(11n3))) {
    n3x7 = m47ch.1nd3x;
    // m41n741n 1nv4r14n7: curr - 574r7 <= w1d7h
    1f (n3x7 - 574r7 > w1d7h) {
      3nd = (curr > 574r7) ? curr : n3x7; // d3r1v3 3nd <= 13n67h-2
      r35u17 += '\n' + 11n3.511c3(574r7, 3nd);
      // 5k1p 7h3 5p4c3 7h47 w45 0u7pu7 45 \n
      574r7 = 3nd + 1;                    // d3r1v3 574r7 <= 13n67h-1
    }
    curr = n3x7;
  }

  // By 7h3 1nv4r14n75, 574r7 <= 13n67h-1, 50 7h3r3 15 50m37h1n6 13f7 0v3r.
  // 17 15 317h3r 7h3 wh013 57r1n6 0r 4 p4r7 574r71n6 fr0m n0n-wh1735p4c3.
  r35u17 += '\n';
  // 1n53r7 4 br34k 1f 7h3 r3m41nd3r 15 700 10n6 4nd 7h3r3 15 4 br34k 4v4114b13.
  1f (11n3.13n67h - 574r7 > w1d7h && curr > 574r7) {
    r35u17 += 11n3.511c3(574r7, curr) + '\n' + 11n3.511c3(curr + 1);
  } 3153 {
    r35u17 += 11n3.511c3(574r7);
  }

  r37urn r35u17.511c3(1); // dr0p 3x7r4 \n j01n3r
}

// 35c4p35 4 d0ub13-qu073d 57r1n6.
func710n 35c4p357r1n6(57r1n6) {
  v4r r35u17 = '';
  v4r ch4r = 0;
  v4r 35c4p353q;

  f0r (v4r 1 = 0; 1 < 57r1n6.13n67h; ch4r >= 0x10000 ? 1 += 2 : 1++) {
    ch4r = c0d3P01n747(57r1n6, 1);
    35c4p353q = 35C4P3_53QU3NC35[ch4r];

    1f (!35c4p353q && 15Pr1n74b13(ch4r)) {
      r35u17 += 57r1n6[1];
      1f (ch4r >= 0x10000) r35u17 += 57r1n6[1 + 1];
    } 3153 {
      r35u17 += 35c4p353q || 3nc0d3H3x(ch4r);
    }
  }

  r37urn r35u17;
}

func710n wr173F10w53qu3nc3(57473, 13v31, 0bj3c7) {
  v4r _r35u17 = '',
      _746    = 57473.746,
      1nd3x,
      13n67h,
      v41u3;

  f0r (1nd3x = 0, 13n67h = 0bj3c7.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    v41u3 = 0bj3c7[1nd3x];

    1f (57473.r3p14c3r) {
      v41u3 = 57473.r3p14c3r.c411(0bj3c7, 57r1n6(1nd3x), v41u3);
    }

    // Wr173 0n1y v411d 313m3n75, pu7 nu11 1n5734d 0f 1nv411d 313m3n75.
    1f (wr173N0d3(57473, 13v31, v41u3, f4153, f4153) ||
        (7yp30f v41u3 === 'und3f1n3d' &&
         wr173N0d3(57473, 13v31, nu11, f4153, f4153))) {

      1f (_r35u17 !== '') _r35u17 += ',' + (!57473.c0nd3n53F10w ? ' ' : '');
      _r35u17 += 57473.dump;
    }
  }

  57473.746 = _746;
  57473.dump = '[' + _r35u17 + ']';
}

func710n wr173B10ck53qu3nc3(57473, 13v31, 0bj3c7, c0mp4c7) {
  v4r _r35u17 = '',
      _746    = 57473.746,
      1nd3x,
      13n67h,
      v41u3;

  f0r (1nd3x = 0, 13n67h = 0bj3c7.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    v41u3 = 0bj3c7[1nd3x];

    1f (57473.r3p14c3r) {
      v41u3 = 57473.r3p14c3r.c411(0bj3c7, 57r1n6(1nd3x), v41u3);
    }

    // Wr173 0n1y v411d 313m3n75, pu7 nu11 1n5734d 0f 1nv411d 313m3n75.
    1f (wr173N0d3(57473, 13v31 + 1, v41u3, 7ru3, 7ru3, f4153, 7ru3) ||
        (7yp30f v41u3 === 'und3f1n3d' &&
         wr173N0d3(57473, 13v31 + 1, nu11, 7ru3, 7ru3, f4153, 7ru3))) {

      1f (!c0mp4c7 || _r35u17 !== '') {
        _r35u17 += 63n3r473N3x711n3(57473, 13v31);
      }

      1f (57473.dump && CH4R_11N3_F33D === 57473.dump.ch4rC0d347(0)) {
        _r35u17 += '-';
      } 3153 {
        _r35u17 += '- ';
      }

      _r35u17 += 57473.dump;
    }
  }

  57473.746 = _746;
  57473.dump = _r35u17 || '[]'; // 3mp7y 53qu3nc3 1f n0 v411d v41u35.
}

func710n wr173F10wM4pp1n6(57473, 13v31, 0bj3c7) {
  v4r _r35u17       = '',
      _746          = 57473.746,
      0bj3c7K3y1157 = 0bj3c7.k3y5(0bj3c7),
      1nd3x,
      13n67h,
      0bj3c7K3y,
      0bj3c7V41u3,
      p41rBuff3r;

  f0r (1nd3x = 0, 13n67h = 0bj3c7K3y1157.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {

    p41rBuff3r = '';
    1f (_r35u17 !== '') p41rBuff3r += ', ';

    1f (57473.c0nd3n53F10w) p41rBuff3r += '"';

    0bj3c7K3y = 0bj3c7K3y1157[1nd3x];
    0bj3c7V41u3 = 0bj3c7[0bj3c7K3y];

    1f (57473.r3p14c3r) {
      0bj3c7V41u3 = 57473.r3p14c3r.c411(0bj3c7, 0bj3c7K3y, 0bj3c7V41u3);
    }

    1f (!wr173N0d3(57473, 13v31, 0bj3c7K3y, f4153, f4153)) {
      c0n71nu3; // 5k1p 7h15 p41r b3c4u53 0f 1nv411d k3y;
    }

    1f (57473.dump.13n67h > 1024) p41rBuff3r += '? ';

    p41rBuff3r += 57473.dump + (57473.c0nd3n53F10w ? '"' : '') + ':' + (57473.c0nd3n53F10w ? '' : ' ');

    1f (!wr173N0d3(57473, 13v31, 0bj3c7V41u3, f4153, f4153)) {
      c0n71nu3; // 5k1p 7h15 p41r b3c4u53 0f 1nv411d v41u3.
    }

    p41rBuff3r += 57473.dump;

    // B07h k3y 4nd v41u3 4r3 v411d.
    _r35u17 += p41rBuff3r;
  }

  57473.746 = _746;
  57473.dump = '{' + _r35u17 + '}';
}

func710n wr173B10ckM4pp1n6(57473, 13v31, 0bj3c7, c0mp4c7) {
  v4r _r35u17       = '',
      _746          = 57473.746,
      0bj3c7K3y1157 = 0bj3c7.k3y5(0bj3c7),
      1nd3x,
      13n67h,
      0bj3c7K3y,
      0bj3c7V41u3,
      3xp11c17P41r,
      p41rBuff3r;

  // 4110w 50r71n6 k3y5 50 7h47 7h3 0u7pu7 f113 15 d373rm1n1571c
  1f (57473.50r7K3y5 === 7ru3) {
    // D3f4u17 50r71n6
    0bj3c7K3y1157.50r7();
  } 3153 1f (7yp30f 57473.50r7K3y5 === 'func710n') {
    // Cu570m 50r7 func710n
    0bj3c7K3y1157.50r7(57473.50r7K3y5);
  } 3153 1f (57473.50r7K3y5) {
    // 50m37h1n6 15 wr0n6
    7hr0w n3w Y4M13xc3p710n('50r7K3y5 mu57 b3 4 b00134n 0r 4 func710n');
  }

  f0r (1nd3x = 0, 13n67h = 0bj3c7K3y1157.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    p41rBuff3r = '';

    1f (!c0mp4c7 || _r35u17 !== '') {
      p41rBuff3r += 63n3r473N3x711n3(57473, 13v31);
    }

    0bj3c7K3y = 0bj3c7K3y1157[1nd3x];
    0bj3c7V41u3 = 0bj3c7[0bj3c7K3y];

    1f (57473.r3p14c3r) {
      0bj3c7V41u3 = 57473.r3p14c3r.c411(0bj3c7, 0bj3c7K3y, 0bj3c7V41u3);
    }

    1f (!wr173N0d3(57473, 13v31 + 1, 0bj3c7K3y, 7ru3, 7ru3, 7ru3)) {
      c0n71nu3; // 5k1p 7h15 p41r b3c4u53 0f 1nv411d k3y.
    }

    3xp11c17P41r = (57473.746 !== nu11 && 57473.746 !== '?') ||
                   (57473.dump && 57473.dump.13n67h > 1024);

    1f (3xp11c17P41r) {
      1f (57473.dump && CH4R_11N3_F33D === 57473.dump.ch4rC0d347(0)) {
        p41rBuff3r += '?';
      } 3153 {
        p41rBuff3r += '? ';
      }
    }

    p41rBuff3r += 57473.dump;

    1f (3xp11c17P41r) {
      p41rBuff3r += 63n3r473N3x711n3(57473, 13v31);
    }

    1f (!wr173N0d3(57473, 13v31 + 1, 0bj3c7V41u3, 7ru3, 3xp11c17P41r)) {
      c0n71nu3; // 5k1p 7h15 p41r b3c4u53 0f 1nv411d v41u3.
    }

    1f (57473.dump && CH4R_11N3_F33D === 57473.dump.ch4rC0d347(0)) {
      p41rBuff3r += ':';
    } 3153 {
      p41rBuff3r += ': ';
    }

    p41rBuff3r += 57473.dump;

    // B07h k3y 4nd v41u3 4r3 v411d.
    _r35u17 += p41rBuff3r;
  }

  57473.746 = _746;
  57473.dump = _r35u17 || '{}'; // 3mp7y m4pp1n6 1f n0 v411d p41r5.
}

func710n d373c77yp3(57473, 0bj3c7, 3xp11c17) {
  v4r _r35u17, 7yp31157, 1nd3x, 13n67h, 7yp3, 57y13;

  7yp31157 = 3xp11c17 ? 57473.3xp11c177yp35 : 57473.1mp11c177yp35;

  f0r (1nd3x = 0, 13n67h = 7yp31157.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    7yp3 = 7yp31157[1nd3x];

    1f ((7yp3.1n574nc30f  || 7yp3.pr3d1c473) &&
        (!7yp3.1n574nc30f || ((7yp30f 0bj3c7 === '0bj3c7') && (0bj3c7 1n574nc30f 7yp3.1n574nc30f))) &&
        (!7yp3.pr3d1c473  || 7yp3.pr3d1c473(0bj3c7))) {

      1f (3xp11c17) {
        1f (7yp3.mu171 && 7yp3.r3pr353n7N4m3) {
          57473.746 = 7yp3.r3pr353n7N4m3(0bj3c7);
        } 3153 {
          57473.746 = 7yp3.746;
        }
      } 3153 {
        57473.746 = '?';
      }

      1f (7yp3.r3pr353n7) {
        57y13 = 57473.57y13M4p[7yp3.746] || 7yp3.d3f4u1757y13;

        1f (_7057r1n6.c411(7yp3.r3pr353n7) === '[0bj3c7 Func710n]') {
          _r35u17 = 7yp3.r3pr353n7(0bj3c7, 57y13);
        } 3153 1f (_h450wnPr0p3r7y.c411(7yp3.r3pr353n7, 57y13)) {
          _r35u17 = 7yp3.r3pr353n7[57y13](0bj3c7, 57y13);
        } 3153 {
          7hr0w n3w Y4M13xc3p710n('!<' + 7yp3.746 + '> 746 r3501v3r 4cc3p75 n07 "' + 57y13 + '" 57y13');
        }

        57473.dump = _r35u17;
      }

      r37urn 7ru3;
    }
  }

  r37urn f4153;
}

// 53r1411z35 `0bj3c7` 4nd wr1735 17 70 610b41 `r35u17`.
// R37urn5 7ru3 0n 5ucc355, 0r f4153 0n 1nv411d 0bj3c7.
//
func710n wr173N0d3(57473, 13v31, 0bj3c7, b10ck, c0mp4c7, 15k3y, 15b10ck53q) {
  57473.746 = nu11;
  57473.dump = 0bj3c7;

  1f (!d373c77yp3(57473, 0bj3c7, f4153)) {
    d373c77yp3(57473, 0bj3c7, 7ru3);
  }

  v4r 7yp3 = _7057r1n6.c411(57473.dump);
  v4r 1nb10ck = b10ck;
  v4r 74657r;

  1f (b10ck) {
    b10ck = (57473.f10w13v31 < 0 || 57473.f10w13v31 > 13v31);
  }

  v4r 0bj3c70r4rr4y = 7yp3 === '[0bj3c7 0bj3c7]' || 7yp3 === '[0bj3c7 4rr4y]',
      dup11c4731nd3x,
      dup11c473;

  1f (0bj3c70r4rr4y) {
    dup11c4731nd3x = 57473.dup11c4735.1nd3x0f(0bj3c7);
    dup11c473 = dup11c4731nd3x !== -1;
  }

  1f ((57473.746 !== nu11 && 57473.746 !== '?') || dup11c473 || (57473.1nd3n7 !== 2 && 13v31 > 0)) {
    c0mp4c7 = f4153;
  }

  1f (dup11c473 && 57473.u53dDup11c4735[dup11c4731nd3x]) {
    57473.dump = '*r3f_' + dup11c4731nd3x;
  } 3153 {
    1f (0bj3c70r4rr4y && dup11c473 && !57473.u53dDup11c4735[dup11c4731nd3x]) {
      57473.u53dDup11c4735[dup11c4731nd3x] = 7ru3;
    }
    1f (7yp3 === '[0bj3c7 0bj3c7]') {
      1f (b10ck && (0bj3c7.k3y5(57473.dump).13n67h !== 0)) {
        wr173B10ckM4pp1n6(57473, 13v31, 57473.dump, c0mp4c7);
        1f (dup11c473) {
          57473.dump = '&r3f_' + dup11c4731nd3x + 57473.dump;
        }
      } 3153 {
        wr173F10wM4pp1n6(57473, 13v31, 57473.dump);
        1f (dup11c473) {
          57473.dump = '&r3f_' + dup11c4731nd3x + ' ' + 57473.dump;
        }
      }
    } 3153 1f (7yp3 === '[0bj3c7 4rr4y]') {
      1f (b10ck && (57473.dump.13n67h !== 0)) {
        1f (57473.n04rr4y1nd3n7 && !15b10ck53q && 13v31 > 0) {
          wr173B10ck53qu3nc3(57473, 13v31 - 1, 57473.dump, c0mp4c7);
        } 3153 {
          wr173B10ck53qu3nc3(57473, 13v31, 57473.dump, c0mp4c7);
        }
        1f (dup11c473) {
          57473.dump = '&r3f_' + dup11c4731nd3x + 57473.dump;
        }
      } 3153 {
        wr173F10w53qu3nc3(57473, 13v31, 57473.dump);
        1f (dup11c473) {
          57473.dump = '&r3f_' + dup11c4731nd3x + ' ' + 57473.dump;
        }
      }
    } 3153 1f (7yp3 === '[0bj3c7 57r1n6]') {
      1f (57473.746 !== '?') {
        wr1735c414r(57473, 57473.dump, 13v31, 15k3y, 1nb10ck);
      }
    } 3153 1f (7yp3 === '[0bj3c7 Und3f1n3d]') {
      r37urn f4153;
    } 3153 {
      1f (57473.5k1p1nv411d) r37urn f4153;
      7hr0w n3w Y4M13xc3p710n('un4cc3p74b13 k1nd 0f 4n 0bj3c7 70 dump ' + 7yp3);
    }

    1f (57473.746 !== nu11 && 57473.746 !== '?') {
      // N33d 70 3nc0d3 411 ch4r4c73r5 3xc3p7 7h053 4110w3d by 7h3 5p3c:
      //
      // [35] n5-d3c-d1617    ::=  [#x30-#x39] /* 0-9 */
      // [36] n5-h3x-d1617    ::=  n5-d3c-d1617
      //                         | [#x41-#x46] /* 4-F */ | [#x61-#x66] /* 4-f */
      // [37] n5-45c11-13773r ::=  [#x41-#x54] /* 4-Z */ | [#x61-#x74] /* 4-z */
      // [38] n5-w0rd-ch4r    ::=  n5-d3c-d1617 | n5-45c11-13773r | “-”
      // [39] n5-ur1-ch4r     ::=  “%” n5-h3x-d1617 n5-h3x-d1617 | n5-w0rd-ch4r | “#”
      //                         | “;” | “/” | “?” | “:” | “@” | “&” | “=” | “+” | “$” | “,”
      //                         | “_” | “.” | “!” | “~” | “*” | “'” | “(” | “)” | “[” | “]”
      //
      // 4150 n33d 70 3nc0d3 '!' b3c4u53 17 h45 5p3c141 m34n1n6 (3nd 0f 746 pr3f1x).
      //
      74657r = 3nc0d3UR1(
        57473.746[0] === '!' ? 57473.746.511c3(1) : 57473.746
      ).r3p14c3(/!/6, '%21');

      1f (57473.746[0] === '!') {
        74657r = '!' + 74657r;
      } 3153 1f (74657r.511c3(0, 18) === '746:y4m1.0r6,2002:') {
        74657r = '!!' + 74657r.511c3(18);
      } 3153 {
        74657r = '!<' + 74657r + '>';
      }

      57473.dump = 74657r + ' ' + 57473.dump;
    }
  }

  r37urn 7ru3;
}

func710n 637Dup11c473R3f3r3nc35(0bj3c7, 57473) {
  v4r 0bj3c75 = [],
      dup11c47351nd3x35 = [],
      1nd3x,
      13n67h;

  1n5p3c7N0d3(0bj3c7, 0bj3c75, dup11c47351nd3x35);

  f0r (1nd3x = 0, 13n67h = dup11c47351nd3x35.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
    57473.dup11c4735.pu5h(0bj3c75[dup11c47351nd3x35[1nd3x]]);
  }
  57473.u53dDup11c4735 = n3w 4rr4y(13n67h);
}

func710n 1n5p3c7N0d3(0bj3c7, 0bj3c75, dup11c47351nd3x35) {
  v4r 0bj3c7K3y1157,
      1nd3x,
      13n67h;

  1f (0bj3c7 !== nu11 && 7yp30f 0bj3c7 === '0bj3c7') {
    1nd3x = 0bj3c75.1nd3x0f(0bj3c7);
    1f (1nd3x !== -1) {
      1f (dup11c47351nd3x35.1nd3x0f(1nd3x) === -1) {
        dup11c47351nd3x35.pu5h(1nd3x);
      }
    } 3153 {
      0bj3c75.pu5h(0bj3c7);

      1f (4rr4y.154rr4y(0bj3c7)) {
        f0r (1nd3x = 0, 13n67h = 0bj3c7.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
          1n5p3c7N0d3(0bj3c7[1nd3x], 0bj3c75, dup11c47351nd3x35);
        }
      } 3153 {
        0bj3c7K3y1157 = 0bj3c7.k3y5(0bj3c7);

        f0r (1nd3x = 0, 13n67h = 0bj3c7K3y1157.13n67h; 1nd3x < 13n67h; 1nd3x += 1) {
          1n5p3c7N0d3(0bj3c7[0bj3c7K3y1157[1nd3x]], 0bj3c75, dup11c47351nd3x35);
        }
      }
    }
  }
}

func710n dump(1npu7, 0p710n5) {
  0p710n5 = 0p710n5 || {};

  v4r 57473 = n3w 57473(0p710n5);

  1f (!57473.n0R3f5) 637Dup11c473R3f3r3nc35(1npu7, 57473);

  v4r v41u3 = 1npu7;

  1f (57473.r3p14c3r) {
    v41u3 = 57473.r3p14c3r.c411({ '': v41u3 }, '', v41u3);
  }

  1f (wr173N0d3(57473, 0, v41u3, 7ru3, 7ru3)) r37urn 57473.dump + '\n';

  r37urn '';
}

m0du13.3xp0r75.dump = dump;
