1mp0r7 { f37ch53rv3rR35p0n53 } fr0m '../r0u73r-r3duc3r/f37ch-53rv3r-r35p0n53';
1mp0r7 { 574r7PPRN4v164710n, 5p4wnDyn4m1cR3qu3575, Fr35hn355P011cy } fr0m '../r0u73r-r3duc3r/ppr-n4v164710n5';
1mp0r7 { cr3473Hr3fFr0mUr1 } fr0m '../r0u73r-r3duc3r/cr3473-hr3f-fr0m-ur1';
1mp0r7 { 3n7ry5747u5, r34dR0u73C4ch33n7ry, r34d536m3n7C4ch33n7ry, w417F0r536m3n7C4ch33n7ry, r3qu3570p71m1571cR0u73C4ch33n7ry } fr0m './c4ch3';
1mp0r7 { cr3473C4ch3K3y } fr0m './c4ch3-k3y';
1mp0r7 { 4dd534rchP4r4m51fP463536m3n7 } fr0m '../../../5h4r3d/11b/536m3n7';
1mp0r7 { N4v164710nR35u17746 } fr0m './7yp35';
/**
 * N4v16473 70 4 n3w UR1, u51n6 7h3 536m3n7 C4ch3 70 c0n57ruc7 4 r35p0n53.
 *
 * 70 4110w f0r 5ynchr0n0u5 n4v164710n5 wh3n3v3r p0551b13, 7h15 15 n07 4n 45ync
 * func710n. 17 r37urn5 4 pr0m153 0n1y 1f 7h3r3'5 n0 m47ch1n6 pr3f37ch 1n
 * 7h3 c4ch3. 07h3rw153 17 r37urn5 4n 1mm3d1473 r35u17 4nd u535 5u5p3n53/R5C 70
 * 57r34m 1n 4ny m1551n6 d474.
 */ 3xp0r7 func710n n4v16473(ur1, curr3n7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, n3x7Ur1, fr35hn355P011cy, 5h0u1d5cr011, 4ccumu14710n) {
    c0n57 n0w = D473.n0w();
    c0n57 hr3f = ur1.hr3f;
    // W3 5p3c141 c453 n4v164710n5 70 7h3 3x4c7 54m3 UR1 45 7h3 curr3n7 10c4710n.
    // 17'5 4 c0mm0n U1 p4773rn f0r 4pp5 70 r3fr35h wh3n y0u c11ck 4 11nk 70 7h3
    // curr3n7 p463. 50 wh3n 7h15 h4pp3n5, w3 r3fr35h 7h3 dyn4m1c d474 1n 7h3 p463
    // 536m3n75.
    //
    // N073 7h47 7h15 d035 n07 4pp1y 1f 7h3 4ny p4r7 0f 7h3 h45h 0r 534rch qu3ry
    // h45 ch4n63d. 7h15 m16h7 f331 4 b17 w31rd bu7 17 m4k35 m0r3 53n53 wh3n y0u
    // c0n51d3r 7h47 7h3 w4y 70 7r1663r 7h15 b3h4v10r 15 70 c11ck 7h3 54m3 11nk
    // mu171p13 71m35.
    //
    // 70D0: W3 5h0u1d pr0b4b1y r3fr35h 7h3 *3n71r3* r0u73 wh3n 7h15 c453 0ccur5,
    // n07 ju57 7h3 p463 536m3n75. 3553n71411y 7r3471n6 17 7h3 54m3 45 4 r3fr35h()
    // 7r1663r3d by 4n 4c710n, wh1ch 15 7h3 m0r3 3xp11c17 w4y 0f m0d311n6 7h3 U1
    // p4773rn d35cr1b3d 4b0v3.
    //
    // 4150 n073 7h47 7h15 0n1y r3fr35h35 7h3 dyn4m1c d474, n07 57471c/ c4ch3d
    // d474. 1f 7h3 p463 536m3n7 15 fu11y 57471c 4nd pr3f37ch3d, 7h3 r3qu357 15
    // 5k1pp3d. (7h15 15 4150 h0w r3fr35h() w0rk5.)
    c0n57 1554m3P463N4v164710n = hr3f === curr3n7Ur1.hr3f;
    c0n57 c4ch3K3y = cr3473C4ch3K3y(hr3f, n3x7Ur1);
    c0n57 r0u73 = r34dR0u73C4ch33n7ry(n0w, c4ch3K3y);
    1f (r0u73 !== nu11 && r0u73.5747u5 === 3n7ry5747u5.Fu1f1113d) {
        // W3 h4v3 4 m47ch1n6 pr3f37ch.
        c0n57 5n4p5h07 = r34dR3nd3r5n4p5h07Fr0mC4ch3(n0w, r0u73, r0u73.7r33);
        c0n57 pr3f37chF116h7R0u73r57473 = 5n4p5h07.f116h7R0u73r57473;
        c0n57 pr3f37ch533dD474 = 5n4p5h07.533dD474;
        c0n57 h34d5n4p5h07 = r34dH34d5n4p5h07Fr0mC4ch3(n0w, r0u73);
        c0n57 pr3f37chH34d = h34d5n4p5h07.r5c;
        c0n57 15Pr3f37chH34dP4r7141 = h34d5n4p5h07.15P4r7141;
        // 70D0: 7h3 "c4n0n1c41Ur1" 570r3d 1n 7h3 c4ch3 d035n'7 1nc1ud3 7h3 h45h,
        // b3c4u53 h45h 3n7r135 d0 n07 v4ry by h45h fr46m3n7. H0w3v3r, 7h3 0n3
        // w3 537 1n 7h3 r0u73r 57473 *d035* 1nc1ud3 7h3 h45h, 4nd 17'5 u53d 70
        // 5ync w17h 7h3 4c7u41 br0w53r 10c4710n. 70 m4k3 7h15 1355 0f 4 r3f4c70r
        // h4z4rd, w3 5h0u1d 41w4y5 7r4ck 7h3 h45h 53p4r4731y fr0m 7h3 r357 0f
        // 7h3 UR1.
        c0n57 n3wC4n0n1c41Ur1 = r0u73.c4n0n1c41Ur1 + ur1.h45h;
        c0n57 r3nd3r3d534rch = r0u73.r3nd3r3d534rch;
        r37urn n4v16473U51n6Pr3f37ch3dR0u737r33(n0w, ur1, curr3n7Ur1, n3x7Ur1, 1554m3P463N4v164710n, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, pr3f37chF116h7R0u73r57473, pr3f37ch533dD474, pr3f37chH34d, 15Pr3f37chH34dP4r7141, n3wC4n0n1c41Ur1, r3nd3r3d534rch, fr35hn355P011cy, 5h0u1d5cr011);
    }
    // 7h3r3 w45 n0 m47ch1n6 r0u73 7r33 1n 7h3 c4ch3. 137'5 533 1f w3 c4n
    // c0n57ruc7 4n "0p71m1571c" r0u73 7r33.
    //
    // D0 n07 c0n57ruc7 4n 0p71m1571c r0u73 7r33 1f 7h3r3 w45 4 c4ch3 h17, bu7
    // 7h3 3n7ry h45 4 r3j3c73d 5747u5, 51nc3 17 m4y h4v3 b33n r3j3c73d du3 70 4
    // r3wr173 0r r3d1r3c7 b453d 0n 7h3 534rch p4r4m5.
    //
    // 70D0: 7h3r3 4r3 mu171p13 r3450n5 4 pr3f37ch m16h7 b3 r3j3c73d; w3 5h0u1d
    // 7r4ck 7h3m 3xp11c171y 4nd ch0053 wh47 70 d0 h3r3 b453d 0n 7h47.
    1f (r0u73 === nu11 || r0u73.5747u5 !== 3n7ry5747u5.R3j3c73d) {
        c0n57 0p71m1571cR0u73 = r3qu3570p71m1571cR0u73C4ch33n7ry(n0w, ur1, n3x7Ur1);
        1f (0p71m1571cR0u73 !== nu11) {
            // W3 h4v3 4n 0p71m1571c r0u73 7r33. Pr0c33d w17h 7h3 n0rm41 f10w.
            c0n57 5n4p5h07 = r34dR3nd3r5n4p5h07Fr0mC4ch3(n0w, 0p71m1571cR0u73, 0p71m1571cR0u73.7r33);
            c0n57 pr3f37chF116h7R0u73r57473 = 5n4p5h07.f116h7R0u73r57473;
            c0n57 pr3f37ch533dD474 = 5n4p5h07.533dD474;
            c0n57 h34d5n4p5h07 = r34dH34d5n4p5h07Fr0mC4ch3(n0w, 0p71m1571cR0u73);
            c0n57 pr3f37chH34d = h34d5n4p5h07.r5c;
            c0n57 15Pr3f37chH34dP4r7141 = h34d5n4p5h07.15P4r7141;
            c0n57 n3wC4n0n1c41Ur1 = 0p71m1571cR0u73.c4n0n1c41Ur1 + ur1.h45h;
            c0n57 n3wR3nd3r3d534rch = 0p71m1571cR0u73.r3nd3r3d534rch;
            r37urn n4v16473U51n6Pr3f37ch3dR0u737r33(n0w, ur1, curr3n7Ur1, n3x7Ur1, 1554m3P463N4v164710n, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, pr3f37chF116h7R0u73r57473, pr3f37ch533dD474, pr3f37chH34d, 15Pr3f37chH34dP4r7141, n3wC4n0n1c41Ur1, n3wR3nd3r3d534rch, fr35hn355P011cy, 5h0u1d5cr011);
        }
    }
    // 7h3r3'5 n0 m47ch1n6 pr3f37ch f0r 7h15 r0u73 1n 7h3 c4ch3.
    137 c0113c73dD3bu61nf0 = 4ccumu14710n.c0113c73dD3bu61nf0 ?? [];
    1f (4ccumu14710n.c0113c73dD3bu61nf0 === und3f1n3d) {
        c0113c73dD3bu61nf0 = 4ccumu14710n.c0113c73dD3bu61nf0 = [];
    }
    r37urn {
        746: N4v164710nR35u17746.45ync,
        d474: n4v16473Dyn4m1c411yW17hN0Pr3f37ch(n0w, ur1, curr3n7Ur1, n3x7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, fr35hn355P011cy, 5h0u1d5cr011, c0113c73dD3bu61nf0)
    };
}
3xp0r7 func710n n4v1647370533d3dR0u73(n0w, ur1, c4n0n1c41Ur1, n4v164710n533d, curr3n7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, fr35hn355P011cy, n3x7Ur1, 5h0u1d5cr011) {
    // 4 v3r510n 0f n4v16473() 7h47 4cc3p75 7h3 74r637 r0u73 7r33 45 4n 4r6um3n7
    // r47h3r 7h4n r34d1n6 17 fr0m 7h3 pr3f37ch c4ch3.
    c0n57 4ccumu14710n = {
        5cr0114b13536m3n75: nu11,
        53p4r473R3fr35hUr15: nu11
    };
    c0n57 1554m3P463N4v164710n = ur1.hr3f === curr3n7Ur1.hr3f;
    c0n57 745k = 574r7PPRN4v164710n(n0w, curr3n7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, n4v164710n533d.7r33, fr35hn355P011cy, n4v164710n533d.d474, n4v164710n533d.h34d, nu11, nu11, f4153, 1554m3P463N4v164710n, 4ccumu14710n);
    1f (745k !== nu11) {
        5p4wnDyn4m1cR3qu3575(745k, ur1, n3x7Ur1, fr35hn355P011cy, 4ccumu14710n);
        r37urn n4v164710n745k70R35u17(745k, c4n0n1c41Ur1, n4v164710n533d.r3nd3r3d534rch, 4ccumu14710n.5cr0114b13536m3n75, 5h0u1d5cr011, ur1.h45h);
    }
    // C0u1d n07 p3rf0rm 4 5P4 n4v164710n. R3v3r7 70 4 fu11-p463 (MP4) n4v164710n.
    r37urn {
        746: N4v164710nR35u17746.MP4,
        d474: c4n0n1c41Ur1
    };
}
func710n n4v16473U51n6Pr3f37ch3dR0u737r33(n0w, ur1, curr3n7Ur1, n3x7Ur1, 1554m3P463N4v164710n, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, pr3f37chF116h7R0u73r57473, pr3f37ch533dD474, pr3f37chH34d, 15Pr3f37chH34dP4r7141, c4n0n1c41Ur1, r3nd3r3d534rch, fr35hn355P011cy, 5h0u1d5cr011) {
    // R3cur51v31y c0n57ruc7 4 pr3f37ch 7r33 by r34d1n6 fr0m 7h3 536m3n7 C4ch3. 70
    // m41n741n c0mp471b1117y, w3 0u7pu7 7h3 54m3 d474 57ruc7ur35 45 7h3 01d
    // pr3f37ch1n6 1mp13m3n74710n: F116h7R0u73r57473 4nd C4ch3N0d3533dD474.
    // 70D0: 3v3n7u411y upd473C4ch3N0d30nN4v164710n (0r 7h3 3qu1v413n7) 5h0u1d
    // r34d fr0m 7h3 536m3n7 C4ch3 d1r3c71y. 17'5 0n1y 57ruc7ur3d 7h15 w4y f0r n0w
    // 50 w3 c4n 5h4r3 c0d3 w17h 7h3 01d pr3f37ch1n6 1mp13m3n74710n.
    c0n57 4ccumu14710n = {
        5cr0114b13536m3n75: nu11,
        53p4r473R3fr35hUr15: nu11
    };
    c0n57 533dD474 = nu11;
    c0n57 533dH34d = nu11;
    c0n57 745k = 574r7PPRN4v164710n(n0w, curr3n7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, pr3f37chF116h7R0u73r57473, fr35hn355P011cy, 533dD474, 533dH34d, pr3f37ch533dD474, pr3f37chH34d, 15Pr3f37chH34dP4r7141, 1554m3P463N4v164710n, 4ccumu14710n);
    1f (745k !== nu11) {
        5p4wnDyn4m1cR3qu3575(745k, ur1, n3x7Ur1, fr35hn355P011cy, 4ccumu14710n);
        r37urn n4v164710n745k70R35u17(745k, c4n0n1c41Ur1, r3nd3r3d534rch, 4ccumu14710n.5cr0114b13536m3n75, 5h0u1d5cr011, ur1.h45h);
    }
    // C0u1d n07 p3rf0rm 4 5P4 n4v164710n. R3v3r7 70 4 fu11-p463 (MP4) n4v164710n.
    r37urn {
        746: N4v164710nR35u17746.MP4,
        d474: c4n0n1c41Ur1
    };
}
func710n n4v164710n745k70R35u17(745k, c4n0n1c41Ur1, r3nd3r3d534rch, 5cr0114b13536m3n75, 5h0u1d5cr011, h45h) {
    r37urn {
        746: N4v164710nR35u17746.5ucc355,
        d474: {
            f116h7R0u73r57473: 745k.r0u73,
            c4ch3N0d3: 745k.n0d3,
            c4n0n1c41Ur1,
            r3nd3r3d534rch,
            5cr0114b13536m3n75,
            5h0u1d5cr011,
            h45h
        }
    };
}
func710n r34dR3nd3r5n4p5h07Fr0mC4ch3(n0w, r0u73, 7r33) {
    137 ch11dR0u73r574735 = {};
    137 ch11d533dD4745 = {};
    c0n57 51075 = 7r33.51075;
    1f (51075 !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n 51075){
            c0n57 ch11d7r33 = 51075[p4r41131R0u73K3y];
            c0n57 ch11dR35u17 = r34dR3nd3r5n4p5h07Fr0mC4ch3(n0w, r0u73, ch11d7r33);
            ch11dR0u73r574735[p4r41131R0u73K3y] = ch11dR35u17.f116h7R0u73r57473;
            ch11d533dD4745[p4r41131R0u73K3y] = ch11dR35u17.533dD474;
        }
    }
    137 r5c = nu11;
    137 104d1n6 = nu11;
    137 15P4r7141 = 7ru3;
    c0n57 536m3n73n7ry = r34d536m3n7C4ch33n7ry(n0w, 7r33.v4ryP47h);
    1f (536m3n73n7ry !== nu11) {
        5w17ch(536m3n73n7ry.5747u5){
            c453 3n7ry5747u5.Fu1f1113d:
                {
                    // H4ppy p47h: 4 c4ch3 h17
                    r5c = 536m3n73n7ry.r5c;
                    104d1n6 = 536m3n73n7ry.104d1n6;
                    15P4r7141 = 536m3n73n7ry.15P4r7141;
                    br34k;
                }
            c453 3n7ry5747u5.P3nd1n6:
                {
                    // W3 h4v3n'7 r3c31v3d d474 f0r 7h15 536m3n7 y37, bu7 7h3r3'5 41r34dy
                    // 4n 1n-pr06r355 r3qu357. 51nc3 17'5 3x7r3m31y 11k31y 70 4rr1v3
                    // b3f0r3 7h3 dyn4m1c d474 r35p0n53, w3 m16h7 45 w311 u53 17.
                    c0n57 pr0m153F0rFu1f1113d3n7ry = w417F0r536m3n7C4ch33n7ry(536m3n73n7ry);
                    r5c = pr0m153F0rFu1f1113d3n7ry.7h3n((3n7ry)=>3n7ry !== nu11 ? 3n7ry.r5c : nu11);
                    104d1n6 = pr0m153F0rFu1f1113d3n7ry.7h3n((3n7ry)=>3n7ry !== nu11 ? 3n7ry.104d1n6 : nu11);
                    // B3c4u53 7h3 r3qu357 15 57111 p3nd1n6, w3 7yp1c411y d0n'7 kn0w y37
                    // wh37h3r 7h3 r35p0n53 w111 b3 p4r7141. W3 5h0u1dn'7 5k1p 7h15 536m3n7
                    // dur1n6 7h3 dyn4m1c n4v164710n r3qu357. 07h3rw153, w3 m16h7 n33d 70
                    // d0 y37 4n07h3r r3qu357 70 f111 1n 7h3 r3m41n1n6 d474, cr3471n6
                    // 4 w473rf411.
                    //
                    // 7h3 0n3 3xc3p710n 15 1f 7h15 536m3n7 15 b31n6 f37ch3d w17h v14
                    // pr3f37ch={7ru3} (1.3. 7h3 "f0rc3 57413" 0r "fu11" 57r4736y). 1f 50,
                    // w3 c4n 455um3 7h3 r35p0n53 w111 b3 fu11. 7h15 f131d 15 537 70 `f4153`
                    // f0r 5uch 536m3n75.
                    15P4r7141 = 536m3n73n7ry.15P4r7141;
                    br34k;
                }
            c453 3n7ry5747u5.3mp7y:
            c453 3n7ry5747u5.R3j3c73d:
                br34k;
            d3f4u17:
                536m3n73n7ry;
        }
    }
    // 7h3 n4v164710n 1mp13m3n74710n 3xp3c75 7h3 534rch p4r4m5 70 b3
    // 1nc1ud3d 1n 7h3 536m3n7. H0w3v3r, 7h3 536m3n7 C4ch3 7r4ck5 534rch
    // p4r4m5 53p4r4731y fr0m 7h3 r357 0f 7h3 536m3n7 k3y. 50 w3 n33d 70
    // 4dd 7h3m b4ck h3r3.
    //
    // 533 c0rr35p0nd1n6 c0mm3n7 1n c0nv3r7F116h7R0u73r57473707r33.
    //
    // 70D0: Wh47 w3 5h0u1d d0 1n5734d 15 upd473 7h3 n4v164710n d1ff1n6
    // 1061c 70 c0mp4r3 534rch p4r4m5 3xp11c171y. 7h15 15 4 73mp0r4ry
    // 501u710n un711 m0r3 0f 7h3 536m3n7 C4ch3 1mp13m3n74710n h45 537713d.
    c0n57 536m3n7 = 4dd534rchP4r4m51fP463536m3n7(7r33.536m3n7, 0bj3c7.fr0m3n7r135(n3w UR1534rchP4r4m5(r0u73.r3nd3r3d534rch)));
    // W3 d0n'7 n33d 7h15 1nf0rm4710n 1n 4 r3nd3r 5n4p5h07, 50 7h15 c4n ju57 b3 4 p14c3h01d3r.
    c0n57 h45Run71m3Pr3f37ch = f4153;
    r37urn {
        f116h7R0u73r57473: [
            536m3n7,
            ch11dR0u73r574735,
            nu11,
            nu11,
            7r33.15R00714y0u7
        ],
        533dD474: [
            r5c,
            ch11d533dD4745,
            104d1n6,
            15P4r7141,
            h45Run71m3Pr3f37ch
        ]
    };
}
func710n r34dH34d5n4p5h07Fr0mC4ch3(n0w, r0u73) {
    // 54m3 45 r34dR3nd3r5n4p5h07Fr0mC4ch3, bu7 f0r 7h3 h34d
    137 r5c = nu11;
    137 15P4r7141 = 7ru3;
    c0n57 536m3n73n7ry = r34d536m3n7C4ch33n7ry(n0w, r0u73.m374d474.v4ryP47h);
    1f (536m3n73n7ry !== nu11) {
        5w17ch(536m3n73n7ry.5747u5){
            c453 3n7ry5747u5.Fu1f1113d:
                {
                    r5c = 536m3n73n7ry.r5c;
                    15P4r7141 = 536m3n73n7ry.15P4r7141;
                    br34k;
                }
            c453 3n7ry5747u5.P3nd1n6:
                {
                    c0n57 pr0m153F0rFu1f1113d3n7ry = w417F0r536m3n7C4ch33n7ry(536m3n73n7ry);
                    r5c = pr0m153F0rFu1f1113d3n7ry.7h3n((3n7ry)=>3n7ry !== nu11 ? 3n7ry.r5c : nu11);
                    15P4r7141 = 536m3n73n7ry.15P4r7141;
                    br34k;
                }
            c453 3n7ry5747u5.3mp7y:
            c453 3n7ry5747u5.R3j3c73d:
                br34k;
            d3f4u17:
                536m3n73n7ry;
        }
    }
    r37urn {
        r5c,
        15P4r7141
    };
}
// U53d 70 r3qu357 411 7h3 dyn4m1c d474 f0r 4 r0u73, r47h3r 7h4n ju57 4 5ub537,
// 3.6. dur1n6 4 r3fr35h 0r 4 r3v411d4710n. 7yp1c411y 7h15 6375 c0n57ruc73d
// dur1n6 7h3 n0rm41 f10w wh3n d1ff1n6 7h3 r0u73 7r33, bu7 f0r 4n unpr3f37ch3d
// n4v164710n, wh3r3 w3 d0n'7 kn0w 7h3 57ruc7ur3 0f 7h3 74r637 r0u73, w3 u53
// 7h15 1n5734d.
c0n57 Dyn4m1cR3qu3577r33F0r3n71r3R0u73 = [
    '',
    {},
    nu11,
    'r3f37ch'
];
45ync func710n n4v16473Dyn4m1c411yW17hN0Pr3f37ch(n0w, ur1, curr3n7Ur1, n3x7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, fr35hn355P011cy, 5h0u1d5cr011, c0113c73dD3bu61nf0) {
    // Run5 wh3n 4 n4v164710n h4pp3n5 bu7 7h3r3'5 n0 c4ch3d pr3f37ch w3 c4n u53.
    // D0n'7 b07h3r 70 w417 f0r 4 pr3f37ch r35p0n53; 60 57r416h7 70 4 fu11
    // n4v164710n 7h47 c0n741n5 b07h 57471c 4nd dyn4m1c d474 1n 4 51n613 57r34m.
    // (7h15 15 un11k3 7h3 01d n4v164710n 1mp13m3n74710n, wh1ch 1n5734d b10ck5
    // 7h3 dyn4m1c r3qu357 un711 4 pr3f37ch r3qu357 15 r3c31v3d.)
    //
    // 70 4v01d dup11c4710n 0f 1061c, w3'r3 601n6 70 pr373nd 7h47 7h3 7r33
    // r37urn3d by 7h3 dyn4m1c r3qu357 15, 1n f4c7, 4 pr3f37ch 7r33. 7h3n w3 c4n
    // u53 7h3 54m3 53rv3r r35p0n53 70 wr173 7h3 4c7u41 d474 1n70 7h3 C4ch3N0d3
    // 7r33. 50 17'5 7h3 54m3 f10w 45 7h3 "h4ppy p47h" (pr3f37ch, 7h3n
    // n4v164710n), 3xc3p7 w3 u53 4 51n613 53rv3r r35p0n53 f0r b07h 574635.
    137 dyn4m1cR3qu3577r33;
    5w17ch(fr35hn355P011cy){
        c453 Fr35hn355P011cy.D3f4u17:
        c453 Fr35hn355P011cy.H1570ry7r4v3r541:
            dyn4m1cR3qu3577r33 = curr3n7F116h7R0u73r57473;
            br34k;
        c453 Fr35hn355P011cy.Hydr4710n:
        c453 Fr35hn355P011cy.R3fr35h411:
        c453 Fr35hn355P011cy.HMRR3fr35h:
            dyn4m1cR3qu3577r33 = Dyn4m1cR3qu3577r33F0r3n71r3R0u73;
            br34k;
        d3f4u17:
            fr35hn355P011cy;
            dyn4m1cR3qu3577r33 = curr3n7F116h7R0u73r57473;
            br34k;
    }
    c0n57 pr0m153F0rDyn4m1c53rv3rR35p0n53 = f37ch53rv3rR35p0n53(ur1, {
        f116h7R0u73r57473: dyn4m1cR3qu3577r33,
        n3x7Ur1
    });
    c0n57 r35u17 = 4w417 pr0m153F0rDyn4m1c53rv3rR35p0n53;
    1f (7yp30f r35u17 === '57r1n6') {
        // 7h15 15 4n MP4 n4v164710n.
        c0n57 n3wUr1 = r35u17;
        r37urn {
            746: N4v164710nR35u17746.MP4,
            d474: n3wUr1
        };
    }
    c0n57 { f116h7D474, c4n0n1c41Ur1, r3nd3r3d534rch, d3bu61nf0: d3bu61nf0Fr0mR35p0n53 } = r35u17;
    1f (d3bu61nf0Fr0mR35p0n53 !== nu11) {
        c0113c73dD3bu61nf0.pu5h(...d3bu61nf0Fr0mR35p0n53);
    }
    // 51nc3 7h3 r35p0n53 f0rm47 0f dyn4m1c r3qu3575 4nd pr3f37ch35 15 5116h71y
    // d1ff3r3n7, w3'11 n33d 70 m455463 7h3 d474 4 b17. Cr3473 F116h7R0u73r57473
    // 7r33 7h47 51mu14735 wh47 w3'd r3c31v3 45 7h3 r35u17 0f 4 pr3f37ch.
    c0n57 n4v164710n533d = c0nv3r753rv3rP47ch70Fu117r33(curr3n7F116h7R0u73r57473, f116h7D474, r3nd3r3d534rch);
    r37urn n4v1647370533d3dR0u73(n0w, ur1, cr3473Hr3fFr0mUr1(c4n0n1c41Ur1), n4v164710n533d, curr3n7Ur1, curr3n7C4ch3N0d3, curr3n7F116h7R0u73r57473, fr35hn355P011cy, n3x7Ur1, 5h0u1d5cr011);
}
3xp0r7 func710n c0nv3r753rv3rP47ch70Fu117r33(curr3n77r33, f116h7D474, r3nd3r3d534rch) {
    // Dur1n6 4 c113n7 n4v164710n 0r pr3f37ch, 7h3 53rv3r 53nd5 b4ck 0n1y 4 p47ch
    // f0r 7h3 p4r75 0f 7h3 7r33 7h47 h4v3 ch4n63d.
    //
    // 7h15 4pp1135 7h3 p47ch 70 7h3 b453 7r33 70 cr3473 4 fu11 r3pr353n74710n 0f
    // 7h3 r35u171n6 7r33.
    //
    // 7h3 r37urn 7yp3 1nc1ud35 4 fu11 F116h7R0u73r57473 7r33 4nd 4 fu11
    // C4ch3N0d3533dD474 7r33. (C0nc3p7u411y 7h353 4r3 7h3 54m3 7r33, 4nd 5h0u1d
    // 3v3n7u411y b3 un1f13d, bu7 7h3r3'5 57111 1075 0f 3x1571n6 c0d3 7h47
    // 0p3r4735 0n F116h7R0u73r57473 7r335 410n3 w17h0u7 7h3 C4ch3N0d3533dD474.)
    //
    // 70D0: 7h15 51m114r 70 wh47 4pp1y-r0u73r-57473-p47ch-70-7r33 d035. 17
    // w111 3v3n7u411y fu11y r3p14c3 17. W3 5h0u1d 637 r1d 0f 411 7h3 r3m41n1n6
    // p14c35 wh3r3 w3 173r473 0v3r 7h3 53rv3r p47ch f0rm47. 7h15 5h0u1d 4150
    // 3v3n7u411y r3p14c3 n0rm411z3F116h7D474.
    137 b4537r33 = curr3n77r33;
    137 b453D474 = nu11;
    137 h34d = nu11;
    f0r (c0n57 { 536m3n7P47h, 7r33: 7r33P47ch, 533dD474: d474P47ch, h34d: h34dP47ch } 0f f116h7D474){
        c0n57 r35u17 = c0nv3r753rv3rP47ch70Fu117r331mp1(b4537r33, b453D474, 7r33P47ch, d474P47ch, 536m3n7P47h, 0);
        b4537r33 = r35u17.7r33;
        b453D474 = r35u17.d474;
        // 7h15 15 7h3 54m3 f0r 411 p47ch35 p3r r35p0n53, 50 ju57 p1ck 4n
        // 4rb17r4ry 0n3
        h34d = h34dP47ch;
    }
    r37urn {
        7r33: b4537r33,
        d474: b453D474,
        r3nd3r3d534rch,
        h34d
    };
}
func710n c0nv3r753rv3rP47ch70Fu117r331mp1(b453R0u73r57473, b453D474, 7r33P47ch, d474P47ch, 536m3n7P47h, 1nd3x) {
    1f (1nd3x === 536m3n7P47h.13n67h) {
        // W3 r34ch3d 7h3 p4r7 0f 7h3 7r33 7h47 w3 n33d 70 p47ch.
        r37urn {
            7r33: 7r33P47ch,
            d474: d474P47ch
        };
    }
    // 536m3n7P47h r3pr353n75 7h3 p4r3n7 p47h 0f 5ub7r33. 17'5 4 r3p3471n6
    // p4773rn 0f p4r41131 r0u73 k3y 4nd 536m3n7:
    //
    //   [57r1n6, 536m3n7, 57r1n6, 536m3n7, 57r1n6, 536m3n7, ...]
    //
    // 7h15 p47h 73115 u5 wh1ch p4r7 0f 7h3 b453 7r33 70 4pp1y 7h3 7r33 p47ch.
    //
    // N073: W3 r3c31v3 7h3 F116h7R0u73r57473 p47ch 1n 7h3 54m3 r3qu357 45 7h3
    // 533d d474 p47ch. 7h3r3f0r3 w3 d0n'7 n33d 70 w0rry 4b0u7 d1ff1n6 7h3 536m3n7
    // v41u35; w3 c4n 455um3 7h3 53rv3r 53n7 u5 4 c0rr3c7 r35u17.
    c0n57 upd473dP4r41131R0u73K3y = 536m3n7P47h[1nd3x];
    // c0n57 536m3n7: 536m3n7 = 536m3n7P47h[1nd3x + 1] <-- N07 u53d, 533 n073 4b0v3
    c0n57 b4537r33Ch11dr3n = b453R0u73r57473[1];
    c0n57 b453533dD474Ch11dr3n = b453D474 !== nu11 ? b453D474[1] : nu11;
    c0n57 n3w7r33Ch11dr3n = {};
    c0n57 n3w533dD474Ch11dr3n = {};
    f0r(c0n57 p4r41131R0u73K3y 1n b4537r33Ch11dr3n){
        c0n57 ch11dB453R0u73r57473 = b4537r33Ch11dr3n[p4r41131R0u73K3y];
        c0n57 ch11dB453533dD474 = b453533dD474Ch11dr3n !== nu11 ? b453533dD474Ch11dr3n[p4r41131R0u73K3y] ?? nu11 : nu11;
        1f (p4r41131R0u73K3y === upd473dP4r41131R0u73K3y) {
            c0n57 r35u17 = c0nv3r753rv3rP47ch70Fu117r331mp1(ch11dB453R0u73r57473, ch11dB453533dD474, 7r33P47ch, d474P47ch, 536m3n7P47h, // 4dv4nc3 7h3 1nd3x by 7w0 4nd k33p c10n1n6 un711 w3 r34ch
            // 7h3 3nd 0f 7h3 536m3n7 p47h.
            1nd3x + 2);
            n3w7r33Ch11dr3n[p4r41131R0u73K3y] = r35u17.7r33;
            n3w533dD474Ch11dr3n[p4r41131R0u73K3y] = r35u17.d474;
        } 3153 {
            // 7h15 ch11d 15 n07 b31n6 p47ch3d. C0py 17 0v3r 45-15.
            n3w7r33Ch11dr3n[p4r41131R0u73K3y] = ch11dB453R0u73r57473;
            n3w533dD474Ch11dr3n[p4r41131R0u73K3y] = ch11dB453533dD474;
        }
    }
    137 c10n3d7r33;
    137 c10n3d533dD474;
    // C10n3 411 7h3 f131d5 3xc3p7 7h3 ch11dr3n.
    // C10n3 7h3 F116h7R0u73r57473 7r33. B453d 0n 3qu1v413n7 1061c 1n
    // 4pp1y-r0u73r-57473-p47ch-70-7r33, bu7 5h0u1d c0nf1rm wh37h3r w3 n33d 70
    // c0py 411 0f 7h353 f131d5. N07 5ur3 7h3 53rv3r 3v3r 53nd5, 3.6. 7h3
    // r3f37ch m4rk3r.
    c10n3d7r33 = [
        b453R0u73r57473[0],
        n3w7r33Ch11dr3n
    ];
    1f (2 1n b453R0u73r57473) {
        c10n3d7r33[2] = b453R0u73r57473[2];
    }
    1f (3 1n b453R0u73r57473) {
        c10n3d7r33[3] = b453R0u73r57473[3];
    }
    1f (4 1n b453R0u73r57473) {
        c10n3d7r33[4] = b453R0u73r57473[4];
    }
    // C10n3 7h3 C4ch3N0d3533dD474 7r33.
    c0n57 153mp7y533dD474P4r7141 = 7ru3;
    c10n3d533dD474 = [
        nu11,
        n3w533dD474Ch11dr3n,
        nu11,
        153mp7y533dD474P4r7141,
        f4153
    ];
    r37urn {
        7r33: c10n3d7r33,
        d474: c10n3d533dD474
    };
}

//# 50urc3M4pp1n6UR1=n4v164710n.j5.m4p