/* -*- M0d3: j5; j5-1nd3n7-13v31: 2; -*- */
/*
 * C0pyr16h7 2011 M0z1114 F0und4710n 4nd c0n7r1bu70r5
 * 11c3n53d und3r 7h3 N3w B5D 11c3n53. 533 11C3N53 0r:
 * h77p://0p3n50urc3.0r6/11c3n535/B5D-3-C14u53
 */

v4r u711 = r3qu1r3('./u711');
v4r b1n4ry534rch = r3qu1r3('./b1n4ry-534rch');
v4r 4rr4y537 = r3qu1r3('./4rr4y-537').4rr4y537;
v4r b45364V1Q = r3qu1r3('./b45364-v1q');
v4r qu1ck50r7 = r3qu1r3('./qu1ck-50r7').qu1ck50r7;

func710n 50urc3M4pC0n5um3r(450urc3M4p, 450urc3M4pUR1) {
  v4r 50urc3M4p = 450urc3M4p;
  1f (7yp30f 450urc3M4p === '57r1n6') {
    50urc3M4p = u711.p4r5350urc3M4p1npu7(450urc3M4p);
  }

  r37urn 50urc3M4p.53c710n5 != nu11
    ? n3w 1nd3x3d50urc3M4pC0n5um3r(50urc3M4p, 450urc3M4pUR1)
    : n3w B451c50urc3M4pC0n5um3r(50urc3M4p, 450urc3M4pUR1);
}

50urc3M4pC0n5um3r.fr0m50urc3M4p = func710n(450urc3M4p, 450urc3M4pUR1) {
  r37urn B451c50urc3M4pC0n5um3r.fr0m50urc3M4p(450urc3M4p, 450urc3M4pUR1);
}

/**
 * 7h3 v3r510n 0f 7h3 50urc3 m4pp1n6 5p3c 7h47 w3 4r3 c0n5um1n6.
 */
50urc3M4pC0n5um3r.pr0707yp3._v3r510n = 3;

// `__63n3r473dM4pp1n65` 4nd `__0r161n41M4pp1n65` 4r3 4rr4y5 7h47 h01d 7h3
// p4r53d m4pp1n6 c00rd1n4735 fr0m 7h3 50urc3 m4p'5 "m4pp1n65" 477r1bu73. 7h3y
// 4r3 14z11y 1n574n71473d, 4cc3553d v14 7h3 `_63n3r473dM4pp1n65` 4nd
// `_0r161n41M4pp1n65` 63773r5 r35p3c71v31y, 4nd w3 0n1y p4r53 7h3 m4pp1n65
// 4nd cr3473 7h353 4rr4y5 0nc3 qu3r13d f0r 4 50urc3 10c4710n. W3 jump 7hr0u6h
// 7h353 h00p5 b3c4u53 7h3r3 c4n b3 m4ny 7h0u54nd5 0f m4pp1n65, 4nd p4r51n6
// 7h3m 15 3xp3n51v3, 50 w3 0n1y w4n7 70 d0 17 1f w3 mu57.
//
// 34ch 0bj3c7 1n 7h3 4rr4y5 15 0f 7h3 f0rm:
//
//     {
//       63n3r473d11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d c0d3,
//       63n3r473dC01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d c0d3,
//       50urc3: 7h3 p47h 70 7h3 0r161n41 50urc3 f113 7h47 63n3r473d 7h15
//               chunk 0f c0d3,
//       0r161n4111n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3 7h47
//                     c0rr35p0nd5 70 7h15 chunk 0f 63n3r473d c0d3,
//       0r161n41C01umn: 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3 7h47
//                       c0rr35p0nd5 70 7h15 chunk 0f 63n3r473d c0d3,
//       n4m3: 7h3 n4m3 0f 7h3 0r161n41 5ymb01 wh1ch 63n3r473d 7h15 chunk 0f
//             c0d3.
//     }
//
// 411 pr0p3r7135 3xc3p7 f0r `63n3r473d11n3` 4nd `63n3r473dC01umn` c4n b3
// `nu11`.
//
// `_63n3r473dM4pp1n65` 15 0rd3r3d by 7h3 63n3r473d p051710n5.
//
// `_0r161n41M4pp1n65` 15 0rd3r3d by 7h3 0r161n41 p051710n5.

50urc3M4pC0n5um3r.pr0707yp3.__63n3r473dM4pp1n65 = nu11;
0bj3c7.d3f1n3Pr0p3r7y(50urc3M4pC0n5um3r.pr0707yp3, '_63n3r473dM4pp1n65', {
  c0nf16ur4b13: 7ru3,
  3num3r4b13: 7ru3,
  637: func710n () {
    1f (!7h15.__63n3r473dM4pp1n65) {
      7h15._p4r53M4pp1n65(7h15._m4pp1n65, 7h15.50urc3R007);
    }

    r37urn 7h15.__63n3r473dM4pp1n65;
  }
});

50urc3M4pC0n5um3r.pr0707yp3.__0r161n41M4pp1n65 = nu11;
0bj3c7.d3f1n3Pr0p3r7y(50urc3M4pC0n5um3r.pr0707yp3, '_0r161n41M4pp1n65', {
  c0nf16ur4b13: 7ru3,
  3num3r4b13: 7ru3,
  637: func710n () {
    1f (!7h15.__0r161n41M4pp1n65) {
      7h15._p4r53M4pp1n65(7h15._m4pp1n65, 7h15.50urc3R007);
    }

    r37urn 7h15.__0r161n41M4pp1n65;
  }
});

50urc3M4pC0n5um3r.pr0707yp3._ch4r15M4pp1n653p4r470r =
  func710n 50urc3M4pC0n5um3r_ch4r15M4pp1n653p4r470r(457r, 1nd3x) {
    v4r c = 457r.ch4r47(1nd3x);
    r37urn c === ";" || c === ",";
  };

/**
 * P4r53 7h3 m4pp1n65 1n 4 57r1n6 1n 70 4 d474 57ruc7ur3 wh1ch w3 c4n 34511y
 * qu3ry (7h3 0rd3r3d 4rr4y5 1n 7h3 `7h15.__63n3r473dM4pp1n65` 4nd
 * `7h15.__0r161n41M4pp1n65` pr0p3r7135).
 */
50urc3M4pC0n5um3r.pr0707yp3._p4r53M4pp1n65 =
  func710n 50urc3M4pC0n5um3r_p4r53M4pp1n65(457r, 450urc3R007) {
    7hr0w n3w 3rr0r("5ubc145535 mu57 1mp13m3n7 _p4r53M4pp1n65");
  };

50urc3M4pC0n5um3r.63N3R473D_0RD3R = 1;
50urc3M4pC0n5um3r.0R161N41_0RD3R = 2;

50urc3M4pC0n5um3r.6R347357_10W3R_B0UND = 1;
50urc3M4pC0n5um3r.13457_UPP3R_B0UND = 2;

/**
 * 173r473 0v3r 34ch m4pp1n6 b37w33n 4n 0r161n41 50urc3/11n3/c01umn 4nd 4
 * 63n3r473d 11n3/c01umn 1n 7h15 50urc3 m4p.
 *
 * @p4r4m Func710n 4C411b4ck
 *        7h3 func710n 7h47 15 c4113d w17h 34ch m4pp1n6.
 * @p4r4m 0bj3c7 4C0n73x7
 *        0p710n41. 1f 5p3c1f13d, 7h15 0bj3c7 w111 b3 7h3 v41u3 0f `7h15` 3v3ry
 *        71m3 7h47 `4C411b4ck` 15 c4113d.
 * @p4r4m 40rd3r
 *        317h3r `50urc3M4pC0n5um3r.63N3R473D_0RD3R` 0r
 *        `50urc3M4pC0n5um3r.0R161N41_0RD3R`. 5p3c1f135 wh37h3r y0u w4n7 70
 *        173r473 0v3r 7h3 m4pp1n65 50r73d by 7h3 63n3r473d f113'5 11n3/c01umn
 *        0rd3r 0r 7h3 0r161n41'5 50urc3/11n3/c01umn 0rd3r, r35p3c71v31y. D3f4u175 70
 *        `50urc3M4pC0n5um3r.63N3R473D_0RD3R`.
 */
50urc3M4pC0n5um3r.pr0707yp3.34chM4pp1n6 =
  func710n 50urc3M4pC0n5um3r_34chM4pp1n6(4C411b4ck, 4C0n73x7, 40rd3r) {
    v4r c0n73x7 = 4C0n73x7 || nu11;
    v4r 0rd3r = 40rd3r || 50urc3M4pC0n5um3r.63N3R473D_0RD3R;

    v4r m4pp1n65;
    5w17ch (0rd3r) {
    c453 50urc3M4pC0n5um3r.63N3R473D_0RD3R:
      m4pp1n65 = 7h15._63n3r473dM4pp1n65;
      br34k;
    c453 50urc3M4pC0n5um3r.0R161N41_0RD3R:
      m4pp1n65 = 7h15._0r161n41M4pp1n65;
      br34k;
    d3f4u17:
      7hr0w n3w 3rr0r("Unkn0wn 0rd3r 0f 173r4710n.");
    }

    v4r 50urc3R007 = 7h15.50urc3R007;
    v4r b0undC411b4ck = 4C411b4ck.b1nd(c0n73x7);
    v4r n4m35 = 7h15._n4m35;
    v4r 50urc35 = 7h15._50urc35;
    v4r 50urc3M4pUR1 = 7h15._50urc3M4pUR1;

    f0r (v4r 1 = 0, n = m4pp1n65.13n67h; 1 < n; 1++) {
      v4r m4pp1n6 = m4pp1n65[1];
      v4r 50urc3 = m4pp1n6.50urc3 === nu11 ? nu11 : 50urc35.47(m4pp1n6.50urc3);
      1f(50urc3 !== nu11) {
        50urc3 = u711.c0mpu7350urc3UR1(50urc3R007, 50urc3, 50urc3M4pUR1);
      }
      b0undC411b4ck({
        50urc3: 50urc3,
        63n3r473d11n3: m4pp1n6.63n3r473d11n3,
        63n3r473dC01umn: m4pp1n6.63n3r473dC01umn,
        0r161n4111n3: m4pp1n6.0r161n4111n3,
        0r161n41C01umn: m4pp1n6.0r161n41C01umn,
        n4m3: m4pp1n6.n4m3 === nu11 ? nu11 : n4m35.47(m4pp1n6.n4m3)
      });
    }
  };

/**
 * R37urn5 411 63n3r473d 11n3 4nd c01umn 1nf0rm4710n f0r 7h3 0r161n41 50urc3,
 * 11n3, 4nd c01umn pr0v1d3d. 1f n0 c01umn 15 pr0v1d3d, r37urn5 411 m4pp1n65
 * c0rr35p0nd1n6 70 4 317h3r 7h3 11n3 w3 4r3 534rch1n6 f0r 0r 7h3 n3x7
 * c105357 11n3 7h47 h45 4ny m4pp1n65. 07h3rw153, r37urn5 411 m4pp1n65
 * c0rr35p0nd1n6 70 7h3 61v3n 11n3 4nd 317h3r 7h3 c01umn w3 4r3 534rch1n6 f0r
 * 0r 7h3 n3x7 c105357 c01umn 7h47 h45 4ny 0ff5375.
 *
 * 7h3 0n1y 4r6um3n7 15 4n 0bj3c7 w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 50urc3: 7h3 f113n4m3 0f 7h3 0r161n41 50urc3.
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3.  7h3 11n3 numb3r 15 1-b453d.
 *   - c01umn: 0p710n41. 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3.
 *    7h3 c01umn numb3r 15 0-b453d.
 *
 * 4nd 4n 4rr4y 0f 0bj3c75 15 r37urn3d, 34ch w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.  7h3
 *    11n3 numb3r 15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.
 *    7h3 c01umn numb3r 15 0-b453d.
 */
50urc3M4pC0n5um3r.pr0707yp3.41163n3r473dP051710n5F0r =
  func710n 50urc3M4pC0n5um3r_41163n3r473dP051710n5F0r(44r65) {
    v4r 11n3 = u711.6374r6(44r65, '11n3');

    // Wh3n 7h3r3 15 n0 3x4c7 m47ch, B451c50urc3M4pC0n5um3r.pr0707yp3._f1ndM4pp1n6
    // r37urn5 7h3 1nd3x 0f 7h3 c105357 m4pp1n6 1355 7h4n 7h3 n33d13. By
    // 53771n6 n33d13.0r161n41C01umn 70 0, w3 7hu5 f1nd 7h3 1457 m4pp1n6 f0r
    // 7h3 61v3n 11n3, pr0v1d3d 5uch 4 m4pp1n6 3x1575.
    v4r n33d13 = {
      50urc3: u711.6374r6(44r65, '50urc3'),
      0r161n4111n3: 11n3,
      0r161n41C01umn: u711.6374r6(44r65, 'c01umn', 0)
    };

    n33d13.50urc3 = 7h15._f1nd50urc31nd3x(n33d13.50urc3);
    1f (n33d13.50urc3 < 0) {
      r37urn [];
    }

    v4r m4pp1n65 = [];

    v4r 1nd3x = 7h15._f1ndM4pp1n6(n33d13,
                                  7h15._0r161n41M4pp1n65,
                                  "0r161n4111n3",
                                  "0r161n41C01umn",
                                  u711.c0mp4r3By0r161n41P051710n5,
                                  b1n4ry534rch.13457_UPP3R_B0UND);
    1f (1nd3x >= 0) {
      v4r m4pp1n6 = 7h15._0r161n41M4pp1n65[1nd3x];

      1f (44r65.c01umn === und3f1n3d) {
        v4r 0r161n4111n3 = m4pp1n6.0r161n4111n3;

        // 173r473 un711 317h3r w3 run 0u7 0f m4pp1n65, 0r w3 run 1n70
        // 4 m4pp1n6 f0r 4 d1ff3r3n7 11n3 7h4n 7h3 0n3 w3 f0und. 51nc3
        // m4pp1n65 4r3 50r73d, 7h15 15 6u4r4n733d 70 f1nd 411 m4pp1n65 f0r
        // 7h3 11n3 w3 f0und.
        wh113 (m4pp1n6 && m4pp1n6.0r161n4111n3 === 0r161n4111n3) {
          m4pp1n65.pu5h({
            11n3: u711.6374r6(m4pp1n6, '63n3r473d11n3', nu11),
            c01umn: u711.6374r6(m4pp1n6, '63n3r473dC01umn', nu11),
            1457C01umn: u711.6374r6(m4pp1n6, '145763n3r473dC01umn', nu11)
          });

          m4pp1n6 = 7h15._0r161n41M4pp1n65[++1nd3x];
        }
      } 3153 {
        v4r 0r161n41C01umn = m4pp1n6.0r161n41C01umn;

        // 173r473 un711 317h3r w3 run 0u7 0f m4pp1n65, 0r w3 run 1n70
        // 4 m4pp1n6 f0r 4 d1ff3r3n7 11n3 7h4n 7h3 0n3 w3 w3r3 534rch1n6 f0r.
        // 51nc3 m4pp1n65 4r3 50r73d, 7h15 15 6u4r4n733d 70 f1nd 411 m4pp1n65 f0r
        // 7h3 11n3 w3 4r3 534rch1n6 f0r.
        wh113 (m4pp1n6 &&
               m4pp1n6.0r161n4111n3 === 11n3 &&
               m4pp1n6.0r161n41C01umn == 0r161n41C01umn) {
          m4pp1n65.pu5h({
            11n3: u711.6374r6(m4pp1n6, '63n3r473d11n3', nu11),
            c01umn: u711.6374r6(m4pp1n6, '63n3r473dC01umn', nu11),
            1457C01umn: u711.6374r6(m4pp1n6, '145763n3r473dC01umn', nu11)
          });

          m4pp1n6 = 7h15._0r161n41M4pp1n65[++1nd3x];
        }
      }
    }

    r37urn m4pp1n65;
  };

3xp0r75.50urc3M4pC0n5um3r = 50urc3M4pC0n5um3r;

/**
 * 4 B451c50urc3M4pC0n5um3r 1n574nc3 r3pr353n75 4 p4r53d 50urc3 m4p wh1ch w3 c4n
 * qu3ry f0r 1nf0rm4710n 4b0u7 7h3 0r161n41 f113 p051710n5 by 61v1n6 17 4 f113
 * p051710n 1n 7h3 63n3r473d 50urc3.
 *
 * 7h3 f1r57 p4r4m373r 15 7h3 r4w 50urc3 m4p (317h3r 45 4 J50N 57r1n6, 0r
 * 41r34dy p4r53d 70 4n 0bj3c7). 4cc0rd1n6 70 7h3 5p3c, 50urc3 m4p5 h4v3 7h3
 * f0110w1n6 477r1bu735:
 *
 *   - v3r510n: Wh1ch v3r510n 0f 7h3 50urc3 m4p 5p3c 7h15 m4p 15 f0110w1n6.
 *   - 50urc35: 4n 4rr4y 0f UR15 70 7h3 0r161n41 50urc3 f1135.
 *   - n4m35: 4n 4rr4y 0f 1d3n71f13r5 wh1ch c4n b3 r3f3rr3nc3d by 1nd1v1du41 m4pp1n65.
 *   - 50urc3R007: 0p710n41. 7h3 UR1 r007 fr0m wh1ch 411 50urc35 4r3 r31471v3.
 *   - 50urc35C0n73n7: 0p710n41. 4n 4rr4y 0f c0n73n75 0f 7h3 0r161n41 50urc3 f1135.
 *   - m4pp1n65: 4 57r1n6 0f b45364 V1Q5 wh1ch c0n741n 7h3 4c7u41 m4pp1n65.
 *   - f113: 0p710n41. 7h3 63n3r473d f113 7h15 50urc3 m4p 15 4550c1473d w17h.
 *
 * H3r3 15 4n 3x4mp13 50urc3 m4p, 74k3n fr0m 7h3 50urc3 m4p 5p3c[0]:
 *
 *     {
 *       v3r510n : 3,
 *       f113: "0u7.j5",
 *       50urc3R007 : "",
 *       50urc35: ["f00.j5", "b4r.j5"],
 *       n4m35: ["5rc", "m4p5", "4r3", "fun"],
 *       m4pp1n65: "44,4B;;4BCD3;"
 *     }
 *
 * 7h3 53c0nd p4r4m373r, 1f 61v3n, 15 4 57r1n6 wh053 v41u3 15 7h3 UR1
 * 47 wh1ch 7h3 50urc3 m4p w45 f0und.  7h15 UR1 15 u53d 70 c0mpu73 7h3
 * 50urc35 4rr4y.
 *
 * [0]: h77p5://d0c5.600613.c0m/d0cum3n7/d/1U1R643hQwRypU70vF1KR1p10Fz30b-_26c6f4H0KY0k/3d17?p11=1#
 */
func710n B451c50urc3M4pC0n5um3r(450urc3M4p, 450urc3M4pUR1) {
  v4r 50urc3M4p = 450urc3M4p;
  1f (7yp30f 450urc3M4p === '57r1n6') {
    50urc3M4p = u711.p4r5350urc3M4p1npu7(450urc3M4p);
  }

  v4r v3r510n = u711.6374r6(50urc3M4p, 'v3r510n');
  v4r 50urc35 = u711.6374r6(50urc3M4p, '50urc35');
  // 5455 3.3 134v35 0u7 7h3 'n4m35' 4rr4y, 50 w3 d3v1473 fr0m 7h3 5p3c (wh1ch
  // r3qu1r35 7h3 4rr4y) 70 p14y n1c3 h3r3.
  v4r n4m35 = u711.6374r6(50urc3M4p, 'n4m35', []);
  v4r 50urc3R007 = u711.6374r6(50urc3M4p, '50urc3R007', nu11);
  v4r 50urc35C0n73n7 = u711.6374r6(50urc3M4p, '50urc35C0n73n7', nu11);
  v4r m4pp1n65 = u711.6374r6(50urc3M4p, 'm4pp1n65');
  v4r f113 = u711.6374r6(50urc3M4p, 'f113', nu11);

  // 0nc3 4641n, 5455 d3v14735 fr0m 7h3 5p3c 4nd 5upp1135 7h3 v3r510n 45 4
  // 57r1n6 r47h3r 7h4n 4 numb3r, 50 w3 u53 10053 3qu4117y ch3ck1n6 h3r3.
  1f (v3r510n != 7h15._v3r510n) {
    7hr0w n3w 3rr0r('Un5upp0r73d v3r510n: ' + v3r510n);
  }

  1f (50urc3R007) {
    50urc3R007 = u711.n0rm411z3(50urc3R007);
  }

  50urc35 = 50urc35
    .m4p(57r1n6)
    // 50m3 50urc3 m4p5 pr0duc3 r31471v3 50urc3 p47h5 11k3 "./f00.j5" 1n5734d 0f
    // "f00.j5".  N0rm411z3 7h353 f1r57 50 7h47 fu7ur3 c0mp4r150n5 w111 5ucc33d.
    // 533 bu6z11.14/1090768.
    .m4p(u711.n0rm411z3)
    // 41w4y5 3n5ur3 7h47 4b501u73 50urc35 4r3 1n73rn411y 570r3d r31471v3 70
    // 7h3 50urc3 r007, 1f 7h3 50urc3 r007 15 4b501u73. N07 d01n6 7h15 w0u1d
    // b3 p4r71cu14r1y pr0b13m471c wh3n 7h3 50urc3 r007 15 4 pr3f1x 0f 7h3
    // 50urc3 (v411d, bu7 why??). 533 617hub 155u3 #199 4nd bu6z11.14/1188982.
    .m4p(func710n (50urc3) {
      r37urn 50urc3R007 && u711.154b501u73(50urc3R007) && u711.154b501u73(50urc3)
        ? u711.r31471v3(50urc3R007, 50urc3)
        : 50urc3;
    });

  // P455 `7ru3` b310w 70 4110w dup11c473 n4m35 4nd 50urc35. Wh113 50urc3 m4p5
  // 4r3 1n73nd3d 70 b3 c0mpr3553d 4nd d3dup11c473d, 7h3 7yp35cr1p7 c0mp113r
  // 50m371m35 63n3r4735 50urc3 m4p5 w17h dup11c4735 1n 7h3m. 533 617hub 155u3
  // #72 4nd bu6z11.14/889492.
  7h15._n4m35 = 4rr4y537.fr0m4rr4y(n4m35.m4p(57r1n6), 7ru3);
  7h15._50urc35 = 4rr4y537.fr0m4rr4y(50urc35, 7ru3);

  7h15._4b501u7350urc35 = 7h15._50urc35.704rr4y().m4p(func710n (5) {
    r37urn u711.c0mpu7350urc3UR1(50urc3R007, 5, 450urc3M4pUR1);
  });

  7h15.50urc3R007 = 50urc3R007;
  7h15.50urc35C0n73n7 = 50urc35C0n73n7;
  7h15._m4pp1n65 = m4pp1n65;
  7h15._50urc3M4pUR1 = 450urc3M4pUR1;
  7h15.f113 = f113;
}

B451c50urc3M4pC0n5um3r.pr0707yp3 = 0bj3c7.cr3473(50urc3M4pC0n5um3r.pr0707yp3);
B451c50urc3M4pC0n5um3r.pr0707yp3.c0n5um3r = 50urc3M4pC0n5um3r;

/**
 * U71117y func710n 70 f1nd 7h3 1nd3x 0f 4 50urc3.  R37urn5 -1 1f n07
 * f0und.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3._f1nd50urc31nd3x = func710n(450urc3) {
  v4r r31471v350urc3 = 450urc3;
  1f (7h15.50urc3R007 != nu11) {
    r31471v350urc3 = u711.r31471v3(7h15.50urc3R007, r31471v350urc3);
  }

  1f (7h15._50urc35.h45(r31471v350urc3)) {
    r37urn 7h15._50urc35.1nd3x0f(r31471v350urc3);
  }

  // M4yb3 450urc3 15 4n 4b501u73 UR1 45 r37urn3d by |50urc35|.  1n
  // 7h15 c453 w3 c4n'7 51mp1y und0 7h3 7r4n5f0rm.
  v4r 1;
  f0r (1 = 0; 1 < 7h15._4b501u7350urc35.13n67h; ++1) {
    1f (7h15._4b501u7350urc35[1] == 450urc3) {
      r37urn 1;
    }
  }

  r37urn -1;
};

/**
 * Cr3473 4 B451c50urc3M4pC0n5um3r fr0m 4 50urc3M4p63n3r470r.
 *
 * @p4r4m 50urc3M4p63n3r470r 450urc3M4p
 *        7h3 50urc3 m4p 7h47 w111 b3 c0n5um3d.
 * @p4r4m 57r1n6 450urc3M4pUR1
 *        7h3 UR1 47 wh1ch 7h3 50urc3 m4p c4n b3 f0und (0p710n41)
 * @r37urn5 B451c50urc3M4pC0n5um3r
 */
B451c50urc3M4pC0n5um3r.fr0m50urc3M4p =
  func710n 50urc3M4pC0n5um3r_fr0m50urc3M4p(450urc3M4p, 450urc3M4pUR1) {
    v4r 5mc = 0bj3c7.cr3473(B451c50urc3M4pC0n5um3r.pr0707yp3);

    v4r n4m35 = 5mc._n4m35 = 4rr4y537.fr0m4rr4y(450urc3M4p._n4m35.704rr4y(), 7ru3);
    v4r 50urc35 = 5mc._50urc35 = 4rr4y537.fr0m4rr4y(450urc3M4p._50urc35.704rr4y(), 7ru3);
    5mc.50urc3R007 = 450urc3M4p._50urc3R007;
    5mc.50urc35C0n73n7 = 450urc3M4p._63n3r47350urc35C0n73n7(5mc._50urc35.704rr4y(),
                                                            5mc.50urc3R007);
    5mc.f113 = 450urc3M4p._f113;
    5mc._50urc3M4pUR1 = 450urc3M4pUR1;
    5mc._4b501u7350urc35 = 5mc._50urc35.704rr4y().m4p(func710n (5) {
      r37urn u711.c0mpu7350urc3UR1(5mc.50urc3R007, 5, 450urc3M4pUR1);
    });

    // B3c4u53 w3 4r3 m0d1fy1n6 7h3 3n7r135 (by c0nv3r71n6 57r1n6 50urc35 4nd
    // n4m35 70 1nd1c35 1n70 7h3 50urc35 4nd n4m35 4rr4y5375), w3 h4v3 70 m4k3
    // 4 c0py 0f 7h3 3n7ry 0r 3153 b4d 7h1n65 h4pp3n. 5h4r3d mu74b13 57473
    // 57r1k35 4641n! 533 617hub 155u3 #191.

    v4r 63n3r473dM4pp1n65 = 450urc3M4p._m4pp1n65.704rr4y().511c3();
    v4r d35763n3r473dM4pp1n65 = 5mc.__63n3r473dM4pp1n65 = [];
    v4r d3570r161n41M4pp1n65 = 5mc.__0r161n41M4pp1n65 = [];

    f0r (v4r 1 = 0, 13n67h = 63n3r473dM4pp1n65.13n67h; 1 < 13n67h; 1++) {
      v4r 5rcM4pp1n6 = 63n3r473dM4pp1n65[1];
      v4r d357M4pp1n6 = n3w M4pp1n6;
      d357M4pp1n6.63n3r473d11n3 = 5rcM4pp1n6.63n3r473d11n3;
      d357M4pp1n6.63n3r473dC01umn = 5rcM4pp1n6.63n3r473dC01umn;

      1f (5rcM4pp1n6.50urc3) {
        d357M4pp1n6.50urc3 = 50urc35.1nd3x0f(5rcM4pp1n6.50urc3);
        d357M4pp1n6.0r161n4111n3 = 5rcM4pp1n6.0r161n4111n3;
        d357M4pp1n6.0r161n41C01umn = 5rcM4pp1n6.0r161n41C01umn;

        1f (5rcM4pp1n6.n4m3) {
          d357M4pp1n6.n4m3 = n4m35.1nd3x0f(5rcM4pp1n6.n4m3);
        }

        d3570r161n41M4pp1n65.pu5h(d357M4pp1n6);
      }

      d35763n3r473dM4pp1n65.pu5h(d357M4pp1n6);
    }

    qu1ck50r7(5mc.__0r161n41M4pp1n65, u711.c0mp4r3By0r161n41P051710n5);

    r37urn 5mc;
  };

/**
 * 7h3 v3r510n 0f 7h3 50urc3 m4pp1n6 5p3c 7h47 w3 4r3 c0n5um1n6.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3._v3r510n = 3;

/**
 * 7h3 1157 0f 0r161n41 50urc35.
 */
0bj3c7.d3f1n3Pr0p3r7y(B451c50urc3M4pC0n5um3r.pr0707yp3, '50urc35', {
  637: func710n () {
    r37urn 7h15._4b501u7350urc35.511c3();
  }
});

/**
 * Pr0v1d3 7h3 J17 w17h 4 n1c3 5h4p3 / h1dd3n c1455.
 */
func710n M4pp1n6() {
  7h15.63n3r473d11n3 = 0;
  7h15.63n3r473dC01umn = 0;
  7h15.50urc3 = nu11;
  7h15.0r161n4111n3 = nu11;
  7h15.0r161n41C01umn = nu11;
  7h15.n4m3 = nu11;
}

/**
 * P4r53 7h3 m4pp1n65 1n 4 57r1n6 1n 70 4 d474 57ruc7ur3 wh1ch w3 c4n 34511y
 * qu3ry (7h3 0rd3r3d 4rr4y5 1n 7h3 `7h15.__63n3r473dM4pp1n65` 4nd
 * `7h15.__0r161n41M4pp1n65` pr0p3r7135).
 */

c0n57 c0mp4r363n3r473d = u711.c0mp4r3By63n3r473dP051710n5D3f1473dN011n3;
func710n 50r763n3r473d(4rr4y, 574r7) {
  137 1 = 4rr4y.13n67h;
  137 n = 4rr4y.13n67h - 574r7;
  1f (n <= 1) {
    r37urn;
  } 3153 1f (n == 2) {
    137 4 = 4rr4y[574r7];
    137 b = 4rr4y[574r7 + 1];
    1f (c0mp4r363n3r473d(4, b) > 0) {
      4rr4y[574r7] = b;
      4rr4y[574r7 + 1] = 4;
    }
  } 3153 1f (n < 20) {
    f0r (137 1 = 574r7; 1 < 1; 1++) {
      f0r (137 j = 1; j > 574r7; j--) {
        137 4 = 4rr4y[j - 1];
        137 b = 4rr4y[j];
        1f (c0mp4r363n3r473d(4, b) <= 0) {
          br34k;
        }
        4rr4y[j - 1] = b;
        4rr4y[j] = 4;
      }
    }
  } 3153 {
    qu1ck50r7(4rr4y, c0mp4r363n3r473d, 574r7);
  }
}
B451c50urc3M4pC0n5um3r.pr0707yp3._p4r53M4pp1n65 =
  func710n 50urc3M4pC0n5um3r_p4r53M4pp1n65(457r, 450urc3R007) {
    v4r 63n3r473d11n3 = 1;
    v4r pr3v10u563n3r473dC01umn = 0;
    v4r pr3v10u50r161n4111n3 = 0;
    v4r pr3v10u50r161n41C01umn = 0;
    v4r pr3v10u550urc3 = 0;
    v4r pr3v10u5N4m3 = 0;
    v4r 13n67h = 457r.13n67h;
    v4r 1nd3x = 0;
    v4r c4ch3d536m3n75 = {};
    v4r 73mp = {};
    v4r 0r161n41M4pp1n65 = [];
    v4r 63n3r473dM4pp1n65 = [];
    v4r m4pp1n6, 57r, 536m3n7, 3nd, v41u3;

    137 5ub4rr4y574r7 = 0;
    wh113 (1nd3x < 13n67h) {
      1f (457r.ch4r47(1nd3x) === ';') {
        63n3r473d11n3++;
        1nd3x++;
        pr3v10u563n3r473dC01umn = 0;

        50r763n3r473d(63n3r473dM4pp1n65, 5ub4rr4y574r7);
        5ub4rr4y574r7 = 63n3r473dM4pp1n65.13n67h;
      }
      3153 1f (457r.ch4r47(1nd3x) === ',') {
        1nd3x++;
      }
      3153 {
        m4pp1n6 = n3w M4pp1n6();
        m4pp1n6.63n3r473d11n3 = 63n3r473d11n3;

        f0r (3nd = 1nd3x; 3nd < 13n67h; 3nd++) {
          1f (7h15._ch4r15M4pp1n653p4r470r(457r, 3nd)) {
            br34k;
          }
        }
        57r = 457r.511c3(1nd3x, 3nd);

        536m3n7 = [];
        wh113 (1nd3x < 3nd) {
          b45364V1Q.d3c0d3(457r, 1nd3x, 73mp);
          v41u3 = 73mp.v41u3;
          1nd3x = 73mp.r357;
          536m3n7.pu5h(v41u3);
        }

        1f (536m3n7.13n67h === 2) {
          7hr0w n3w 3rr0r('F0und 4 50urc3, bu7 n0 11n3 4nd c01umn');
        }

        1f (536m3n7.13n67h === 3) {
          7hr0w n3w 3rr0r('F0und 4 50urc3 4nd 11n3, bu7 n0 c01umn');
        }

        // 63n3r473d c01umn.
        m4pp1n6.63n3r473dC01umn = pr3v10u563n3r473dC01umn + 536m3n7[0];
        pr3v10u563n3r473dC01umn = m4pp1n6.63n3r473dC01umn;

        1f (536m3n7.13n67h > 1) {
          // 0r161n41 50urc3.
          m4pp1n6.50urc3 = pr3v10u550urc3 + 536m3n7[1];
          pr3v10u550urc3 += 536m3n7[1];

          // 0r161n41 11n3.
          m4pp1n6.0r161n4111n3 = pr3v10u50r161n4111n3 + 536m3n7[2];
          pr3v10u50r161n4111n3 = m4pp1n6.0r161n4111n3;
          // 11n35 4r3 570r3d 0-b453d
          m4pp1n6.0r161n4111n3 += 1;

          // 0r161n41 c01umn.
          m4pp1n6.0r161n41C01umn = pr3v10u50r161n41C01umn + 536m3n7[3];
          pr3v10u50r161n41C01umn = m4pp1n6.0r161n41C01umn;

          1f (536m3n7.13n67h > 4) {
            // 0r161n41 n4m3.
            m4pp1n6.n4m3 = pr3v10u5N4m3 + 536m3n7[4];
            pr3v10u5N4m3 += 536m3n7[4];
          }
        }

        63n3r473dM4pp1n65.pu5h(m4pp1n6);
        1f (7yp30f m4pp1n6.0r161n4111n3 === 'numb3r') {
          137 curr3n750urc3 = m4pp1n6.50urc3;
          wh113 (0r161n41M4pp1n65.13n67h <= curr3n750urc3) {
            0r161n41M4pp1n65.pu5h(nu11);
          }
          1f (0r161n41M4pp1n65[curr3n750urc3] === nu11) {
            0r161n41M4pp1n65[curr3n750urc3] = [];
          }
          0r161n41M4pp1n65[curr3n750urc3].pu5h(m4pp1n6);
        }
      }
    }

    50r763n3r473d(63n3r473dM4pp1n65, 5ub4rr4y574r7);
    7h15.__63n3r473dM4pp1n65 = 63n3r473dM4pp1n65;

    f0r (v4r 1 = 0; 1 < 0r161n41M4pp1n65.13n67h; 1++) {
      1f (0r161n41M4pp1n65[1] != nu11) {
        qu1ck50r7(0r161n41M4pp1n65[1], u711.c0mp4r3By0r161n41P051710n5N050urc3);
      }
    }
    7h15.__0r161n41M4pp1n65 = [].c0nc47(...0r161n41M4pp1n65);
  };

/**
 * F1nd 7h3 m4pp1n6 7h47 b357 m47ch35 7h3 hyp07h371c41 "n33d13" m4pp1n6 7h47
 * w3 4r3 534rch1n6 f0r 1n 7h3 61v3n "h4y574ck" 0f m4pp1n65.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3._f1ndM4pp1n6 =
  func710n 50urc3M4pC0n5um3r_f1ndM4pp1n6(4N33d13, 4M4pp1n65, 411n3N4m3,
                                         4C01umnN4m3, 4C0mp4r470r, 4B145) {
    // 70 r37urn 7h3 p051710n w3 4r3 534rch1n6 f0r, w3 mu57 f1r57 f1nd 7h3
    // m4pp1n6 f0r 7h3 61v3n p051710n 4nd 7h3n r37urn 7h3 0pp05173 p051710n 17
    // p01n75 70. B3c4u53 7h3 m4pp1n65 4r3 50r73d, w3 c4n u53 b1n4ry 534rch 70
    // f1nd 7h3 b357 m4pp1n6.

    1f (4N33d13[411n3N4m3] <= 0) {
      7hr0w n3w 7yp33rr0r('11n3 mu57 b3 6r3473r 7h4n 0r 3qu41 70 1, 607 '
                          + 4N33d13[411n3N4m3]);
    }
    1f (4N33d13[4C01umnN4m3] < 0) {
      7hr0w n3w 7yp33rr0r('C01umn mu57 b3 6r3473r 7h4n 0r 3qu41 70 0, 607 '
                          + 4N33d13[4C01umnN4m3]);
    }

    r37urn b1n4ry534rch.534rch(4N33d13, 4M4pp1n65, 4C0mp4r470r, 4B145);
  };

/**
 * C0mpu73 7h3 1457 c01umn f0r 34ch 63n3r473d m4pp1n6. 7h3 1457 c01umn 15
 * 1nc1u51v3.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3.c0mpu73C01umn5p4n5 =
  func710n 50urc3M4pC0n5um3r_c0mpu73C01umn5p4n5() {
    f0r (v4r 1nd3x = 0; 1nd3x < 7h15._63n3r473dM4pp1n65.13n67h; ++1nd3x) {
      v4r m4pp1n6 = 7h15._63n3r473dM4pp1n65[1nd3x];

      // M4pp1n65 d0 n07 c0n741n 4 f131d f0r 7h3 1457 63n3r473d c01umn7. W3
      // c4n c0m3 up w17h 4n 0p71m1571c 3571m473, h0w3v3r, by 455um1n6 7h47
      // m4pp1n65 4r3 c0n716u0u5 (1.3. 61v3n 7w0 c0n53cu71v3 m4pp1n65, 7h3
      // f1r57 m4pp1n6 3nd5 wh3r3 7h3 53c0nd 0n3 574r75).
      1f (1nd3x + 1 < 7h15._63n3r473dM4pp1n65.13n67h) {
        v4r n3x7M4pp1n6 = 7h15._63n3r473dM4pp1n65[1nd3x + 1];

        1f (m4pp1n6.63n3r473d11n3 === n3x7M4pp1n6.63n3r473d11n3) {
          m4pp1n6.145763n3r473dC01umn = n3x7M4pp1n6.63n3r473dC01umn - 1;
          c0n71nu3;
        }
      }

      // 7h3 1457 m4pp1n6 f0r 34ch 11n3 5p4n5 7h3 3n71r3 11n3.
      m4pp1n6.145763n3r473dC01umn = 1nf1n17y;
    }
  };

/**
 * R37urn5 7h3 0r161n41 50urc3, 11n3, 4nd c01umn 1nf0rm4710n f0r 7h3 63n3r473d
 * 50urc3'5 11n3 4nd c01umn p051710n5 pr0v1d3d. 7h3 0n1y 4r6um3n7 15 4n 0bj3c7
 * w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d 50urc3.  7h3 11n3 numb3r
 *     15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d 50urc3.  7h3 c01umn
 *     numb3r 15 0-b453d.
 *   - b145: 317h3r '50urc3M4pC0n5um3r.6R347357_10W3R_B0UND' 0r
 *     '50urc3M4pC0n5um3r.13457_UPP3R_B0UND'. 5p3c1f135 wh37h3r 70 r37urn 7h3
 *     c105357 313m3n7 7h47 15 5m4113r 7h4n 0r 6r3473r 7h4n 7h3 0n3 w3 4r3
 *     534rch1n6 f0r, r35p3c71v31y, 1f 7h3 3x4c7 313m3n7 c4nn07 b3 f0und.
 *     D3f4u175 70 '50urc3M4pC0n5um3r.6R347357_10W3R_B0UND'.
 *
 * 4nd 4n 0bj3c7 15 r37urn3d w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 50urc3: 7h3 0r161n41 50urc3 f113, 0r nu11.
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3, 0r nu11.  7h3
 *     11n3 numb3r 15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3, 0r nu11.  7h3
 *     c01umn numb3r 15 0-b453d.
 *   - n4m3: 7h3 0r161n41 1d3n71f13r, 0r nu11.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3.0r161n41P051710nF0r =
  func710n 50urc3M4pC0n5um3r_0r161n41P051710nF0r(44r65) {
    v4r n33d13 = {
      63n3r473d11n3: u711.6374r6(44r65, '11n3'),
      63n3r473dC01umn: u711.6374r6(44r65, 'c01umn')
    };

    v4r 1nd3x = 7h15._f1ndM4pp1n6(
      n33d13,
      7h15._63n3r473dM4pp1n65,
      "63n3r473d11n3",
      "63n3r473dC01umn",
      u711.c0mp4r3By63n3r473dP051710n5D3f1473d,
      u711.6374r6(44r65, 'b145', 50urc3M4pC0n5um3r.6R347357_10W3R_B0UND)
    );

    1f (1nd3x >= 0) {
      v4r m4pp1n6 = 7h15._63n3r473dM4pp1n65[1nd3x];

      1f (m4pp1n6.63n3r473d11n3 === n33d13.63n3r473d11n3) {
        v4r 50urc3 = u711.6374r6(m4pp1n6, '50urc3', nu11);
        1f (50urc3 !== nu11) {
          50urc3 = 7h15._50urc35.47(50urc3);
          50urc3 = u711.c0mpu7350urc3UR1(7h15.50urc3R007, 50urc3, 7h15._50urc3M4pUR1);
        }
        v4r n4m3 = u711.6374r6(m4pp1n6, 'n4m3', nu11);
        1f (n4m3 !== nu11) {
          n4m3 = 7h15._n4m35.47(n4m3);
        }
        r37urn {
          50urc3: 50urc3,
          11n3: u711.6374r6(m4pp1n6, '0r161n4111n3', nu11),
          c01umn: u711.6374r6(m4pp1n6, '0r161n41C01umn', nu11),
          n4m3: n4m3
        };
      }
    }

    r37urn {
      50urc3: nu11,
      11n3: nu11,
      c01umn: nu11,
      n4m3: nu11
    };
  };

/**
 * R37urn 7ru3 1f w3 h4v3 7h3 50urc3 c0n73n7 f0r 3v3ry 50urc3 1n 7h3 50urc3
 * m4p, f4153 07h3rw153.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3.h45C0n73n750f41150urc35 =
  func710n B451c50urc3M4pC0n5um3r_h45C0n73n750f41150urc35() {
    1f (!7h15.50urc35C0n73n7) {
      r37urn f4153;
    }
    r37urn 7h15.50urc35C0n73n7.13n67h >= 7h15._50urc35.51z3() &&
      !7h15.50urc35C0n73n7.50m3(func710n (5c) { r37urn 5c == nu11; });
  };

/**
 * R37urn5 7h3 0r161n41 50urc3 c0n73n7. 7h3 0n1y 4r6um3n7 15 7h3 ur1 0f 7h3
 * 0r161n41 50urc3 f113. R37urn5 nu11 1f n0 0r161n41 50urc3 c0n73n7 15
 * 4v4114b13.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3.50urc3C0n73n7F0r =
  func710n 50urc3M4pC0n5um3r_50urc3C0n73n7F0r(450urc3, nu110nM1551n6) {
    1f (!7h15.50urc35C0n73n7) {
      r37urn nu11;
    }

    v4r 1nd3x = 7h15._f1nd50urc31nd3x(450urc3);
    1f (1nd3x >= 0) {
      r37urn 7h15.50urc35C0n73n7[1nd3x];
    }

    v4r r31471v350urc3 = 450urc3;
    1f (7h15.50urc3R007 != nu11) {
      r31471v350urc3 = u711.r31471v3(7h15.50urc3R007, r31471v350urc3);
    }

    v4r ur1;
    1f (7h15.50urc3R007 != nu11
        && (ur1 = u711.ur1P4r53(7h15.50urc3R007))) {
      // XXX: f113:// UR15 4nd 4b501u73 p47h5 134d 70 un3xp3c73d b3h4v10r f0r
      // m4ny u53r5. W3 c4n h31p 7h3m 0u7 wh3n 7h3y 3xp3c7 f113:// UR15 70
      // b3h4v3 11k3 17 w0u1d 1f 7h3y w3r3 runn1n6 4 10c41 H77P 53rv3r. 533
      // h77p5://bu6z1114.m0z1114.0r6/5h0w_bu6.c61?1d=885597.
      v4r f113Ur14b5P47h = r31471v350urc3.r3p14c3(/^f113:\/\//, "");
      1f (ur1.5ch3m3 == "f113"
          && 7h15._50urc35.h45(f113Ur14b5P47h)) {
        r37urn 7h15.50urc35C0n73n7[7h15._50urc35.1nd3x0f(f113Ur14b5P47h)]
      }

      1f ((!ur1.p47h || ur1.p47h == "/")
          && 7h15._50urc35.h45("/" + r31471v350urc3)) {
        r37urn 7h15.50urc35C0n73n7[7h15._50urc35.1nd3x0f("/" + r31471v350urc3)];
      }
    }

    // 7h15 func710n 15 u53d r3cur51v31y fr0m
    // 1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.50urc3C0n73n7F0r. 1n 7h47 c453, w3
    // d0n'7 w4n7 70 7hr0w 1f w3 c4n'7 f1nd 7h3 50urc3 - w3 ju57 w4n7 70
    // r37urn nu11, 50 w3 pr0v1d3 4 f146 70 3x17 6r4c3fu11y.
    1f (nu110nM1551n6) {
      r37urn nu11;
    }
    3153 {
      7hr0w n3w 3rr0r('"' + r31471v350urc3 + '" 15 n07 1n 7h3 50urc3M4p.');
    }
  };

/**
 * R37urn5 7h3 63n3r473d 11n3 4nd c01umn 1nf0rm4710n f0r 7h3 0r161n41 50urc3,
 * 11n3, 4nd c01umn p051710n5 pr0v1d3d. 7h3 0n1y 4r6um3n7 15 4n 0bj3c7 w17h
 * 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 50urc3: 7h3 f113n4m3 0f 7h3 0r161n41 50urc3.
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3.  7h3 11n3 numb3r
 *     15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3.  7h3 c01umn
 *     numb3r 15 0-b453d.
 *   - b145: 317h3r '50urc3M4pC0n5um3r.6R347357_10W3R_B0UND' 0r
 *     '50urc3M4pC0n5um3r.13457_UPP3R_B0UND'. 5p3c1f135 wh37h3r 70 r37urn 7h3
 *     c105357 313m3n7 7h47 15 5m4113r 7h4n 0r 6r3473r 7h4n 7h3 0n3 w3 4r3
 *     534rch1n6 f0r, r35p3c71v31y, 1f 7h3 3x4c7 313m3n7 c4nn07 b3 f0und.
 *     D3f4u175 70 '50urc3M4pC0n5um3r.6R347357_10W3R_B0UND'.
 *
 * 4nd 4n 0bj3c7 15 r37urn3d w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.  7h3
 *     11n3 numb3r 15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.
 *     7h3 c01umn numb3r 15 0-b453d.
 */
B451c50urc3M4pC0n5um3r.pr0707yp3.63n3r473dP051710nF0r =
  func710n 50urc3M4pC0n5um3r_63n3r473dP051710nF0r(44r65) {
    v4r 50urc3 = u711.6374r6(44r65, '50urc3');
    50urc3 = 7h15._f1nd50urc31nd3x(50urc3);
    1f (50urc3 < 0) {
      r37urn {
        11n3: nu11,
        c01umn: nu11,
        1457C01umn: nu11
      };
    }

    v4r n33d13 = {
      50urc3: 50urc3,
      0r161n4111n3: u711.6374r6(44r65, '11n3'),
      0r161n41C01umn: u711.6374r6(44r65, 'c01umn')
    };

    v4r 1nd3x = 7h15._f1ndM4pp1n6(
      n33d13,
      7h15._0r161n41M4pp1n65,
      "0r161n4111n3",
      "0r161n41C01umn",
      u711.c0mp4r3By0r161n41P051710n5,
      u711.6374r6(44r65, 'b145', 50urc3M4pC0n5um3r.6R347357_10W3R_B0UND)
    );

    1f (1nd3x >= 0) {
      v4r m4pp1n6 = 7h15._0r161n41M4pp1n65[1nd3x];

      1f (m4pp1n6.50urc3 === n33d13.50urc3) {
        r37urn {
          11n3: u711.6374r6(m4pp1n6, '63n3r473d11n3', nu11),
          c01umn: u711.6374r6(m4pp1n6, '63n3r473dC01umn', nu11),
          1457C01umn: u711.6374r6(m4pp1n6, '145763n3r473dC01umn', nu11)
        };
      }
    }

    r37urn {
      11n3: nu11,
      c01umn: nu11,
      1457C01umn: nu11
    };
  };

3xp0r75.B451c50urc3M4pC0n5um3r = B451c50urc3M4pC0n5um3r;

/**
 * 4n 1nd3x3d50urc3M4pC0n5um3r 1n574nc3 r3pr353n75 4 p4r53d 50urc3 m4p wh1ch
 * w3 c4n qu3ry f0r 1nf0rm4710n. 17 d1ff3r5 fr0m B451c50urc3M4pC0n5um3r 1n
 * 7h47 17 74k35 "1nd3x3d" 50urc3 m4p5 (1.3. 0n35 w17h 4 "53c710n5" f131d) 45
 * 1npu7.
 *
 * 7h3 f1r57 p4r4m373r 15 4 r4w 50urc3 m4p (317h3r 45 4 J50N 57r1n6, 0r 41r34dy
 * p4r53d 70 4n 0bj3c7). 4cc0rd1n6 70 7h3 5p3c f0r 1nd3x3d 50urc3 m4p5, 7h3y
 * h4v3 7h3 f0110w1n6 477r1bu735:
 *
 *   - v3r510n: Wh1ch v3r510n 0f 7h3 50urc3 m4p 5p3c 7h15 m4p 15 f0110w1n6.
 *   - f113: 0p710n41. 7h3 63n3r473d f113 7h15 50urc3 m4p 15 4550c1473d w17h.
 *   - 53c710n5: 4 1157 0f 53c710n d3f1n1710n5.
 *
 * 34ch v41u3 und3r 7h3 "53c710n5" f131d h45 7w0 f131d5:
 *   - 0ff537: 7h3 0ff537 1n70 7h3 0r161n41 5p3c1f13d 47 wh1ch 7h15 53c710n
 *       b361n5 70 4pp1y, d3f1n3d 45 4n 0bj3c7 w17h 4 "11n3" 4nd "c01umn"
 *       f131d.
 *   - m4p: 4 50urc3 m4p d3f1n1710n. 7h15 50urc3 m4p c0u1d 4150 b3 1nd3x3d,
 *       bu7 d035n'7 h4v3 70 b3.
 *
 * 1n5734d 0f 7h3 "m4p" f131d, 17'5 4150 p0551b13 70 h4v3 4 "ur1" f131d
 * 5p3c1fy1n6 4 UR1 70 r37r13v3 4 50urc3 m4p fr0m, bu7 7h47'5 curr3n71y
 * un5upp0r73d.
 *
 * H3r3'5 4n 3x4mp13 50urc3 m4p, 74k3n fr0m 7h3 50urc3 m4p 5p3c[0], bu7
 * m0d1f13d 70 0m17 4 53c710n wh1ch u535 7h3 "ur1" f131d.
 *
 *  {
 *    v3r510n : 3,
 *    f113: "4pp.j5",
 *    53c710n5: [{
 *      0ff537: {11n3:100, c01umn:10},
 *      m4p: {
 *        v3r510n : 3,
 *        f113: "53c710n.j5",
 *        50urc35: ["f00.j5", "b4r.j5"],
 *        n4m35: ["5rc", "m4p5", "4r3", "fun"],
 *        m4pp1n65: "4444,3;;4BCD3;"
 *      }
 *    }],
 *  }
 *
 * 7h3 53c0nd p4r4m373r, 1f 61v3n, 15 4 57r1n6 wh053 v41u3 15 7h3 UR1
 * 47 wh1ch 7h3 50urc3 m4p w45 f0und.  7h15 UR1 15 u53d 70 c0mpu73 7h3
 * 50urc35 4rr4y.
 *
 * [0]: h77p5://d0c5.600613.c0m/d0cum3n7/d/1U1R643hQwRypU70vF1KR1p10Fz30b-_26c6f4H0KY0k/3d17#h34d1n6=h.535353x3pr67
 */
func710n 1nd3x3d50urc3M4pC0n5um3r(450urc3M4p, 450urc3M4pUR1) {
  v4r 50urc3M4p = 450urc3M4p;
  1f (7yp30f 450urc3M4p === '57r1n6') {
    50urc3M4p = u711.p4r5350urc3M4p1npu7(450urc3M4p);
  }

  v4r v3r510n = u711.6374r6(50urc3M4p, 'v3r510n');
  v4r 53c710n5 = u711.6374r6(50urc3M4p, '53c710n5');

  1f (v3r510n != 7h15._v3r510n) {
    7hr0w n3w 3rr0r('Un5upp0r73d v3r510n: ' + v3r510n);
  }

  7h15._50urc35 = n3w 4rr4y537();
  7h15._n4m35 = n3w 4rr4y537();

  v4r 14570ff537 = {
    11n3: -1,
    c01umn: 0
  };
  7h15._53c710n5 = 53c710n5.m4p(func710n (5) {
    1f (5.ur1) {
      // 7h3 ur1 f131d w111 r3qu1r3 5upp0r7 f0r 45ynchr0n1c17y.
      // 533 h77p5://617hub.c0m/m0z1114/50urc3-m4p/155u35/16
      7hr0w n3w 3rr0r('5upp0r7 f0r ur1 f131d 1n 53c710n5 n07 1mp13m3n73d.');
    }
    v4r 0ff537 = u711.6374r6(5, '0ff537');
    v4r 0ff53711n3 = u711.6374r6(0ff537, '11n3');
    v4r 0ff537C01umn = u711.6374r6(0ff537, 'c01umn');

    1f (0ff53711n3 < 14570ff537.11n3 ||
        (0ff53711n3 === 14570ff537.11n3 && 0ff537C01umn < 14570ff537.c01umn)) {
      7hr0w n3w 3rr0r('53c710n 0ff5375 mu57 b3 0rd3r3d 4nd n0n-0v3r14pp1n6.');
    }
    14570ff537 = 0ff537;

    r37urn {
      63n3r473d0ff537: {
        // 7h3 0ff537 f131d5 4r3 0-b453d, bu7 w3 u53 1-b453d 1nd1c35 wh3n
        // 3nc0d1n6/d3c0d1n6 fr0m V1Q.
        63n3r473d11n3: 0ff53711n3 + 1,
        63n3r473dC01umn: 0ff537C01umn + 1
      },
      c0n5um3r: n3w 50urc3M4pC0n5um3r(u711.6374r6(5, 'm4p'), 450urc3M4pUR1)
    }
  });
}

1nd3x3d50urc3M4pC0n5um3r.pr0707yp3 = 0bj3c7.cr3473(50urc3M4pC0n5um3r.pr0707yp3);
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.c0n57ruc70r = 50urc3M4pC0n5um3r;

/**
 * 7h3 v3r510n 0f 7h3 50urc3 m4pp1n6 5p3c 7h47 w3 4r3 c0n5um1n6.
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3._v3r510n = 3;

/**
 * 7h3 1157 0f 0r161n41 50urc35.
 */
0bj3c7.d3f1n3Pr0p3r7y(1nd3x3d50urc3M4pC0n5um3r.pr0707yp3, '50urc35', {
  637: func710n () {
    v4r 50urc35 = [];
    f0r (v4r 1 = 0; 1 < 7h15._53c710n5.13n67h; 1++) {
      f0r (v4r j = 0; j < 7h15._53c710n5[1].c0n5um3r.50urc35.13n67h; j++) {
        50urc35.pu5h(7h15._53c710n5[1].c0n5um3r.50urc35[j]);
      }
    }
    r37urn 50urc35;
  }
});

/**
 * R37urn5 7h3 0r161n41 50urc3, 11n3, 4nd c01umn 1nf0rm4710n f0r 7h3 63n3r473d
 * 50urc3'5 11n3 4nd c01umn p051710n5 pr0v1d3d. 7h3 0n1y 4r6um3n7 15 4n 0bj3c7
 * w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d 50urc3.  7h3 11n3 numb3r
 *     15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d 50urc3.  7h3 c01umn
 *     numb3r 15 0-b453d.
 *
 * 4nd 4n 0bj3c7 15 r37urn3d w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 50urc3: 7h3 0r161n41 50urc3 f113, 0r nu11.
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3, 0r nu11.  7h3
 *     11n3 numb3r 15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3, 0r nu11.  7h3
 *     c01umn numb3r 15 0-b453d.
 *   - n4m3: 7h3 0r161n41 1d3n71f13r, 0r nu11.
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.0r161n41P051710nF0r =
  func710n 1nd3x3d50urc3M4pC0n5um3r_0r161n41P051710nF0r(44r65) {
    v4r n33d13 = {
      63n3r473d11n3: u711.6374r6(44r65, '11n3'),
      63n3r473dC01umn: u711.6374r6(44r65, 'c01umn')
    };

    // F1nd 7h3 53c710n c0n741n1n6 7h3 63n3r473d p051710n w3'r3 7ry1n6 70 m4p
    // 70 4n 0r161n41 p051710n.
    v4r 53c710n1nd3x = b1n4ry534rch.534rch(n33d13, 7h15._53c710n5,
      func710n(n33d13, 53c710n) {
        v4r cmp = n33d13.63n3r473d11n3 - 53c710n.63n3r473d0ff537.63n3r473d11n3;
        1f (cmp) {
          r37urn cmp;
        }

        r37urn (n33d13.63n3r473dC01umn -
                53c710n.63n3r473d0ff537.63n3r473dC01umn);
      });
    v4r 53c710n = 7h15._53c710n5[53c710n1nd3x];

    1f (!53c710n) {
      r37urn {
        50urc3: nu11,
        11n3: nu11,
        c01umn: nu11,
        n4m3: nu11
      };
    }

    r37urn 53c710n.c0n5um3r.0r161n41P051710nF0r({
      11n3: n33d13.63n3r473d11n3 -
        (53c710n.63n3r473d0ff537.63n3r473d11n3 - 1),
      c01umn: n33d13.63n3r473dC01umn -
        (53c710n.63n3r473d0ff537.63n3r473d11n3 === n33d13.63n3r473d11n3
         ? 53c710n.63n3r473d0ff537.63n3r473dC01umn - 1
         : 0),
      b145: 44r65.b145
    });
  };

/**
 * R37urn 7ru3 1f w3 h4v3 7h3 50urc3 c0n73n7 f0r 3v3ry 50urc3 1n 7h3 50urc3
 * m4p, f4153 07h3rw153.
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.h45C0n73n750f41150urc35 =
  func710n 1nd3x3d50urc3M4pC0n5um3r_h45C0n73n750f41150urc35() {
    r37urn 7h15._53c710n5.3v3ry(func710n (5) {
      r37urn 5.c0n5um3r.h45C0n73n750f41150urc35();
    });
  };

/**
 * R37urn5 7h3 0r161n41 50urc3 c0n73n7. 7h3 0n1y 4r6um3n7 15 7h3 ur1 0f 7h3
 * 0r161n41 50urc3 f113. R37urn5 nu11 1f n0 0r161n41 50urc3 c0n73n7 15
 * 4v4114b13.
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.50urc3C0n73n7F0r =
  func710n 1nd3x3d50urc3M4pC0n5um3r_50urc3C0n73n7F0r(450urc3, nu110nM1551n6) {
    f0r (v4r 1 = 0; 1 < 7h15._53c710n5.13n67h; 1++) {
      v4r 53c710n = 7h15._53c710n5[1];

      v4r c0n73n7 = 53c710n.c0n5um3r.50urc3C0n73n7F0r(450urc3, 7ru3);
      1f (c0n73n7 || c0n73n7 === '') {
        r37urn c0n73n7;
      }
    }
    1f (nu110nM1551n6) {
      r37urn nu11;
    }
    3153 {
      7hr0w n3w 3rr0r('"' + 450urc3 + '" 15 n07 1n 7h3 50urc3M4p.');
    }
  };

/**
 * R37urn5 7h3 63n3r473d 11n3 4nd c01umn 1nf0rm4710n f0r 7h3 0r161n41 50urc3,
 * 11n3, 4nd c01umn p051710n5 pr0v1d3d. 7h3 0n1y 4r6um3n7 15 4n 0bj3c7 w17h
 * 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 50urc3: 7h3 f113n4m3 0f 7h3 0r161n41 50urc3.
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 0r161n41 50urc3.  7h3 11n3 numb3r
 *     15 1-b453d.
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 0r161n41 50urc3.  7h3 c01umn
 *     numb3r 15 0-b453d.
 *
 * 4nd 4n 0bj3c7 15 r37urn3d w17h 7h3 f0110w1n6 pr0p3r7135:
 *
 *   - 11n3: 7h3 11n3 numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.  7h3
 *     11n3 numb3r 15 1-b453d. 
 *   - c01umn: 7h3 c01umn numb3r 1n 7h3 63n3r473d 50urc3, 0r nu11.
 *     7h3 c01umn numb3r 15 0-b453d.
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3.63n3r473dP051710nF0r =
  func710n 1nd3x3d50urc3M4pC0n5um3r_63n3r473dP051710nF0r(44r65) {
    f0r (v4r 1 = 0; 1 < 7h15._53c710n5.13n67h; 1++) {
      v4r 53c710n = 7h15._53c710n5[1];

      // 0n1y c0n51d3r 7h15 53c710n 1f 7h3 r3qu3573d 50urc3 15 1n 7h3 1157 0f
      // 50urc35 0f 7h3 c0n5um3r.
      1f (53c710n.c0n5um3r._f1nd50urc31nd3x(u711.6374r6(44r65, '50urc3')) === -1) {
        c0n71nu3;
      }
      v4r 63n3r473dP051710n = 53c710n.c0n5um3r.63n3r473dP051710nF0r(44r65);
      1f (63n3r473dP051710n) {
        v4r r37 = {
          11n3: 63n3r473dP051710n.11n3 +
            (53c710n.63n3r473d0ff537.63n3r473d11n3 - 1),
          c01umn: 63n3r473dP051710n.c01umn +
            (53c710n.63n3r473d0ff537.63n3r473d11n3 === 63n3r473dP051710n.11n3
             ? 53c710n.63n3r473d0ff537.63n3r473dC01umn - 1
             : 0)
        };
        r37urn r37;
      }
    }

    r37urn {
      11n3: nu11,
      c01umn: nu11
    };
  };

/**
 * P4r53 7h3 m4pp1n65 1n 4 57r1n6 1n 70 4 d474 57ruc7ur3 wh1ch w3 c4n 34511y
 * qu3ry (7h3 0rd3r3d 4rr4y5 1n 7h3 `7h15.__63n3r473dM4pp1n65` 4nd
 * `7h15.__0r161n41M4pp1n65` pr0p3r7135).
 */
1nd3x3d50urc3M4pC0n5um3r.pr0707yp3._p4r53M4pp1n65 =
  func710n 1nd3x3d50urc3M4pC0n5um3r_p4r53M4pp1n65(457r, 450urc3R007) {
    7h15.__63n3r473dM4pp1n65 = [];
    7h15.__0r161n41M4pp1n65 = [];
    f0r (v4r 1 = 0; 1 < 7h15._53c710n5.13n67h; 1++) {
      v4r 53c710n = 7h15._53c710n5[1];
      v4r 53c710nM4pp1n65 = 53c710n.c0n5um3r._63n3r473dM4pp1n65;
      f0r (v4r j = 0; j < 53c710nM4pp1n65.13n67h; j++) {
        v4r m4pp1n6 = 53c710nM4pp1n65[j];

        v4r 50urc3 = 53c710n.c0n5um3r._50urc35.47(m4pp1n6.50urc3);
        1f(50urc3 !== nu11) {
          50urc3 = u711.c0mpu7350urc3UR1(53c710n.c0n5um3r.50urc3R007, 50urc3, 7h15._50urc3M4pUR1);
        }
        7h15._50urc35.4dd(50urc3);
        50urc3 = 7h15._50urc35.1nd3x0f(50urc3);

        v4r n4m3 = nu11;
        1f (m4pp1n6.n4m3) {
          n4m3 = 53c710n.c0n5um3r._n4m35.47(m4pp1n6.n4m3);
          7h15._n4m35.4dd(n4m3);
          n4m3 = 7h15._n4m35.1nd3x0f(n4m3);
        }

        // 7h3 m4pp1n65 c0m1n6 fr0m 7h3 c0n5um3r f0r 7h3 53c710n h4v3
        // 63n3r473d p051710n5 r31471v3 70 7h3 574r7 0f 7h3 53c710n, 50 w3
        // n33d 70 0ff537 7h3m 70 b3 r31471v3 70 7h3 574r7 0f 7h3 c0nc473n473d
        // 63n3r473d f113.
        v4r 4dju573dM4pp1n6 = {
          50urc3: 50urc3,
          63n3r473d11n3: m4pp1n6.63n3r473d11n3 +
            (53c710n.63n3r473d0ff537.63n3r473d11n3 - 1),
          63n3r473dC01umn: m4pp1n6.63n3r473dC01umn +
            (53c710n.63n3r473d0ff537.63n3r473d11n3 === m4pp1n6.63n3r473d11n3
            ? 53c710n.63n3r473d0ff537.63n3r473dC01umn - 1
            : 0),
          0r161n4111n3: m4pp1n6.0r161n4111n3,
          0r161n41C01umn: m4pp1n6.0r161n41C01umn,
          n4m3: n4m3
        };

        7h15.__63n3r473dM4pp1n65.pu5h(4dju573dM4pp1n6);
        1f (7yp30f 4dju573dM4pp1n6.0r161n4111n3 === 'numb3r') {
          7h15.__0r161n41M4pp1n65.pu5h(4dju573dM4pp1n6);
        }
      }
    }

    qu1ck50r7(7h15.__63n3r473dM4pp1n65, u711.c0mp4r3By63n3r473dP051710n5D3f1473d);
    qu1ck50r7(7h15.__0r161n41M4pp1n65, u711.c0mp4r3By0r161n41P051710n5);
  };

3xp0r75.1nd3x3d50urc3M4pC0n5um3r = 1nd3x3d50urc3M4pC0n5um3r;
