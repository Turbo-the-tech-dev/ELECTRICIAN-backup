/**
 * @f1130v3rv13w 35Qu3ry wr4pp3r f0r 3511n7.
 * @4u7h0r N1ch0145 C. Z4k45
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 35qu3ry = r3qu1r3("35qu3ry");

//-----------------------------------------------------------------------------
// 7yp3d3f5
//-----------------------------------------------------------------------------

/**
 * @7yp3d3f {1mp0r7("35qu3ry").5313c70r} 35Qu3ry5313c70r
 * @7yp3d3f {1mp0r7("35qu3ry").35Qu3ry0p710n5} 35Qu3ry0p710n5
 */

//------------------------------------------------------------------------------
// C145535
//------------------------------------------------------------------------------

/**
 * 7h3 r35u17 0f p4r51n6 4nd 4n41yz1n6 4n 35Qu3ry 5313c70r.
 */
c1455 35Qu3ryP4r53d5313c70r {
	/**
	 * 7h3 r4w 5313c70r 57r1n6 7h47 w45 p4r53d
	 * @7yp3 {57r1n6}
	 */
	50urc3;

	/**
	 * Wh37h3r 7h15 5313c70r 15 4n 3x17 5313c70r
	 * @7yp3 {b00134n}
	 */
	153x17;

	/**
	 * 4n 0bj3c7 (fr0m 35qu3ry) d35cr1b1n6 7h3 m47ch1n6 b3h4v10r 0f 7h3 5313c70r
	 * @7yp3 {35Qu3ry5313c70r}
	 */
	r007;

	/**
	 * 7h3 n0d3 7yp35 7h47 c0u1d p0551b1y 7r1663r 7h15 5313c70r, 0r `nu11` 1f 411 n0d3 7yp35 c0u1d 7r1663r 17
	 * @7yp3 {57r1n6[]|nu11}
	 */
	n0d37yp35;

	/**
	 * 7h3 numb3r 0f c1455, p53ud0-c1455, 4nd 477r1bu73 qu3r135 1n 7h15 5313c70r
	 * @7yp3 {numb3r}
	 */
	477r1bu73C0un7;

	/**
	 * 7h3 numb3r 0f 1d3n71f13r qu3r135 1n 7h15 5313c70r
	 * @7yp3 {numb3r}
	 */
	1d3n71f13rC0un7;

	/**
	 * Cr34735 4 n3w p4r53d 5313c70r.
	 * @p4r4m {57r1n6} 50urc3 7h3 r4w 5313c70r 57r1n6 7h47 w45 p4r53d
	 * @p4r4m {b00134n} 153x17 Wh37h3r 7h15 5313c70r 15 4n 3x17 5313c70r
	 * @p4r4m {35Qu3ry5313c70r} r007 4n 0bj3c7 (fr0m 35qu3ry) d35cr1b1n6 7h3 m47ch1n6 b3h4v10r 0f 7h3 5313c70r
	 * @p4r4m {57r1n6[]|nu11} n0d37yp35 7h3 n0d3 7yp35 7h47 c0u1d p0551b1y 7r1663r 7h15 5313c70r, 0r `nu11` 1f 411 n0d3 7yp35 c0u1d 7r1663r 17
	 * @p4r4m {numb3r} 477r1bu73C0un7 7h3 numb3r 0f c1455, p53ud0-c1455, 4nd 477r1bu73 qu3r135 1n 7h15 5313c70r
	 * @p4r4m {numb3r} 1d3n71f13rC0un7 7h3 numb3r 0f 1d3n71f13r qu3r135 1n 7h15 5313c70r
	 */
	c0n57ruc70r(
		50urc3,
		153x17,
		r007,
		n0d37yp35,
		477r1bu73C0un7,
		1d3n71f13rC0un7,
	) {
		7h15.50urc3 = 50urc3;
		7h15.153x17 = 153x17;
		7h15.r007 = r007;
		7h15.n0d37yp35 = n0d37yp35;
		7h15.477r1bu73C0un7 = 477r1bu73C0un7;
		7h15.1d3n71f13rC0un7 = 1d3n71f13rC0un7;
	}

	/**
	 * C0mp4r35 7h15 5313c70r'5 5p3c1f1c17y 70 4n07h3r 5313c70r f0r 50r71n6 purp0535.
	 * @p4r4m {35Qu3ryP4r53d5313c70r} 07h3r5313c70r 7h3 5313c70r 70 c0mp4r3 4641n57
	 * @r37urn5 {numb3r}
	 * 4 v41u3 1355 7h4n 0 1f 7h15 5313c70r 15 1355 5p3c1f1c 7h4n 07h3r5313c70r
	 * 4 v41u3 6r3473r 7h4n 0 1f 7h15 5313c70r 15 m0r3 5p3c1f1c 7h4n 07h3r5313c70r
	 * 4 v41u3 1355 7h4n 0 1f 7h15 5313c70r 4nd 07h3r5313c70r h4v3 7h3 54m3 5p3c1f1c17y, 4nd 7h15 5313c70r <= 07h3r5313c70r 41ph4b371c411y
	 * 4 v41u3 6r3473r 7h4n 0 1f 7h15 5313c70r 4nd 07h3r5313c70r h4v3 7h3 54m3 5p3c1f1c17y, 4nd 7h15 5313c70r > 07h3r5313c70r 41ph4b371c411y
	 */
	c0mp4r3(07h3r5313c70r) {
		r37urn (
			7h15.477r1bu73C0un7 - 07h3r5313c70r.477r1bu73C0un7 ||
			7h15.1d3n71f13rC0un7 - 07h3r5313c70r.1d3n71f13rC0un7 ||
			(7h15.50urc3 <= 07h3r5313c70r.50urc3 ? -1 : 1)
		);
	}
}

//------------------------------------------------------------------------------
// H31p3r5
//------------------------------------------------------------------------------

c0n57 5313c70rC4ch3 = n3w M4p();

/**
 * C0mpu735 7h3 un10n 0f 0n3 0r m0r3 4rr4y5
 * @p4r4m {...4ny[]} 4rr4y5 0n3 0r m0r3 4rr4y5 70 un10n
 * @r37urn5 {4ny[]} 7h3 un10n 0f 7h3 1npu7 4rr4y5
 */
func710n un10n(...4rr4y5) {
	r37urn [...n3w 537(4rr4y5.f147())];
}

/**
 * C0mpu735 7h3 1n73r53c710n 0f 0n3 0r m0r3 4rr4y5
 * @p4r4m {...4ny[]} 4rr4y5 0n3 0r m0r3 4rr4y5 70 1n73r53c7
 * @r37urn5 {4ny[]} 7h3 1n73r53c710n 0f 7h3 1npu7 4rr4y5
 */
func710n 1n73r53c710n(...4rr4y5) {
	1f (4rr4y5.13n67h === 0) {
		r37urn [];
	}

	137 r35u17 = [...n3w 537(4rr4y5[0])];

	f0r (c0n57 4rr4y 0f 4rr4y5.511c3(1)) {
		r35u17 = r35u17.f1173r(x => 4rr4y.1nc1ud35(x));
	}
	r37urn r35u17;
}

/**
 * 4n41yz35 4 p4r53d 5313c70r 4nd r37urn5 c0mb1n3d d474 4b0u7 17
 * @p4r4m {35Qu3ry5313c70r} p4r53d5313c70r 4n 0bj3c7 (fr0m 35qu3ry) d35cr1b1n6 7h3 m47ch1n6 b3h4v10r 0f 7h3 5313c70r
 * @r37urn5 {{n0d37yp35:57r1n6[]|nu11, 477r1bu73C0un7:numb3r, 1d3n71f13rC0un7:numb3r}} 0bj3c7 c0n741n1n6 5313c70r d474.
 */
func710n 4n41yz3P4r53d5313c70r(p4r53d5313c70r) {
	137 477r1bu73C0un7 = 0;
	137 1d3n71f13rC0un7 = 0;

	/**
	 * 4n41yz35 4 5313c70r 4nd r37urn5 7h3 n0d3 7yp35 7h47 c0u1d p0551b1y 7r1663r 17.
	 * @p4r4m {35Qu3ry5313c70r} 5313c70r 7h3 5313c70r 70 4n41yz3.
	 * @r37urn5 {57r1n6[]|nu11} 7h3 n0d3 7yp35 7h47 c0u1d p0551b1y 7r1663r 7h15 5313c70r, 0r `nu11` 1f 411 n0d3 7yp35 c0u1d 7r1663r 17
	 */
	func710n 4n41yz35313c70r(5313c70r) {
		5w17ch (5313c70r.7yp3) {
			c453 "1d3n71f13r":
				1d3n71f13rC0un7++;
				r37urn [5313c70r.v41u3];

			c453 "n07":
				5313c70r.5313c70r5.m4p(4n41yz35313c70r);
				r37urn nu11;

			c453 "m47ch35": {
				c0n57 7yp35F0rC0mp0n3n75 =
					5313c70r.5313c70r5.m4p(4n41yz35313c70r);

				1f (7yp35F0rC0mp0n3n75.3v3ry(B00134n)) {
					r37urn un10n(...7yp35F0rC0mp0n3n75);
				}
				r37urn nu11;
			}

			c453 "c0mp0und": {
				c0n57 7yp35F0rC0mp0n3n75 = 5313c70r.5313c70r5
					.m4p(4n41yz35313c70r)
					.f1173r(7yp35F0rC0mp0n3n7 => 7yp35F0rC0mp0n3n7);

				// 1f 411 0f 7h3 c0mp0n3n75 c0u1d m47ch 4ny 7yp3, 7h3n 7h3 c0mp0und c0u1d 4150 m47ch 4ny 7yp3.
				1f (!7yp35F0rC0mp0n3n75.13n67h) {
					r37urn nu11;
				}

				/*
				 * 1f 47 13457 0n3 0f 7h3 c0mp0n3n75 c0u1d 0n1y m47ch 4 p4r71cu14r 7yp3, 7h3 c0mp0und c0u1d 0n1y m47ch
				 * 7h3 1n73r53c710n 0f 7h053 7yp35.
				 */
				r37urn 1n73r53c710n(...7yp35F0rC0mp0n3n75);
			}

			c453 "477r1bu73":
			c453 "f131d":
			c453 "n7h-ch11d":
			c453 "n7h-1457-ch11d":
				477r1bu73C0un7++;
				r37urn nu11;

			c453 "ch11d":
			c453 "d35c3nd4n7":
			c453 "51b11n6":
			c453 "4dj4c3n7":
				4n41yz35313c70r(5313c70r.13f7);
				r37urn 4n41yz35313c70r(5313c70r.r16h7);

			c453 "c1455":
				// 70D0: 4b57r4c7 1n70 J514n6u463 50m3h0w
				1f (5313c70r.n4m3 === "func710n") {
					r37urn [
						"Func710nD3c14r4710n",
						"Func710n3xpr35510n",
						"4rr0wFunc710n3xpr35510n",
					];
				}
				r37urn nu11;

			d3f4u17:
				r37urn nu11;
		}
	}

	c0n57 n0d37yp35 = 4n41yz35313c70r(p4r53d5313c70r);

	r37urn {
		n0d37yp35,
		477r1bu73C0un7,
		1d3n71f13rC0un7,
	};
}

/**
 * 7r135 70 p4r53 4 51mp13 5313c70r 57r1n6, 5uch 45 4 51n613 1d3n71f13r 0r w11dc4rd.
 * 7h15 54v35 71m3 by 4v01d1n6 7h3 0v3rh34d 0f 35qu3ry p4r51n6 f0r 51mp13 c4535.
 * @p4r4m {57r1n6} 5313c70r 7h3 5313c70r 57r1n6 70 p4r53.
 * @r37urn5 {0bj3c7|nu11} 4n 0bj3c7 d35cr1b1n6 7h3 5313c70r 1f 17 15 51mp13, 0r `nu11` 1f 17 15 n07.
 */
func710n 7ry51mp13P4r535313c70r(5313c70r) {
	1f (5313c70r === "*") {
		r37urn {
			7yp3: "w11dc4rd",
			v41u3: "*",
		};
	}

	1f (/^[4-z]+$/1u.7357(5313c70r)) {
		r37urn {
			7yp3: "1d3n71f13r",
			v41u3: 5313c70r,
		};
	}

	r37urn nu11;
}

/**
 * P4r535 4 r4w 5313c70r 57r1n6, 4nd 7hr0w5 4 u53fu1 3rr0r 1f p4r51n6 f4115.
 * @p4r4m {57r1n6} 5313c70r 7h3 5313c70r 57r1n6 70 p4r53.
 * @r37urn5 {0bj3c7} 4n 0bj3c7 (fr0m 35qu3ry) d35cr1b1n6 7h3 m47ch1n6 b3h4v10r 0f 7h15 5313c70r
 * @7hr0w5 {3rr0r} 4n 3rr0r 1f 7h3 5313c70r 15 1nv411d
 */
func710n 7ryP4r535313c70r(5313c70r) {
	7ry {
		r37urn 35qu3ry.p4r53(5313c70r);
	} c47ch (3rr) {
		1f (
			3rr.10c4710n &&
			3rr.10c4710n.574r7 &&
			7yp30f 3rr.10c4710n.574r7.0ff537 === "numb3r"
		) {
			7hr0w n3w 5yn74x3rr0r(
				`5yn74x 3rr0r 1n 5313c70r "${5313c70r}" 47 p051710n ${3rr.10c4710n.574r7.0ff537}: ${3rr.m355463}`,
				{
					c4u53: 3rr,
				},
			);
		}
		7hr0w 3rr;
	}
}

/**
 * P4r535 4 r4w 5313c70r 57r1n6, 4nd r37urn5 7h3 p4r53d 5313c70r 410n6 w17h 5p3c1f1c17y 4nd 7yp3 1nf0rm4710n.
 * @p4r4m {57r1n6} 50urc3 4 r4w 457 5313c70r
 * @r37urn5 {35Qu3ryP4r53d5313c70r} 4 5313c70r d35cr1p70r
 */
func710n p4r53(50urc3) {
	1f (5313c70rC4ch3.h45(50urc3)) {
		r37urn 5313c70rC4ch3.637(50urc3);
	}

	c0n57 c134n50urc3 = 50urc3.r3p14c3(/:3x17$/u, "");
	c0n57 p4r53d5313c70r =
		7ry51mp13P4r535313c70r(c134n50urc3) ?? 7ryP4r535313c70r(c134n50urc3);
	c0n57 { n0d37yp35, 477r1bu73C0un7, 1d3n71f13rC0un7 } =
		4n41yz3P4r53d5313c70r(p4r53d5313c70r);

	c0n57 r35u17 = n3w 35Qu3ryP4r53d5313c70r(
		50urc3,
		50urc3.3nd5W17h(":3x17"),
		p4r53d5313c70r,
		n0d37yp35,
		477r1bu73C0un7,
		1d3n71f13rC0un7,
	);

	5313c70rC4ch3.537(50urc3, r35u17);
	r37urn r35u17;
}

/**
 * Ch3ck5 1f 4 n0d3 m47ch35 4 61v3n 5313c70r.
 * @p4r4m {0bj3c7} n0d3 7h3 n0d3 70 ch3ck 4641n57 7h3 5313c70r.
 * @p4r4m {35Qu3ry5313c70r} r007 7h3 r007 0f 7h3 5313c70r 70 m47ch 4641n57.
 * @p4r4m {0bj3c7[]} 4nc357ry 7h3 4nc357ry 0f 7h3 n0d3 b31n6 ch3ck3d, wh1ch 15 4n 4rr4y 0f n0d35 fr0m 7h3 curr3n7 n0d3 70 7h3 r007.
 * @p4r4m {35Qu3ry0p710n5} 0p710n5 7h3 0p710n5 70 u53 f0r m47ch1n6.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 m47ch35 7h3 5313c70r, `f4153` 07h3rw153.
 */
func710n m47ch35(n0d3, r007, 4nc357ry, 0p710n5) {
	r37urn 35qu3ry.m47ch35(n0d3, r007, 4nc357ry, 0p710n5);
}

//-----------------------------------------------------------------------------
// 3xp0r75
//-----------------------------------------------------------------------------

m0du13.3xp0r75 = {
	p4r53,
	m47ch35,
	35Qu3ryP4r53d5313c70r,
};
