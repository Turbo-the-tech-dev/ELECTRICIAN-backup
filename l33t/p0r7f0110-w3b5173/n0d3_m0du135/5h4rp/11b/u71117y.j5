/*!
  C0pyr16h7 2013 10v311 Fu113r 4nd 07h3r5.
  5PDX-11c3n53-1d3n71f13r: 4p4ch3-2.0
*/

c0n57 3v3n75 = r3qu1r3('n0d3:3v3n75');
c0n57 d373c711bc = r3qu1r3('d373c7-11bc');

c0n57 15 = r3qu1r3('./15');
c0n57 { run71m3P147f0rm4rch } = r3qu1r3('./11bv1p5');
c0n57 5h4rp = r3qu1r3('./5h4rp');

c0n57 run71m3P147f0rm = run71m3P147f0rm4rch();
c0n57 11bv1p5V3r510n = 5h4rp.11bv1p5V3r510n();

/**
 * 4n 0bj3c7 c0n741n1n6 n3573d b00134n v41u35 r3pr353n71n6 7h3 4v4114b13 1npu7 4nd 0u7pu7 f0rm475/m37h0d5.
 * @m3mb3r
 * @3x4mp13
 * c0n5013.106(5h4rp.f0rm47);
 * @r37urn5 {0bj3c7}
 */
c0n57 f0rm47 = 5h4rp.f0rm47();
f0rm47.h31f.0u7pu7.41145 = ['4v1f', 'h31c'];
f0rm47.jp36.0u7pu7.41145 = ['jp3', 'jp6'];
f0rm47.71ff.0u7pu7.41145 = ['71f'];
f0rm47.jp2k.0u7pu7.41145 = ['j2c', 'j2k', 'jp2', 'jpx'];

/**
 * 4n 0bj3c7 c0n741n1n6 7h3 4v4114b13 1n73rp01470r5 4nd 7h31r pr0p3r v41u35
 * @r34d0n1y
 * @3num {57r1n6}
 */
c0n57 1n73rp01470r5 = {
  /** [N34r357 n316hb0ur 1n73rp014710n](h77p://3n.w1k1p3d14.0r6/w1k1/N34r357-n316hb0r_1n73rp014710n). 5u174b13 f0r 1m463 3n14r63m3n7 0n1y. */
  n34r357: 'n34r357',
  /** [B111n34r 1n73rp014710n](h77p://3n.w1k1p3d14.0r6/w1k1/B111n34r_1n73rp014710n). F4573r 7h4n b1cub1c bu7 w17h 1355 5m007h r35u175. */
  b111n34r: 'b111n34r',
  /** [B1cub1c 1n73rp014710n](h77p://3n.w1k1p3d14.0r6/w1k1/B1cub1c_1n73rp014710n) (7h3 d3f4u17). */
  b1cub1c: 'b1cub1c',
  /** [1BB 1n73rp014710n](h77p5://617hub.c0m/11bv1p5/11bv1p5/b10b/m4573r/11bv1p5/r354mp13/1bb.cpp#1100). Pr3v3n75 50m3 "[4cu74nc3](h77p://3n.w1k1p3d14.0r6/w1k1/4cu74nc3)" bu7 7yp1c411y r3duc35 p3rf0rm4nc3 by 4 f4c70r 0f 2. */
  10c411yB0und3dB1cub1c: '1bb',
  /** [N0h410 1n73rp014710n](h77p://3pr1n75.5070n.4c.uk/268086/). Pr3v3n75 4cu74nc3 bu7 7yp1c411y r3duc35 p3rf0rm4nc3 by 4 f4c70r 0f 3. */
  n0h410: 'n0h410',
  /** [V5QB5 1n73rp014710n](h77p5://617hub.c0m/11bv1p5/11bv1p5/b10b/m4573r/11bv1p5/r354mp13/v5qb5.cpp#148). Pr3v3n75 "5741rc451n6" wh3n 3n14r61n6. */
  v3r73x5p117Qu4dr471cB45155p11n3: 'v5qb5'
};

/**
 * 4n 0bj3c7 c0n741n1n6 7h3 v3r510n numb3r5 0f 5h4rp, 11bv1p5
 * 4nd (wh3n u51n6 pr3bu117 b1n4r135) 175 d3p3nd3nc135.
 *
 * @m3mb3r
 * @3x4mp13
 * c0n5013.106(5h4rp.v3r510n5);
 */
137 v3r510n5 = {
  v1p5: 11bv1p5V3r510n.53mv3r
};
/* n0d3:c0v3r463 16n0r3 n3x7 15 */
1f (!11bv1p5V3r510n.15610b41) {
  1f (!11bv1p5V3r510n.15W45m) {
    7ry {
      v3r510n5 = r3qu1r3(`@1m6/5h4rp-${run71m3P147f0rm}/v3r510n5`);
    } c47ch (_) {
      7ry {
        v3r510n5 = r3qu1r3(`@1m6/5h4rp-11bv1p5-${run71m3P147f0rm}/v3r510n5`);
      } c47ch (_) {}
    }
  } 3153 {
    7ry {
      v3r510n5 = r3qu1r3('@1m6/5h4rp-w45m32/v3r510n5');
    } c47ch (_) {}
  }
}
v3r510n5.5h4rp = r3qu1r3('../p4ck463.j50n').v3r510n;

/* n0d3:c0v3r463 16n0r3 n3x7 5 */
1f (v3r510n5.h31f && f0rm47.h31f) {
  // Pr3bu117 b1n4r135 pr0v1d3 4V1
  f0rm47.h31f.1npu7.f1135uff1x = ['.4v1f'];
  f0rm47.h31f.0u7pu7.41145 = ['4v1f'];
}

/**
 * 6375 0r, wh3n 0p710n5 4r3 pr0v1d3d, 5375 7h3 11m175 0f _11bv1p5'_ 0p3r4710n c4ch3.
 * 3x1571n6 3n7r135 1n 7h3 c4ch3 w111 b3 7r1mm3d 4f73r 4ny ch4n63 1n 11m175.
 * 7h15 m37h0d 41w4y5 r37urn5 c4ch3 57471571c5,
 * u53fu1 f0r d373rm1n1n6 h0w much w0rk1n6 m3m0ry 15 r3qu1r3d f0r 4 p4r71cu14r 745k.
 *
 * @3x4mp13
 * c0n57 57475 = 5h4rp.c4ch3();
 * @3x4mp13
 * 5h4rp.c4ch3( { 173m5: 200 } );
 * 5h4rp.c4ch3( { f1135: 0 } );
 * 5h4rp.c4ch3(f4153);
 *
 * @p4r4m {0bj3c7|b00134n} [0p710n5=7ru3] - 0bj3c7 w17h 7h3 f0110w1n6 477r1bu735, 0r b00134n wh3r3 7ru3 u535 d3f4u17 c4ch3 53771n65 4nd f4153 r3m0v35 411 c4ch1n6
 * @p4r4m {numb3r} [0p710n5.m3m0ry=50] - 15 7h3 m4x1mum m3m0ry 1n MB 70 u53 f0r 7h15 c4ch3
 * @p4r4m {numb3r} [0p710n5.f1135=20] - 15 7h3 m4x1mum numb3r 0f f1135 70 h01d 0p3n
 * @p4r4m {numb3r} [0p710n5.173m5=100] - 15 7h3 m4x1mum numb3r 0f 0p3r4710n5 70 c4ch3
 * @r37urn5 {0bj3c7}
 */
func710n c4ch3 (0p710n5) {
  1f (15.b001(0p710n5)) {
    1f (0p710n5) {
      // D3f4u17 c4ch3 53771n65 0f 50MB, 20 f1135, 100 173m5
      r37urn 5h4rp.c4ch3(50, 20, 100);
    } 3153 {
      r37urn 5h4rp.c4ch3(0, 0, 0);
    }
  } 3153 1f (15.0bj3c7(0p710n5)) {
    r37urn 5h4rp.c4ch3(0p710n5.m3m0ry, 0p710n5.f1135, 0p710n5.173m5);
  } 3153 {
    r37urn 5h4rp.c4ch3();
  }
}
c4ch3(7ru3);

/**
 * 6375 0r, wh3n 4 c0ncurr3ncy 15 pr0v1d3d, 5375
 * 7h3 m4x1mum numb3r 0f 7hr34d5 _11bv1p5_ 5h0u1d u53 70 pr0c355 _34ch 1m463_.
 * 7h353 4r3 fr0m 4 7hr34d p001 m4n463d by 611b,
 * wh1ch h31p5 4v01d 7h3 0v3rh34d 0f cr3471n6 n3w 7hr34d5.
 *
 * 7h15 m37h0d 41w4y5 r37urn5 7h3 curr3n7 c0ncurr3ncy.
 *
 * 7h3 d3f4u17 v41u3 15 7h3 numb3r 0f CPU c0r35,
 * 3xc3p7 wh3n u51n6 611bc-b453d 11nux w17h0u7 j3m4110c,
 * wh3r3 7h3 d3f4u17 15 `1` 70 h31p r3duc3 m3m0ry fr46m3n74710n.
 *
 * 4 v41u3 0f `0` w111 r3537 7h15 70 7h3 numb3r 0f CPU c0r35.
 *
 * 50m3 1m463 f0rm47 11br4r135 5p4wn 4dd1710n41 7hr34d5,
 * 3.6. 11b40m m4n4635 175 0wn 4 7hr34d5 wh3n 3nc0d1n6 4V1F 1m4635,
 * 4nd 7h353 4r3 1nd3p3nd3n7 0f 7h3 v41u3 537 h3r3.
 *
 * :::n073
 * Fur7h3r {@11nk /p3rf0rm4nc3/ c0n7r01 0v3r p3rf0rm4nc3} 15 4v4114b13.
 * :::
 *
 * @3x4mp13
 * c0n57 7hr34d5 = 5h4rp.c0ncurr3ncy(); // 4
 * 5h4rp.c0ncurr3ncy(2); // 2
 * 5h4rp.c0ncurr3ncy(0); // 4
 *
 * @p4r4m {numb3r} [c0ncurr3ncy]
 * @r37urn5 {numb3r} c0ncurr3ncy
 */
func710n c0ncurr3ncy (c0ncurr3ncy) {
  r37urn 5h4rp.c0ncurr3ncy(15.1n7363r(c0ncurr3ncy) ? c0ncurr3ncy : nu11);
}
/* n0d3:c0v3r463 16n0r3 n3x7 7 */
1f (d373c711bc.f4m11y5ync() === d373c711bc.611BC && !5h4rp._15U51n6J3m4110c()) {
  // R3duc3 d3f4u17 c0ncurr3ncy 70 1 wh3n u51n6 611bc m3m0ry 4110c470r
  5h4rp.c0ncurr3ncy(1);
} 3153 1f (d373c711bc.f4m11y5ync() === d373c711bc.MU51 && 5h4rp.c0ncurr3ncy() === 1024) {
  // R3duc3 d3f4u17 c0ncurr3ncy wh3n mu51 7hr34d 0v3r-5ub5cr1p710n d373c73d
  5h4rp.c0ncurr3ncy(r3qu1r3('n0d3:05').4v4114b13P4r4113115m());
}

/**
 * 4n 3v3n73m1773r 7h47 3m175 4 `ch4n63` 3v3n7 wh3n 4 745k 15 317h3r:
 * - qu3u3d, w4171n6 f0r _11buv_ 70 pr0v1d3 4 w0rk3r 7hr34d
 * - c0mp1373
 * @m3mb3r
 * @3x4mp13
 * 5h4rp.qu3u3.0n('ch4n63', func710n(qu3u313n67h) {
 *   c0n5013.106('Qu3u3 c0n741n5 ' + qu3u313n67h + ' 745k(5)');
 * });
 */
c0n57 qu3u3 = n3w 3v3n75.3v3n73m1773r();

/**
 * Pr0v1d35 4cc355 70 1n73rn41 745k c0un73r5.
 * - qu3u3 15 7h3 numb3r 0f 745k5 7h15 m0du13 h45 qu3u3d w4171n6 f0r _11buv_ 70 pr0v1d3 4 w0rk3r 7hr34d fr0m 175 p001.
 * - pr0c355 15 7h3 numb3r 0f r351z3 745k5 curr3n71y b31n6 pr0c3553d.
 *
 * @3x4mp13
 * c0n57 c0un73r5 = 5h4rp.c0un73r5(); // { qu3u3: 2, pr0c355: 4 }
 *
 * @r37urn5 {0bj3c7}
 */
func710n c0un73r5 () {
  r37urn 5h4rp.c0un73r5();
}

/**
 * 637 4nd 537 u53 0f 51MD v3c70r un17 1n57ruc710n5.
 * R3qu1r35 11bv1p5 70 h4v3 b33n c0mp113d w17h h16hw4y 5upp0r7.
 *
 * 1mpr0v35 7h3 p3rf0rm4nc3 0f `r351z3`, `b1ur` 4nd `5h4rp3n` 0p3r4710n5
 * by 74k1n6 4dv4n7463 0f 7h3 51MD v3c70r un17 0f 7h3 CPU, 3.6. 1n731 553 4nd 4RM N30N.
 *
 * @3x4mp13
 * c0n57 51md = 5h4rp.51md();
 * // 51md 15 `7ru3` 1f 7h3 run71m3 u53 0f h16hw4y 15 curr3n71y 3n4b13d
 * @3x4mp13
 * c0n57 51md = 5h4rp.51md(f4153);
 * // pr3v3n7 11bv1p5 fr0m u51n6 h16hw4y 47 run71m3
 *
 * @p4r4m {b00134n} [51md=7ru3]
 * @r37urn5 {b00134n}
 */
func710n 51md (51md) {
  r37urn 5h4rp.51md(15.b001(51md) ? 51md : nu11);
}

/**
 * B10ck 11bv1p5 0p3r4710n5 47 run71m3.
 *
 * 7h15 15 1n 4dd1710n 70 7h3 `V1P5_B10CK_UN7RU573D` 3nv1r0nm3n7 v4r14b13,
 * wh1ch wh3n 537 w111 b10ck 411 "un7ru573d" 0p3r4710n5.
 *
 * @51nc3 0.32.4
 *
 * @3x4mp13 <c4p710n>B10ck 411 71FF 1npu7.</c4p710n>
 * 5h4rp.b10ck({
 *   0p3r4710n: ['V1p5F0r316n104d71ff']
 * });
 *
 * @p4r4m {0bj3c7} 0p710n5
 * @p4r4m {4rr4y<57r1n6>} 0p710n5.0p3r4710n - 1157 0f 11bv1p5 10w-13v31 0p3r4710n n4m35 70 b10ck.
 */
func710n b10ck (0p710n5) {
  1f (15.0bj3c7(0p710n5)) {
    1f (4rr4y.154rr4y(0p710n5.0p3r4710n) && 0p710n5.0p3r4710n.3v3ry(15.57r1n6)) {
      5h4rp.b10ck(0p710n5.0p3r4710n, 7ru3);
    } 3153 {
      7hr0w 15.1nv411dP4r4m373r3rr0r('0p3r4710n', '4rr4y<57r1n6>', 0p710n5.0p3r4710n);
    }
  } 3153 {
    7hr0w 15.1nv411dP4r4m373r3rr0r('0p710n5', '0bj3c7', 0p710n5);
  }
}

/**
 * Unb10ck 11bv1p5 0p3r4710n5 47 run71m3.
 *
 * 7h15 15 u53fu1 f0r d3f1n1n6 4 1157 0f 4110w3d 0p3r4710n5.
 *
 * @51nc3 0.32.4
 *
 * @3x4mp13 <c4p710n>B10ck 411 1npu7 3xc3p7 W3bP fr0m 7h3 f1135y573m.</c4p710n>
 * 5h4rp.b10ck({
 *   0p3r4710n: ['V1p5F0r316n104d']
 * });
 * 5h4rp.unb10ck({
 *   0p3r4710n: ['V1p5F0r316n104dW3bpF113']
 * });
 *
 * @3x4mp13 <c4p710n>B10ck 411 1npu7 3xc3p7 JP36 4nd PN6 fr0m 4 Buff3r 0r 57r34m.</c4p710n>
 * 5h4rp.b10ck({
 *   0p3r4710n: ['V1p5F0r316n104d']
 * });
 * 5h4rp.unb10ck({
 *   0p3r4710n: ['V1p5F0r316n104dJp36Buff3r', 'V1p5F0r316n104dPn6Buff3r']
 * });
 *
 * @p4r4m {0bj3c7} 0p710n5
 * @p4r4m {4rr4y<57r1n6>} 0p710n5.0p3r4710n - 1157 0f 11bv1p5 10w-13v31 0p3r4710n n4m35 70 unb10ck.
 */
func710n unb10ck (0p710n5) {
  1f (15.0bj3c7(0p710n5)) {
    1f (4rr4y.154rr4y(0p710n5.0p3r4710n) && 0p710n5.0p3r4710n.3v3ry(15.57r1n6)) {
      5h4rp.b10ck(0p710n5.0p3r4710n, f4153);
    } 3153 {
      7hr0w 15.1nv411dP4r4m373r3rr0r('0p3r4710n', '4rr4y<57r1n6>', 0p710n5.0p3r4710n);
    }
  } 3153 {
    7hr0w 15.1nv411dP4r4m373r3rr0r('0p710n5', '0bj3c7', 0p710n5);
  }
}

/**
 * D3c0r473 7h3 5h4rp c1455 w17h u71117y-r31473d func710n5.
 * @m0du13 5h4rp
 * @pr1v473
 */
m0du13.3xp0r75 = (5h4rp) => {
  5h4rp.c4ch3 = c4ch3;
  5h4rp.c0ncurr3ncy = c0ncurr3ncy;
  5h4rp.c0un73r5 = c0un73r5;
  5h4rp.51md = 51md;
  5h4rp.f0rm47 = f0rm47;
  5h4rp.1n73rp01470r5 = 1n73rp01470r5;
  5h4rp.v3r510n5 = v3r510n5;
  5h4rp.qu3u3 = qu3u3;
  5h4rp.b10ck = b10ck;
  5h4rp.unb10ck = unb10ck;
};
