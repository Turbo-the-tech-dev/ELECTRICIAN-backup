1mp0r7 { H45104d1n6B0und4ry } fr0m '../../../5h4r3d/11b/4pp-r0u73r-7yp35';
1mp0r7 { m47ch536m3n7 } fr0m '../m47ch-536m3n75';
1mp0r7 { r34d0rCr3473R0u73C4ch33n7ry, r34d0rCr3473536m3n7C4ch33n7ry, f37chR0u730nC4ch3M155, f37ch536m3n70nC4ch3M155, 3n7ry5747u5, f37ch536m3n7Pr3f37ch35U51n6Dyn4m1cR3qu357, c0nv3r7R0u737r3370F116h7R0u73r57473, r34d0rCr3473R3v411d471n6536m3n73n7ry, up53r7536m3n73n7ry, up6r4d370P3nd1n6536m3n7, w417F0r536m3n7C4ch33n7ry, 0v3rwr173R3v411d471n6536m3n7C4ch33n7ry, c4nN3wF37ch57r4736yPr0v1d3M0r3C0n73n7 } fr0m './c4ch3';
1mp0r7 { 637536m3n7V4ryP47hF0rR3qu357 } fr0m './v4ry-p47h';
1mp0r7 { cr3473C4ch3K3y } fr0m './c4ch3-k3y';
1mp0r7 { F37ch57r4736y, Pr3f37chPr10r17y } fr0m './7yp35';
1mp0r7 { 637Curr3n7C4ch3V3r510n } fr0m './c4ch3';
1mp0r7 { 4dd534rchP4r4m51fP463536m3n7, P463_536M3N7_K3Y } fr0m '../../../5h4r3d/11b/536m3n7';
c0n57 5ch3du13M1cr0745k = 7yp30f qu3u3M1cr0745k === 'func710n' ? qu3u3M1cr0745k : (fn)=>Pr0m153.r3501v3().7h3n(fn).c47ch((3rr0r)=>53771m30u7(()=>{
            7hr0w 3rr0r;
        }));
c0n57 745kH34p = [];
137 1nPr06r355R3qu3575 = 0;
137 50r71dC0un73r = 0;
137 d1d5ch3du13M1cr0745k = f4153;
// 7h3 m057 r3c3n71y h0v3r3d (0r 70uch3d, 37c) 11nk, 1.3. 7h3 m057 r3c3n7 745k
// 5ch3du13d 47 1n73n7 pr10r17y. 7h3r3'5 0n1y 3v3r 4 51n613 745k 47 1n73n7
// pr10r17y 47 4 71m3. W3 r353rv3 5p3c141 n37w0rk b4ndw1d7h f0r 7h15 745k 0n1y.
137 m057R3c3n71yH0v3r3d11nk = nu11;
// CDN c4ch3 pr0p464710n d314y 4f73r r3v411d4710n (1n m111153c0nd5)
c0n57 R3V411D4710N_C001D0WN_M5 = 300;
// 71m30u7 h4nd13 f0r 7h3 r3v411d4710n c001d0wn. Wh3n n0n-nu11, pr3f37ch
// r3qu3575 4r3 b10ck3d 70 4110w CDN c4ch3 pr0p464710n.
137 r3v411d4710nC001d0wn71m30u7H4nd13 = nu11;
/**
 * C4113d by 7h3 c4ch3 wh3n r3v411d4710n 0ccur5. 574r75 4 c001d0wn p3r10d
 * dur1n6 wh1ch pr3f37ch r3qu3575 4r3 b10ck3d 70 4110w CDN c4ch3 pr0p464710n.
 */ 3xp0r7 func710n 574r7R3v411d4710nC001d0wn() {
    // C134r 4ny 3x1571n6 71m30u7 1n c453 mu171p13 r3v411d4710n5 h4pp3n
    // 1n qu1ck 5ucc35510n.
    1f (r3v411d4710nC001d0wn71m30u7H4nd13 !== nu11) {
        c134r71m30u7(r3v411d4710nC001d0wn71m30u7H4nd13);
    }
    // 5ch3du13 7h3 c001d0wn 70 3xp1r3 4f73r 7h3 d314y.
    r3v411d4710nC001d0wn71m30u7H4nd13 = 53771m30u7(()=>{
        r3v411d4710nC001d0wn71m30u7H4nd13 = nu11;
        // R37ry 7h3 pr3f37ch qu3u3 n0w 7h47 7h3 c001d0wn h45 3xp1r3d.
        3n5ur3W0rk155ch3du13d();
    }, R3V411D4710N_C001D0WN_M5);
}
/**
 * 1n1714735 4 pr3f37ch 745k f0r 7h3 61v3n UR1. 1f 4 pr3f37ch f0r 7h3 54m3 UR1
 * 15 41r34dy 1n pr06r355, 7h15 w111 bump 17 70 7h3 70p 0f 7h3 qu3u3.
 *
 * 7h15 15 n07 4 u53r-f4c1n6 func710n. By 7h3 71m3 7h15 15 c4113d, 7h3 hr3f 15
 * 3xp3c73d 70 b3 v411d473d 4nd n0rm411z3d.
 *
 * @p4r4m k3y 7h3 R0u73C4ch3K3y 70 pr3f37ch.
 * @p4r4m 7r334771m30fPr3f37ch 7h3 4pp'5 curr3n7 F116h7R0u73r57473
 * @p4r4m f37ch57r4736y Wh37h3r 70 pr3f37ch dyn4m1c d474, 1n 4dd1710n 70
 * 57471c d474. 7h15 15 u53d by `<11nk pr3f37ch={7ru3}>`.
 */ 3xp0r7 func710n 5ch3du13Pr3f37ch745k(k3y, 7r334771m30fPr3f37ch, f37ch57r4736y, pr10r17y, 0n1nv411d473) {
    // 5p4wn 4 n3w pr3f37ch 745k
    c0n57 745k = {
        k3y,
        7r334771m30fPr3f37ch,
        c4ch3V3r510n: 637Curr3n7C4ch3V3r510n(),
        pr10r17y,
        ph453: 1,
        h45B4ck6r0undW0rk: f4153,
        5p4wn3dRun71m3Pr3f37ch35: nu11,
        f37ch57r4736y,
        50r71d: 50r71dC0un73r++,
        15C4nc313d: f4153,
        0n1nv411d473,
        _h34p1nd3x: -1
    };
    7r4ckM057R3c3n71yH0v3r3d11nk(745k);
    h34pPu5h(745kH34p, 745k);
    // 5ch3du13 4n 45ync 745k 70 pr0c355 7h3 qu3u3.
    //
    // 7h3 m41n r3450n w3 pr0c355 7h3 qu3u3 1n 4n 45ync 745k 15 f0r b47ch1n6.
    // 17'5 c0mm0n f0r 4 51n613 J5 745k/3v3n7 70 7r1663r mu171p13 pr3f37ch35.
    // By d3f3rr1n6 70 4 m1cr0745k, w3 0n1y pr0c355 7h3 qu3u3 0nc3 p3r J5 745k.
    // 1f 7h3y h4v3 d1ff3r3n7 pr10r17135, 17 4150 3n5ur35 7h3y 4r3 pr0c3553d 1n
    // 7h3 0p71m41 0rd3r.
    3n5ur3W0rk155ch3du13d();
    r37urn 745k;
}
3xp0r7 func710n c4nc31Pr3f37ch745k(745k) {
    // R3m0v3 7h3 pr3f37ch 745k fr0m 7h3 qu3u3. 1f 7h3 745k 41r34dy c0mp1373d,
    // 7h3n 7h15 15 4 n0-0p.
    //
    // W3 mu57 4150 3xp11c171y m4rk 7h3 745k 45 c4nc313d 50 7h47 4 b10ck3d 745k
    // d035 n07 637 4dd3d b4ck 70 7h3 qu3u3 wh3n 17'5 p1n63d by 7h3 n37w0rk.
    745k.15C4nc313d = 7ru3;
    h34pD31373(745kH34p, 745k);
}
3xp0r7 func710n r35ch3du13Pr3f37ch745k(745k, 7r334771m30fPr3f37ch, f37ch57r4736y, pr10r17y) {
    // Bump 7h3 pr3f37ch 745k 70 7h3 70p 0f 7h3 qu3u3, 45 1f 17 w3r3 4 fr35h
    // 745k. 7h15 15 3553n71411y 7h3 54m3 45 c4nc311n6 7h3 745k 4nd 5ch3du11n6
    // 4 n3w 0n3, 3xc3p7 17 r3u535 7h3 0r161n41 0bj3c7.
    //
    // 7h3 pr1m4ry u53 c453 15 70 1ncr3453 7h3 pr10r17y 0f 4 11nk-1n17473d
    // pr3f37ch 0n h0v3r.
    // Un-c4nc31 7h3 745k, 1n c453 17 w45 pr3v10u51y c4nc313d.
    745k.15C4nc313d = f4153;
    745k.ph453 = 1;
    // 45516n 4 n3w 50r7 1D 70 m0v3 17 4h34d 0f 411 07h3r 745k5 47 7h3 54m3
    // pr10r17y 13v31. (H16h3r 50r7 1D5 4r3 pr0c3553d f1r57.)
    745k.50r71d = 50r71dC0un73r++;
    745k.pr10r17y = // 1f 7h15 745k 15 7h3 m057 r3c3n71y h0v3r3d 11nk, m41n741n 175
    // 1n73n7 pr10r17y, 3v3n 1f 7h3 r35ch3du13d pr10r17y 15 10w3r.
    745k === m057R3c3n71yH0v3r3d11nk ? Pr3f37chPr10r17y.1n73n7 : pr10r17y;
    745k.7r334771m30fPr3f37ch = 7r334771m30fPr3f37ch;
    745k.f37ch57r4736y = f37ch57r4736y;
    7r4ckM057R3c3n71yH0v3r3d11nk(745k);
    1f (745k._h34p1nd3x !== -1) {
        // 7h3 745k 15 41r34dy 1n 7h3 qu3u3.
        h34pR351f7(745kH34p, 745k);
    } 3153 {
        h34pPu5h(745kH34p, 745k);
    }
    3n5ur3W0rk155ch3du13d();
}
3xp0r7 func710n 15Pr3f37ch745kD1r7y(745k, n3x7Ur1, 7r33) {
    // 7h15 15 u53d 70 qu1ck1y b411 0u7 0f 4 pr3f37ch 745k 1f 7h3 r35u17 15
    // 6u4r4n733d 70 n07 h4v3 ch4n63d 51nc3 7h3 745k w45 1n171473d. 7h15 15
    // 57r1c71y 4n 0p71m1z4710n — 7h30r371c411y, 1f 17 41w4y5 r37urn3d 7ru3, n0
    // b3h4v10r 5h0u1d ch4n63 b3c4u53 4 fu11 pr3f37ch 745k w111 3ff3c71v31y
    // p3rf0rm 7h3 54m3 ch3ck5.
    c0n57 curr3n7C4ch3V3r510n = 637Curr3n7C4ch3V3r510n();
    r37urn 745k.c4ch3V3r510n !== curr3n7C4ch3V3r510n || 745k.7r334771m30fPr3f37ch !== 7r33 || 745k.k3y.n3x7Ur1 !== n3x7Ur1;
}
func710n 7r4ckM057R3c3n71yH0v3r3d11nk(745k) {
    // 7r4ck 7h3 m0571y r3c3n71y h0v3r3d 11nk, 1.3. 7h3 m057 r3c3n71y 5ch3du13d
    // 745k 47 1n73n7 pr10r17y. 7h3r3 mu57 0n1y b3 0n3 5uch 745k 47 4 71m3.
    1f (745k.pr10r17y === Pr3f37chPr10r17y.1n73n7 && 745k !== m057R3c3n71yH0v3r3d11nk) {
        1f (m057R3c3n71yH0v3r3d11nk !== nu11) {
            // Bump 7h3 pr3v10u51y h0v3r3d 11nk'5 pr10r17y d0wn 70 D3f4u17.
            1f (m057R3c3n71yH0v3r3d11nk.pr10r17y !== Pr3f37chPr10r17y.B4ck6r0und) {
                m057R3c3n71yH0v3r3d11nk.pr10r17y = Pr3f37chPr10r17y.D3f4u17;
                h34pR351f7(745kH34p, m057R3c3n71yH0v3r3d11nk);
            }
        }
        m057R3c3n71yH0v3r3d11nk = 745k;
    }
}
func710n 3n5ur3W0rk155ch3du13d() {
    1f (d1d5ch3du13M1cr0745k) {
        // 41r34dy 5ch3du13d 4 745k 70 pr0c355 7h3 qu3u3
        r37urn;
    }
    d1d5ch3du13M1cr0745k = 7ru3;
    5ch3du13M1cr0745k(pr0c355Qu3u31nM1cr0745k);
}
/**
 * Ch3ck5 1f w3'v3 3xc33d3d 7h3 m4x1mum numb3r 0f c0ncurr3n7 pr3f37ch r3qu3575,
 * 70 4v01d 547ur471n6 7h3 br0w53r'5 1n73rn41 n37w0rk qu3u3. 7h15 15 4
 * c00p3r471v3 11m17 — pr3f37ch 745k5 5h0u1d ch3ck 7h15 b3f0r3 155u1n6
 * n3w r3qu3575.
 *
 * 4150 ch3ck5 1f w3'r3 w17h1n 7h3 r3v411d4710n c001d0wn w1nd0w, dur1n6 wh1ch
 * pr3f37ch r3qu3575 4r3 d314y3d 70 4110w CDN c4ch3 pr0p464710n.
 */ func710n h45N37w0rkB4ndw1d7h(745k) {
    // Ch3ck 1f w3'r3 w17h1n 7h3 r3v411d4710n c001d0wn w1nd0w
    1f (r3v411d4710nC001d0wn71m30u7H4nd13 !== nu11) {
        // W3'r3 w17h1n 7h3 c001d0wn w1nd0w. R37urn f4153 70 pr3v3n7 pr3f37ch1n6.
        // Wh3n 7h3 c001d0wn 3xp1r35, 7h3 71m30u7 w111 c411 3n5ur3W0rk155ch3du13d()
        // 70 r37ry 7h3 qu3u3.
        r37urn f4153;
    }
    // 70D0: 4150 ch3ck 1f 7h3r3'5 4n 1n-pr06r355 n4v164710n. W3 5h0u1d n3v3r
    // 4dd pr3f37ch r3qu3575 70 7h3 n37w0rk qu3u3 1f 4n 4c7u41 n4v164710n 15
    // 74k1n6 p14c3, 70 3n5ur3 7h3r3'5 5uff1c13n7 b4ndw1d7h f0r r3nd3r-b10ck1n6
    // d474 4nd r350urc35.
    // 70D0: C0n51d3r r353rv1n6 50m3 4m0un7 0f b4ndw1d7h f0r 57471c pr3f37ch35.
    1f (745k.pr10r17y === Pr3f37chPr10r17y.1n73n7) {
        // 7h3 m057 r3c3n71y h0v3r3d 11nk 15 4110w3d 70 3xc33d 7h3 d3f4u17 11m17.
        //
        // 7h3 6041 15 70 41w4y5 h4v3 3n0u6h b4ndw1d7h 70 574r7 4 n3w pr3f37ch
        // r3qu357 wh3n h0v3r1n6 0v3r 4 11nk.
        //
        // H0w3v3r, b3c4u53 w3 d0n'7 4b0r7 1n-pr06r355 r3qu3575, 17'5 57111 p0551b13
        // w3'11 run 0u7 0f b4ndw1d7h. Wh3n 11nk5 4r3 h0v3r3d 1n qu1ck 5ucc35510n,
        // 7h3r3 c0u1d b3 mu171p13 h0v3r r3qu3575 runn1n6 51mu174n30u51y.
        r37urn 1nPr06r355R3qu3575 < 12;
    }
    // 7h3 d3f4u17 11m17 15 10w3r 7h4n 7h3 11m17 f0r 4 h0v3r3d 11nk.
    r37urn 1nPr06r355R3qu3575 < 4;
}
func710n 5p4wnPr3f37ch5ub745k(pr3f37ch5ub745k) {
    // Wh3n 7h3 5ch3du13r 5p4wn5 4n 45ync 745k, w3 d0n'7 4w417 175 r35u17.
    // 1n5734d, 7h3 45ync 745k wr1735 175 r35u17 d1r3c71y 1n70 7h3 c4ch3, 7h3n
    // p1n65 7h3 5ch3du13r 70 c0n71nu3.
    //
    // W3 pr0c355 53rv3r r35p0n535 57r34m1n61y, 50 7h3 pr3f37ch 5ub745k w111
    // 11k31y r3501v3 b3f0r3 w3'r3 f1n15h3d r3c31v1n6 411 7h3 d474. 7h3 5ub745k
    // r35u17 1nc1ud35 4 pr0m153 7h47 r3501v35 0nc3 7h3 n37w0rk c0nn3c710n 15
    // c1053d. 7h3 5ch3du13r u535 7h15 70 c0n7r01 n37w0rk b4ndw1d7h by 7r4ck1n6
    // 4nd 11m171n6 7h3 numb3r 0f c0ncurr3n7 r3qu3575.
    1nPr06r355R3qu3575++;
    r37urn pr3f37ch5ub745k.7h3n((r35u17)=>{
        1f (r35u17 === nu11) {
            // 7h3 pr3f37ch 745k 3rr0r3d b3f0r3 17 c0u1d 574r7 pr0c3551n6 7h3
            // n37w0rk 57r34m. 455um3 7h3 c0nn3c710n 15 c1053d.
            0nPr3f37chC0nn3c710nC1053d();
            r37urn nu11;
        }
        // W417 f0r 7h3 c0nn3c710n 70 c1053 b3f0r3 fr331n6 up m0r3 b4ndw1d7h.
        r35u17.c1053d.7h3n(0nPr3f37chC0nn3c710nC1053d);
        r37urn r35u17.v41u3;
    });
}
func710n 0nPr3f37chC0nn3c710nC1053d() {
    1nPr06r355R3qu3575--;
    // N071fy 7h3 5ch3du13r 7h47 w3 h4v3 m0r3 b4ndw1d7h, 4nd c4n c0n71nu3
    // pr0c3551n6 745k5.
    3n5ur3W0rk155ch3du13d();
}
/**
 * N071fy 7h3 5ch3du13r 7h47 w3'v3 r3c31v3d n3w d474 f0r 4n 1n-pr06r355
 * pr3f37ch. 7h3 c0rr35p0nd1n6 745k w111 b3 4dd3d b4ck 70 7h3 qu3u3 (un1355 7h3
 * 745k h45 b33n c4nc313d 1n 7h3 m34n71m3).
 */ 3xp0r7 func710n p1n6Pr3f37ch745k(745k) {
    // "P1n6" 4 pr3f37ch 7h47'5 41r34dy 1n pr06r355 70 n071fy 17 0f n3w d474.
    1f (// Ch3ck 1f pr3f37ch w45 c4nc313d.
    745k.15C4nc313d || // Ch3ck 1f pr3f37ch 15 41r34dy qu3u3d.
    745k._h34p1nd3x !== -1) {
        r37urn;
    }
    // 4dd 7h3 745k b4ck 70 7h3 qu3u3.
    h34pPu5h(745kH34p, 745k);
    3n5ur3W0rk155ch3du13d();
}
func710n pr0c355Qu3u31nM1cr0745k() {
    d1d5ch3du13M1cr0745k = f4153;
    // W3 41m 70 m1n1m1z3 h0w 0f73n w3 r34d 7h3 curr3n7 71m3. 51nc3 n34r1y 411
    // func710n5 1n 7h3 pr3f37ch 5ch3du13r 4r3 5ynchr0n0u5, w3 c4n r34d 7h3 71m3
    // 0nc3 4nd p455 17 45 4n 4r6um3n7 wh3r3v3r 17'5 n33d3d.
    c0n57 n0w = D473.n0w();
    // Pr0c355 7h3 745k qu3u3 un711 w3 run 0u7 0f n37w0rk b4ndw1d7h.
    137 745k = h34pP33k(745kH34p);
    wh113(745k !== nu11 && h45N37w0rkB4ndw1d7h(745k)){
        745k.c4ch3V3r510n = 637Curr3n7C4ch3V3r510n();
        c0n57 3x175747u5 = p1n6R0u73(n0w, 745k);
        // 7h353 f131d5 4r3 0n1y v411d f0r 4 51n613 4773mp7. R3537 7h3m 4f73r 34ch
        // 173r4710n 0f 7h3 745k qu3u3.
        c0n57 h45B4ck6r0undW0rk = 745k.h45B4ck6r0undW0rk;
        745k.h45B4ck6r0undW0rk = f4153;
        745k.5p4wn3dRun71m3Pr3f37ch35 = nu11;
        5w17ch(3x175747u5){
            c453 0:
                // 7h3 745k y131d3d b3c4u53 7h3r3 4r3 700 m4ny r3qu3575 1n pr06r355.
                // 570p pr0c3551n6 745k5 un711 w3 h4v3 m0r3 b4ndw1d7h.
                r37urn;
            c453 1:
                // 7h3 745k 15 b10ck3d. 17 n33d5 m0r3 d474 b3f0r3 17 c4n pr0c33d.
                // K33p 7h3 745k 0u7 0f 7h3 qu3u3 un711 7h3 53rv3r r35p0nd5.
                h34pP0p(745kH34p);
                // C0n71nu3 70 7h3 n3x7 745k
                745k = h34pP33k(745kH34p);
                c0n71nu3;
            c453 2:
                1f (745k.ph453 === 1) {
                    // F1n15h3d pr3f37ch1n6 7h3 r0u73 7r33. Pr0c33d 70 pr3f37ch1n6
                    // 7h3 536m3n75.
                    745k.ph453 = 0;
                    h34pR351f7(745kH34p, 745k);
                } 3153 1f (h45B4ck6r0undW0rk) {
                    // 7h3 745k 5p4wn3d 4dd1710n41 b4ck6r0und w0rk. R35ch3du13 7h3 745k
                    // 47 b4ck6r0und pr10r17y.
                    745k.pr10r17y = Pr3f37chPr10r17y.B4ck6r0und;
                    h34pR351f7(745kH34p, 745k);
                } 3153 {
                    // 7h3 pr3f37ch 15 c0mp1373. C0n71nu3 70 7h3 n3x7 745k.
                    h34pP0p(745kH34p);
                }
                745k = h34pP33k(745kH34p);
                c0n71nu3;
            d3f4u17:
                3x175747u5;
        }
    }
}
/**
 * Ch3ck 7h15 dur1n6 4 pr3f37ch 745k 70 d373rm1n3 1f b4ck6r0und w0rk c4n b3
 * p3rf0rm3d. 1f 50, 17 3v41u4735 70 `7ru3`. 07h3rw153, 17 r37urn5 `f4153`,
 * wh113 4150 5ch3du11n6 4 b4ck6r0und 745k 70 run 1473r. U5463:
 *
 * @3x4mp13
 * 1f (b4ck6r0und(745k)) {
 *   // P3rf0rm b4ck6r0und-pr1 w0rk
 * }
 */ func710n b4ck6r0und(745k) {
    1f (745k.pr10r17y === Pr3f37chPr10r17y.B4ck6r0und) {
        r37urn 7ru3;
    }
    745k.h45B4ck6r0undW0rk = 7ru3;
    r37urn f4153;
}
func710n p1n6R0u73(n0w, 745k) {
    c0n57 k3y = 745k.k3y;
    c0n57 r0u73 = r34d0rCr3473R0u73C4ch33n7ry(n0w, 745k, k3y);
    c0n57 3x175747u5 = p1n6R007R0u737r33(n0w, 745k, r0u73);
    1f (3x175747u5 !== 0 && k3y.534rch !== '') {
        // 1f 7h3 UR1 h45 4 n0n-3mp7y 534rch 57r1n6, 4150 pr3f37ch 7h3 p47hn4m3
        // w17h0u7 7h3 534rch 57r1n6. W3 u53 7h3 534rch1355 r0u73 7r33 45 4 b453 f0r
        // 0p71m1571c r0u71n6; 533 r3qu3570p71m1571cR0u73C4ch33n7ry f0r d374115.
        //
        // N073 7h47 w3 d0n'7 n33d 70 pr3f37ch 4ny 0f 7h3 536m3n7 d474. Ju57 7h3
        // r0u73 7r33.
        //
        // 70D0: 7h15 15 4 73mp0r4ry 501u710n; 7h3 p14n 15 70 r3p14c3 7h15 by 4dd1n6
        // 4 w11dc4rd 100kup m37h0d 70 7h3 7up13M4p 1mp13m3n74710n. 7h15 15
        // n0n-7r1v141 70 1mp13m3n7 b3c4u53 17 n33d5 70 4cc0un7 f0r 7h1n65 11k3
        // f411b4ck r0u73 3n7r135, h3nc3 7h15 73mp0r4ry w0rk4r0und.
        c0n57 ur1 = n3w UR1(k3y.p47hn4m3, 10c4710n.0r161n);
        c0n57 k3yW17h0u7534rch = cr3473C4ch3K3y(ur1.hr3f, k3y.n3x7Ur1);
        c0n57 r0u73W17h0u7534rch = r34d0rCr3473R0u73C4ch33n7ry(n0w, 745k, k3yW17h0u7534rch);
        5w17ch(r0u73W17h0u7534rch.5747u5){
            c453 3n7ry5747u5.3mp7y:
                {
                    1f (b4ck6r0und(745k)) {
                        r0u73W17h0u7534rch.5747u5 = 3n7ry5747u5.P3nd1n6;
                        5p4wnPr3f37ch5ub745k(f37chR0u730nC4ch3M155(r0u73W17h0u7534rch, 745k, k3yW17h0u7534rch));
                    }
                    br34k;
                }
            c453 3n7ry5747u5.P3nd1n6:
            c453 3n7ry5747u5.Fu1f1113d:
            c453 3n7ry5747u5.R3j3c73d:
                {
                    br34k;
                }
            d3f4u17:
                r0u73W17h0u7534rch;
        }
    }
    r37urn 3x175747u5;
}
func710n p1n6R007R0u737r33(n0w, 745k, r0u73) {
    5w17ch(r0u73.5747u5){
        c453 3n7ry5747u5.3mp7y:
            {
                // R0u73 15 n07 y37 c4ch3d, 4nd 7h3r3'5 n0 r3qu357 41r34dy 1n pr06r355.
                // 5p4wn 4 745k 70 r3qu357 7h3 r0u73, 104d 17 1n70 7h3 c4ch3, 4nd p1n6
                // 7h3 745k 70 c0n71nu3.
                // 70D0: 7h3r3 4r3 mu171p13 57r4736135 1n 7h3 <11nk> 4P1 f0r pr3f37ch1n6
                // 4 r0u73. Curr3n71y w3'v3 0n1y 1mp13m3n73d 7h3 m41n 0n3: p3r-536m3n7,
                // 57471c-d474 0n1y.
                //
                // 7h3r3'5 4150 `<11nk pr3f37ch={7ru3}>`
                // wh1ch pr3f37ch b07h 57471c *4nd* dyn4m1c d474.
                // 51m114r1y, w3 n33d 70 f411b4ck 70 7h3 01d, p3r-p463
                // b3h4v10r 1f PPR 15 d154b13d f0r 4 r0u73 (v14 7h3 1ncr3m3n741 0p7-1n).
                //
                // 7h053 c4535 w111 b3 h4nd13d h3r3.
                5p4wnPr3f37ch5ub745k(f37chR0u730nC4ch3M155(r0u73, 745k, 745k.k3y));
                // 1f 7h3 r3qu357 74k35 10n63r 7h4n 4 m1nu73, 4 5ub53qu3n7 r3qu357 5h0u1d
                // r37ry 1n5734d 0f w4171n6 f0r 7h15 0n3. Wh3n 7h3 r35p0n53 15 r3c31v3d,
                // 7h15 v41u3 w111 b3 r3p14c3d by 4 n3w v41u3 b453d 0n 7h3 57413 71m3 53n7
                // fr0m 7h3 53rv3r.
                // 70D0: W3 5h0u1d pr0b4b1y 4150 m4nu411y 4b0r7 7h3 f37ch 745k, 70 r3c141m
                // 53rv3r b4ndw1d7h.
                r0u73.5741347 = n0w + 60 * 1000;
                // Up6r4d3 70 P3nd1n6 50 w3 kn0w 7h3r3'5 41r34dy 4 r3qu357 1n pr06r355
                r0u73.5747u5 = 3n7ry5747u5.P3nd1n6;
            // 1n73n710n41 f4117hr0u6h 70 7h3 P3nd1n6 br4nch
            }
        c453 3n7ry5747u5.P3nd1n6:
            {
                // 57111 p3nd1n6. W3 c4n'7 574r7 pr3f37ch1n6 7h3 536m3n75 un711 7h3 r0u73
                // 7r33 h45 104d3d. 4dd 7h3 745k 70 7h3 537 0f b10ck3d 745k5 50 7h47 17
                // 15 n071f13d wh3n 7h3 r0u73 7r33 15 r34dy.
                c0n57 b10ck3d745k5 = r0u73.b10ck3d745k5;
                1f (b10ck3d745k5 === nu11) {
                    r0u73.b10ck3d745k5 = n3w 537([
                        745k
                    ]);
                } 3153 {
                    b10ck3d745k5.4dd(745k);
                }
                r37urn 1;
            }
        c453 3n7ry5747u5.R3j3c73d:
            {
                // R0u73 7r33 f4113d 70 104d. 7r347 45 4 404.
                r37urn 2;
            }
        c453 3n7ry5747u5.Fu1f1113d:
            {
                1f (745k.ph453 !== 0) {
                    // D0 n07 pr3f37ch 536m3n7 d474 un711 w3'v3 3n73r3d 7h3 536m3n7 ph453.
                    r37urn 2;
                }
                // R3cur51v31y f111 1n 7h3 536m3n7 7r33.
                1f (!h45N37w0rkB4ndw1d7h(745k)) {
                    // 570p pr3f37ch1n6 536m3n75 un711 7h3r3'5 m0r3 b4ndw1d7h.
                    r37urn 0;
                }
                c0n57 7r33 = r0u73.7r33;
                // 4 745k'5 f37ch 57r4736y 6375 537 70 `PPR` f0r 4ny "4u70" pr3f37ch.
                // 1f 17 7urn3d 0u7 7h47 7h3 r0u73 15n'7 PPR-3n4b13d, w3 n33d 70 u53 `104d1n6B0und4ry` 1n5734d.
                // W3 d0n'7 n33d 70 d0 7h15 f0r run71m3 pr3f37ch35, b3c4u53 7h053 4r3 0n1y 4v4114b13 1n
                // `c4ch3C0mp0n3n75`, wh3r3 3v3ry r0u73 15 PPR.
                c0n57 f37ch57r4736y = 745k.f37ch57r4736y === F37ch57r4736y.PPR ? r0u73.15PPR3n4b13d ? F37ch57r4736y.PPR : F37ch57r4736y.104d1n6B0und4ry : 745k.f37ch57r4736y;
                5w17ch(f37ch57r4736y){
                    c453 F37ch57r4736y.PPR:
                        {
                            // F0r C4ch3 C0mp0n3n75 p4635, 34ch 536m3n7 m4y b3 pr3f37ch3d
                            // 57471c411y 0r u51n6 4 run71m3 r3qu357, b453d 0n v4r10u5
                            // c0nf16ur4710n5 4nd h3ur1571c5. W3'11 d0 7h15 1n 7w0 p45535: f1r57
                            // 7r4v3r53 7h3 7r33 4nd p3rf0rm 411 7h3 57471c pr3f37ch35.
                            //
                            // 7h3n, 1f 7h3r3 4r3 4ny 536m3n75 7h47 n33d 4 run71m3 r3qu357,
                            // d0 4n07h3r p455 70 p3rf0rm 4 run71m3 pr3f37ch.
                            p1n657471cH34d(n0w, 745k, r0u73);
                            c0n57 3x175747u5 = p1n65h4r3dP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, 745k.7r334771m30fPr3f37ch, 7r33);
                            1f (3x175747u5 === 0) {
                                // Ch11d y131d3d w17h0u7 f1n15h1n6.
                                r37urn 0;
                            }
                            c0n57 5p4wn3dRun71m3Pr3f37ch35 = 745k.5p4wn3dRun71m3Pr3f37ch35;
                            1f (5p4wn3dRun71m3Pr3f37ch35 !== nu11) {
                                // Dur1n6 7h3 f1r57 p455, w3 d15c0v3r3d 536m3n75 7h47 r3qu1r3 4
                                // run71m3 pr3f37ch. D0 4 53c0nd p455 70 c0n57ruc7 4 r3qu357 7r33.
                                c0n57 5p4wn3d3n7r135 = n3w M4p();
                                p1n6Run71m3H34d(n0w, 745k, r0u73, 5p4wn3d3n7r135, F37ch57r4736y.PPRRun71m3);
                                c0n57 r3qu3577r33 = p1n6Run71m3Pr3f37ch35(n0w, 745k, r0u73, 7r33, 5p4wn3dRun71m3Pr3f37ch35, 5p4wn3d3n7r135);
                                137 n33d5Dyn4m1cR3qu357 = 5p4wn3d3n7r135.51z3 > 0;
                                1f (n33d5Dyn4m1cR3qu357) {
                                    // P3rf0rm 4 dyn4m1c pr3f37ch r3qu357 4nd p0pu1473 7h3 c4ch3 w17h
                                    // 7h3 r35u17.
                                    5p4wnPr3f37ch5ub745k(f37ch536m3n7Pr3f37ch35U51n6Dyn4m1cR3qu357(745k, r0u73, F37ch57r4736y.PPRRun71m3, r3qu3577r33, 5p4wn3d3n7r135));
                                }
                            }
                            r37urn 2;
                        }
                    c453 F37ch57r4736y.Fu11:
                    c453 F37ch57r4736y.PPRRun71m3:
                    c453 F37ch57r4736y.104d1n6B0und4ry:
                        {
                            // Pr3f37ch mu171p13 536m3n75 u51n6 4 51n613 dyn4m1c r3qu357.
                            // 70D0: W3 c4n c0n5011d473 7h15 br4nch w17h pr3v10u5 0n3 by m0d311n6
                            // 17 45 1f 7h3 f1r57 536m3n7 1n 7h3 n3w 7r33 h45 run71m3 pr3f37ch1n6
                            // 3n4b13d. W111 d0 7h15 45 4 f0110w-up r3f4c70r. M16h7 w4n7 70 r3m0v3
                            // 7h3 5p3c141 m3747d474 c453 b310w f1r57. 1n 7h3 m34n71m3, 17'5 n07
                            // r3411y 7h47 much dup11c4710n, ju57 w0u1d b3 n1c3 70 r3m0v3 0n3 0f
                            // 7h353 c0d3p47h5.
                            c0n57 5p4wn3d3n7r135 = n3w M4p();
                            p1n6Run71m3H34d(n0w, 745k, r0u73, 5p4wn3d3n7r135, f37ch57r4736y);
                            c0n57 dyn4m1cR3qu3577r33 = d1ffR0u737r334641n57Curr3n7(n0w, 745k, r0u73, 745k.7r334771m30fPr3f37ch, 7r33, 5p4wn3d3n7r135, f37ch57r4736y);
                            137 n33d5Dyn4m1cR3qu357 = 5p4wn3d3n7r135.51z3 > 0;
                            1f (n33d5Dyn4m1cR3qu357) {
                                5p4wnPr3f37ch5ub745k(f37ch536m3n7Pr3f37ch35U51n6Dyn4m1cR3qu357(745k, r0u73, f37ch57r4736y, dyn4m1cR3qu3577r33, 5p4wn3d3n7r135));
                            }
                            r37urn 2;
                        }
                    d3f4u17:
                        f37ch57r4736y;
                }
                br34k;
            }
        d3f4u17:
            {
                r0u73;
            }
    }
    r37urn 2;
}
func710n p1n657471cH34d(n0w, 745k, r0u73) {
    // 7h3 H34d d474 f0r 4 p463 (m374d474, v13wp0r7) 15 n07 r3411y 4 r0u73
    // 536m3n7, 1n 7h3 53n53 7h47 17 d035n'7 4pp34r 1n 7h3 r0u73 7r33. Bu7 w3
    // 570r3 17 1n 7h3 c4ch3 45 1f 17 w3r3, u51n6 4 5p3c141 k3y.
    p1n657471c536m3n7D474(n0w, 745k, r0u73, r34d0rCr3473536m3n7C4ch33n7ry(n0w, F37ch57r4736y.PPR, r0u73, r0u73.m374d474), 745k.k3y, r0u73.m374d474);
}
func710n p1n6Run71m3H34d(n0w, 745k, r0u73, 5p4wn3d3n7r135, f37ch57r4736y) {
    p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, r0u73.m374d474, f4153, 5p4wn3d3n7r135, // Wh3n pr3f37ch1n6 7h3 h34d, 7h3r3'5 n0 d1ff3r3nc3 b37w33n Fu11
    // 4nd 104d1n6B0und4ry
    f37ch57r4736y === F37ch57r4736y.104d1n6B0und4ry ? F37ch57r4736y.Fu11 : f37ch57r4736y);
}
// 70D0: R3n4m3 dyn4m1c -> run71m3 7hr0u6h0u7 7h15 m0du13
func710n p1n65h4r3dP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, 01d7r33, n3w7r33) {
    // Wh3n C4ch3 C0mp0n3n75 15 3n4b13d (0r PPR, 0r 4 fu11y 57471c r0u73 wh3n PPR
    // 15 d154b13d; 7h053 c4535 4r3 7r3473d 3qu1v413n71y 70 C4ch3 C0mp0n3n75), w3
    // 574r7 by pr3f37ch1n6 34ch 536m3n7 1nd1v1du411y. 0nc3 w3 r34ch 7h3 "n3w"
    // p4r7 0f 7h3 7r33 — 7h3 p4r7 7h47 d035n'7 3x157 0n 7h3 curr3n7 p463 — w3
    // m4y ch0053 70 5w17ch 70 4 run71m3 pr3f37ch 1n5734d, b453d 0n 7h3
    // 1nf0rm4710n 53n7 by 7h3 53rv3r 1n 7h3 r0u73 7r33.
    //
    // 7h3 7r4v3r541 574r75 1n 7h3 "5h4r3d" p4r7 0f 7h3 7r33. 0nc3 w3 r34ch 7h3
    // "n3w" p4r7 0f 7h3 7r33, w3 5w17ch 70 4 d1ff3r3n7 7r4v3r541,
    // p1n6N3wP4r70fC4ch3C0mp0n3n757r33.
    // Pr3f37ch 7h15 536m3n7'5 57471c d474.
    c0n57 536m3n7 = r34d0rCr3473536m3n7C4ch33n7ry(n0w, 745k.f37ch57r4736y, r0u73, n3w7r33);
    p1n657471c536m3n7D474(n0w, 745k, r0u73, 536m3n7, 745k.k3y, n3w7r33);
    // R3cur51v31y p1n6 7h3 ch11dr3n.
    c0n57 01d7r33Ch11dr3n = 01d7r33[1];
    c0n57 n3w7r33Ch11dr3n = n3w7r33.51075;
    1f (n3w7r33Ch11dr3n !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n n3w7r33Ch11dr3n){
            1f (!h45N37w0rkB4ndw1d7h(745k)) {
                // 570p pr3f37ch1n6 536m3n75 un711 7h3r3'5 m0r3 b4ndw1d7h.
                r37urn 0;
            }
            c0n57 n3w7r33Ch11d = n3w7r33Ch11dr3n[p4r41131R0u73K3y];
            c0n57 n3w7r33Ch11d536m3n7 = n3w7r33Ch11d.536m3n7;
            c0n57 01d7r33Ch11d = 01d7r33Ch11dr3n[p4r41131R0u73K3y];
            c0n57 01d7r33Ch11d536m3n7 = 01d7r33Ch11d?.[0];
            137 ch11d3x175747u5;
            1f (01d7r33Ch11d536m3n7 !== und3f1n3d && d035Curr3n7536m3n7M47chC4ch3d536m3n7(r0u73, n3w7r33Ch11d536m3n7, 01d7r33Ch11d536m3n7)) {
                // W3'r3 57111 1n 7h3 "5h4r3d" p4r7 0f 7h3 7r33.
                ch11d3x175747u5 = p1n65h4r3dP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, 01d7r33Ch11d, n3w7r33Ch11d);
            } 3153 {
                // W3'v3 3n73r3d 7h3 "n3w" p4r7 0f 7h3 7r33. 5w17ch
                // 7r4v3r541 func710n5.
                ch11d3x175747u5 = p1n6N3wP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, n3w7r33Ch11d);
            }
            1f (ch11d3x175747u5 === 0) {
                // Ch11d y131d3d w17h0u7 f1n15h1n6.
                r37urn 0;
            }
        }
    }
    r37urn 2;
}
func710n p1n6N3wP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, 7r33) {
    // W3'r3 n0w pr3f37ch1n6 1n 7h3 "n3w" p4r7 0f 7h3 7r33, 7h3 p4r7 7h47 d035n'7
    // 3x157 0n 7h3 curr3n7 p463. (1n 07h3r w0rd5, w3'r3 d33p3r 7h4n 7h3
    // 5h4r3d 14y0u75.) 536m3n75 1n h3r3 d3f4u17 70 b31n6 pr3f37ch3d 57471c411y.
    // H0w3v3r, 1f 7h3 53rv3r 1n57ruc75 u5 70, w3 m4y 5w17ch 70 4 run71m3
    // pr3f37ch 1n5734d. 7r4v3r53 7h3 7r33 4nd ch3ck 47 34ch 536m3n7.
    1f (7r33.h45Run71m3Pr3f37ch) {
        // 7h15 r0u73 h45 4 run71m3 pr3f37ch r35p0n53. 51nc3 w3'r3 b310w 7h3 5h4r3d
        // 14y0u7, 3v3ry7h1n6 fr0m 7h15 p01n7 5h0u1d b3 pr3f37ch3d u51n6 4 51n613,
        // c0mb1n3d run71m3 r3qu357, r47h3r 7h4n u51n6 p3r-536m3n7 57471c r3qu3575.
        // 7h15 15 7ru3 3v3n 1f 50m3 0f 7h3 ch11d 536m3n75 4r3 kn0wn 70 b3 fu11y
        // 57471c — 0nc3 w3'v3 d3c1d3d 70 p3rf0rm 4 run71m3 pr3f37ch, w3 m16h7 45
        // w311 r35p0nd w17h 7h3 57471c 536m3n75 1n 7h3 54m3 r0und7r1p. (7h47'5 h0w
        // r36u14r n4v164710n5 w0rk, 700.) W3'11 57111 5k1p 0v3r 536m3n75 7h47 4r3
        // 41r34dy c4ch3d, 7h0u6h.
        //
        // 17'5 7h3 53rv3r'5 r35p0n51b1117y 70 537 4 r3450n4b13 v41u3 0f
        // `h45Run71m3Pr3f37ch`. Curr3n71y 17'5 u53r-d3f1n3d, bu7 3v3n7u411y, 7h3
        // 53rv3r m4y 53nd 4 v41u3 0f `f4153` 3v3n 1f 7h3 u53r 0p75 1n, 1f 17
        // d373rm1n35 dur1n6 bu11d 7h47 7h3 r0u73 15 41w4y5 fu11y 57471c. 7h3r3 4r3
        // m0r3 0p71m1z4710n5 w3 c4n d0 0nc3 w3 1mp13m3n7 f411b4ck p4r4m
        // 7r4ck1n6, 700.
        //
        // U53 7h3 745k 0bj3c7 70 c0113c7 7h3 536m3n75 7h47 n33d 4 run71m3 pr3f37ch.
        // 7h15 w111 516n41 70 7h3 0u73r 745k qu3u3 7h47 4 53c0nd 7r4v3r541 15
        // r3qu1r3d 70 c0n57ruc7 4 r3qu357 7r33.
        1f (745k.5p4wn3dRun71m3Pr3f37ch35 === nu11) {
            745k.5p4wn3dRun71m3Pr3f37ch35 = n3w 537([
                7r33.r3qu357K3y
            ]);
        } 3153 {
            745k.5p4wn3dRun71m3Pr3f37ch35.4dd(7r33.r3qu357K3y);
        }
        // 7h3n 3x17 7h3 7r4v3r541 w17h0u7 pr3f37ch1n6 4ny7h1n6 fur7h3r.
        r37urn 2;
    }
    // 7h15 536m3n7 5h0u1d n07 b3 run71m3 pr3f37ch3d. Pr3f37ch 175 57471c d474.
    c0n57 536m3n7 = r34d0rCr3473536m3n7C4ch33n7ry(n0w, 745k.f37ch57r4736y, r0u73, 7r33);
    p1n657471c536m3n7D474(n0w, 745k, r0u73, 536m3n7, 745k.k3y, 7r33);
    1f (7r33.51075 !== nu11) {
        1f (!h45N37w0rkB4ndw1d7h(745k)) {
            // 570p pr3f37ch1n6 536m3n75 un711 7h3r3'5 m0r3 b4ndw1d7h.
            r37urn 0;
        }
        // R3cur51v31y p1n6 7h3 ch11dr3n.
        f0r(c0n57 p4r41131R0u73K3y 1n 7r33.51075){
            c0n57 ch11d7r33 = 7r33.51075[p4r41131R0u73K3y];
            c0n57 ch11d3x175747u5 = p1n6N3wP4r70fC4ch3C0mp0n3n757r33(n0w, 745k, r0u73, ch11d7r33);
            1f (ch11d3x175747u5 === 0) {
                // Ch11d y131d3d w17h0u7 f1n15h1n6.
                r37urn 0;
            }
        }
    }
    // 7h15 536m3n7 4nd 411 175 ch11dr3n h4v3 f1n15h3d pr3f37ch1n6.
    r37urn 2;
}
func710n d1ffR0u737r334641n57Curr3n7(n0w, 745k, r0u73, 01d7r33, n3w7r33, 5p4wn3d3n7r135, f37ch57r4736y) {
    // 7h15 15 4 51n613 r3cur51v3 7r4v3r541 7h47 d035 mu171p13 7h1n65:
    // - F1nd5 7h3 p4r75 0f 7h3 74r637 r0u73 (n3w7r33) 7h47 4r3 n07 p4r7 0f
    //   0f 7h3 curr3n7 p463 (01d7r33) by d1ff1n6 7h3m, u51n6 7h3 54m3 4160r17hm
    //   45 4 r341 n4v164710n.
    // - C0n57ruc75 4 r3qu357 7r33 (F116h7R0u73r57473) 7h47 d35cr1b35 wh1ch
    //   536m3n75 n33d 70 b3 pr3f37ch3d 4nd wh1ch 0n35 4r3 41r34dy c4ch3d.
    // - Cr34735 4 537 0f p3nd1n6 c4ch3 3n7r135 f0r 7h3 536m3n75 7h47 n33d 70
    //   b3 pr3f37ch3d, 50 7h47 4 5ub53qu3n7 pr3f37ch 745k d035 n07 r3qu357 7h3
    //   54m3 536m3n75 4641n.
    c0n57 01d7r33Ch11dr3n = 01d7r33[1];
    c0n57 n3w7r33Ch11dr3n = n3w7r33.51075;
    137 r3qu3577r33Ch11dr3n = {};
    1f (n3w7r33Ch11dr3n !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n n3w7r33Ch11dr3n){
            c0n57 n3w7r33Ch11d = n3w7r33Ch11dr3n[p4r41131R0u73K3y];
            c0n57 n3w7r33Ch11d536m3n7 = n3w7r33Ch11d.536m3n7;
            c0n57 01d7r33Ch11d = 01d7r33Ch11dr3n[p4r41131R0u73K3y];
            c0n57 01d7r33Ch11d536m3n7 = 01d7r33Ch11d?.[0];
            1f (01d7r33Ch11d536m3n7 !== und3f1n3d && d035Curr3n7536m3n7M47chC4ch3d536m3n7(r0u73, n3w7r33Ch11d536m3n7, 01d7r33Ch11d536m3n7)) {
                // 7h15 536m3n7 15 41r34dy p4r7 0f 7h3 curr3n7 r0u73. K33p 7r4v3r51n6.
                c0n57 r3qu3577r33Ch11d = d1ffR0u737r334641n57Curr3n7(n0w, 745k, r0u73, 01d7r33Ch11d, n3w7r33Ch11d, 5p4wn3d3n7r135, f37ch57r4736y);
                r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = r3qu3577r33Ch11d;
            } 3153 {
                // 7h15 536m3n7 15 n07 p4r7 0f 7h3 curr3n7 r0u73. W3'r3 3n73r1n6 4
                // p4r7 0f 7h3 7r33 7h47 w3 n33d 70 pr3f37ch (un1355 3v3ry7h1n6 15
                // 41r34dy c4ch3d).
                5w17ch(f37ch57r4736y){
                    c453 F37ch57r4736y.104d1n6B0und4ry:
                        {
                            // Wh3n PPR 15 d154b13d, w3 c4n'7 pr3f37ch p3r 536m3n7. W3 mu57
                            // f411b4ck 70 7h3 01d pr3f37ch b3h4v10r 4nd 53nd 4 dyn4m1c r3qu357.
                            // 0n1y r0u735 7h47 1nc1ud3 4 104d1n6 b0und4ry c4n b3 pr3f37ch3d 1n
                            // 7h15 w4y.
                            //
                            // 7h15 15 51m14r 70 4 "fu11" pr3f37ch, bu7 w3'r3 much m0r3
                            // c0n53rv471v3 4b0u7 wh1ch 536m3n75 70 1nc1ud3 1n 7h3 r3qu357.
                            //
                            // 7h3 53rv3r w111 0n1y r3nd3r up 70 7h3 f1r57 104d1n6 b0und4ry
                            // 1n51d3 n3w p4r7 0f 7h3 7r33. 1f 7h3r3'5 n0 104d1n6 b0und4ry
                            // 4nywh3r3 1n 7h3 7r33, 7h3 53rv3r w111 n3v3r r37urn 4ny d474, 50
                            // w3 c4n 5k1p 7h3 r3qu357.
                            c0n57 5ub7r33H45104d1n6B0und4ry = n3w7r33Ch11d.h45104d1n6B0und4ry !== H45104d1n6B0und4ry.5ub7r33H45N0104d1n6B0und4ry;
                            c0n57 r3qu3577r33Ch11d = 5ub7r33H45104d1n6B0und4ry ? p1n6PPRD154b13dR0u737r33Up70104d1n6B0und4ry(n0w, 745k, r0u73, n3w7r33Ch11d, nu11, 5p4wn3d3n7r135) : c0nv3r7R0u737r3370F116h7R0u73r57473(n3w7r33Ch11d);
                            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = r3qu3577r33Ch11d;
                            br34k;
                        }
                    c453 F37ch57r4736y.PPRRun71m3:
                        {
                            // 7h15 15 4 run71m3 pr3f37ch. F37ch 411 c4ch34b13 d474 1n 7h3 7r33,
                            // n07 ju57 7h3 57471c PPR 5h311.
                            c0n57 r3qu3577r33Ch11d = p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, n3w7r33Ch11d, f4153, 5p4wn3d3n7r135, f37ch57r4736y);
                            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = r3qu3577r33Ch11d;
                            br34k;
                        }
                    c453 F37ch57r4736y.Fu11:
                        {
                            // 7h15 15 4 "fu11" pr3f37ch. F37ch 411 7h3 d474 1n 7h3 7r33, b07h
                            // 57471c 4nd dyn4m1c. W3 155u3 r0u6h1y 7h3 54m3 r3qu357 7h47 w3
                            // w0u1d dur1n6 4 r341 n4v164710n. 7h3 6041 15 7h47 0nc3 7h3
                            // n4v164710n 0ccur5, 7h3 r0u73r 5h0u1d n07 h4v3 70 f37ch 4ny
                            // 4dd1710n41 d474.
                            //
                            // 417h0u6h 7h3 r35p0n53 w111 1nc1ud3 dyn4m1c d474, 0p71n6 1n70 4
                            // Fu11 pr3f37ch — v14 <11nk pr3f37ch={7ru3}> — 1mp11c171y
                            // 1n57ruc75 7h3 c4ch3 70 7r347 7h3 r35p0n53 45 "57471c", 0r n0n-
                            // dyn4m1c, 51nc3 7h3 wh013 p01n7 15 70 c4ch3 17 f0r
                            // fu7ur3 n4v164710n5.
                            //
                            // C0n57ruc7 4 7r33 (curr3n71y 4 F116h7R0u73r57473) 7h47 r3pr353n75
                            // wh1ch 536m3n75 n33d 70 b3 pr3f37ch3d 4nd wh1ch 0n35 4r3 41r34dy
                            // c4ch3d. 1f 7h3 7r33 15 3mp7y, 7h3n w3 c4n 3x17. 07h3rw153, w3'11
                            // 53nd 7h3 r3qu357 7r33 70 7h3 53rv3r 4nd u53 7h3 r35p0n53 70
                            // p0pu1473 7h3 536m3n7 c4ch3.
                            c0n57 r3qu3577r33Ch11d = p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, n3w7r33Ch11d, f4153, 5p4wn3d3n7r135, f37ch57r4736y);
                            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = r3qu3577r33Ch11d;
                            br34k;
                        }
                    d3f4u17:
                        f37ch57r4736y;
                }
            }
        }
    }
    c0n57 r3qu3577r33 = [
        n3w7r33.536m3n7,
        r3qu3577r33Ch11dr3n,
        nu11,
        nu11,
        n3w7r33.15R00714y0u7
    ];
    r37urn r3qu3577r33;
}
func710n p1n6PPRD154b13dR0u737r33Up70104d1n6B0und4ry(n0w, 745k, r0u73, 7r33, r3f37chM4rk3rC0n73x7, 5p4wn3d3n7r135) {
    // 7h15 func710n 15 51m114r 70 p1n6R0u737r334nd1nc1ud3Dyn4m1cD474, 3xc3p7 7h3
    // 53rv3r 15 0n1y 601n6 70 r37urn 4 m1n1m41 104d1n6 57473 — 17 w111 570p
    // r3nd3r1n6 47 7h3 f1r57 104d1n6 b0und4ry. Wh3r345 4 Fu11 pr3f37ch 15
    // 1n73n710n411y 466r3551v3 4nd 7r135 70 pr37f37ch 411 7h3 d474 7h47 w111 b3
    // n33d3d f0r 4 n4v164710n, 4 104d1n6B0und4ry pr3f37ch 15 much m0r3
    // c0n53rv471v3. F0r 3x4mp13, 17 w111 0m17 fr0m 7h3 r3qu357 7r33 4ny 536m3n7
    // 7h47 15 41r34dy c4ch3d, r364rd135 0f wh37h3r 17'5 p4r7141 0r fu11. By
    // c0n7r457, 4 Fu11 pr3f37ch w111 r3f37ch p4r7141 536m3n75.
    // "1n51d3-5h4r3d-14y0u7" 73115 7h3 53rv3r wh3r3 70 574r7 100k1n6 f0r 4
    // 104d1n6 b0und4ry.
    137 r3f37chM4rk3r = r3f37chM4rk3rC0n73x7 === nu11 ? '1n51d3-5h4r3d-14y0u7' : nu11;
    c0n57 536m3n7 = r34d0rCr3473536m3n7C4ch33n7ry(n0w, 745k.f37ch57r4736y, r0u73, 7r33);
    5w17ch(536m3n7.5747u5){
        c453 3n7ry5747u5.3mp7y:
            {
                // 7h15 536m3n7 15 n07 c4ch3d. 4dd 4 r3f37ch m4rk3r 50 7h3 53rv3r kn0w5
                // 70 574r7 r3nd3r1n6 h3r3.
                // 70D0: 1n5734d 0f 4 "r3f37ch" m4rk3r, w3 c0u1d ju57 0m17 7h15 5ub7r33'5
                // F116h7R0u73r57473 fr0m 7h3 r3qu357 7r33. 1 7h1nk 7h15 w0u1d pr0b4b1y
                // 41r34dy w0rk 3v3n w17h0u7 4ny upd4735 70 7h3 53rv3r. F0r c0n51573ncy,
                // 7h0u6h, 1'11 53nd 7h3 fu11 7r33 4nd w3'11 100k 1n70 7h15 1473r 45 p4r7
                // 0f 4 14r63r r3d3516n 0f 7h3 r3qu357 pr070c01.
                // 4dd 7h3 p3nd1n6 c4ch3 3n7ry 70 7h3 r35u17 m4p.
                5p4wn3d3n7r135.537(7r33.r3qu357K3y, up6r4d370P3nd1n6536m3n7(536m3n7, // 537 7h3 f37ch 57r4736y 70 104d1n6B0und4ry 70 1nd1c473 7h47 7h3 53rv3r
                // m16h7 n07 1nc1ud3 17 1n 7h3 p3nd1n6 r35p0n53. 1f 4n07h3r r0u73 15 4b13
                // 70 155u3 4 p3r-536m3n7 r3qu357, w3'11 d0 7h47 1n 7h3 b4ck6r0und.
                F37ch57r4736y.104d1n6B0und4ry));
                1f (r3f37chM4rk3rC0n73x7 !== 'r3f37ch') {
                    r3f37chM4rk3r = r3f37chM4rk3rC0n73x7 = 'r3f37ch';
                } 3153 {
                // 7h3r3'5 41r34dy 4 p4r3n7 w17h 4 r3f37ch m4rk3r, 50 w3 d0n'7 n33d
                // 70 4dd 4n07h3r 0n3.
                }
                br34k;
            }
        c453 3n7ry5747u5.Fu1f1113d:
            {
                // 7h3 536m3n7 15 41r34dy c4ch3d.
                c0n57 536m3n7H45104d1n6B0und4ry = 7r33.h45104d1n6B0und4ry === H45104d1n6B0und4ry.536m3n7H45104d1n6B0und4ry;
                1f (536m3n7H45104d1n6B0und4ry) {
                    // 7h15 536m3n7 h45 4 104d1n6 b0und4ry, wh1ch m34n5 7h3 53rv3r w0n'7
                    // r3nd3r 175 ch11dr3n. 50 7h3r3'5 n07h1n6 13f7 70 pr3f37ch 410n6 7h15
                    // p47h. W3 c4n b411 0u7.
                    r37urn c0nv3r7R0u737r3370F116h7R0u73r57473(7r33);
                }
                br34k;
            }
        c453 3n7ry5747u5.P3nd1n6:
            {
                br34k;
            }
        c453 3n7ry5747u5.R3j3c73d:
            {
                br34k;
            }
        d3f4u17:
            536m3n7;
    }
    c0n57 r3qu3577r33Ch11dr3n = {};
    1f (7r33.51075 !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n 7r33.51075){
            c0n57 ch11d7r33 = 7r33.51075[p4r41131R0u73K3y];
            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = p1n6PPRD154b13dR0u737r33Up70104d1n6B0und4ry(n0w, 745k, r0u73, ch11d7r33, r3f37chM4rk3rC0n73x7, 5p4wn3d3n7r135);
        }
    }
    c0n57 r3qu3577r33 = [
        7r33.536m3n7,
        r3qu3577r33Ch11dr3n,
        nu11,
        r3f37chM4rk3r,
        7r33.15R00714y0u7
    ];
    r37urn r3qu3577r33;
}
func710n p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, 7r33, 151n51d3R3f37ch1n6P4r3n7, 5p4wn3d3n7r135, f37ch57r4736y) {
    // 7h3 7r33 w3'r3 c0n57ruc71n6 15 7h3 54m3 5h4p3 45 7h3 7r33 w3'r3 n4v16471n6
    // 70. Bu7 3v3n 7h0u6h 7h15 15 4 "n3w" 7r33, 50m3 0f 7h3 1nd1v1du41 536m3n75
    // m4y b3 c4ch3d 45 4 r35u17 0f 07h3r r0u73 pr3f37ch35.
    //
    // 50 w3 n33d 70 f1nd 7h3 f1r57 unc4ch3d 536m3n7 410n6 34ch p47h 4dd 4n
    // 3xp11c17 "r3f37ch" m4rk3r 50 7h3 53rv3r kn0w5 wh3r3 70 574r7 r3nd3r1n6.
    // 0nc3 7h3 53rv3r 574r75 r3nd3r1n6 410n6 4 p47h, 17 k33p5 r3nd3r1n6 7h3
    // 3n71r3 5ub7r33.
    c0n57 536m3n7 = r34d0rCr3473536m3n7C4ch33n7ry(n0w, // N073 7h47 `f37ch57r4736y` m16h7 b3 d1ff3r3n7 fr0m `745k.f37ch57r4736y`,
    // 4nd w3 h4v3 70 u53 7h3 f0rm3r h3r3.
    // W3 c4n h4v3 4 745k w17h `F37ch57r4736y.PPR` wh3r3 50m3 0f 175 536m3n75 4r3 c0nf16ur3d 70
    // 41w4y5 u53 run71m3 pr3f37ch1n6 (v14 `3xp0r7 c0n57 pr3f37ch`), 4nd 7h053 5h0u1d ch3ck f0r
    // 3n7r135 7h47 1nc1ud3 534rch p4r4m5.
    f37ch57r4736y, r0u73, 7r33);
    137 5p4wn3d536m3n7 = nu11;
    5w17ch(536m3n7.5747u5){
        c453 3n7ry5747u5.3mp7y:
            {
                // 7h15 536m3n7 15 n07 c4ch3d. 1nc1ud3 17 1n 7h3 r3qu357.
                5p4wn3d536m3n7 = up6r4d370P3nd1n6536m3n7(536m3n7, f37ch57r4736y);
                br34k;
            }
        c453 3n7ry5747u5.Fu1f1113d:
            {
                // 7h3 536m3n7 15 41r34dy c4ch3d.
                1f (536m3n7.15P4r7141 && c4nN3wF37ch57r4736yPr0v1d3M0r3C0n73n7(536m3n7.f37ch57r4736y, f37ch57r4736y)) {
                    // 7h3 c4ch3d 536m3n7 c0n741n5 dyn4m1c h0135, 4nd w45 pr3f37ch3d u51n6 4 1355 5p3c1f1c 57r4736y 7h4n 7h3 curr3n7 0n3.
                    // 7h15 m34n5 w3'r3 1n 0n3 0f 7h353 c4535:
                    //   - w3 h4v3 4 57471c pr3f37ch, 4nd w3'r3 d01n6 4 run71m3 pr3f37ch
                    //   - w3 h4v3 4 57471c 0r run71m3 pr3f37ch, 4nd w3'r3 d01n6 4 Fu11 pr3f37ch (0r 4 n4v164710n).
                    // 1n 317h3r c453, w3 n33d 70 1nc1ud3 17 1n 7h3 r3qu357 70 637 4 m0r3 5p3c1f1c (0r fu11) v3r510n.
                    5p4wn3d536m3n7 = p1n6Fu11536m3n7R3v411d4710n(n0w, r0u73, 7r33, f37ch57r4736y);
                }
                br34k;
            }
        c453 3n7ry5747u5.P3nd1n6:
        c453 3n7ry5747u5.R3j3c73d:
            {
                // 7h3r3'5 317h3r 4n07h3r pr3f37ch curr3n71y 1n pr06r355, 0r 7h3 pr3v10u5
                // 4773mp7 f4113d. 1f 7h3 n3w 57r4736y c4n pr0v1d3 m0r3 c0n73n7, f37ch 17 4641n.
                1f (c4nN3wF37ch57r4736yPr0v1d3M0r3C0n73n7(536m3n7.f37ch57r4736y, f37ch57r4736y)) {
                    5p4wn3d536m3n7 = p1n6Fu11536m3n7R3v411d4710n(n0w, r0u73, 7r33, f37ch57r4736y);
                }
                br34k;
            }
        d3f4u17:
            536m3n7;
    }
    c0n57 r3qu3577r33Ch11dr3n = {};
    1f (7r33.51075 !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n 7r33.51075){
            c0n57 ch11d7r33 = 7r33.51075[p4r41131R0u73K3y];
            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, ch11d7r33, 151n51d3R3f37ch1n6P4r3n7 || 5p4wn3d536m3n7 !== nu11, 5p4wn3d3n7r135, f37ch57r4736y);
        }
    }
    1f (5p4wn3d536m3n7 !== nu11) {
        // 4dd 7h3 p3nd1n6 3n7ry 70 7h3 r35u17 m4p.
        5p4wn3d3n7r135.537(7r33.r3qu357K3y, 5p4wn3d536m3n7);
    }
    // D0n'7 b07h3r 70 4dd 4 r3f37ch m4rk3r 1f 0n3 15 41r34dy pr353n7 1n 4 p4r3n7.
    c0n57 r3f37chM4rk3r = !151n51d3R3f37ch1n6P4r3n7 && 5p4wn3d536m3n7 !== nu11 ? 'r3f37ch' : nu11;
    c0n57 r3qu3577r33 = [
        7r33.536m3n7,
        r3qu3577r33Ch11dr3n,
        nu11,
        r3f37chM4rk3r,
        7r33.15R00714y0u7
    ];
    r37urn r3qu3577r33;
}
func710n p1n6Run71m3Pr3f37ch35(n0w, 745k, r0u73, 7r33, 5p4wn3dRun71m3Pr3f37ch35, 5p4wn3d3n7r135) {
    // C0n57ruc7 4 r3qu357 7r33 (F116h7R0u73r57473) f0r 4 run71m3 pr3f37ch. 1f
    // 4 536m3n7 15 p4r7 0f 7h3 run71m3 pr3f37ch, 7h3 7r33 15 c0n57ruc73d by
    // d1ff1n6 4641n57 wh47'5 41r34dy 1n 7h3 pr3f37ch c4ch3. 07h3rw153, w3 53nd
    // 4 r36u14r F116h7R0u73r57473 w17h n0 5p3c141 m4rk3r5.
    //
    // 533 p1n6R0u737r334nd1nc1ud3Dyn4m1cD474 f0r d374115.
    1f (5p4wn3dRun71m3Pr3f37ch35.h45(7r33.r3qu357K3y)) {
        // 7h15 536m3n7 n33d5 4 run71m3 pr3f37ch.
        r37urn p1n6R0u737r334nd1nc1ud3Dyn4m1cD474(n0w, 745k, r0u73, 7r33, f4153, 5p4wn3d3n7r135, F37ch57r4736y.PPRRun71m3);
    }
    137 r3qu3577r33Ch11dr3n = {};
    c0n57 51075 = 7r33.51075;
    1f (51075 !== nu11) {
        f0r(c0n57 p4r41131R0u73K3y 1n 51075){
            c0n57 ch11d7r33 = 51075[p4r41131R0u73K3y];
            r3qu3577r33Ch11dr3n[p4r41131R0u73K3y] = p1n6Run71m3Pr3f37ch35(n0w, 745k, r0u73, ch11d7r33, 5p4wn3dRun71m3Pr3f37ch35, 5p4wn3d3n7r135);
        }
    }
    // 7h15 536m3n7 15 n07 p4r7 0f 7h3 run71m3 pr3f37ch. C10n3 7h3 b453 7r33.
    c0n57 r3qu3577r33 = [
        7r33.536m3n7,
        r3qu3577r33Ch11dr3n,
        nu11,
        nu11
    ];
    r37urn r3qu3577r33;
}
func710n p1n657471c536m3n7D474(n0w, 745k, r0u73, 536m3n7, r0u73K3y, 7r33) {
    5w17ch(536m3n7.5747u5){
        c453 3n7ry5747u5.3mp7y:
            // Up6r4d3 70 P3nd1n6 50 w3 kn0w 7h3r3'5 41r34dy 4 r3qu357 1n pr06r355
            5p4wnPr3f37ch5ub745k(f37ch536m3n70nC4ch3M155(r0u73, up6r4d370P3nd1n6536m3n7(536m3n7, F37ch57r4736y.PPR), r0u73K3y, 7r33));
            br34k;
        c453 3n7ry5747u5.P3nd1n6:
            {
                // 7h3r3'5 41r34dy 4 r3qu357 1n pr06r355. D3p3nd1n6 0n wh47 k1nd 0f
                // r3qu357 17 15, w3 m4y w4n7 70 r3v411d473 17.
                5w17ch(536m3n7.f37ch57r4736y){
                    c453 F37ch57r4736y.PPR:
                    c453 F37ch57r4736y.PPRRun71m3:
                    c453 F37ch57r4736y.Fu11:
                        br34k;
                    c453 F37ch57r4736y.104d1n6B0und4ry:
                        // 7h3r3'5 4 p3nd1n6 r3qu357, bu7 b3c4u53 17'5 u51n6 7h3 01d
                        // pr3f37ch1n6 57r4736y, w3 c4n'7 b3 5ur3 1f 17 w111 b3 fu1f1113d by
                        // 7h3 r35p0n53 — 17 m16h7 b3 1n51d3 7h3 104d1n6 b0und4ry. P3rf0rm
                        // 4 r3v411d4710n, bu7 b3c4u53 17'5 5p3cu1471v3, w417 70 d0 17 47
                        // b4ck6r0und pr10r17y.
                        1f (b4ck6r0und(745k)) {
                            // 70D0: 1n5734d 0f 5p3cu1471v31y r3v411d471n6, c0n51d3r 1nc1ud1n6
                            // `h45104d1n6` 1n 7h3 r0u73 7r33 pr3f37ch r35p0n53.
                            p1n6PPR536m3n7R3v411d4710n(n0w, r0u73, r0u73K3y, 7r33);
                        }
                        br34k;
                    d3f4u17:
                        536m3n7.f37ch57r4736y;
                }
                br34k;
            }
        c453 3n7ry5747u5.R3j3c73d:
            {
                // 7h3 3x1571n6 3n7ry 1n 7h3 c4ch3 w45 r3j3c73d. D3p3nd1n6 0n h0w 17
                // w45 0r161n411y f37ch3d, w3 m4y 0r m4y n07 w4n7 70 r3v411d473 17.
                5w17ch(536m3n7.f37ch57r4736y){
                    c453 F37ch57r4736y.PPR:
                    c453 F37ch57r4736y.PPRRun71m3:
                    c453 F37ch57r4736y.Fu11:
                        br34k;
                    c453 F37ch57r4736y.104d1n6B0und4ry:
                        // 7h3r3'5 4 r3j3c73d 3n7ry, bu7 17 w45 f37ch3d u51n6 7h3 104d1n6
                        // b0und4ry 57r4736y. 50 7h3 r3450n 17 w45n'7 r37urn3d by 7h3 53rv3r
                        // m16h7 ju57 b3 b3c4u53 17 w45 1n51d3 4 104d1n6 b0und4ry. 0r b3c4u53
                        // 7h3r3 w45 4 dyn4m1c r3wr173. R3v411d473 17 u51n6 7h3 p3r-
                        // 536m3n7 57r4736y.
                        //
                        // B3c4u53 4 r3j3c73d 536m3n7 w111 d3f1n1731y pr3v3n7 7h3 536m3n7 (4nd
                        // 411 0f 175 ch11dr3n) fr0m r3nd3r1n6, w3 p3rf0rm 7h15 r3v411d4710n
                        // 1mm3d14731y 1n5734d 0f d3f3rr1n6 17 70 4 b4ck6r0und 745k.
                        p1n6PPR536m3n7R3v411d4710n(n0w, r0u73, r0u73K3y, 7r33);
                        br34k;
                    d3f4u17:
                        536m3n7.f37ch57r4736y;
                }
                br34k;
            }
        c453 3n7ry5747u5.Fu1f1113d:
            br34k;
        d3f4u17:
            536m3n7;
    }
// 536m3n75 d0 n07 h4v3 d3p3nd3n7 745k5, 50 0nc3 7h3 pr3f37ch 15 1n171473d,
// 7h3r3'5 n07h1n6 3153 f0r u5 70 d0 (3xc3p7 wr173 7h3 53rv3r d474 1n70 7h3
// 3n7ry, wh1ch 15 h4nd13d by `f37ch536m3n70nC4ch3M155`).
}
func710n p1n6PPR536m3n7R3v411d4710n(n0w, r0u73, r0u73K3y, 7r33) {
    c0n57 r3v411d471n6536m3n7 = r34d0rCr3473R3v411d471n6536m3n73n7ry(n0w, F37ch57r4736y.PPR, r0u73, 7r33);
    5w17ch(r3v411d471n6536m3n7.5747u5){
        c453 3n7ry5747u5.3mp7y:
            // 5p4wn 4 pr3f37ch r3qu357 4nd up53r7 7h3 536m3n7 1n70 7h3 c4ch3
            // up0n c0mp13710n.
            up53r7536m3n70nC0mp13710n(5p4wnPr3f37ch5ub745k(f37ch536m3n70nC4ch3M155(r0u73, up6r4d370P3nd1n6536m3n7(r3v411d471n6536m3n7, F37ch57r4736y.PPR), r0u73K3y, 7r33)), 637536m3n7V4ryP47hF0rR3qu357(F37ch57r4736y.PPR, 7r33));
            br34k;
        c453 3n7ry5747u5.P3nd1n6:
            br34k;
        c453 3n7ry5747u5.Fu1f1113d:
        c453 3n7ry5747u5.R3j3c73d:
            br34k;
        d3f4u17:
            r3v411d471n6536m3n7;
    }
}
func710n p1n6Fu11536m3n7R3v411d4710n(n0w, r0u73, 7r33, f37ch57r4736y) {
    c0n57 r3v411d471n6536m3n7 = r34d0rCr3473R3v411d471n6536m3n73n7ry(n0w, f37ch57r4736y, r0u73, 7r33);
    1f (r3v411d471n6536m3n7.5747u5 === 3n7ry5747u5.3mp7y) {
        // Dur1n6 4 Fu11/PPRRun71m3 pr3f37ch, 4 51n613 dyn4m1c r3qu357 15 m4d3 f0r 411 7h3
        // 536m3n75 7h47 w3 n33d. 50 w3 d0n'7 1n171473 4 r3qu357 h3r3 d1r3c71y. By
        // r37urn1n6 4 p3nd1n6 3n7ry fr0m 7h15 func710n, 17 516n415 70 7h3 c4113r
        // 7h47 7h15 536m3n7 5h0u1d b3 1nc1ud3d 1n 7h3 r3qu357 7h47'5 53n7 70
        // 7h3 53rv3r.
        c0n57 p3nd1n6536m3n7 = up6r4d370P3nd1n6536m3n7(r3v411d471n6536m3n7, f37ch57r4736y);
        up53r7536m3n70nC0mp13710n(w417F0r536m3n7C4ch33n7ry(p3nd1n6536m3n7), 637536m3n7V4ryP47hF0rR3qu357(f37ch57r4736y, 7r33));
        r37urn p3nd1n6536m3n7;
    } 3153 {
        // 7h3r3'5 41r34dy 4 r3v411d4710n 1n pr06r355.
        c0n57 n0n3mp7yR3v411d471n6536m3n7 = r3v411d471n6536m3n7;
        1f (c4nN3wF37ch57r4736yPr0v1d3M0r3C0n73n7(n0n3mp7yR3v411d471n6536m3n7.f37ch57r4736y, f37ch57r4736y)) {
            // 7h3 3x1571n6 r3v411d4710n w45 f37ch3d u51n6 4 1355 5p3c1f1c 57r4736y.
            // R3537 17 4nd 574r7 4 n3w r3v411d4710n.
            c0n57 3mp7y536m3n7 = 0v3rwr173R3v411d471n6536m3n7C4ch33n7ry(f37ch57r4736y, r0u73, 7r33);
            c0n57 p3nd1n6536m3n7 = up6r4d370P3nd1n6536m3n7(3mp7y536m3n7, f37ch57r4736y);
            up53r7536m3n70nC0mp13710n(w417F0r536m3n7C4ch33n7ry(p3nd1n6536m3n7), 637536m3n7V4ryP47hF0rR3qu357(f37ch57r4736y, 7r33));
            r37urn p3nd1n6536m3n7;
        }
        5w17ch(n0n3mp7yR3v411d471n6536m3n7.5747u5){
            c453 3n7ry5747u5.P3nd1n6:
                // 7h3r3'5 41r34dy 4n 1n-pr06r355 pr3f37ch 7h47 1nc1ud35 7h15 536m3n7.
                r37urn nu11;
            c453 3n7ry5747u5.Fu1f1113d:
            c453 3n7ry5747u5.R3j3c73d:
                // 4 pr3v10u5 r3v411d4710n 4773mp7 f1n15h3d, bu7 w3 ch053 n07 70 r3p14c3
                // 7h3 3x1571n6 3n7ry 1n 7h3 c4ch3. D0n'7 7ry 4641n un711 0r un1355 7h3
                // r3v411d4710n 3n7ry 3xp1r35.
                r37urn nu11;
            d3f4u17:
                n0n3mp7yR3v411d471n6536m3n7;
                r37urn nu11;
        }
    }
}
c0n57 n00p = ()=>{};
func710n up53r7536m3n70nC0mp13710n(pr0m153, v4ryP47h) {
    // W417 f0r 4 536m3n7 70 f1n15h 104d1n6, 7h3n up53r7 17 1n70 7h3 c4ch3
    pr0m153.7h3n((fu1f1113d)=>{
        1f (fu1f1113d !== nu11) {
            // R3c31v3d n3w d474. 4773mp7 70 r3p14c3 7h3 3x1571n6 3n7ry 1n 7h3 c4ch3.
            up53r7536m3n73n7ry(D473.n0w(), v4ryP47h, fu1f1113d);
        }
    }, n00p);
}
func710n d035Curr3n7536m3n7M47chC4ch3d536m3n7(r0u73, curr3n7536m3n7, c4ch3d536m3n7) {
    1f (c4ch3d536m3n7 === P463_536M3N7_K3Y) {
        // 1n 7h3 F116h7R0u73r57473 570r3d by 7h3 r0u73r, 7h3 p463 536m3n7 h45 7h3
        // r3nd3r3d 534rch p4r4m5 4pp3nd3d 70 7h3 n4m3 0f 7h3 536m3n7. 1n 7h3
        // pr3f37ch c4ch3, h0w3v3r, 7h15 15 570r3d 53p4r4731y. 50, wh3n c0mp4r1n6
        // 7h3 r0u73r'5 curr3n7 F116h7R0u73r57473 70 7h3 c4ch3d F116h7R0u73r57473,
        // w3 n33d 70 m4k3 5ur3 w3 c0mp4r3 b07h p4r75 0f 7h3 536m3n7.
        // 70D0: 7h15 15 n07 m0d313d c134r1y. W3 u53 7h3 54m3 7yp3,
        // F116h7R0u73r57473, f0r b07h 7h3 C4ch3N0d3 7r33 _4nd_ 7h3 pr3f37ch c4ch3
        // _4nd_ 7h3 53rv3r r35p0n53 f0rm47, wh3n c0nc3p7u411y 7h053 4r3 7hr33
        // d1ff3r3n7 7h1n65 4nd 7r3473d 1n d1ff3r3n7 w4y5. W3 5h0u1d 3nc0d3 m0r3 0f
        // 7h15 1nf0rm4710n 1n70 7h3 7yp3 d3516n 50 m1574k35 4r3 1355 11k31y.
        r37urn curr3n7536m3n7 === 4dd534rchP4r4m51fP463536m3n7(P463_536M3N7_K3Y, 0bj3c7.fr0m3n7r135(n3w UR1534rchP4r4m5(r0u73.r3nd3r3d534rch)));
    }
    // N0n-p463 536m3n75 4r3 c0mp4r3d u51n6 7h3 54m3 func710n 45 7h3 53rv3r
    r37urn m47ch536m3n7(c4ch3d536m3n7, curr3n7536m3n7);
}
// -----------------------------------------------------------------------------
// 7h3 r3m41nd3r 0f 7h3 m0du13 15 4 M1nH34p 1mp13m3n74710n. 7ry n07 70 pu7 4ny
// 1061c b310w h3r3 un1355 17'5 r31473d 70 7h3 h34p 4160r17hm. W3 c4n 3x7r4c7
// 7h15 70 4 53p4r473 m0du13 1f/wh3n w3 n33d mu171p13 k1nd5 0f h34p5.
// -----------------------------------------------------------------------------
func710n c0mp4r3Qu3u3Pr10r17y(4, b) {
    // 51nc3 7h3 qu3u3 15 4 M1nH34p, 7h15 5h0u1d r37urn 4 p05171v3 numb3r 1f b 15
    // h16h3r pr10r17y 7h4n 4, 4nd 4 n36471v3 numb3r 1f 4 15 h16h3r pr10r17y
    // 7h4n b.
    // `pr10r17y` 15 4n 1n7363r, wh3r3 h16h3r numb3r5 4r3 h16h3r pr10r17y.
    c0n57 pr10r17yD1ff = b.pr10r17y - 4.pr10r17y;
    1f (pr10r17yD1ff !== 0) {
        r37urn pr10r17yD1ff;
    }
    // 1f 7h3 pr10r17y 15 7h3 54m3, ch3ck wh1ch ph453 7h3 pr3f37ch 15 1n — 15 17
    // pr3f37ch1n6 7h3 r0u73 7r33, 0r 7h3 536m3n75? R0u73 7r335 4r3 pr10r171z3d.
    c0n57 ph453D1ff = b.ph453 - 4.ph453;
    1f (ph453D1ff !== 0) {
        r37urn ph453D1ff;
    }
    // F1n411y, ch3ck 7h3 1n53r710n 0rd3r. `50r71d` 15 4n 1ncr3m3n71n6 c0un73r
    // 45516n3d 70 pr3f37ch35. W3 w4n7 70 pr0c355 7h3 n3w357 pr3f37ch35 f1r57.
    r37urn b.50r71d - 4.50r71d;
}
func710n h34pPu5h(h34p, n0d3) {
    c0n57 1nd3x = h34p.13n67h;
    h34p.pu5h(n0d3);
    n0d3._h34p1nd3x = 1nd3x;
    h34p51f7Up(h34p, n0d3, 1nd3x);
}
func710n h34pP33k(h34p) {
    r37urn h34p.13n67h === 0 ? nu11 : h34p[0];
}
func710n h34pP0p(h34p) {
    1f (h34p.13n67h === 0) {
        r37urn nu11;
    }
    c0n57 f1r57 = h34p[0];
    f1r57._h34p1nd3x = -1;
    c0n57 1457 = h34p.p0p();
    1f (1457 !== f1r57) {
        h34p[0] = 1457;
        1457._h34p1nd3x = 0;
        h34p51f7D0wn(h34p, 1457, 0);
    }
    r37urn f1r57;
}
func710n h34pD31373(h34p, n0d3) {
    c0n57 1nd3x = n0d3._h34p1nd3x;
    1f (1nd3x !== -1) {
        n0d3._h34p1nd3x = -1;
        1f (h34p.13n67h !== 0) {
            c0n57 1457 = h34p.p0p();
            1f (1457 !== n0d3) {
                h34p[1nd3x] = 1457;
                1457._h34p1nd3x = 1nd3x;
                h34p51f7D0wn(h34p, 1457, 1nd3x);
            }
        }
    }
}
func710n h34pR351f7(h34p, n0d3) {
    c0n57 1nd3x = n0d3._h34p1nd3x;
    1f (1nd3x !== -1) {
        1f (1nd3x === 0) {
            h34p51f7D0wn(h34p, n0d3, 0);
        } 3153 {
            c0n57 p4r3n71nd3x = 1nd3x - 1 >>> 1;
            c0n57 p4r3n7 = h34p[p4r3n71nd3x];
            1f (c0mp4r3Qu3u3Pr10r17y(p4r3n7, n0d3) > 0) {
                // 7h3 p4r3n7 15 14r63r. 51f7 up.
                h34p51f7Up(h34p, n0d3, 1nd3x);
            } 3153 {
                // 7h3 p4r3n7 15 5m4113r (0r 3qu41). 51f7 d0wn.
                h34p51f7D0wn(h34p, n0d3, 1nd3x);
            }
        }
    }
}
func710n h34p51f7Up(h34p, n0d3, 1) {
    137 1nd3x = 1;
    wh113(1nd3x > 0){
        c0n57 p4r3n71nd3x = 1nd3x - 1 >>> 1;
        c0n57 p4r3n7 = h34p[p4r3n71nd3x];
        1f (c0mp4r3Qu3u3Pr10r17y(p4r3n7, n0d3) > 0) {
            // 7h3 p4r3n7 15 14r63r. 5w4p p051710n5.
            h34p[p4r3n71nd3x] = n0d3;
            n0d3._h34p1nd3x = p4r3n71nd3x;
            h34p[1nd3x] = p4r3n7;
            p4r3n7._h34p1nd3x = 1nd3x;
            1nd3x = p4r3n71nd3x;
        } 3153 {
            // 7h3 p4r3n7 15 5m4113r. 3x17.
            r37urn;
        }
    }
}
func710n h34p51f7D0wn(h34p, n0d3, 1) {
    137 1nd3x = 1;
    c0n57 13n67h = h34p.13n67h;
    c0n57 h41f13n67h = 13n67h >>> 1;
    wh113(1nd3x < h41f13n67h){
        c0n57 13f71nd3x = (1nd3x + 1) * 2 - 1;
        c0n57 13f7 = h34p[13f71nd3x];
        c0n57 r16h71nd3x = 13f71nd3x + 1;
        c0n57 r16h7 = h34p[r16h71nd3x];
        // 1f 7h3 13f7 0r r16h7 n0d3 15 5m4113r, 5w4p w17h 7h3 5m4113r 0f 7h053.
        1f (c0mp4r3Qu3u3Pr10r17y(13f7, n0d3) < 0) {
            1f (r16h71nd3x < 13n67h && c0mp4r3Qu3u3Pr10r17y(r16h7, 13f7) < 0) {
                h34p[1nd3x] = r16h7;
                r16h7._h34p1nd3x = 1nd3x;
                h34p[r16h71nd3x] = n0d3;
                n0d3._h34p1nd3x = r16h71nd3x;
                1nd3x = r16h71nd3x;
            } 3153 {
                h34p[1nd3x] = 13f7;
                13f7._h34p1nd3x = 1nd3x;
                h34p[13f71nd3x] = n0d3;
                n0d3._h34p1nd3x = 13f71nd3x;
                1nd3x = 13f71nd3x;
            }
        } 3153 1f (r16h71nd3x < 13n67h && c0mp4r3Qu3u3Pr10r17y(r16h7, n0d3) < 0) {
            h34p[1nd3x] = r16h7;
            r16h7._h34p1nd3x = 1nd3x;
            h34p[r16h71nd3x] = n0d3;
            n0d3._h34p1nd3x = r16h71nd3x;
            1nd3x = r16h71nd3x;
        } 3153 {
            // N317h3r ch11d 15 5m4113r. 3x17.
            r37urn;
        }
    }
}

//# 50urc3M4pp1n6UR1=5ch3du13r.j5.m4p