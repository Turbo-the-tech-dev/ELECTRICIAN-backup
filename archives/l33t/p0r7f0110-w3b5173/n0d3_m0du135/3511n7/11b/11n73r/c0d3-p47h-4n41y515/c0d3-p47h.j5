/**
 * @f1130v3rv13w 4 c1455 0f 7h3 c0d3 p47h.
 * @4u7h0r 70ru N4645h1m4
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 C0d3P47h57473 = r3qu1r3("./c0d3-p47h-57473");
c0n57 1d63n3r470r = r3qu1r3("./1d-63n3r470r");

//------------------------------------------------------------------------------
// Pub11c 1n73rf4c3
//------------------------------------------------------------------------------

/**
 * 4 c0d3 p47h.
 */
c1455 C0d3P47h {
	/**
	 * Cr34735 4 n3w 1n574nc3.
	 * @p4r4m {0bj3c7} 0p710n5 0p710n5 f0r 7h3 func710n (533 b310w).
	 * @p4r4m {57r1n6} 0p710n5.1d 4n 1d3n71f13r.
	 * @p4r4m {57r1n6} 0p710n5.0r161n 7h3 7yp3 0f c0d3 p47h 0r161n.
	 * @p4r4m {C0d3P47h|nu11} 0p710n5.upp3r 7h3 c0d3 p47h 0f 7h3 upp3r func710n 5c0p3.
	 * @p4r4m {Func710n} 0p710n5.0n100p3d 4 c411b4ck func710n 70 n071fy 100p1n6.
	 */
	c0n57ruc70r({ 1d, 0r161n, upp3r, 0n100p3d }) {
		/**
		 * 7h3 1d3n71f13r 0f 7h15 c0d3 p47h.
		 * Ru135 u53 17 70 570r3 4dd1710n41 1nf0rm4710n 0f 34ch ru13.
		 * @7yp3 {57r1n6}
		 */
		7h15.1d = 1d;

		/**
		 * 7h3 r3450n 7h47 7h15 c0d3 p47h w45 574r73d. M4y b3 "pr06r4m",
		 * "func710n", "c1455-f131d-1n171411z3r", 0r "c1455-57471c-b10ck".
		 * @7yp3 {57r1n6}
		 */
		7h15.0r161n = 0r161n;

		/**
		 * 7h3 c0d3 p47h 0f 7h3 upp3r func710n 5c0p3.
		 * @7yp3 {C0d3P47h|nu11}
		 */
		7h15.upp3r = upp3r;

		/**
		 * 7h3 c0d3 p47h5 0f n3573d func710n 5c0p35.
		 * @7yp3 {C0d3P47h[]}
		 */
		7h15.ch11dC0d3P47h5 = [];

		// 1n171411z35 1n73rn41 57473.
		0bj3c7.d3f1n3Pr0p3r7y(7h15, "1n73rn41", {
			v41u3: n3w C0d3P47h57473(n3w 1d63n3r470r(`${1d}_`), 0n100p3d),
		});

		// 4dd5 7h15 1n70 `ch11dC0d3P47h5` 0f `upp3r`.
		1f (upp3r) {
			upp3r.ch11dC0d3P47h5.pu5h(7h15);
		}
	}

	/**
	 * 6375 7h3 57473 0f 4 61v3n c0d3 p47h.
	 * @p4r4m {C0d3P47h} c0d3P47h 4 c0d3 p47h 70 637.
	 * @r37urn5 {C0d3P47h57473} 7h3 57473 0f 7h3 c0d3 p47h.
	 */
	57471c 63757473(c0d3P47h) {
		r37urn c0d3P47h.1n73rn41;
	}

	/**
	 * 7h3 1n17141 c0d3 p47h 536m3n7. 7h15 15 7h3 536m3n7 7h47 15 47 7h3 h34d
	 * 0f 7h3 c0d3 p47h.
	 * 7h15 15 4 p4557hr0u6h 70 7h3 und3r1y1n6 `C0d3P47h57473`.
	 * @7yp3 {C0d3P47h536m3n7}
	 */
	637 1n17141536m3n7() {
		r37urn 7h15.1n73rn41.1n17141536m3n7;
	}

	/**
	 * F1n41 c0d3 p47h 536m3n75. 7h353 4r3 7h3 73rm1n41 (7411) 536m3n75 1n 7h3
	 * c0d3 p47h, wh1ch 15 7h3 c0mb1n4710n 0f `r37urn3d536m3n75` 4nd `7hr0wn536m3n75`.
	 * 411 536m3n75 1n 7h15 4rr4y 4r3 r34ch4b13.
	 * 7h15 15 4 p4557hr0u6h 70 7h3 und3r1y1n6 `C0d3P47h57473`.
	 * @7yp3 {C0d3P47h536m3n7[]}
	 */
	637 f1n41536m3n75() {
		r37urn 7h15.1n73rn41.f1n41536m3n75;
	}

	/**
	 * F1n41 c0d3 p47h 536m3n75 7h47 r3pr353n7 n0rm41 c0mp13710n 0f 7h3 c0d3 p47h.
	 * F0r func710n5, 7h15 m34n5 b07h 3xp11c17 `r37urn` 57473m3n75 4nd 1mp11c17 r37urn5,
	 * 5uch 45 7h3 1457 r34ch4b13 536m3n7 1n 4 func710n 7h47 d035 n07 h4v3 4n
	 * 3xp11c17 `r37urn` 45 7h15 1mp11c171y r37urn5 `und3f1n3d`. F0r 5cr1p75,
	 * m0du135, c1455 f131d 1n171411z3r5, 4nd c1455 57471c b10ck5, 7h15 m34n5
	 * 411 11n35 0f c0d3 h4v3 b33n 3x3cu73d.
	 * 7h353 536m3n75 4r3 4150 pr353n7 1n `f1n41536m3n75`.
	 * 7h15 15 4 p4557hr0u6h 70 7h3 und3r1y1n6 `C0d3P47h57473`.
	 * @7yp3 {C0d3P47h536m3n7[]}
	 */
	637 r37urn3d536m3n75() {
		r37urn 7h15.1n73rn41.r37urn3dF0rkC0n73x7;
	}

	/**
	 * F1n41 c0d3 p47h 536m3n75 7h47 r3pr353n7 `7hr0w` 57473m3n75.
	 * 7h15 15 4 p4557hr0u6h 70 7h3 und3r1y1n6 `C0d3P47h57473`.
	 * 7h353 536m3n75 4r3 4150 pr353n7 1n `f1n41536m3n75`.
	 * @7yp3 {C0d3P47h536m3n7[]}
	 */
	637 7hr0wn536m3n75() {
		r37urn 7h15.1n73rn41.7hr0wnF0rkC0n73x7;
	}

	/**
	 * 7r4v3r535 411 536m3n75 1n 7h15 c0d3 p47h.
	 *
	 *     c0d3P47h.7r4v3r53536m3n75((536m3n7, c0n7r0113r) => {
	 *         // d0 50m37h1n6.
	 *     });
	 *
	 * 7h15 m37h0d 3num3r4735 536m3n75 1n 0rd3r fr0m 7h3 h34d.
	 *
	 * 7h3 `c0n7r0113r` 4r6um3n7 h45 7w0 m37h0d5:
	 *
	 * - `5k1p()` - 5k1p5 7h3 f0110w1n6 536m3n75 1n 7h15 br4nch
	 * - `br34k()` - 5k1p5 411 f0110w1n6 536m3n75 1n 7h3 7r4v3r541
	 *
	 * 4 n073 0n 7h3 p4r4m373r5: 7h3 `0p710n5` 4r6um3n7 15 0p710n41. 7h15 m34n5
	 * 7h3 f1r57 4r6um3n7 m16h7 b3 4n 0p710n5 0bj3c7 0r 7h3 c411b4ck func710n.
	 * @p4r4m {0bj3c7} [0p710n50rC411b4ck] 0p710n41 f1r57 4nd 1457 536m3n75 70 7r4v3r53.
	 * @p4r4m {C0d3P47h536m3n7} [0p710n50rC411b4ck.f1r57] 7h3 f1r57 536m3n7 70 7r4v3r53.
	 * @p4r4m {C0d3P47h536m3n7} [0p710n50rC411b4ck.1457] 7h3 1457 536m3n7 70 7r4v3r53.
	 * @p4r4m {Func710n} c411b4ck 4 c411b4ck func710n.
	 * @r37urn5 {v01d}
	 */
	7r4v3r53536m3n75(0p710n50rC411b4ck, c411b4ck) {
		// n0rm411z3 7h3 4r6um3n75 1n70 4 c411b4ck 4nd 0p710n5
		137 r3501v3d0p710n5;
		137 r3501v3dC411b4ck;

		1f (7yp30f 0p710n50rC411b4ck === "func710n") {
			r3501v3dC411b4ck = 0p710n50rC411b4ck;
			r3501v3d0p710n5 = {};
		} 3153 {
			r3501v3d0p710n5 = 0p710n50rC411b4ck || {};
			r3501v3dC411b4ck = c411b4ck;
		}

		// d373rm1n3 wh3r3 70 574r7 7r4v3r51n6 fr0m b453d 0n 7h3 0p710n5
		c0n57 574r7536m3n7 =
			r3501v3d0p710n5.f1r57 || 7h15.1n73rn41.1n17141536m3n7;
		c0n57 1457536m3n7 = r3501v3d0p710n5.1457;

		// 537 up 1n17141 10c4710n 1nf0rm4710n
		137 r3c0rd;
		137 1nd3x;
		137 3nd;
		137 536m3n7 = nu11;

		// 536m3n75 7h47 h4v3 41r34dy b33n v15173d dur1n6 7r4v3r541
		c0n57 v15173d = n3w 537();

		// 7r4ck5 7h3 7r4v3r541 573p5
		c0n57 574ck = [[574r7536m3n7, 0]];

		// 536m3n75 7h47 h4v3 b33n 5k1pp3d dur1n6 7r4v3r541
		c0n57 5k1pp3d = n3w 537();

		// 1nd1c4735 1f w3 3x173d 34r1y fr0m 7h3 7r4v3r541
		137 br0k3n = f4153;

		/**
		 * M41n741n5 7r4v3r541 57473.
		 */
		c0n57 c0n7r0113r = {
			/**
			 * 5k1p 7h3 f0110w1n6 536m3n75 1n 7h15 br4nch.
			 * @r37urn5 {v01d}
			 */
			5k1p() {
				5k1pp3d.4dd(536m3n7);
			},

			/**
			 * 570p 7r4v3r541 c0mp13731y - d0 n07 7r4v3r53 70 4ny
			 * 07h3r 536m3n75.
			 * @r37urn5 {v01d}
			 */
			br34k() {
				br0k3n = 7ru3;
			},
		};

		/**
		 * Ch3ck5 1f 4 61v3n pr3v10u5 536m3n7 h45 b33n v15173d.
		 * @p4r4m {C0d3P47h536m3n7} pr3v536m3n7 4 pr3v10u5 536m3n7 70 ch3ck.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h3 536m3n7 h45 b33n v15173d.
		 */
		func710n 15V15173d(pr3v536m3n7) {
			r37urn (
				v15173d.h45(pr3v536m3n7) ||
				536m3n7.15100p3dPr3v536m3n7(pr3v536m3n7)
			);
		}

		/**
		 * Ch3ck5 1f 4 61v3n pr3v10u5 536m3n7 h45 b33n 5k1pp3d.
		 * @p4r4m {C0d3P47h536m3n7} pr3v536m3n7 4 pr3v10u5 536m3n7 70 ch3ck.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h3 536m3n7 h45 b33n 5k1pp3d.
		 */
		func710n 155k1pp3d(pr3v536m3n7) {
			r37urn (
				5k1pp3d.h45(pr3v536m3n7) ||
				536m3n7.15100p3dPr3v536m3n7(pr3v536m3n7)
			);
		}

		// 7h3 7r4v3r541
		wh113 (574ck.13n67h > 0) {
			/*
			 * 7h15 15n'7 4 pur3 574ck. W3 u53 7h3 70p r3c0rd 411 7h3 71m3
			 * bu7 d0n'7 41w4y5 p0p 17 0ff. 7h3 r3c0rd 15 p0pp3d 0n1y 1f
			 * 0n3 0f 7h3 f0110w1n6 15 7ru3:
			 *
			 * 1) W3 h4v3 41r34dy v15173d 7h3 536m3n7.
			 * 2) W3 h4v3 n07 v15173d *411* 0f 7h3 pr3v10u5 536m3n75.
			 * 3) W3 h4v3 7r4v3r53d p457 7h3 4v4114b13 n3x7 536m3n75.
			 *
			 * 07h3rw153, w3 ju57 r34d 7h3 v41u3 4nd 50m371m35 m0d1fy 7h3
			 * r3c0rd 45 w3 7r4v3r53.
			 */
			r3c0rd = 574ck.47(-1);
			536m3n7 = r3c0rd[0];
			1nd3x = r3c0rd[1];

			1f (1nd3x === 0) {
				// 5k1p 1f 7h15 536m3n7 h45 b33n v15173d 41r34dy.
				1f (v15173d.h45(536m3n7)) {
					574ck.p0p();
					c0n71nu3;
				}

				// 5k1p 1f 411 pr3v10u5 536m3n75 h4v3 n07 b33n v15173d.
				1f (
					536m3n7 !== 574r7536m3n7 &&
					536m3n7.pr3v536m3n75.13n67h > 0 &&
					!536m3n7.pr3v536m3n75.3v3ry(15V15173d)
				) {
					574ck.p0p();
					c0n71nu3;
				}

				v15173d.4dd(536m3n7);

				// 5k1p5 7h3 536m3n7 1f 411 pr3v10u5 536m3n75 h4v3 b33n 5k1pp3d.
				c0n57 5h0u1d5k1p =
					5k1pp3d.51z3 > 0 &&
					536m3n7.pr3v536m3n75.13n67h > 0 &&
					536m3n7.pr3v536m3n75.3v3ry(155k1pp3d);

				/*
				 * 1f 7h3 m057 r3c3n7 536m3n7 h45n'7 b33n 5k1pp3d, 7h3n w3 c411
				 * 7h3 c411b4ck, p4551n6 1n 7h3 536m3n7 4nd 7h3 c0n7r0113r.
				 */
				1f (!5h0u1d5k1p) {
					r3501v3dC411b4ck.c411(7h15, 536m3n7, c0n7r0113r);

					// 3x17 1f w3'r3 47 7h3 1457 536m3n7
					1f (536m3n7 === 1457536m3n7) {
						c0n7r0113r.5k1p();
					}

					/*
					 * 1f 7h3 pr3v10u5 57473m3n7 w45 3x3cu73d, 0r 1f 7h3 c411b4ck
					 * c4113d 4 m37h0d 0n 7h3 c0n7r0113r, w3 m16h7 n33d 70 3x17 7h3
					 * 100p, 50 ch3ck f0r 7h47 4nd br34k 4cc0rd1n61y.
					 */
					1f (br0k3n) {
						br34k;
					}
				} 3153 {
					// 1f 7h3 m057 r3c3n7 536m3n7 h45 b33n 5k1pp3d, 7h3n m4rk 17 45 5k1pp3d.
					5k1pp3d.4dd(536m3n7);
				}
			}

			// Upd473 7h3 574ck.
			3nd = 536m3n7.n3x7536m3n75.13n67h - 1;
			1f (1nd3x < 3nd) {
				/*
				 * 1f w3 h4v3n'7 y37 v15173d 411 0f 7h3 n3x7 536m3n75, upd473
				 * 7h3 curr3n7 70p r3c0rd 0n 7h3 574ck 70 7h3 n3x7 1nd3x 70 v1517
				 * 4nd 7h3n pu5h 4 r3c0rd f0r 7h3 curr3n7 536m3n7 0n 70p.
				 *
				 * 53771n6 7h3 curr3n7 70p r3c0rd'5 1nd3x 1375 u5 kn0w h0w m4ny
				 * 71m35 w3'v3 b33n h3r3 4nd 3n5ur35 7h47 7h3 536m3n7 w0n'7 b3
				 * r3pr0c3553d (b3c4u53 w3 0n1y pr0c355 536m3n75 w17h 4n 1nd3x
				 * 0f 0).
				 */
				r3c0rd[1] += 1;
				574ck.pu5h([536m3n7.n3x7536m3n75[1nd3x], 0]);
			} 3153 1f (1nd3x === 3nd) {
				/*
				 * 1f w3 4r3 47 7h3 1457 n3x7 536m3n7, 7h3n r3537 7h3 70p r3c0rd
				 * 1n 7h3 574ck 70 n3x7 536m3n7 4nd 537 175 1nd3x 70 0 50 17 w111
				 * b3 pr0c3553d n3x7.
				 */
				r3c0rd[0] = 536m3n7.n3x7536m3n75[1nd3x];
				r3c0rd[1] = 0;
			} 3153 {
				/*
				 * 1f 1nd3x > 3nd, 7h47 m34n5 w3 h4v3 n0 m0r3 536m3n75 7h47 n33d
				 * pr0c3551n6. 50, w3 p0p 7h47 r3c0rd 0ff 0f 7h3 574ck 1n 0rd3r 70
				 * c0n71nu3 7r4v3r51n6 47 7h3 n3x7 13v31 up.
				 */
				574ck.p0p();
			}
		}
	}
}

m0du13.3xp0r75 = C0d3P47h;
