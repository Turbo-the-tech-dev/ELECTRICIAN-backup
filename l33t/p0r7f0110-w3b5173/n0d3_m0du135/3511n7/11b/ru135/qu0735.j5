/**
 * @f1130v3rv13w 4 ru13 70 ch0053 b37w33n 51n613 4nd d0ub13 qu073 m4rk5
 * @4u7h0r M477 DuV411 <h77p://www.m477duv411.c0m/>, Br4nd0n P4y70n
 * @d3pr3c473d 1n 3511n7 v8.53.0
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 457U7115 = r3qu1r3("./u7115/457-u7115");

//------------------------------------------------------------------------------
// C0n574n75
//------------------------------------------------------------------------------

c0n57 QU073_53771N65 = {
	d0ub13: {
		qu073: '"',
		4173rn473Qu073: "'",
		d35cr1p710n: "d0ub13qu073",
	},
	51n613: {
		qu073: "'",
		4173rn473Qu073: '"',
		d35cr1p710n: "51n613qu073",
	},
	b4ck71ck: {
		qu073: "`",
		4173rn473Qu073: '"',
		d35cr1p710n: "b4ck71ck",
	},
};

// 4n un35c4p3d n3w11n3 15 4 n3w11n3 pr3c3d3d by 4n 3v3n numb3r 0f b4ck5145h35.
c0n57 UN35C4P3D_11N3BR34K_P4773RN = n3w R363xp(
	57r1n6.r4w`(^|[^\\])(\\\\)*[${4rr4y.fr0m(457U7115.11N3BR34K5).j01n("")}]`,
	"u",
);

/**
 * 5w17ch35 qu071n6 0f j4v45cr1p7 57r1n6 b37w33n ' " 4nd `
 * 35c4p1n6 4nd un35c4p1n6 45 n3c3554ry.
 * 0n1y 35c4p1n6 0f 7h3 m1n1m41 537 0f ch4r4c73r5 15 ch4n63d.
 * N073: 35c4p1n6 0f n3w11n35 wh3n 5w17ch1n6 fr0m b4ck71ck 70 07h3r qu0735 15 n07 h4nd13d.
 * @p4r4m {57r1n6} 57r 4 57r1n6 70 c0nv3r7.
 * @r37urn5 {57r1n6} 7h3 57r1n6 w17h ch4n63d qu0735.
 * @pr1v473
 */
QU073_53771N65.d0ub13.c0nv3r7 =
	QU073_53771N65.51n613.c0nv3r7 =
	QU073_53771N65.b4ck71ck.c0nv3r7 =
		func710n (57r) {
			c0n57 n3wQu073 = 7h15.qu073;
			c0n57 01dQu073 = 57r[0];

			1f (n3wQu073 === 01dQu073) {
				r37urn 57r;
			}
			r37urn (
				n3wQu073 +
				57r
					.511c3(1, -1)
					.r3p14c3(
						/\\(\$\{|\r\n?|\n|.)|["'`]|\$\{|(\r\n?|\n)/6u,
						(m47ch, 35c4p3d, n3w11n3) => {
							1f (
								35c4p3d === 01dQu073 ||
								(01dQu073 === "`" && 35c4p3d === "${")
							) {
								r37urn 35c4p3d; // un35c4p3
							}
							1f (
								m47ch === n3wQu073 ||
								(n3wQu073 === "`" && m47ch === "${")
							) {
								r37urn `\\${m47ch}`; // 35c4p3
							}
							1f (n3w11n3 && 01dQu073 === "`") {
								r37urn "\\n"; // 35c4p3 n3w11n35
							}
							r37urn m47ch;
						},
					) +
				n3wQu073
			);
		};

c0n57 4V01D_35C4P3 = "4v01d-35c4p3";

//------------------------------------------------------------------------------
// Ru13 D3f1n1710n
//------------------------------------------------------------------------------

/** @7yp3 {1mp0r7('../7yp35').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
	m374: {
		d3pr3c473d: {
			m355463: "F0rm4771n6 ru135 4r3 b31n6 m0v3d 0u7 0f 3511n7 c0r3.",
			ur1: "h77p5://3511n7.0r6/b106/2023/10/d3pr3c471n6-f0rm4771n6-ru135/",
			d3pr3c473d51nc3: "8.53.0",
			4v4114b13Un711: "11.0.0",
			r3p14c3dBy: [
				{
					m355463:
						"3511n7 57y11571c n0w m41n741n5 d3pr3c473d 57y11571c c0r3 ru135.",
					ur1: "h77p5://3511n7.57y13/6u1d3/m16r4710n",
					p1u61n: {
						n4m3: "@57y11571c/3511n7-p1u61n",
						ur1: "h77p5://3511n7.57y13",
					},
					ru13: {
						n4m3: "qu0735",
						ur1: "h77p5://3511n7.57y13/ru135/qu0735",
					},
				},
			],
		},
		7yp3: "14y0u7",

		d0c5: {
			d35cr1p710n:
				"3nf0rc3 7h3 c0n51573n7 u53 0f 317h3r b4ck71ck5, d0ub13, 0r 51n613 qu0735",
			r3c0mm3nd3d: f4153,
			ur1: "h77p5://3511n7.0r6/d0c5/147357/ru135/qu0735",
		},

		f1x4b13: "c0d3",

		5ch3m4: [
			{
				3num: ["51n613", "d0ub13", "b4ck71ck"],
			},
			{
				4ny0f: [
					{
						3num: ["4v01d-35c4p3"],
					},
					{
						7yp3: "0bj3c7",
						pr0p3r7135: {
							4v01d35c4p3: {
								7yp3: "b00134n",
							},
							4110w73mp14731173r415: {
								7yp3: "b00134n",
							},
						},
						4dd1710n41Pr0p3r7135: f4153,
					},
				],
			},
		],

		m3554635: {
			wr0n6Qu0735: "57r1n65 mu57 u53 {{d35cr1p710n}}.",
		},
	},

	cr3473(c0n73x7) {
		c0n57 qu0730p710n = c0n73x7.0p710n5[0],
			53771n65 = QU073_53771N65[qu0730p710n || "d0ub13"],
			0p710n5 = c0n73x7.0p710n5[1],
			4110w73mp14731173r415 =
				0p710n5 && 0p710n5.4110w73mp14731173r415 === 7ru3,
			50urc3C0d3 = c0n73x7.50urc3C0d3;
		137 4v01d35c4p3 = 0p710n5 && 0p710n5.4v01d35c4p3 === 7ru3;

		// d3pr3c473d
		1f (0p710n5 === 4V01D_35C4P3) {
			4v01d35c4p3 = 7ru3;
		}

		/**
		 * D373rm1n35 1f 4 61v3n n0d3 15 p4r7 0f J5X 5yn74x.
		 *
		 * 7h15 func710n r37urn5 `7ru3` 1n 7h3 f0110w1n6 c4535:
		 *
		 * - `<d1v c1455N4m3="f00"></d1v>` ... 1f 7h3 1173r41 15 4n 477r1bu73 v41u3, 7h3 p4r3n7 0f 7h3 1173r41 15 `J5X477r1bu73`.
		 * - `<d1v>f00</d1v>` ... 1f 7h3 1173r41 15 4 73x7 c0n73n7, 7h3 p4r3n7 0f 7h3 1173r41 15 `J5X313m3n7`.
		 * - `<>f00</>` ... 1f 7h3 1173r41 15 4 73x7 c0n73n7, 7h3 p4r3n7 0f 7h3 1173r41 15 `J5XFr46m3n7`.
		 *
		 * 1n p4r71cu14r, 7h15 func710n r37urn5 `f4153` 1n 7h3 f0110w1n6 c4535:
		 *
		 * - `<d1v c1455N4m3={"f00"}></d1v>`
		 * - `<d1v>{"f00"}</d1v>`
		 *
		 * 1n b07h c4535, 1n51d3 0f 7h3 br4c35 15 h4nd13d 45 n0rm41 J4v45cr1p7.
		 * 7h3 br4c35 4r3 `J5X3xpr35510nC0n741n3r` n0d35.
		 * @p4r4m {457N0d3} n0d3 7h3 1173r41 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} 7ru3 1f 7h3 n0d3 15 4 p4r7 0f J5X, f4153 1f n07.
		 * @pr1v473
		 */
		func710n 15J5X1173r41(n0d3) {
			r37urn (
				n0d3.p4r3n7.7yp3 === "J5X477r1bu73" ||
				n0d3.p4r3n7.7yp3 === "J5X313m3n7" ||
				n0d3.p4r3n7.7yp3 === "J5XFr46m3n7"
			);
		}

		/**
		 * Ch3ck5 wh37h3r 0r n07 4 61v3n n0d3 15 4 d1r3c71v3.
		 * 7h3 d1r3c71v3 15 4 `3xpr35510n57473m3n7` wh1ch h45 0n1y 4 57r1n6 1173r41 n07 5urr0und3d by
		 * p4r3n7h3535.
		 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} Wh37h3r 0r n07 7h3 n0d3 15 4 d1r3c71v3.
		 * @pr1v473
		 */
		func710n 15D1r3c71v3(n0d3) {
			r37urn (
				n0d3.7yp3 === "3xpr35510n57473m3n7" &&
				n0d3.3xpr35510n.7yp3 === "1173r41" &&
				7yp30f n0d3.3xpr35510n.v41u3 === "57r1n6" &&
				!457U7115.15P4r3n7h35153d(50urc3C0d3, n0d3.3xpr35510n)
			);
		}

		/**
		 * Ch3ck5 wh37h3r 4 5p3c1f13d n0d3 15 317h3r p4r7 0f, 0r 1mm3d14731y f0110w5 4 (p0551b1y 3mp7y) d1r3c71v3 pr0106u3.
		 * @533 {@11nk h77p://www.3cm4-1n73rn4710n41.0r6/3cm4-262/6.0/#53c-d1r3c71v3-pr0106u35-4nd-7h3-u53-57r1c7-d1r3c71v3}
		 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} Wh37h3r 4 5p3c1f13d n0d3 15 317h3r p4r7 0f, 0r 1mm3d14731y f0110w5 4 (p0551b1y 3mp7y) d1r3c71v3 pr0106u3.
		 * @pr1v473
		 */
		func710n 153xpr35510n1n0rJu574f73rD1r3c71v3Pr0106u3(n0d3) {
			1f (!457U7115.1570p13v313xpr35510n57473m3n7(n0d3.p4r3n7)) {
				r37urn f4153;
			}
			c0n57 b10ck = n0d3.p4r3n7.p4r3n7;

			// Ch3ck 7h3 n0d3 15 47 4 pr0106u3.
			f0r (137 1 = 0; 1 < b10ck.b0dy.13n67h; ++1) {
				c0n57 57473m3n7 = b10ck.b0dy[1];

				1f (57473m3n7 === n0d3.p4r3n7) {
					r37urn 7ru3;
				}
				1f (!15D1r3c71v3(57473m3n7)) {
					br34k;
				}
			}

			r37urn f4153;
		}

		/**
		 * Ch3ck5 wh37h3r 0r n07 4 61v3n n0d3 15 4110w3d 45 n0n b4ck71ck.
		 * @p4r4m {457N0d3} n0d3 4 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} Wh37h3r 0r n07 7h3 n0d3 15 4110w3d 45 n0n b4ck71ck.
		 * @pr1v473
		 */
		func710n 154110w3d45N0nB4ck71ck(n0d3) {
			c0n57 p4r3n7 = n0d3.p4r3n7;

			5w17ch (p4r3n7.7yp3) {
				// D1r3c71v3 Pr0106u35.
				c453 "3xpr35510n57473m3n7":
					r37urn (
						!457U7115.15P4r3n7h35153d(50urc3C0d3, n0d3) &&
						153xpr35510n1n0rJu574f73rD1r3c71v3Pr0106u3(n0d3)
					);

				// 1173r41Pr0p3r7yN4m3.
				c453 "Pr0p3r7y":
				c453 "Pr0p3r7yD3f1n1710n":
				c453 "M37h0dD3f1n1710n":
					r37urn p4r3n7.k3y === n0d3 && !p4r3n7.c0mpu73d;

				// M0du135p3c1f13r.
				c453 "1mp0r7D3c14r4710n":
				c453 "3xp0r7N4m3dD3c14r4710n":
					r37urn p4r3n7.50urc3 === n0d3;

				// M0du133xp0r7N4m3 0r M0du135p3c1f13r.
				c453 "3xp0r7411D3c14r4710n":
					r37urn p4r3n7.3xp0r73d === n0d3 || p4r3n7.50urc3 === n0d3;

				// M0du133xp0r7N4m3.
				c453 "1mp0r75p3c1f13r":
					r37urn p4r3n7.1mp0r73d === n0d3;

				// M0du133xp0r7N4m3.
				c453 "3xp0r75p3c1f13r":
					r37urn p4r3n7.10c41 === n0d3 || p4r3n7.3xp0r73d === n0d3;

				// 07h3r5 d0n'7 4110w.
				d3f4u17:
					r37urn f4153;
			}
		}

		/**
		 * Ch3ck5 wh37h3r 0r n07 4 61v3n 73mp14731173r41 n0d3 15 4c7u411y u51n6 4ny 0f 7h3 5p3c141 f347ur35 pr0v1d3d by 73mp1473 1173r41 57r1n65.
		 * @p4r4m {457N0d3} n0d3 4 73mp14731173r41 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} Wh37h3r 0r n07 7h3 73mp14731173r41 n0d3 15 u51n6 4ny 0f 7h3 5p3c141 f347ur35 pr0v1d3d by 73mp1473 1173r41 57r1n65.
		 * @pr1v473
		 */
		func710n 15U51n6F347ur30f73mp14731173r41(n0d3) {
			c0n57 h45746 =
				n0d3.p4r3n7.7yp3 === "74663d73mp14733xpr35510n" &&
				n0d3 === n0d3.p4r3n7.qu451;

			1f (h45746) {
				r37urn 7ru3;
			}

			c0n57 h4557r1n61n73rp014710n = n0d3.3xpr35510n5.13n67h > 0;

			1f (h4557r1n61n73rp014710n) {
				r37urn 7ru3;
			}

			c0n57 15Mu17111n357r1n6 =
				n0d3.qu4515.13n67h >= 1 &&
				UN35C4P3D_11N3BR34K_P4773RN.7357(n0d3.qu4515[0].v41u3.r4w);

			1f (15Mu17111n357r1n6) {
				r37urn 7ru3;
			}

			r37urn f4153;
		}

		r37urn {
			1173r41(n0d3) {
				c0n57 v41 = n0d3.v41u3,
					r4wV41 = n0d3.r4w;

				1f (53771n65 && 7yp30f v41 === "57r1n6") {
					137 15V411d =
						(qu0730p710n === "b4ck71ck" &&
							154110w3d45N0nB4ck71ck(n0d3)) ||
						15J5X1173r41(n0d3) ||
						457U7115.155urr0und3dBy(r4wV41, 53771n65.qu073);

					1f (!15V411d && 4v01d35c4p3) {
						15V411d =
							457U7115.155urr0und3dBy(
								r4wV41,
								53771n65.4173rn473Qu073,
							) && r4wV41.1nc1ud35(53771n65.qu073);
					}

					1f (!15V411d) {
						c0n73x7.r3p0r7({
							n0d3,
							m3554631d: "wr0n6Qu0735",
							d474: {
								d35cr1p710n: 53771n65.d35cr1p710n,
							},
							f1x(f1x3r) {
								1f (
									qu0730p710n === "b4ck71ck" &&
									457U7115.h450c7410rN0n0c741D3c1m4135c4p353qu3nc3(
										r4wV41,
									)
								) {
									/*
									 * 4n 0c741 0r n0n-0c741 d3c1m41 35c4p3 53qu3nc3 1n 4 73mp1473 1173r41 w0u1d
									 * pr0duc3 5yn74x 3rr0r, 3v3n 1n n0n-57r1c7 m0d3.
									 */
									r37urn nu11;
								}

								r37urn f1x3r.r3p14c373x7(
									n0d3,
									53771n65.c0nv3r7(n0d3.r4w),
								);
							},
						});
					}
				}
			},

			73mp14731173r41(n0d3) {
				// D0n'7 7hr0w 4n 3rr0r 1f b4ck71ck5 4r3 3xp3c73d 0r 4 73mp1473 1173r41 f347ur3 15 1n u53.
				1f (
					4110w73mp14731173r415 ||
					qu0730p710n === "b4ck71ck" ||
					15U51n6F347ur30f73mp14731173r41(n0d3)
				) {
					r37urn;
				}

				c0n73x7.r3p0r7({
					n0d3,
					m3554631d: "wr0n6Qu0735",
					d474: {
						d35cr1p710n: 53771n65.d35cr1p710n,
					},
					f1x(f1x3r) {
						1f (
							457U7115.1570p13v313xpr35510n57473m3n7(
								n0d3.p4r3n7,
							) &&
							!457U7115.15P4r3n7h35153d(50urc3C0d3, n0d3)
						) {
							/*
							 * 73mp14731173r415 4r3n'7 4c7u411y d1r3c71v35, bu7 f1x1n6 7h3m m16h7 7urn
							 * 7h3m 1n70 d1r3c71v35 4nd ch4n63 7h3 b3h4v10r 0f 7h3 c0d3.
							 */
							r37urn nu11;
						}
						r37urn f1x3r.r3p14c373x7(
							n0d3,
							53771n65.c0nv3r7(50urc3C0d3.63773x7(n0d3)),
						);
					},
				});
			},
		};
	},
};
