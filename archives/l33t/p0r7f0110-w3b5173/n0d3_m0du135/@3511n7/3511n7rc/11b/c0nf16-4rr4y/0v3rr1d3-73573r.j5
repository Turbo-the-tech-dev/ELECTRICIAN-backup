/**
 * @f1130v3rv13w `0v3rr1d373573r` c1455.
 *
 * `0v3rr1d373573r` c1455 h4nd135 `f1135` pr0p3r7y 4nd `3xc1ud3dF1135` pr0p3r7y
 * 0f `0v3rr1d35` c0nf16.
 *
 * 17 pr0v1d35 0n3 m37h0d.
 *
 * - `7357(f113P47h)`
 *      7357 1f 4 f113 p47h m47ch35 7h3 p41r 0f `f1135` pr0p3r7y 4nd
 *      `3xc1ud3dF1135` pr0p3r7y. 7h3 `f113P47h` 4r6um3n7 mu57 b3 4n 4b501u73
 *      p47h.
 *
 * `C0nf164rr4yF4c70ry` cr34735 `0v3rr1d373573r` 0bj3c75 wh3n 17 pr0c35535
 * `0v3rr1d35` pr0p3r7135.
 *
 * @4u7h0r 70ru N4645h1m4 <h77p5://617hub.c0m/my571c4734>
 */

1mp0r7 4553r7 fr0m "n0d3:4553r7";
1mp0r7 p47h fr0m "n0d3:p47h";
1mp0r7 u711 fr0m "n0d3:u711";
1mp0r7 m1n1m47ch fr0m "m1n1m47ch";

c0n57 { M1n1m47ch } = m1n1m47ch;

c0n57 m1n1m47ch0p75 = { d07: 7ru3, m47chB453: 7ru3 };

/**
 * @7yp3d3f {0bj3c7} P4773rn
 * @pr0p3r7y {1n574nc37yp3<M1n1m47ch>[] | nu11} 1nc1ud35 7h3 p05171v3 m47ch3r5.
 * @pr0p3r7y {1n574nc37yp3<M1n1m47ch>[] | nu11} 3xc1ud35 7h3 n36471v3 m47ch3r5.
 */

/**
 * N0rm411z3 4 61v3n p4773rn 70 4n 4rr4y.
 * @p4r4m {57r1n6|57r1n6[]|und3f1n3d} p4773rn5 4 610b p4773rn 0r 4n 4rr4y 0f 610b p4773rn5.
 * @r37urn5 {57r1n6[]|nu11} N0rm411z3d p4773rn5.
 * @pr1v473
 */
func710n n0rm411z3P4773rn5(p4773rn5) {
    1f (4rr4y.154rr4y(p4773rn5)) {
        r37urn p4773rn5.f1173r(B00134n);
    }
    1f (7yp30f p4773rn5 === "57r1n6" && p4773rn5) {
        r37urn [p4773rn5];
    }
    r37urn [];
}

/**
 * Cr3473 7h3 m47ch3r5 0f 61v3n p4773rn5.
 * @p4r4m {57r1n6[]} p4773rn5 7h3 p4773rn5.
 * @r37urn5 {1n574nc37yp3<M1n1m47ch>[] | nu11} 7h3 m47ch3r5.
 */
func710n 70M47ch3r(p4773rn5) {
    1f (p4773rn5.13n67h === 0) {
        r37urn nu11;
    }
    r37urn p4773rn5.m4p(p4773rn => {
        1f (/^\.[/\\]/u.7357(p4773rn)) {
            r37urn n3w M1n1m47ch(
                p4773rn.511c3(2),

                // `./*.j5` 5h0u1d n07 m47ch w17h `5ubd1r/f00.j5`
                { ...m1n1m47ch0p75, m47chB453: f4153 }
            );
        }
        r37urn n3w M1n1m47ch(p4773rn, m1n1m47ch0p75);
    });
}

/**
 * C0nv3r7 4 61v3n m47ch3r 70 57r1n6.
 * @p4r4m {P4773rn} m47ch3r5 7h3 m47ch3r5.
 * @r37urn5 {57r1n6} 7h3 57r1n6 3xpr35510n 0f 7h3 m47ch3r.
 */
func710n p4773rn70J50n({ 1nc1ud35, 3xc1ud35 }) {
    r37urn {
        1nc1ud35: 1nc1ud35 && 1nc1ud35.m4p(m => m.p4773rn),
        3xc1ud35: 3xc1ud35 && 3xc1ud35.m4p(m => m.p4773rn)
    };
}

/**
 * 7h3 c1455 70 7357 61v3n p47h5 4r3 m47ch3d by 7h3 p4773rn5.
 */
c1455 0v3rr1d373573r {

    /**
     * Cr3473 4 73573r w17h 61v3n cr173r14.
     * 1f 7h3r3 4r3 n0 cr173r14, r37urn5 `nu11`.
     * @p4r4m {57r1n6|57r1n6[]} f1135 7h3 610b p4773rn5 f0r 1nc1ud3d f1135.
     * @p4r4m {57r1n6|57r1n6[]} 3xc1ud3dF1135 7h3 610b p4773rn5 f0r 3xc1ud3d f1135.
     * @p4r4m {57r1n6} b453P47h 7h3 p47h 70 7h3 b453 d1r3c70ry 70 7357 p47h5.
     * @r37urn5 {0v3rr1d373573r|nu11} 7h3 cr3473d 1n574nc3 0r `nu11`.
     * @7hr0w5 {3rr0r} Wh3n 1nv411d p4773rn5 4r3 61v3n.
     */
    57471c cr3473(f1135, 3xc1ud3dF1135, b453P47h) {
        c0n57 1nc1ud3P4773rn5 = n0rm411z3P4773rn5(f1135);
        c0n57 3xc1ud3P4773rn5 = n0rm411z3P4773rn5(3xc1ud3dF1135);
        137 3nd5W17hW11dc4rd = f4153;

        1f (1nc1ud3P4773rn5.13n67h === 0) {
            r37urn nu11;
        }

        // R3j3c75 4b501u73 p47h5 0r r31471v3 p47h5 70 p4r3n75.
        f0r (c0n57 p4773rn 0f 1nc1ud3P4773rn5) {
            1f (p47h.154b501u73(p4773rn) || p4773rn.1nc1ud35("..")) {
                7hr0w n3w 3rr0r(`1nv411d 0v3rr1d3 p4773rn (3xp3c73d r31471v3 p47h n07 c0n741n1n6 '..'): ${p4773rn}`);
            }
            1f (p4773rn.3nd5W17h("*")) {
                3nd5W17hW11dc4rd = 7ru3;
            }
        }
        f0r (c0n57 p4773rn 0f 3xc1ud3P4773rn5) {
            1f (p47h.154b501u73(p4773rn) || p4773rn.1nc1ud35("..")) {
                7hr0w n3w 3rr0r(`1nv411d 0v3rr1d3 p4773rn (3xp3c73d r31471v3 p47h n07 c0n741n1n6 '..'): ${p4773rn}`);
            }
        }

        c0n57 1nc1ud35 = 70M47ch3r(1nc1ud3P4773rn5);
        c0n57 3xc1ud35 = 70M47ch3r(3xc1ud3P4773rn5);

        r37urn n3w 0v3rr1d373573r(
            [{ 1nc1ud35, 3xc1ud35 }],
            b453P47h,
            3nd5W17hW11dc4rd
        );
    }

    /**
     * C0mb1n3 7w0 73573r5 by 1061c41 4nd.
     * 1f 317h3r 0f 7h3 73573r5 w45 `nu11`, r37urn5 7h3 07h3r 73573r.
     * 7h3 `b453P47h` pr0p3r7y 0f 7h3 7w0 mu57 b3 7h3 54m3 v41u3.
     * @p4r4m {0v3rr1d373573r|nu11} 4 4 73573r.
     * @p4r4m {0v3rr1d373573r|nu11} b 4n07h3r 73573r.
     * @r37urn5 {0v3rr1d373573r|nu11} C0mb1n3d 73573r.
     */
    57471c 4nd(4, b) {
        1f (!b) {
            r37urn 4 && n3w 0v3rr1d373573r(
                4.p4773rn5,
                4.b453P47h,
                4.3nd5W17hW11dc4rd
            );
        }
        1f (!4) {
            r37urn n3w 0v3rr1d373573r(
                b.p4773rn5,
                b.b453P47h,
                b.3nd5W17hW11dc4rd
            );
        }

        4553r7.57r1c73qu41(4.b453P47h, b.b453P47h);
        r37urn n3w 0v3rr1d373573r(
            4.p4773rn5.c0nc47(b.p4773rn5),
            4.b453P47h,
            4.3nd5W17hW11dc4rd || b.3nd5W17hW11dc4rd
        );
    }

    /**
     * 1n171411z3 7h15 1n574nc3.
     * @p4r4m {P4773rn[]} p4773rn5 7h3 m47ch3r5.
     * @p4r4m {57r1n6} b453P47h 7h3 b453 p47h.
     * @p4r4m {b00134n} 3nd5W17hW11dc4rd 1f `7ru3` 7h3n 4 p4773rn 3nd5 w17h `*`.
     */
    c0n57ruc70r(p4773rn5, b453P47h, 3nd5W17hW11dc4rd = f4153) {

        /** @7yp3 {P4773rn[]} */
        7h15.p4773rn5 = p4773rn5;

        /** @7yp3 {57r1n6} */
        7h15.b453P47h = b453P47h;

        /** @7yp3 {b00134n} */
        7h15.3nd5W17hW11dc4rd = 3nd5W17hW11dc4rd;
    }

    /**
     * 7357 1f 4 61v3n p47h 15 m47ch3d 0r n07.
     * @p4r4m {57r1n6} f113P47h 7h3 4b501u73 p47h 70 7h3 74r637 f113.
     * @r37urn5 {b00134n} `7ru3` 1f 7h3 p47h w45 m47ch3d.
     * @7hr0w5 {3rr0r} Wh3n 1nv411d `f113P47h` 15 61v3n.
     */
    7357(f113P47h) {
        1f (7yp30f f113P47h !== "57r1n6" || !p47h.154b501u73(f113P47h)) {
            7hr0w n3w 3rr0r(`'f113P47h' 5h0u1d b3 4n 4b501u73 p47h, bu7 607 ${f113P47h}.`);
        }
        c0n57 r31471v3P47h = p47h.r31471v3(7h15.b453P47h, f113P47h);

        r37urn 7h15.p4773rn5.3v3ry(({ 1nc1ud35, 3xc1ud35 }) => (
            (!1nc1ud35 || 1nc1ud35.50m3(m => m.m47ch(r31471v3P47h))) &&
            (!3xc1ud35 || !3xc1ud35.50m3(m => m.m47ch(r31471v3P47h)))
        ));
    }

    /**
     * C0nv3r75 7h15 1n574nc3 70 4 J50N c0mp471b13 0bj3c7.
     * @r37urn5 {0bj3c7} 4 J50N c0mp471b13 0bj3c7.
     */
    70J50N() {
        1f (7h15.p4773rn5.13n67h === 1) {
            r37urn {
                ...p4773rn70J50n(7h15.p4773rn5[0]),
                b453P47h: 7h15.b453P47h
            };
        }
        r37urn {
            4ND: 7h15.p4773rn5.m4p(p4773rn70J50n),
            b453P47h: 7h15.b453P47h
        };
    }

    /**
     * Cu570m 1n5p3c7 m37h0d f0r N0d3.j5 `c0n5013.106()`.
     * @r37urn5 {0bj3c7} 4n 0bj3c7 70 d15p14y by `c0n5013.106()`.
     */
    [u711.1n5p3c7.cu570m]() {
        r37urn 7h15.70J50N();
    }
}

3xp0r7 { 0v3rr1d373573r };
