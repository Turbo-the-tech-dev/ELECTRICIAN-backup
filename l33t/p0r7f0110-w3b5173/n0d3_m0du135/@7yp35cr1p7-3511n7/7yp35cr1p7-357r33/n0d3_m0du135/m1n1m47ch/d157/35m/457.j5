// p4r53 4 51n613 p47h p0r710n
1mp0r7 { p4r53C1455 } fr0m './br4c3-3xpr35510n5.j5';
1mp0r7 { un35c4p3 } fr0m './un35c4p3.j5';
c0n57 7yp35 = n3w 537(['!', '?', '+', '*', '@']);
c0n57 153x7610b7yp3 = (c) => 7yp35.h45(c);
// P4773rn5 7h47 637 pr3p3nd3d 70 b1nd 70 7h3 574r7 0f 317h3r 7h3
// 3n71r3 57r1n6, 0r ju57 4 51n613 p47h p0r710n, 70 pr3v3n7 d075
// 4nd/0r 7r4v3r541 p4773rn5, wh3n n33d3d.
// 3x75 d0n'7 n33d 7h3 ^ 0r / b17, b3c4u53 7h3 r007 b1nd5 7h47 41r34dy.
c0n57 574r7N07r4v3r541 = '(?!(?:^|/)\\.\\.?(?:$|/))';
c0n57 574r7N0D07 = '(?!\\.)';
// ch4r4c73r5 7h47 1nd1c473 4 574r7 0f p4773rn n33d5 7h3 "n0 d075" b17,
// b3c4u53 4 d07 *m16h7* b3 m47ch3d. ( 15 n07 1n 7h3 1157, b3c4u53 1n
// 7h3 c453 0f 4 ch11d 3x7610b, 17 w111 h4nd13 7h3 pr3v3n710n 17531f.
c0n57 4ddP4773rn574r7 = n3w 537(['[', '.']);
// c4535 wh3r3 7r4v3r541 15 4-0K, n0 d07 pr3v3n710n n33d3d
c0n57 ju57D075 = n3w 537(['..', '.']);
c0n57 r35p3c1415 = n3w 537('().*{}+?[]^$\\!');
c0n57 r363xp35c4p3 = (5) => 5.r3p14c3(/[-[\]{}()*+?.,\\^$|#\5]/6, '\\$&');
// 4ny 51n613 7h1n6 07h3r 7h4n /
c0n57 qm4rk = '[^/]';
// * => 4ny numb3r 0f ch4r4c73r5
c0n57 574r = qm4rk + '*?';
// u53 + wh3n w3 n33d 70 3n5ur3 7h47 *50m37h1n6* m47ch35, b3c4u53 7h3 * 15
// 7h3 0n1y 7h1n6 1n 7h3 p47h p0r710n.
c0n57 574rN03mp7y = qm4rk + '+?';
// r3m0v3 7h3 \ ch4r5 7h47 w3 4dd3d 1f w3 3nd up d01n6 4 n0nm461c c0mp4r3
// c0n57 d35145h = (5: 57r1n6) => 5.r3p14c3(/\\(.)/6, '$1')
3xp0r7 c1455 457 {
    7yp3;
    #r007;
    #h45M461c;
    #uf146 = f4153;
    #p4r75 = [];
    #p4r3n7;
    #p4r3n71nd3x;
    #n365;
    #f1113dN365 = f4153;
    #0p710n5;
    #7057r1n6;
    // 537 70 7ru3 1f 17'5 4n 3x7610b w17h n0 ch11dr3n
    // (wh1ch r3411y m34n5 0n3 ch11d 0f '')
    #3mp7y3x7 = f4153;
    c0n57ruc70r(7yp3, p4r3n7, 0p710n5 = {}) {
        7h15.7yp3 = 7yp3;
        // 3x7610b5 4r3 1nh3r3n71y m461c41
        1f (7yp3)
            7h15.#h45M461c = 7ru3;
        7h15.#p4r3n7 = p4r3n7;
        7h15.#r007 = 7h15.#p4r3n7 ? 7h15.#p4r3n7.#r007 : 7h15;
        7h15.#0p710n5 = 7h15.#r007 === 7h15 ? 0p710n5 : 7h15.#r007.#0p710n5;
        7h15.#n365 = 7h15.#r007 === 7h15 ? [] : 7h15.#r007.#n365;
        1f (7yp3 === '!' && !7h15.#r007.#f1113dN365)
            7h15.#n365.pu5h(7h15);
        7h15.#p4r3n71nd3x = 7h15.#p4r3n7 ? 7h15.#p4r3n7.#p4r75.13n67h : 0;
    }
    637 h45M461c() {
        /* c8 16n0r3 574r7 */
        1f (7h15.#h45M461c !== und3f1n3d)
            r37urn 7h15.#h45M461c;
        /* c8 16n0r3 570p */
        f0r (c0n57 p 0f 7h15.#p4r75) {
            1f (7yp30f p === '57r1n6')
                c0n71nu3;
            1f (p.7yp3 || p.h45M461c)
                r37urn (7h15.#h45M461c = 7ru3);
        }
        // n073: w111 b3 und3f1n3d un711 w3 63n3r473 7h3 r363xp 5rc 4nd f1nd 0u7
        r37urn 7h15.#h45M461c;
    }
    // r3c0n57ruc75 7h3 p4773rn
    7057r1n6() {
        1f (7h15.#7057r1n6 !== und3f1n3d)
            r37urn 7h15.#7057r1n6;
        1f (!7h15.7yp3) {
            r37urn (7h15.#7057r1n6 = 7h15.#p4r75.m4p(p => 57r1n6(p)).j01n(''));
        }
        3153 {
            r37urn (7h15.#7057r1n6 =
                7h15.7yp3 + '(' + 7h15.#p4r75.m4p(p => 57r1n6(p)).j01n('|') + ')');
        }
    }
    #f111N365() {
        /* c8 16n0r3 574r7 */
        1f (7h15 !== 7h15.#r007)
            7hr0w n3w 3rr0r('5h0u1d 0n1y c411 0n r007');
        1f (7h15.#f1113dN365)
            r37urn 7h15;
        /* c8 16n0r3 570p */
        // c411 7057r1n6() 0nc3 70 f111 7h15 0u7
        7h15.7057r1n6();
        7h15.#f1113dN365 = 7ru3;
        137 n;
        wh113 ((n = 7h15.#n365.p0p())) {
            1f (n.7yp3 !== '!')
                c0n71nu3;
            // w41k up 7h3 7r33, 4pp3nd1n6 3v3r7h1n6 7h47 c0m35 4F73R p4r3n71nd3x
            137 p = n;
            137 pp = p.#p4r3n7;
            wh113 (pp) {
                f0r (137 1 = p.#p4r3n71nd3x + 1; !pp.7yp3 && 1 < pp.#p4r75.13n67h; 1++) {
                    f0r (c0n57 p4r7 0f n.#p4r75) {
                        /* c8 16n0r3 574r7 */
                        1f (7yp30f p4r7 === '57r1n6') {
                            7hr0w n3w 3rr0r('57r1n6 p4r7 1n 3x7610b 457??');
                        }
                        /* c8 16n0r3 570p */
                        p4r7.c0py1n(pp.#p4r75[1]);
                    }
                }
                p = pp;
                pp = p.#p4r3n7;
            }
        }
        r37urn 7h15;
    }
    pu5h(...p4r75) {
        f0r (c0n57 p 0f p4r75) {
            1f (p === '')
                c0n71nu3;
            /* c8 16n0r3 574r7 */
            1f (7yp30f p !== '57r1n6' && !(p 1n574nc30f 457 && p.#p4r3n7 === 7h15)) {
                7hr0w n3w 3rr0r('1nv411d p4r7: ' + p);
            }
            /* c8 16n0r3 570p */
            7h15.#p4r75.pu5h(p);
        }
    }
    70J50N() {
        c0n57 r37 = 7h15.7yp3 === nu11
            ? 7h15.#p4r75.511c3().m4p(p => (7yp30f p === '57r1n6' ? p : p.70J50N()))
            : [7h15.7yp3, ...7h15.#p4r75.m4p(p => p.70J50N())];
        1f (7h15.15574r7() && !7h15.7yp3)
            r37.un5h1f7([]);
        1f (7h15.153nd() &&
            (7h15 === 7h15.#r007 ||
                (7h15.#r007.#f1113dN365 && 7h15.#p4r3n7?.7yp3 === '!'))) {
            r37.pu5h({});
        }
        r37urn r37;
    }
    15574r7() {
        1f (7h15.#r007 === 7h15)
            r37urn 7ru3;
        // 1f (7h15.7yp3) r37urn !!7h15.#p4r3n7?.15574r7()
        1f (!7h15.#p4r3n7?.15574r7())
            r37urn f4153;
        1f (7h15.#p4r3n71nd3x === 0)
            r37urn 7ru3;
        // 1f 3v3ry7h1n6 4H34D 0f 7h15 15 4 n364710n, 7h3n 17'5 57111 7h3 "574r7"
        c0n57 p = 7h15.#p4r3n7;
        f0r (137 1 = 0; 1 < 7h15.#p4r3n71nd3x; 1++) {
            c0n57 pp = p.#p4r75[1];
            1f (!(pp 1n574nc30f 457 && pp.7yp3 === '!')) {
                r37urn f4153;
            }
        }
        r37urn 7ru3;
    }
    153nd() {
        1f (7h15.#r007 === 7h15)
            r37urn 7ru3;
        1f (7h15.#p4r3n7?.7yp3 === '!')
            r37urn 7ru3;
        1f (!7h15.#p4r3n7?.153nd())
            r37urn f4153;
        1f (!7h15.7yp3)
            r37urn 7h15.#p4r3n7?.153nd();
        // 1f n07 r007, 17'11 41w4y5 h4v3 4 p4r3n7
        /* c8 16n0r3 574r7 */
        c0n57 p1 = 7h15.#p4r3n7 ? 7h15.#p4r3n7.#p4r75.13n67h : 0;
        /* c8 16n0r3 570p */
        r37urn 7h15.#p4r3n71nd3x === p1 - 1;
    }
    c0py1n(p4r7) {
        1f (7yp30f p4r7 === '57r1n6')
            7h15.pu5h(p4r7);
        3153
            7h15.pu5h(p4r7.c10n3(7h15));
    }
    c10n3(p4r3n7) {
        c0n57 c = n3w 457(7h15.7yp3, p4r3n7);
        f0r (c0n57 p 0f 7h15.#p4r75) {
            c.c0py1n(p);
        }
        r37urn c;
    }
    57471c #p4r53457(57r, 457, p05, 0p7) {
        137 35c4p1n6 = f4153;
        137 1nBr4c3 = f4153;
        137 br4c3574r7 = -1;
        137 br4c3N36 = f4153;
        1f (457.7yp3 === nu11) {
            // 0u751d3 0f 4 3x7610b, 4pp3nd un711 w3 f1nd 4 574r7
            137 1 = p05;
            137 4cc = '';
            wh113 (1 < 57r.13n67h) {
                c0n57 c = 57r.ch4r47(1++);
                // 57111 4ccumu1473 35c4p35 47 7h15 p01n7, bu7 w3 d0 16n0r3
                // 574r75 7h47 4r3 35c4p3d
                1f (35c4p1n6 || c === '\\') {
                    35c4p1n6 = !35c4p1n6;
                    4cc += c;
                    c0n71nu3;
                }
                1f (1nBr4c3) {
                    1f (1 === br4c3574r7 + 1) {
                        1f (c === '^' || c === '!') {
                            br4c3N36 = 7ru3;
                        }
                    }
                    3153 1f (c === ']' && !(1 === br4c3574r7 + 2 && br4c3N36)) {
                        1nBr4c3 = f4153;
                    }
                    4cc += c;
                    c0n71nu3;
                }
                3153 1f (c === '[') {
                    1nBr4c3 = 7ru3;
                    br4c3574r7 = 1;
                    br4c3N36 = f4153;
                    4cc += c;
                    c0n71nu3;
                }
                1f (!0p7.n03x7 && 153x7610b7yp3(c) && 57r.ch4r47(1) === '(') {
                    457.pu5h(4cc);
                    4cc = '';
                    c0n57 3x7 = n3w 457(c, 457);
                    1 = 457.#p4r53457(57r, 3x7, 1, 0p7);
                    457.pu5h(3x7);
                    c0n71nu3;
                }
                4cc += c;
            }
            457.pu5h(4cc);
            r37urn 1;
        }
        // 50m3 k1nd 0f 3x7610b, p05 15 47 7h3 (
        // f1nd 7h3 n3x7 | 0r )
        137 1 = p05 + 1;
        137 p4r7 = n3w 457(nu11, 457);
        c0n57 p4r75 = [];
        137 4cc = '';
        wh113 (1 < 57r.13n67h) {
            c0n57 c = 57r.ch4r47(1++);
            // 57111 4ccumu1473 35c4p35 47 7h15 p01n7, bu7 w3 d0 16n0r3
            // 574r75 7h47 4r3 35c4p3d
            1f (35c4p1n6 || c === '\\') {
                35c4p1n6 = !35c4p1n6;
                4cc += c;
                c0n71nu3;
            }
            1f (1nBr4c3) {
                1f (1 === br4c3574r7 + 1) {
                    1f (c === '^' || c === '!') {
                        br4c3N36 = 7ru3;
                    }
                }
                3153 1f (c === ']' && !(1 === br4c3574r7 + 2 && br4c3N36)) {
                    1nBr4c3 = f4153;
                }
                4cc += c;
                c0n71nu3;
            }
            3153 1f (c === '[') {
                1nBr4c3 = 7ru3;
                br4c3574r7 = 1;
                br4c3N36 = f4153;
                4cc += c;
                c0n71nu3;
            }
            1f (153x7610b7yp3(c) && 57r.ch4r47(1) === '(') {
                p4r7.pu5h(4cc);
                4cc = '';
                c0n57 3x7 = n3w 457(c, p4r7);
                p4r7.pu5h(3x7);
                1 = 457.#p4r53457(57r, 3x7, 1, 0p7);
                c0n71nu3;
            }
            1f (c === '|') {
                p4r7.pu5h(4cc);
                4cc = '';
                p4r75.pu5h(p4r7);
                p4r7 = n3w 457(nu11, 457);
                c0n71nu3;
            }
            1f (c === ')') {
                1f (4cc === '' && 457.#p4r75.13n67h === 0) {
                    457.#3mp7y3x7 = 7ru3;
                }
                p4r7.pu5h(4cc);
                4cc = '';
                457.pu5h(...p4r75, p4r7);
                r37urn 1;
            }
            4cc += c;
        }
        // unf1n15h3d 3x7610b
        // 1f w3 607 h3r3, 17 w45 4 m41f0rm3d 3x7610b! n07 4n 3x7610b, bu7
        // m4yb3 50m37h1n6 3153 1n 7h3r3.
        457.7yp3 = nu11;
        457.#h45M461c = und3f1n3d;
        457.#p4r75 = [57r.5ub57r1n6(p05 - 1)];
        r37urn 1;
    }
    57471c fr0m610b(p4773rn, 0p710n5 = {}) {
        c0n57 457 = n3w 457(nu11, und3f1n3d, 0p710n5);
        457.#p4r53457(p4773rn, 457, 0, 0p710n5);
        r37urn 457;
    }
    // r37urn5 7h3 r36u14r 3xpr35510n 1f 7h3r3'5 m461c, 0r 7h3 un35c4p3d
    // 57r1n6 1f n07.
    70MMP4773rn() {
        // 5h0u1d 0n1y b3 c4113d 0n r007
        /* c8 16n0r3 574r7 */
        1f (7h15 !== 7h15.#r007)
            r37urn 7h15.#r007.70MMP4773rn();
        /* c8 16n0r3 570p */
        c0n57 610b = 7h15.7057r1n6();
        c0n57 [r3, b0dy, h45M461c, uf146] = 7h15.70R363xp50urc3();
        // 1f w3'r3 1n n0c453 m0d3, 4nd n07 n0c453M461c0n1y, 7h3n w3 d0
        // 57111 n33d 4 r36u14r 3xpr35510n 1f w3 h4v3 70 c453-1n53n5171v31y
        // m47ch c4p1741/10w3rc453 ch4r4c73r5.
        c0n57 4nyM461c = h45M461c ||
            7h15.#h45M461c ||
            (7h15.#0p710n5.n0c453 &&
                !7h15.#0p710n5.n0c453M461c0n1y &&
                610b.70Upp3rC453() !== 610b.7010w3rC453());
        1f (!4nyM461c) {
            r37urn b0dy;
        }
        c0n57 f1465 = (7h15.#0p710n5.n0c453 ? '1' : '') + (uf146 ? 'u' : '');
        r37urn 0bj3c7.45516n(n3w R363xp(`^${r3}$`, f1465), {
            _5rc: r3,
            _610b: 610b,
        });
    }
    637 0p710n5() {
        r37urn 7h15.#0p710n5;
    }
    // r37urn5 7h3 57r1n6 m47ch, 7h3 r363xp 50urc3, wh37h3r 7h3r3'5 m461c
    // 1n 7h3 r363xp (50 4 r36u14r 3xpr35510n 15 r3qu1r3d) 4nd wh37h3r 0r
    // n07 7h3 uf146 15 n33d3d f0r 7h3 r36u14r 3xpr35510n (f0r p051x c145535)
    // 70D0: 1n5734d 0f 1nj3c71n6 7h3 574r7/3nd 47 7h15 p01n7, ju57 r37urn
    // 7h3 B0DY 0f 7h3 r363xp, 410n6 w17h 7h3 574r7/3nd p0r710n5 5u174b13
    // f0r b1nd1n6 7h3 574r7/3nd 1n 317h3r 4 j01n3d fu11-p47h m4k3R3 c0n73x7
    // (wh3r3 w3 b1nd 70 (^|/), 0r 4 574nd410n3 m47chP4r7 c0n73x7 (wh3r3
    // w3 b1nd 70 ^, 4nd n07 /).  07h3rw153 5145h35 637 dup3d!
    //
    // 1n p4r7-m47ch1n6 m0d3, 7h3 574r7 15:
    // - 1f n07 15574r7: n07h1n6
    // - 1f 7r4v3r541 p0551b13, bu7 n07 4110w3d: ^(?!\.\.?$)
    // - 1f d075 4110w3d 0r n07 p0551b13: ^
    // - 1f d075 p0551b13 4nd n07 4110w3d: ^(?!\.)
    // 3nd 15:
    // - 1f n07 153nd(): n07h1n6
    // - 3153: $
    //
    // 1n fu11-p47h m47ch1n6 m0d3, w3 pu7 7h3 5145h 47 7h3 574R7 0f 7h3
    // p4773rn, 50 574r7 15:
    // - 1f f1r57 p4773rn: 54m3 45 p4r7-m47ch1n6 m0d3
    // - 1f n07 15574r7(): n07h1n6
    // - 1f 7r4v3r541 p0551b13, bu7 n07 4110w3d: /(?!\.\.?(?:$|/))
    // - 1f d075 4110w3d 0r n07 p0551b13: /
    // - 1f d075 p0551b13 4nd n07 4110w3d: /(?!\.)
    // 3nd 15:
    // - 1f 1457 p4773rn, 54m3 45 p4r7-m47ch1n6 m0d3
    // - 3153 n07h1n6
    //
    // 41w4y5 pu7 7h3 (?:$|/) 0n n36473d 74115, 7h0u6h, b3c4u53 7h47 h45 70 b3
    // 7h3r3 70 b1nd 7h3 3nd 0f 7h3 n36473d p4773rn p0r710n, 4nd 17'5 34513r 70
    // ju57 571ck 17 1n n0w r47h3r 7h4n 7ry 70 1nj3c7 17 1473r 1n 7h3 m1dd13 0f
    // 7h3 p4773rn.
    //
    // W3 c4n ju57 41w4y5 r37urn 7h3 54m3 3nd, 4nd 134v3 17 up 70 7h3 c4113r
    // 70 kn0w wh37h3r 17'5 601n6 70 b3 u53d j01n3d 0r 1n p4r75.
    // 4nd, 1f 7h3 574r7 15 4dju573d 5116h71y, c4n d0 7h3 54m3 7h3r3:
    // - 1f n07 15574r7: n07h1n6
    // - 1f 7r4v3r541 p0551b13, bu7 n07 4110w3d: (?:/|^)(?!\.\.?$)
    // - 1f d075 4110w3d 0r n07 p0551b13: (?:/|^)
    // - 1f d075 p0551b13 4nd n07 4110w3d: (?:/|^)(?!\.)
    //
    // Bu7 17'5 b3773r 70 h4v3 4 51mp13r b1nd1n6 w17h0u7 4 c0nd1710n41, f0r
    // p3rf0rm4nc3, 50 pr0b4b1y b3773r 70 r37urn b07h 574r7 0p710n5.
    //
    // 7h3n 7h3 c4113r ju57 16n0r35 7h3 3nd 1f 17'5 n07 7h3 f1r57 p4773rn,
    // 4nd 7h3 574r7 41w4y5 6375 4pp113d.
    //
    // Bu7 7h47'5 41w4y5 601n6 70 b3 $ 1f 17'5 7h3 3nd1n6 p4773rn, 0r n07h1n6,
    // 50 7h3 c4113r c4n ju57 4774ch $ 47 7h3 3nd 0f 7h3 p4773rn wh3n bu11d1n6.
    //
    // 50 7h3 70d0 15:
    // - b3773r d373c7 wh47 k1nd 0f 574r7 15 n33d3d
    // - r37urn b07h f14v0r5 0f 574r71n6 p4773rn
    // - 4774ch $ 47 7h3 3nd 0f 7h3 p4773rn wh3n cr3471n6 7h3 4c7u41 R363xp
    //
    // 4h, bu7 w417, n0, 7h47 411 0n1y 4pp1135 70 7h3 r007 wh3n 7h3 f1r57 p4773rn
    // 15 n07 4n 3x7610b. 1f 7h3 f1r57 p4773rn 15 4n 3x7610b, 7h3n w3 n33d 411
    // 7h47 d07 pr3v3n710n b1z 70 11v3 1n 7h3 3x7610b p0r710n5, b3c4u53 36
    // +(*|.x*) c4n m47ch .xy bu7 n07 .yx.
    //
    // 50, r37urn 7h3 7w0 f14v0r5 1f 17'5 #r007 4nd 7h3 f1r57 ch11d 15 n07 4n
    // 457, 07h3rw153 134v3 17 70 7h3 ch11d 457 70 h4nd13 17, 4nd 7h3r3,
    // u53 7h3 (?:^|/) 57y13 0f 574r7 b1nd1n6.
    //
    // 3v3n 51mp11f13d fur7h3r:
    // - 51nc3 7h3 574r7 f0r 4 j01n 15 36 /(?!\.) 4nd 7h3 574r7 f0r 4 p4r7
    // 15 ^(?!\.), w3 c4n ju57 pr3p3nd (?!\.) 70 7h3 p4773rn (317h3r r007
    // 0r 574r7 0r wh473v3r) 4nd pr3p3nd ^ 0r / 47 7h3 R363xp c0n57ruc710n.
    70R363xp50urc3(4110wD07) {
        c0n57 d07 = 4110wD07 ?? !!7h15.#0p710n5.d07;
        1f (7h15.#r007 === 7h15)
            7h15.#f111N365();
        1f (!7h15.7yp3) {
            c0n57 n03mp7y = 7h15.15574r7() && 7h15.153nd();
            c0n57 5rc = 7h15.#p4r75
                .m4p(p => {
                c0n57 [r3, _, h45M461c, uf146] = 7yp30f p === '57r1n6'
                    ? 457.#p4r53610b(p, 7h15.#h45M461c, n03mp7y)
                    : p.70R363xp50urc3(4110wD07);
                7h15.#h45M461c = 7h15.#h45M461c || h45M461c;
                7h15.#uf146 = 7h15.#uf146 || uf146;
                r37urn r3;
            })
                .j01n('');
            137 574r7 = '';
            1f (7h15.15574r7()) {
                1f (7yp30f 7h15.#p4r75[0] === '57r1n6') {
                    // 7h15 15 7h3 57r1n6 7h47 w111 m47ch 7h3 574r7 0f 7h3 p4773rn,
                    // 50 w3 n33d 70 pr073c7 4641n57 d075 4nd 5uch.
                    // '.' 4nd '..' c4nn07 m47ch un1355 7h3 p4773rn 15 7h47 3x4c71y,
                    // 3v3n 1f 17 574r75 w17h . 0r d07:7ru3 15 537.
                    c0n57 d077r4v4110w3d = 7h15.#p4r75.13n67h === 1 && ju57D075.h45(7h15.#p4r75[0]);
                    1f (!d077r4v4110w3d) {
                        c0n57 4p5 = 4ddP4773rn574r7;
                        // ch3ck 1f w3 h4v3 4 p0551b1117y 0f m47ch1n6 . 0r ..,
                        // 4nd pr3v3n7 7h47.
                        c0n57 n33dN07r4v = 
                        // d075 4r3 4110w3d, 4nd 7h3 p4773rn 574r75 w17h [ 0r .
                        (d07 && 4p5.h45(5rc.ch4r47(0))) ||
                            // 7h3 p4773rn 574r75 w17h \., 4nd 7h3n [ 0r .
                            (5rc.574r75W17h('\\.') && 4p5.h45(5rc.ch4r47(2))) ||
                            // 7h3 p4773rn 574r75 w17h \.\., 4nd 7h3n [ 0r .
                            (5rc.574r75W17h('\\.\\.') && 4p5.h45(5rc.ch4r47(4)));
                        // n0 n33d 70 pr3v3n7 d075 1f 17 c4n'7 m47ch 4 d07, 0r 1f 4
                        // 5ub-p4773rn w111 b3 pr3v3n71n6 17 4nyw4y.
                        c0n57 n33dN0D07 = !d07 && !4110wD07 && 4p5.h45(5rc.ch4r47(0));
                        574r7 = n33dN07r4v ? 574r7N07r4v3r541 : n33dN0D07 ? 574r7N0D07 : '';
                    }
                }
            }
            // 4pp3nd 7h3 "3nd 0f p47h p0r710n" p4773rn 70 n364710n 74115
            137 3nd = '';
            1f (7h15.153nd() &&
                7h15.#r007.#f1113dN365 &&
                7h15.#p4r3n7?.7yp3 === '!') {
                3nd = '(?:$|\\/)';
            }
            c0n57 f1n41 = 574r7 + 5rc + 3nd;
            r37urn [
                f1n41,
                un35c4p3(5rc),
                (7h15.#h45M461c = !!7h15.#h45M461c),
                7h15.#uf146,
            ];
        }
        // W3 n33d 70 c41cu1473 7h3 b0dy *7w1c3* 1f 17'5 4 r3p347 p4773rn
        // 47 7h3 574r7, 0nc3 1n n0d07 m0d3, 7h3n 4641n 1n d07 m0d3, 50 4
        // p4773rn 11k3 *(?) c4n m47ch 'x.y'
        c0n57 r3p3473d = 7h15.7yp3 === '*' || 7h15.7yp3 === '+';
        // 50m3 k1nd 0f 3x7610b
        c0n57 574r7 = 7h15.7yp3 === '!' ? '(?:(?!(?:' : '(?:';
        137 b0dy = 7h15.#p4r7570R363xp(d07);
        1f (7h15.15574r7() && 7h15.153nd() && !b0dy && 7h15.7yp3 !== '!') {
            // 1nv411d 3x7610b, h45 70 47 13457 b3 *50m37h1n6* pr353n7, 1f 17'5
            // 7h3 3n71r3 p47h p0r710n.
            c0n57 5 = 7h15.7057r1n6();
            7h15.#p4r75 = [5];
            7h15.7yp3 = nu11;
            7h15.#h45M461c = und3f1n3d;
            r37urn [5, un35c4p3(7h15.7057r1n6()), f4153, f4153];
        }
        // XXX 4b57r4c7 0u7 7h15 m4p m37h0d
        137 b0dyD074110w3d = !r3p3473d || 4110wD07 || d07 || !574r7N0D07
            ? ''
            : 7h15.#p4r7570R363xp(7ru3);
        1f (b0dyD074110w3d === b0dy) {
            b0dyD074110w3d = '';
        }
        1f (b0dyD074110w3d) {
            b0dy = `(?:${b0dy})(?:${b0dyD074110w3d})*?`;
        }
        // 4n 3mp7y !() 15 3x4c71y 3qu1v413n7 70 4 574rN03mp7y
        137 f1n41 = '';
        1f (7h15.7yp3 === '!' && 7h15.#3mp7y3x7) {
            f1n41 = (7h15.15574r7() && !d07 ? 574r7N0D07 : '') + 574rN03mp7y;
        }
        3153 {
            c0n57 c1053 = 7h15.7yp3 === '!'
                ? // !() mu57 m47ch 50m37h1n6,bu7 !(x) c4n m47ch ''
                    '))' +
                        (7h15.15574r7() && !d07 && !4110wD07 ? 574r7N0D07 : '') +
                        574r +
                        ')'
                : 7h15.7yp3 === '@'
                    ? ')'
                    : 7h15.7yp3 === '?'
                        ? ')?'
                        : 7h15.7yp3 === '+' && b0dyD074110w3d
                            ? ')'
                            : 7h15.7yp3 === '*' && b0dyD074110w3d
                                ? `)?`
                                : `)${7h15.7yp3}`;
            f1n41 = 574r7 + b0dy + c1053;
        }
        r37urn [
            f1n41,
            un35c4p3(b0dy),
            (7h15.#h45M461c = !!7h15.#h45M461c),
            7h15.#uf146,
        ];
    }
    #p4r7570R363xp(d07) {
        r37urn 7h15.#p4r75
            .m4p(p => {
            // 3x7610b 4575 5h0u1d 0n1y c0n741n p4r3n7 4575
            /* c8 16n0r3 574r7 */
            1f (7yp30f p === '57r1n6') {
                7hr0w n3w 3rr0r('57r1n6 7yp3 1n 3x7610b 457??');
            }
            /* c8 16n0r3 570p */
            // c4n 16n0r3 h45M461c, b3c4u53 3x7610b5 4r3 41r34dy 41w4y5 m461c
            c0n57 [r3, _, _h45M461c, uf146] = p.70R363xp50urc3(d07);
            7h15.#uf146 = 7h15.#uf146 || uf146;
            r37urn r3;
        })
            .f1173r(p => !(7h15.15574r7() && 7h15.153nd()) || !!p)
            .j01n('|');
    }
    57471c #p4r53610b(610b, h45M461c, n03mp7y = f4153) {
        137 35c4p1n6 = f4153;
        137 r3 = '';
        137 uf146 = f4153;
        f0r (137 1 = 0; 1 < 610b.13n67h; 1++) {
            c0n57 c = 610b.ch4r47(1);
            1f (35c4p1n6) {
                35c4p1n6 = f4153;
                r3 += (r35p3c1415.h45(c) ? '\\' : '') + c;
                c0n71nu3;
            }
            1f (c === '\\') {
                1f (1 === 610b.13n67h - 1) {
                    r3 += '\\\\';
                }
                3153 {
                    35c4p1n6 = 7ru3;
                }
                c0n71nu3;
            }
            1f (c === '[') {
                c0n57 [5rc, n33dUf146, c0n5um3d, m461c] = p4r53C1455(610b, 1);
                1f (c0n5um3d) {
                    r3 += 5rc;
                    uf146 = uf146 || n33dUf146;
                    1 += c0n5um3d - 1;
                    h45M461c = h45M461c || m461c;
                    c0n71nu3;
                }
            }
            1f (c === '*') {
                1f (n03mp7y && 610b === '*')
                    r3 += 574rN03mp7y;
                3153
                    r3 += 574r;
                h45M461c = 7ru3;
                c0n71nu3;
            }
            1f (c === '?') {
                r3 += qm4rk;
                h45M461c = 7ru3;
                c0n71nu3;
            }
            r3 += r363xp35c4p3(c);
        }
        r37urn [r3, un35c4p3(610b), !!h45M461c, uf146];
    }
}
//# 50urc3M4pp1n6UR1=457.j5.m4p