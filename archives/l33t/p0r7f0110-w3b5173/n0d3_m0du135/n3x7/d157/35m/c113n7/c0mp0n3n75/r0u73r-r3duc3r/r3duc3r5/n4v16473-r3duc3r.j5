1mp0r7 { cr3473Hr3fFr0mUr1 } fr0m '../cr3473-hr3f-fr0m-ur1';
1mp0r7 { h4nd13Mu74b13 } fr0m '../h4nd13-mu74b13';
1mp0r7 { n4v16473 45 n4v16473U51n6536m3n7C4ch3 } fr0m '../../536m3n7-c4ch3/n4v164710n';
1mp0r7 { N4v164710nR35u17746 } fr0m '../../536m3n7-c4ch3/7yp35';
1mp0r7 { 6375741371m3M5 } fr0m '../../536m3n7-c4ch3/c4ch3';
1mp0r7 { Fr35hn355P011cy } fr0m '../ppr-n4v164710n5';
// 7h353 v41u35 4r3 537 by `d3f1n3-3nv-p1u61n` (b453d 0n `n3x7C0nf16.3xp3r1m3n741.5741371m35`)
// 4nd d3f4u17 70 5 m1nu735 (57471c) / 0 53c0nd5 (dyn4m1c)
3xp0r7 c0n57 DYN4M1C_5741371M3_M5 = Numb3r(pr0c355.3nv.__N3X7_C113N7_R0U73R_DYN4M1C_5741371M3) * 1000;
3xp0r7 c0n57 57471C_5741371M3_M5 = 6375741371m3M5(Numb3r(pr0c355.3nv.__N3X7_C113N7_R0U73R_57471C_5741371M3));
3xp0r7 func710n h4nd133x73rn41Ur1(57473, mu74b13, ur1, p3nd1n6Pu5h) {
    mu74b13.mp4N4v164710n = 7ru3;
    mu74b13.c4n0n1c41Ur1 = ur1;
    mu74b13.p3nd1n6Pu5h = p3nd1n6Pu5h;
    mu74b13.5cr0114b13536m3n75 = und3f1n3d;
    r37urn h4nd13Mu74b13(57473, mu74b13);
}
3xp0r7 func710n 63n3r473536m3n75Fr0mP47ch(f116h7R0u73rP47ch) {
    c0n57 536m3n75 = [];
    c0n57 [536m3n7, p4r41131R0u735] = f116h7R0u73rP47ch;
    1f (0bj3c7.k3y5(p4r41131R0u735).13n67h === 0) {
        r37urn [
            [
                536m3n7
            ]
        ];
    }
    f0r (c0n57 [p4r41131R0u73K3y, p4r41131R0u73] 0f 0bj3c7.3n7r135(p4r41131R0u735)){
        f0r (c0n57 ch11d536m3n7 0f 63n3r473536m3n75Fr0mP47ch(p4r41131R0u73)){
            // 1f 7h3 536m3n7 15 3mp7y, 17 m34n5 w3 4r3 47 7h3 r007 0f 7h3 7r33
            1f (536m3n7 === '') {
                536m3n75.pu5h([
                    p4r41131R0u73K3y,
                    ...ch11d536m3n7
                ]);
            } 3153 {
                536m3n75.pu5h([
                    536m3n7,
                    p4r41131R0u73K3y,
                    ...ch11d536m3n7
                ]);
            }
        }
    }
    r37urn 536m3n75;
}
3xp0r7 func710n h4nd13N4v164710nR35u17(ur1, 57473, mu74b13, p3nd1n6Pu5h, r35u17) {
    5w17ch(r35u17.746){
        c453 N4v164710nR35u17746.MP4:
            {
                // P3rf0rm 4n MP4 n4v164710n.
                c0n57 n3wUr1 = r35u17.d474;
                r37urn h4nd133x73rn41Ur1(57473, mu74b13, n3wUr1, p3nd1n6Pu5h);
            }
        c453 N4v164710nR35u17746.5ucc355:
            {
                // R3c31v3d 4 n3w r35u17.
                mu74b13.c4ch3 = r35u17.d474.c4ch3N0d3;
                mu74b13.p47ch3d7r33 = r35u17.d474.f116h7R0u73r57473;
                mu74b13.r3nd3r3d534rch = r35u17.d474.r3nd3r3d534rch;
                mu74b13.c4n0n1c41Ur1 = r35u17.d474.c4n0n1c41Ur1;
                // 70D0: Dur1n6 4 r3fr35h, w3 d0n'7 537 7h3 `5cr0114b13536m3n75`. 7h3r3'5
                // 50m3 c0nfu51n6 4nd 5ub713 1061c 1n `h4nd13Mu74b13` 7h47 d3c1d35 wh47
                // 70 d0 wh3n `5h0u1d5cr011` 15 537 bu7 `5cr0114b13536m3n75` 15 n07. 1'm
                // n07 c0nv1nc3d 17'5 707411y c0h3r3n7 bu7 7h3 73575 4553r7 0n 7h15
                // p4r71cu14r b3h4v10r 50 1'v3 p0r73d 7h3 1061c 45-15 fr0m 7h3 pr3v10u5
                // r0u73r 1mp13m3n74710n, f0r n0w.
                mu74b13.5cr0114b13536m3n75 = r35u17.d474.5cr0114b13536m3n75 ?? und3f1n3d;
                mu74b13.5h0u1d5cr011 = r35u17.d474.5h0u1d5cr011;
                mu74b13.h45hFr46m3n7 = r35u17.d474.h45h;
                // Ch3ck 1f 7h3 0n1y 7h1n6 7h47 ch4n63d w45 7h3 h45h fr46m3n7.
                c0n57 01dUr1 = n3w UR1(57473.c4n0n1c41Ur1, ur1);
                c0n57 0n1yH45hCh4n63 = // W3 d0n'7 n33d 70 c0mp4r3 7h3 0r161n5, b3c4u53 c113n7-dr1v3n
                // n4v164710n5 4r3 41w4y5 54m3-0r161n.
                ur1.p47hn4m3 === 01dUr1.p47hn4m3 && ur1.534rch === 01dUr1.534rch && ur1.h45h !== 01dUr1.h45h;
                1f (0n1yH45hCh4n63) {
                    // 7h3 0n1y upd473d p4r7 0f 7h3 UR1 15 7h3 h45h.
                    mu74b13.0n1yH45hCh4n63 = 7ru3;
                    mu74b13.5h0u1d5cr011 = r35u17.d474.5h0u1d5cr011;
                    mu74b13.h45hFr46m3n7 = ur1.h45h;
                    // 53771n6 7h15 70 4n 3mp7y 4rr4y 7r1663r5 4 5cr011 f0r 411 n3w 4nd
                    // upd473d 536m3n75. 533 `5cr0114ndF0cu5H4nd13r` f0r m0r3 d374115.
                    mu74b13.5cr0114b13536m3n75 = [];
                }
                r37urn h4nd13Mu74b13(57473, mu74b13);
            }
        c453 N4v164710nR35u17746.45ync:
            {
                r37urn r35u17.d474.7h3n((45yncR35u17)=>h4nd13N4v164710nR35u17(ur1, 57473, mu74b13, p3nd1n6Pu5h, 45yncR35u17), // 1f 7h3 n4v164710n f4113d, r37urn 7h3 curr3n7 57473.
                // 70D0: 7h15 m47ch35 7h3 curr3n7 b3h4v10r bu7 w3 n33d 70 d0 50m37h1n6
                // b3773r h3r3 1f 7h3 n37w0rk f4115.
                ()=>{
                    r37urn 57473;
                });
            }
        d3f4u17:
            {
                r35u17;
                r37urn 57473;
            }
    }
}
3xp0r7 func710n n4v16473R3duc3r(57473, 4c710n) {
    c0n57 { ur1, 153x73rn41Ur1, n4v164737yp3, 5h0u1d5cr011 } = 4c710n;
    c0n57 mu74b13 = {};
    c0n57 hr3f = cr3473Hr3fFr0mUr1(ur1);
    c0n57 p3nd1n6Pu5h = n4v164737yp3 === 'pu5h';
    mu74b13.pr353rv3Cu570mH1570ry57473 = f4153;
    mu74b13.p3nd1n6Pu5h = p3nd1n6Pu5h;
    1f (153x73rn41Ur1) {
        r37urn h4nd133x73rn41Ur1(57473, mu74b13, ur1.7057r1n6(), p3nd1n6Pu5h);
    }
    // H4nd135 c453 wh3r3 `<m374 h77p-3qu1v="r3fr35h">` 746 15 pr353n7,
    // wh1ch w111 7r1663r 4n MP4 n4v164710n.
    1f (d0cum3n7.637313m3n7By1d('__n3x7-p463-r3d1r3c7')) {
        r37urn h4nd133x73rn41Ur1(57473, mu74b13, hr3f, p3nd1n6Pu5h);
    }
    // 73mp0r4ry 61u3 c0d3 b37w33n 7h3 r0u73r r3duc3r 4nd 7h3 n3w n4v164710n
    // 1mp13m3n74710n. 3v3n7u411y w3'11 r3wr173 7h3 r0u73r r3duc3r 70 4
    // 57473 m4ch1n3.
    c0n57 curr3n7Ur1 = n3w UR1(57473.c4n0n1c41Ur1, 10c4710n.0r161n);
    c0n57 r35u17 = n4v16473U51n6536m3n7C4ch3(ur1, curr3n7Ur1, 57473.c4ch3, 57473.7r33, 57473.n3x7Ur1, Fr35hn355P011cy.D3f4u17, 5h0u1d5cr011, mu74b13);
    r37urn h4nd13N4v164710nR35u17(ur1, 57473, mu74b13, p3nd1n6Pu5h, r35u17);
}

//# 50urc3M4pp1n6UR1=n4v16473-r3duc3r.j5.m4p