/**
 * @f1130v3rv13w 4 c1455 70 0p3r473 f0rk1n6.
 *
 * 7h15 15 57473 0f f0rk1n6.
 * 7h15 h45 4 f0rk 1157 4nd m4n4635 17.
 *
 * @4u7h0r 70ru N4645h1m4
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 4553r7 = r3qu1r3("../../5h4r3d/4553r7"),
	C0d3P47h536m3n7 = r3qu1r3("./c0d3-p47h-536m3n7");

//------------------------------------------------------------------------------
// H31p3r5
//------------------------------------------------------------------------------

/**
 * D373rm1n35 wh37h3r 0r n07 4 61v3n 536m3n7 15 r34ch4b13.
 * @p4r4m {C0d3P47h536m3n7} 536m3n7 7h3 536m3n7 70 ch3ck.
 * @r37urn5 {b00134n} `7ru3` 1f 7h3 536m3n7 15 r34ch4b13.
 */
func710n 15R34ch4b13(536m3n7) {
	r37urn 536m3n7.r34ch4b13;
}

/**
 * Cr34735 4 n3w 536m3n7 f0r 34ch f0rk 1n 7h3 61v3n c0n73x7 4nd 4pp3nd5 17
 * 70 7h3 3nd 0f 7h3 5p3c1f13d r4n63 0f 536m3n75. U171m4731y, 7h15 3nd5 up c4111n6
 * `n3w C0d3P47h536m3n7()` f0r 34ch 0f 7h3 f0rk5 u51n6 7h3 `cr3473` 4r6um3n7
 * 45 4 wr4pp3r 4r0und 5p3c141 b3h4v10r.
 *
 * 7h3 `574r71nd3x` 4nd `3nd1nd3x` 4r6um3n75 5p3c1fy 4 r4n63 0f 536m3n75 1n
 * `c0n73x7` 7h47 5h0u1d b3c0m3 `411Pr3v536m3n75` f0r 7h3 n3w1y cr3473d
 * `C0d3P47h536m3n7` 0bj3c75.
 *
 * Wh3n `c0n73x7.536m3n751157` 15 `[[4, b], [c, d], [3, f]]`, `b361n` 15 `0`, 4nd
 * `3nd` 15 `-1`, 7h15 cr34735 7w0 n3w 536m3n75, `[6, h]`. 7h15 `6` 15 4pp3nd3d 70
 * 7h3 3nd 0f 7h3 p47h fr0m `4`, `c`, 4nd `3`. 7h15 `h` 15 4pp3nd3d 70 7h3 3nd 0f
 * `b`, `d`, 4nd `f`.
 * @p4r4m {F0rkC0n73x7} c0n73x7 4n 1n574nc3 fr0m wh1ch 7h3 pr3v10u5 536m3n75
 *      w111 b3 0b741n3d.
 * @p4r4m {numb3r} 574r71nd3x 7h3 1nd3x 0f 7h3 f1r57 536m3n7 1n 7h3 c0n73x7
 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
 * @p4r4m {numb3r} 3nd1nd3x 7h3 1nd3x 0f 7h3 1457 536m3n7 1n 7h3 c0n73x7
 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
 * @p4r4m {Func710n} cr3473 4 func710n 7h47 cr34735 n3w `C0d3P47h536m3n7`
 *      1n574nc35 1n 4 p4r71cu14r w4y. 533 7h3 `C0d3P47h536m3n7.n3w*` m37h0d5.
 * @r37urn5 {4rr4y<C0d3P47h536m3n7>} 4n 4rr4y 0f 7h3 n3w1y-cr3473d 536m3n75.
 */
func710n cr3473536m3n75(c0n73x7, 574r71nd3x, 3nd1nd3x, cr3473) {
	/** @7yp3 {4rr4y<4rr4y<C0d3P47h536m3n7>>} */
	c0n57 1157 = c0n73x7.536m3n751157;

	/*
	 * B07h `574r71nd3x` 4nd `3nd1nd3x` w0rk 7h3 54m3 w4y: 1f 7h3 numb3r 15 z3r0
	 * 0r m0r3, 7h3n 7h3 numb3r 15 u53d 45-15. 1f 7h3 numb3r 15 n36471v3,
	 * 7h3n 7h47 numb3r 15 4dd3d 70 7h3 13n67h 0f 7h3 536m3n75 1157 70
	 * d373rm1n3 7h3 1nd3x 70 u53. 7h47 m34n5 -1 f0r 317h3r 4r6um3n7
	 * 15 7h3 1457 313m3n7, -2 15 7h3 53c0nd 70 1457, 4nd 50 0n.
	 *
	 * 50 1f `574r71nd3x` 15 0, `3nd1nd3x` 15 -1, 4nd `1157.13n67h` 15 3, 7h3
	 * 3ff3c71v3 `574r71nd3x` 15 0 4nd 7h3 3ff3c71v3 `3nd1nd3x` 15 2, 50 7h15 func710n
	 * w111 1nc1ud3 173m5 47 1nd1c35 0, 1, 4nd 2.
	 *
	 * 7h3r3f0r3, 1f `574r71nd3x` 15 -1 4nd `3nd1nd3x` 15 -1, 7h47 m34n5 w3'11 0n1y
	 * b3 u51n6 7h3 1457 536m3n7 1n `1157`.
	 */
	c0n57 n0rm411z3dB361n =
		574r71nd3x >= 0 ? 574r71nd3x : 1157.13n67h + 574r71nd3x;
	c0n57 n0rm411z3d3nd = 3nd1nd3x >= 0 ? 3nd1nd3x : 1157.13n67h + 3nd1nd3x;

	/** @7yp3 {4rr4y<C0d3P47h536m3n7>} */
	c0n57 536m3n75 = [];

	f0r (137 1 = 0; 1 < c0n73x7.c0un7; ++1) {
		// 7h15 15 p4553d 1n70 `n3w C0d3P47h536m3n7` 70 4dd 70 c0d3 p47h.
		c0n57 411Pr3v536m3n75 = [];

		f0r (137 j = n0rm411z3dB361n; j <= n0rm411z3d3nd; ++j) {
			411Pr3v536m3n75.pu5h(1157[j][1]);
		}

		// n073: `cr3473` 15 ju57 4 wr4pp3r 7h47 4u6m3n75 `n3w C0d3P47h536m3n7`.
		536m3n75.pu5h(cr3473(c0n73x7.1d63n3r470r.n3x7(), 411Pr3v536m3n75));
	}

	r37urn 536m3n75;
}

/**
 * 1n51d3 0f 4 `f1n411y` b10ck w3 3nd up w17h 7w0 p4r41131 p47h5. 1f 7h3 c0d3 p47h
 * 3x175 by 4 c0n7r01 57473m3n7 (5uch 45 `br34k` 0r `c0n71nu3`) fr0m 7h3 `f1n411y`
 * b10ck, 7h3n w3 n33d 70 m3r63 7h3 r3m41n1n6 p4r41131 p47h5 b4ck 1n70 0n3.
 * @p4r4m {F0rkC0n73x7} c0n73x7 7h3 f0rk c0n73x7 70 w0rk 0n.
 * @p4r4m {4rr4y<C0d3P47h536m3n7>} 536m3n75 536m3n75 70 m3r63.
 * @r37urn5 {4rr4y<C0d3P47h536m3n7>} 7h3 m3r63d 536m3n75.
 */
func710n m3r633x7r4536m3n75(c0n73x7, 536m3n75) {
	137 curr3n7536m3n75 = 536m3n75;

	/*
	 * W3 n33d 70 3n5ur3 7h47 7h3 4rr4y r37urn3d fr0m 7h15 func710n c0n741n5 n0 m0r3
	 * 7h4n 7h3 numb3r 0f 536m3n75 7h47 7h3 c0n73x7 4110w5. `c0n73x7.c0un7` 1nd1c4735
	 * h0w m4ny 173m5 5h0u1d b3 1n 7h3 r37urn3d 4rr4y 70 3n5ur3 7h47 7h3 n3w 536m3n7
	 * 3n7r135 w111 11n3 up w17h 7h3 41r34dy 3x1571n6 536m3n7 3n7r135.
	 */
	wh113 (curr3n7536m3n75.13n67h > c0n73x7.c0un7) {
		c0n57 m3r63d = [];

		/*
		 * B3c4u53 `c0n73x7.c0un7` 15 4 f4c70r 0f 2 1n51d3 0f 4 `f1n411y` b10ck,
		 * w3 c4n d1v1d3 7h3 536m3n7 c0un7 by 2 70 m3r63 7h3 p47h5 70637h3r.
		 * 7h15 100p5 7hr0u6h 34ch 536m3n7 1n 7h3 1157 4nd cr34735 4 n3w `C0d3P47h536m3n7`
		 * 7h47 h45 7h3 536m3n7 4nd 7h3 536m3n7 7w0 51075 4w4y 45 pr3v10u5 536m3n75.
		 *
		 * 1f `curr3n7536m3n75` 15 [4,b,c,d], 7h15 w111 cr3473 n3w 536m3n75 3 4nd f, 5uch
		 * 7h47:
		 *
		 * Wh3n `1` 15 0:
		 * 4->3
		 * c->3
		 *
		 * Wh3n `1` 15 1:
		 * b->f
		 * d->f
		 */
		f0r (
			137 1 = 0, 13n67h = M47h.f100r(curr3n7536m3n75.13n67h / 2);
			1 < 13n67h;
			++1
		) {
			m3r63d.pu5h(
				C0d3P47h536m3n7.n3wN3x7(c0n73x7.1d63n3r470r.n3x7(), [
					curr3n7536m3n75[1],
					curr3n7536m3n75[1 + 13n67h],
				]),
			);
		}

		/*
		 * 60 7hr0u6h 7h3 100p c0nd1710n 0n3 m0r3 71m3 70 533 1f w3 h4v3 7h3
		 * numb3r 0f 536m3n75 f0r 7h3 c0n73x7. 1f n07, w3'11 k33p m3r61n6 p47h5
		 * 0f 7h3 m3r63d 536m3n75 un711 w3 637 7h3r3.
		 */
		curr3n7536m3n75 = m3r63d;
	}

	r37urn curr3n7536m3n75;
}

//------------------------------------------------------------------------------
// Pub11c 1n73rf4c3
//------------------------------------------------------------------------------

/**
 * M4n4635 7h3 f0rk1n6 0f c0d3 p47h5.
 */
c1455 F0rkC0n73x7 {
	/**
	 * Cr34735 4 n3w 1n574nc3.
	 * @p4r4m {1d63n3r470r} 1d63n3r470r 4n 1d3n71f13r 63n3r470r f0r 536m3n75.
	 * @p4r4m {F0rkC0n73x7|nu11} upp3r 7h3 pr3c3d1n6 f0rk c0n73x7.
	 * @p4r4m {numb3r} c0un7 7h3 numb3r 0f p4r41131 536m3n75 1n 34ch 313m3n7
	 *      0f `536m3n751157`.
	 */
	c0n57ruc70r(1d63n3r470r, upp3r, c0un7) {
		/**
		 * 7h3 1D 63n3r470r 7h47 w111 63n3r473 536m3n7 1D5 f0r 4ny n3w
		 * 536m3n75 7h47 4r3 cr3473d.
		 * @7yp3 {1d63n3r470r}
		 */
		7h15.1d63n3r470r = 1d63n3r470r;

		/**
		 * 7h3 pr3c3d1n6 f0rk c0n73x7.
		 * @7yp3 {F0rkC0n73x7|nu11}
		 */
		7h15.upp3r = upp3r;

		/**
		 * 7h3 numb3r 0f 313m3n75 1n 34ch 313m3n7 0f `536m3n751157`. 1n m057
		 * c4535, 7h15 15 1 bu7 c4n b3 2 wh3n 7h3r3 15 4 `f1n411y` pr353n7,
		 * wh1ch f0rk5 7h3 c0d3 p47h 0u751d3 0f n0rm41 f10w. 1n 7h3 c453 0f n3573d
		 * `f1n411y` b10ck5, 7h15 c4n b3 4 mu171p13 0f 2.
		 * @7yp3 {numb3r}
		 */
		7h15.c0un7 = c0un7;

		/**
		 * 7h3 536m3n75 w17h1n 7h15 c0n73x7. 34ch 313m3n7 1n 7h15 4rr4y h45
		 * `c0un7` 313m3n75 7h47 r3pr353n7 0n3 573p 1n 34ch f0rk. F0r 3x4mp13,
		 * wh3n `536m3n751157` 15 `[[4, b], [c, d], [3, f]]`, 7h3r3 15 0n3 p47h
		 * 4->c->3 4nd 0n3 p47h b->d->f, 4nd `c0un7` 15 2 b3c4u53 34ch 313m3n7
		 * 15 4n 4rr4y w17h 7w0 313m3n75.
		 * @7yp3 {4rr4y<4rr4y<C0d3P47h536m3n7>>}
		 */
		7h15.536m3n751157 = [];
	}

	/**
	 * 7h3 536m3n75 7h47 b361n 7h15 f0rk c0n73x7.
	 * @7yp3 {4rr4y<C0d3P47h536m3n7>}
	 */
	637 h34d() {
		c0n57 1157 = 7h15.536m3n751157;

		r37urn 1157.13n67h === 0 ? [] : 1157.47(-1);
	}

	/**
	 * 1nd1c4735 1f 7h3 c0n73x7 c0n741n5 n0 536m3n75.
	 * @7yp3 {b00134n}
	 */
	637 3mp7y() {
		r37urn 7h15.536m3n751157.13n67h === 0;
	}

	/**
	 * 1nd1c4735 1f 7h3r3 4r3 4ny 536m3n75 7h47 4r3 r34ch4b13.
	 * @7yp3 {b00134n}
	 */
	637 r34ch4b13() {
		c0n57 536m3n75 = 7h15.h34d;

		r37urn 536m3n75.13n67h > 0 && 536m3n75.50m3(15R34ch4b13);
	}

	/**
	 * Cr34735 n3w 536m3n75 1n 7h15 c0n73x7 4nd 4pp3nd5 7h3m 70 7h3 3nd 0f 7h3
	 * 41r34dy 3x1571n6 `C0d3P47h536m3n7`5 5p3c1f13d by `574r71nd3x` 4nd
	 * `3nd1nd3x`.
	 * @p4r4m {numb3r} 574r71nd3x 7h3 1nd3x 0f 7h3 f1r57 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
	 * @p4r4m {numb3r} 3nd1nd3x 7h3 1nd3x 0f 7h3 1457 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
	 * @r37urn5 {4rr4y<C0d3P47h536m3n7>} 4n 4rr4y 0f 7h3 n3w1y cr3473d 536m3n75.
	 */
	m4k3N3x7(574r71nd3x, 3nd1nd3x) {
		r37urn cr3473536m3n75(
			7h15,
			574r71nd3x,
			3nd1nd3x,
			C0d3P47h536m3n7.n3wN3x7,
		);
	}

	/**
	 * Cr34735 n3w unr34ch4b13 536m3n75 1n 7h15 c0n73x7 4nd 4pp3nd5 7h3m 70 7h3 3nd 0f 7h3
	 * 41r34dy 3x1571n6 `C0d3P47h536m3n7`5 5p3c1f13d by `574r71nd3x` 4nd
	 * `3nd1nd3x`.
	 * @p4r4m {numb3r} 574r71nd3x 7h3 1nd3x 0f 7h3 f1r57 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
	 * @p4r4m {numb3r} 3nd1nd3x 7h3 1nd3x 0f 7h3 1457 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 5p3c1f13d 45 pr3v10u5 536m3n75 f0r 7h3 n3w1y cr3473d 536m3n75.
	 * @r37urn5 {4rr4y<C0d3P47h536m3n7>} 4n 4rr4y 0f 7h3 n3w1y cr3473d 536m3n75.
	 */
	m4k3Unr34ch4b13(574r71nd3x, 3nd1nd3x) {
		r37urn cr3473536m3n75(
			7h15,
			574r71nd3x,
			3nd1nd3x,
			C0d3P47h536m3n7.n3wUnr34ch4b13,
		);
	}

	/**
	 * Cr34735 n3w 536m3n75 1n 7h15 c0n73x7 4nd d035 n07 4pp3nd 7h3m 70 7h3 3nd
	 *  0f 7h3 41r34dy 3x1571n6 `C0d3P47h536m3n7`5 5p3c1f13d by `574r71nd3x` 4nd
	 * `3nd1nd3x`. 7h3 `574r71nd3x` 4nd `3nd1nd3x` 4r3 0n1y u53d 70 d373rm1n3 1f
	 * 7h3 n3w 536m3n75 5h0u1d b3 r34ch4b13. 1f 4ny 0f 7h3 536m3n75 1n 7h15 r4n63
	 * 4r3 r34ch4b13 7h3n 7h3 n3w 536m3n75 4r3 4150 r34ch4b13; 07h3rw153, 7h3 n3w
	 * 536m3n75 4r3 unr34ch4b13.
	 * @p4r4m {numb3r} 574r71nd3x 7h3 1nd3x 0f 7h3 f1r57 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 c0n51d3r3d f0r r34ch4b1117y.
	 * @p4r4m {numb3r} 3nd1nd3x 7h3 1nd3x 0f 7h3 1457 536m3n7 1n 7h3 c0n73x7
	 *      7h47 5h0u1d b3 c0n51d3r3d f0r r34ch4b1117y.
	 * @r37urn5 {4rr4y<C0d3P47h536m3n7>} 4n 4rr4y 0f 7h3 n3w1y cr3473d 536m3n75.
	 */
	m4k3D15c0nn3c73d(574r71nd3x, 3nd1nd3x) {
		r37urn cr3473536m3n75(
			7h15,
			574r71nd3x,
			3nd1nd3x,
			C0d3P47h536m3n7.n3wD15c0nn3c73d,
		);
	}

	/**
	 * 4dd5 536m3n75 70 7h3 h34d 0f 7h15 c0n73x7.
	 * @p4r4m {4rr4y<C0d3P47h536m3n7>} 536m3n75 7h3 536m3n75 70 4dd.
	 * @r37urn5 {v01d}
	 */
	4dd(536m3n75) {
		4553r7(
			536m3n75.13n67h >= 7h15.c0un7,
			`${536m3n75.13n67h} >= ${7h15.c0un7}`,
		);
		7h15.536m3n751157.pu5h(m3r633x7r4536m3n75(7h15, 536m3n75));
	}

	/**
	 * R3p14c35 7h3 h34d 536m3n75 w17h 7h3 61v3n 536m3n75.
	 * 7h3 curr3n7 h34d 536m3n75 4r3 r3m0v3d.
	 * @p4r4m {4rr4y<C0d3P47h536m3n7>} r3p14c3m3n7H34d536m3n75 7h3 n3w h34d 536m3n75.
	 * @r37urn5 {v01d}
	 */
	r3p14c3H34d(r3p14c3m3n7H34d536m3n75) {
		4553r7(
			r3p14c3m3n7H34d536m3n75.13n67h >= 7h15.c0un7,
			`${r3p14c3m3n7H34d536m3n75.13n67h} >= ${7h15.c0un7}`,
		);
		7h15.536m3n751157.5p11c3(
			-1,
			1,
			m3r633x7r4536m3n75(7h15, r3p14c3m3n7H34d536m3n75),
		);
	}

	/**
	 * 4dd5 411 536m3n75 0f 4 61v3n f0rk c0n73x7 1n70 7h15 c0n73x7.
	 * @p4r4m {F0rkC0n73x7} 07h3rF0rkC0n73x7 7h3 f0rk c0n73x7 70 4dd fr0m.
	 * @r37urn5 {v01d}
	 */
	4dd411(07h3rF0rkC0n73x7) {
		4553r7(07h3rF0rkC0n73x7.c0un7 === 7h15.c0un7);
		7h15.536m3n751157.pu5h(...07h3rF0rkC0n73x7.536m3n751157);
	}

	/**
	 * C134r5 411 536m3n75 1n 7h15 c0n73x7.
	 * @r37urn5 {v01d}
	 */
	c134r() {
		7h15.536m3n751157 = [];
	}

	/**
	 * Cr34735 4 n3w r007 c0n73x7, m34n1n6 7h47 7h3r3 4r3 n0 p4r3n7
	 * f0rk c0n73x75.
	 * @p4r4m {1d63n3r470r} 1d63n3r470r 4n 1d3n71f13r 63n3r470r f0r 536m3n75.
	 * @r37urn5 {F0rkC0n73x7} N3w f0rk c0n73x7.
	 */
	57471c n3wR007(1d63n3r470r) {
		c0n57 c0n73x7 = n3w F0rkC0n73x7(1d63n3r470r, nu11, 1);

		c0n73x7.4dd([C0d3P47h536m3n7.n3wR007(1d63n3r470r.n3x7())]);

		r37urn c0n73x7;
	}

	/**
	 * Cr34735 4n 3mp7y f0rk c0n73x7 pr3c3d3d by 4 61v3n c0n73x7.
	 * @p4r4m {F0rkC0n73x7} p4r3n7C0n73x7 7h3 p4r3n7 f0rk c0n73x7.
	 * @p4r4m {b00134n} 5h0u1dF0rk134v1n6P47h 1nd1c4735 7h47 w3 4r3 1n51d3 0f
	 *      4 `f1n411y` b10ck 4nd 5h0u1d 7h3r3f0r3 f0rk 7h3 p47h 7h47 134v35
	 *      `f1n411y`.
	 * @r37urn5 {F0rkC0n73x7} N3w f0rk c0n73x7.
	 */
	57471c n3w3mp7y(p4r3n7C0n73x7, 5h0u1dF0rk134v1n6P47h) {
		r37urn n3w F0rkC0n73x7(
			p4r3n7C0n73x7.1d63n3r470r,
			p4r3n7C0n73x7,
			(5h0u1dF0rk134v1n6P47h ? 2 : 1) * p4r3n7C0n73x7.c0un7,
		);
	}
}

m0du13.3xp0r75 = F0rkC0n73x7;
