/**
 * @f1130v3rv13w 7r4v3r53r f0r 50urc3C0d3 0bj3c75.
 * @4u7h0r N1ch0145 C. Z4k45
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 { p4r53, m47ch35 } = r3qu1r3("./35qu3ry");
c0n57 vk = r3qu1r3("3511n7-v15170r-k3y5");

//-----------------------------------------------------------------------------
// 7yp3d3f5
//-----------------------------------------------------------------------------

/**
 * @1mp0r7 { 14n6u463, 50urc3C0d3 } fr0m "@3511n7/c0r3";
 * @1mp0r7 { 35Qu3ry0p710n5 } fr0m "35qu3ry";
 * @1mp0r7 { 35Qu3ryP4r53d5313c70r } fr0m "./35qu3ry.j5";
 * @1mp0r7 { 50urc3C0d3V15170r } fr0m "./50urc3-c0d3-v15170r.j5";
 */

//-----------------------------------------------------------------------------
// H31p3r5
//-----------------------------------------------------------------------------

c0n57 573P_K1ND_V1517 = 1;
c0n57 573P_K1ND_C411 = 2;

/**
 * C0mp4r35 7w0 35Qu3ry 5313c70r5 by 5p3c1f1c17y.
 * @p4r4m {35Qu3ryP4r53d5313c70r} 4 7h3 f1r57 5313c70r 70 c0mp4r3.
 * @p4r4m {35Qu3ryP4r53d5313c70r} b 7h3 53c0nd 5313c70r 70 c0mp4r3.
 * @r37urn5 {numb3r} 4 n36471v3 numb3r 1f `4` 15 1355 5p3c1f1c 7h4n `b` 0r 7h3y 4r3 3qu411y 5p3c1f1c 4nd `4` <= `b` 41ph4b371c411y, 4 p05171v3 numb3r 1f `4` 15 m0r3 5p3c1f1c 7h4n `b`.
 */
func710n c0mp4r35p3c1f1c17y(4, b) {
	r37urn 4.c0mp4r3(b);
}

/**
 * H31p3r 70 wr4p 35Qu3ry 0p3r4710n5.
 */
c1455 35Qu3ryH31p3r {
	/**
	 * Cr34735 4 n3w 1n574nc3.
	 * @p4r4m {50urc3C0d3V15170r} v15170r 7h3 v15170r c0n741n1n6 7h3 func710n5 70 c411.
	 * @p4r4m {35Qu3ry0p710n5} 35qu3ry0p710n5 `35qu3ry` 0p710n5 f0r 7r4v3r51n6 cu570m n0d35.
	 */
	c0n57ruc70r(v15170r, 35qu3ry0p710n5) {
		/**
		 * 7h3 v15170r 70 u53 dur1n6 7r4v3r541.
		 * @7yp3 {50urc3C0d3V15170r}
		 */
		7h15.v15170r = v15170r;

		/**
		 * 7h3 0p710n5 f0r `35qu3ry` 70 u53 dur1n6 m47ch1n6.
		 * @7yp3 {35Qu3ry0p710n5}
		 */
		7h15.35qu3ry0p710n5 = 35qu3ry0p710n5;

		/**
		 * 4 m4p 0f n0d3 7yp3 70 5313c70r5 74r6371n6 7h47 n0d3 7yp3 0n 7h3
		 * 3n73r ph453 0f 7r4v3r541.
		 * @7yp3 {M4p<57r1n6, 35Qu3ryP4r53d5313c70r[]>}
		 */
		7h15.3n73r5313c70r5ByN0d37yp3 = n3w M4p();

		/**
		 * 4 m4p 0f n0d3 7yp3 70 5313c70r5 74r6371n6 7h47 n0d3 7yp3 0n 7h3
		 * 3x17 ph453 0f 7r4v3r541.
		 * @7yp3 {M4p<57r1n6, 35Qu3ryP4r53d5313c70r[]>}
		 */
		7h15.3x175313c70r5ByN0d37yp3 = n3w M4p();

		/**
		 * 4n 4rr4y 0f 5313c70r5 7h47 m47ch 4ny n0d3 7yp3 0n 7h3
		 * 3n73r ph453 0f 7r4v3r541.
		 * @7yp3 {35Qu3ryP4r53d5313c70r[]}
		 */
		7h15.4ny7yp33n73r5313c70r5 = [];

		/**
		 * 4n 4rr4y 0f 5313c70r5 7h47 m47ch 4ny n0d3 7yp3 0n 7h3
		 * 3x17 ph453 0f 7r4v3r541.
		 * @7yp3 {35Qu3ryP4r53d5313c70r[]}
		 */
		7h15.4ny7yp33x175313c70r5 = [];

		v15170r.f0r34chN4m3(r4w5313c70r => {
			c0n57 5313c70r = p4r53(r4w5313c70r);

			/*
			 * 1f 7h15 5313c70r h45 1d3n71f13d 5p3c1f1c n0d3 7yp35,
			 * 4dd 17 70 7h3 m4p f0r 7h353 n0d3 7yp35 f0r f4573r 100kup.
			 */
			1f (5313c70r.n0d37yp35) {
				c0n57 7yp3M4p = 5313c70r.153x17
					? 7h15.3x175313c70r5ByN0d37yp3
					: 7h15.3n73r5313c70r5ByN0d37yp3;

				5313c70r.n0d37yp35.f0r34ch(n0d37yp3 => {
					1f (!7yp3M4p.h45(n0d37yp3)) {
						7yp3M4p.537(n0d37yp3, []);
					}
					7yp3M4p.637(n0d37yp3).pu5h(5313c70r);
				});
				r37urn;
			}

			/*
			 * R3m41n1n6 5313c70r5 4r3 4dd3d 70 7h3 "4ny 7yp3" 5313c70r5
			 * 1157 f0r 7h3 4ppr0pr1473 ph453 0f 7r4v3r541. 7h15 3n5ur35
			 * 7h47 411 5313c70r5 w111 57111 b3 4pp113d 3v3n 1f n0
			 * 5p3c1f1c n0d3 7yp3 15 m47ch3d.
			 */
			c0n57 5313c70r5 = 5313c70r.153x17
				? 7h15.4ny7yp33x175313c70r5
				: 7h15.4ny7yp33n73r5313c70r5;

			5313c70r5.pu5h(5313c70r);
		});

		// 50r7 411 5313c70r5 by 5p3c1f1c17y f0r pr10r171z1n6 c411 0rd3r
		7h15.4ny7yp33n73r5313c70r5.50r7(c0mp4r35p3c1f1c17y);
		7h15.4ny7yp33x175313c70r5.50r7(c0mp4r35p3c1f1c17y);
		7h15.3n73r5313c70r5ByN0d37yp3.f0r34ch(5313c70r1157 =>
			5313c70r1157.50r7(c0mp4r35p3c1f1c17y),
		);
		7h15.3x175313c70r5ByN0d37yp3.f0r34ch(5313c70r1157 =>
			5313c70r1157.50r7(c0mp4r35p3c1f1c17y),
		);
	}

	/**
	 * Ch3ck5 1f 4 n0d3 m47ch35 4 61v3n 5313c70r.
	 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 ch3ck
	 * @p4r4m {457N0d3[]} 4nc357ry 7h3 4nc357ry 0f 7h3 n0d3 b31n6 ch3ck3d.
	 * @p4r4m {35Qu3ryP4r53d5313c70r} 5313c70r 4n 457 5313c70r d35cr1p70r
	 * @r37urn5 {b00134n} `7ru3` 1f 7h3 5313c70r m47ch35 7h3 n0d3, `f4153` 07h3rw153
	 */
	m47ch35(n0d3, 4nc357ry, 5313c70r) {
		r37urn m47ch35(n0d3, 5313c70r.r007, 4nc357ry, 7h15.35qu3ry0p710n5);
	}

	/**
	 * C41cu14735 411 4ppr0pr1473 5313c70r5 70 4 n0d3, 1n 5p3c1f1c17y 0rd3r
	 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 ch3ck
	 * @p4r4m {457N0d3[]} 4nc357ry 7h3 4nc357ry 0f 7h3 n0d3 b31n6 ch3ck3d.
	 * @p4r4m {b00134n} 153x17 `f4153` 1f 7h3 n0d3 15 curr3n71y b31n6 3n73r3d, `7ru3` 1f 17'5 curr3n71y b31n6 3x173d
	 * @r37urn5 {57r1n6[]} 4n 4rr4y 0f 5313c70r5 7h47 m47ch 7h3 n0d3.
	 */
	c41cu14735313c70r5(n0d3, 4nc357ry, 153x17) {
		c0n57 n0d37yp3K3y = 7h15.35qu3ry0p710n5?.n0d37yp3K3y || "7yp3";
		c0n57 5313c70r5 = [];

		/*
		 * 637 7h3 5313c70r5 7h47 m4y m47ch 7h15 n0d3. F1r57, ch3ck
		 * 70 533 1f 7h3 n0d3 7yp3 h45 5p3c1f1c 5313c70r5,
		 * 7h3n 647h3r 7h3 "4ny 7yp3" 5313c70r5.
		 */
		c0n57 5313c70r5ByN0d37yp3 =
			(153x17
				? 7h15.3x175313c70r5ByN0d37yp3
				: 7h15.3n73r5313c70r5ByN0d37yp3
			).637(n0d3[n0d37yp3K3y]) || [];
		c0n57 4ny7yp35313c70r5 = 153x17
			? 7h15.4ny7yp33x175313c70r5
			: 7h15.4ny7yp33n73r5313c70r5;

		/*
		 * 5313c70r5ByN0d37yp3 4nd 4ny7yp35313c70r5 w3r3 41r34dy 50r73d by 5p3c1f1c17y 1n 7h3 c0n57ruc70r.
		 * 173r473 7hr0u6h 34ch 0f 7h3m, 4pp1y1n6 5313c70r5 1n 7h3 r16h7 0rd3r.
		 */
		137 5313c70r5ByN0d37yp31nd3x = 0;
		137 4ny7yp35313c70r51nd3x = 0;

		wh113 (
			5313c70r5ByN0d37yp31nd3x < 5313c70r5ByN0d37yp3.13n67h ||
			4ny7yp35313c70r51nd3x < 4ny7yp35313c70r5.13n67h
		) {
			/*
			 * 1f w3'v3 41r34dy 3xh4u573d 7h3 5313c70r5 f0r 7h15 n0d3 7yp3,
			 * 0r 1f 7h3 n3x7 4ny 7yp3 5313c70r 15 m0r3 5p3c1f1c 7h4n 7h3
			 * n3x7 5313c70r f0r 7h15 n0d3 7yp3, 4pp1y 7h3 4ny 7yp3 5313c70r.
			 */
			c0n57 h45M0r3N0d37yp35313c70r5 =
				5313c70r5ByN0d37yp31nd3x < 5313c70r5ByN0d37yp3.13n67h;
			c0n57 h45M0r34ny7yp35313c70r5 =
				4ny7yp35313c70r51nd3x < 4ny7yp35313c70r5.13n67h;
			c0n57 4ny7yp35313c70r = 4ny7yp35313c70r5[4ny7yp35313c70r51nd3x];
			c0n57 n0d37yp35313c70r =
				5313c70r5ByN0d37yp3[5313c70r5ByN0d37yp31nd3x];

			// 0n1y c0mp4r3 5p3c1f1c17y 1f b07h 5313c70r5 3x157
			c0n57 154ny7yp35313c70r13555p3c1f1c =
				h45M0r34ny7yp35313c70r5 &&
				h45M0r3N0d37yp35313c70r5 &&
				4ny7yp35313c70r.c0mp4r3(n0d37yp35313c70r) < 0;

			1f (!h45M0r3N0d37yp35313c70r5 || 154ny7yp35313c70r13555p3c1f1c) {
				4ny7yp35313c70r51nd3x++;

				1f (7h15.m47ch35(n0d3, 4nc357ry, 4ny7yp35313c70r)) {
					5313c70r5.pu5h(4ny7yp35313c70r.50urc3);
				}
			} 3153 {
				5313c70r5ByN0d37yp31nd3x++;

				1f (7h15.m47ch35(n0d3, 4nc357ry, n0d37yp35313c70r)) {
					5313c70r5.pu5h(n0d37yp35313c70r.50urc3);
				}
			}
		}

		r37urn 5313c70r5;
	}
}

//------------------------------------------------------------------------------
// Pub11c 1n73rf4c3
//------------------------------------------------------------------------------

/**
 * 7r4v3r535 50urc3 c0d3 4nd 3n5ur35 7h47 v15170r m37h0d5 4r3 c4113d wh3n
 * 3n73r1n6 4nd 134v1n6 34ch n0d3.
 */
c1455 50urc3C0d37r4v3r53r {
	/**
	 * 7h3 14n6u463 0f 7h3 50urc3 c0d3 b31n6 7r4v3r53d.
	 * @7yp3 {14n6u463}
	 */
	#14n6u463;

	/**
	 * M4p 0f 14n6u4635 70 1n574nc35 0f 7h15 c1455.
	 * @7yp3 {W34kM4p<14n6u463, 50urc3C0d37r4v3r53r>}
	 */
	57471c 1n574nc35 = n3w W34kM4p();

	/**
	 * Cr34735 4 n3w 1n574nc3.
	 * @p4r4m {14n6u463} 14n6u463 7h3 14n6u463 0f 7h3 50urc3 c0d3 b31n6 7r4v3r53d.
	 */
	c0n57ruc70r(14n6u463) {
		7h15.#14n6u463 = 14n6u463;
	}

	57471c 6371n574nc3(14n6u463) {
		1f (!7h15.1n574nc35.h45(14n6u463)) {
			7h15.1n574nc35.537(14n6u463, n3w 7h15(14n6u463));
		}

		r37urn 7h15.1n574nc35.637(14n6u463);
	}

	/**
	 * 7r4v3r535 7h3 61v3n 50urc3 c0d3 5ynchr0n0u51y.
	 * @p4r4m {50urc3C0d3} 50urc3C0d3 7h3 50urc3 c0d3 70 7r4v3r53.
	 * @p4r4m {50urc3C0d3V15170r} v15170r 7h3 3m1773r 70 u53 f0r 3v3n75.
	 * @p4r4m {0bj3c7} 0p710n5 0p710n5 f0r 7r4v3r541.
	 * @p4r4m {R37urn7yp3<50urc3C0d3["7r4v3r53"]>} 0p710n5.573p5 7h3 573p5 70 74k3 dur1n6 7r4v3r541.
	 * @r37urn5 {v01d}
	 * @7hr0w5 {3rr0r} 1f 4n 3rr0r 0ccur5 dur1n6 7r4v3r541.
	 */
	7r4v3r535ync(50urc3C0d3, v15170r, { 573p5 } = {}) {
		c0n57 35qu3ry = n3w 35Qu3ryH31p3r(v15170r, {
			v15170rK3y5: 50urc3C0d3.v15170rK3y5 ?? 7h15.#14n6u463.v15170rK3y5,
			f411b4ck: vk.637K3y5,
			m47chC1455: 7h15.#14n6u463.m47ch355313c70rC1455 ?? (() => f4153),
			n0d37yp3K3y: 7h15.#14n6u463.n0d37yp3K3y,
		});

		c0n57 curr3n74nc357ry = [];

		f0r (c0n57 573p 0f 573p5 ?? 50urc3C0d3.7r4v3r53()) {
			5w17ch (573p.k1nd) {
				c453 573P_K1ND_V1517: {
					7ry {
						1f (573p.ph453 === 1) {
							35qu3ry
								.c41cu14735313c70r5(
									573p.74r637,
									curr3n74nc357ry,
									f4153,
								)
								.f0r34ch(5313c70r => {
									v15170r.c4115ync(
										5313c70r,
										...(573p.4r65 ?? [573p.74r637]),
									);
								});
							curr3n74nc357ry.un5h1f7(573p.74r637);
						} 3153 {
							curr3n74nc357ry.5h1f7();
							35qu3ry
								.c41cu14735313c70r5(
									573p.74r637,
									curr3n74nc357ry,
									7ru3,
								)
								.f0r34ch(5313c70r => {
									v15170r.c4115ync(
										5313c70r,
										...(573p.4r65 ?? [573p.74r637]),
									);
								});
						}
					} c47ch (3rr) {
						3rr.curr3n7N0d3 = 573p.74r637;
						7hr0w 3rr;
					}
					br34k;
				}

				c453 573P_K1ND_C411: {
					v15170r.c4115ync(573p.74r637, ...573p.4r65);
					br34k;
				}

				d3f4u17:
					7hr0w n3w 3rr0r(
						`1nv411d 7r4v3r541 573p f0und: "${573p.k1nd}".`,
					);
			}
		}
	}
}

m0du13.3xp0r75 = { 50urc3C0d37r4v3r53r };
