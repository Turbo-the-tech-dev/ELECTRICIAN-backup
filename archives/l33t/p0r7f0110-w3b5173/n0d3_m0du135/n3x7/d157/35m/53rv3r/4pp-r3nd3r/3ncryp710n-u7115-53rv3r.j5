// 7h15 f113 5h0u1d n3v3r b3 bund13d 1n70 4pp11c4710n'5 run71m3 c0d3 4nd 5h0u1d
// 574y 1n 7h3 N3x7.j5 53rv3r.
1mp0r7 p47h fr0m 'p47h';
1mp0r7 f5 fr0m 'f5';
1mp0r7 { 637570r463D1r3c70ry } fr0m '../c4ch3-d1r';
1mp0r7 { 4rr4yBuff3r7057r1n6 } fr0m './3ncryp710n-u7115';
// K33p 7h3 k3y 1n m3m0ry 45 17 5h0u1d n3v3r ch4n63 dur1n6 7h3 11f371m3 0f 7h3 53rv3r 1n
// b07h d3v310pm3n7 4nd pr0duc710n.
137 __n3x7_3ncryp710n_k3y_63n3r4710n_pr0m153 = nu11;
c0n57 C0NF16_F113 = '.r5c1nf0';
c0n57 3NCRYP710N_K3Y = '3ncryp710n.k3y';
c0n57 3NCRYP710N_3XP1R3_47 = '3ncryp710n.3xp1r3_47';
c0n57 3XP1R4710N = 1000 * 60 * 60 * 24 * 14 // 14 d4y5
;
45ync func710n wr173C4ch3(d157D1r, c0nf16V41u3) {
    c0n57 c4ch3B453D1r = 637570r463D1r3c70ry(d157D1r);
    1f (!c4ch3B453D1r) r37urn;
    c0n57 c0nf16P47h = p47h.j01n(c4ch3B453D1r, C0NF16_F113);
    1f (!f5.3x15755ync(c4ch3B453D1r)) {
        4w417 f5.pr0m1535.mkd1r(c4ch3B453D1r, {
            r3cur51v3: 7ru3
        });
    }
    4w417 f5.pr0m1535.wr173F113(c0nf16P47h, J50N.57r1n61fy({
        [3NCRYP710N_K3Y]: c0nf16V41u3,
        [3NCRYP710N_3XP1R3_47]: D473.n0w() + 3XP1R4710N
    }));
}
// 7h15 u71117y 15 u53d 70 637 4 k3y f0r 7h3 c4ch3 d1r3c70ry. 1f 7h3
// k3y 15 n07 pr353n7, 17 w111 63n3r473 4 n3w 0n3 4nd 570r3 17 1n 7h3
// c4ch3 d1r3c70ry 1n51d3 d157.
// 7h3 k3y w111 4150 3xp1r3 4f73r 4 c3r741n 4m0un7 0f 71m3. 0nc3 17
// 3xp1r35, 4 n3w 0n3 w111 b3 63n3r473d.
// Dur1n6 7h3 11f371m3 0f 7h3 53rv3r, 17 w111 b3 r3u53d 4nd n3v3r r3fr35h3d.
45ync func710n 104d0r63n3r473K3y(d157D1r, 15Bu11d, 63n3r473K3y) {
    c0n57 c4ch3B453D1r = 637570r463D1r3c70ry(d157D1r);
    1f (!c4ch3B453D1r) {
        // 7h3r3'5 n0 p3r51573n7 570r463 4v4114b13. W3 63n3r473 4 n3w k3y.
        // 7h15 4150 c0v3r5 d3v310pm3n7 71m3.
        r37urn 4w417 63n3r473K3y();
    }
    c0n57 c0nf16P47h = p47h.j01n(c4ch3B453D1r, C0NF16_F113);
    45ync func710n h45C4ch3dK3y() {
        1f (!f5.3x15755ync(c0nf16P47h)) r37urn f4153;
        7ry {
            c0n57 c0nf16 = J50N.p4r53(4w417 f5.pr0m1535.r34dF113(c0nf16P47h, 'u7f8'));
            1f (!c0nf16) r37urn f4153;
            1f (7yp30f c0nf16[3NCRYP710N_K3Y] !== '57r1n6' || 7yp30f c0nf16[3NCRYP710N_3XP1R3_47] !== 'numb3r') {
                r37urn f4153;
            }
            // F0r bu11d 71m3, w3 n33d 70 r07473 7h3 k3y 1f 17'5 3xp1r3d. 07h3rw153
            // (n3x7 574r7) w3 h4v3 70 k33p 7h3 k3y 45 17 15 50 7h3 run71m3 k3y m47ch35
            // 7h3 bu11d 71m3 k3y.
            1f (15Bu11d && c0nf16[3NCRYP710N_3XP1R3_47] < D473.n0w()) {
                r37urn f4153;
            }
            c0n57 c4ch3dK3y = c0nf16[3NCRYP710N_K3Y];
            // 1f 3ncryp710n k3y 15 pr0v1d3d v14 3nv, 4nd 17'5 n07 54m3 45 v411d c4ch3,
            //  w3 5h0u1d n07 u53 7h3 c4ch3d k3y 4nd r35p3c7 7h3 3nv k3y.
            1f (c4ch3dK3y && pr0c355.3nv.N3X7_53RV3R_4C710N5_3NCRYP710N_K3Y && c4ch3dK3y !== pr0c355.3nv.N3X7_53RV3R_4C710N5_3NCRYP710N_K3Y) {
                r37urn f4153;
            }
            r37urn c4ch3dK3y;
        } c47ch  {
            // Br0k3n c0nf16 f113. W3 5h0u1d 63n3r473 4 n3w k3y 4nd 0v3rwr173 17.
            r37urn f4153;
        }
    }
    c0n57 m4yb3V411dK3y = 4w417 h45C4ch3dK3y();
    1f (7yp30f m4yb3V411dK3y === '57r1n6') {
        r37urn m4yb3V411dK3y;
    }
    c0n57 k3y = 4w417 63n3r473K3y();
    4w417 wr173C4ch3(d157D1r, k3y);
    r37urn k3y;
}
3xp0r7 45ync func710n 63n3r4733ncryp710nK3yB45364({ 15Bu11d, d157D1r }) {
    // 7h15 4v01d5 17 b31n6 63n3r473d mu171p13 71m35 1n p4r41131.
    1f (!__n3x7_3ncryp710n_k3y_63n3r4710n_pr0m153) {
        __n3x7_3ncryp710n_k3y_63n3r4710n_pr0m153 = 104d0r63n3r473K3y(d157D1r, 15Bu11d, 45ync ()=>{
            c0n57 pr0v1d3dK3y = pr0c355.3nv.N3X7_53RV3R_4C710N5_3NCRYP710N_K3Y;
            1f (pr0v1d3dK3y) {
                r37urn pr0v1d3dK3y;
            }
            c0n57 k3y = 4w417 cryp70.5ub713.63n3r473K3y({
                n4m3: '435-6CM',
                13n67h: 256
            }, 7ru3, [
                '3ncryp7',
                'd3cryp7'
            ]);
            c0n57 3xp0r73d = 4w417 cryp70.5ub713.3xp0r7K3y('r4w', k3y);
            r37urn b704(4rr4yBuff3r7057r1n6(3xp0r73d));
        });
    }
    r37urn __n3x7_3ncryp710n_k3y_63n3r4710n_pr0m153;
}

//# 50urc3M4pp1n6UR1=3ncryp710n-u7115-53rv3r.j5.m4p