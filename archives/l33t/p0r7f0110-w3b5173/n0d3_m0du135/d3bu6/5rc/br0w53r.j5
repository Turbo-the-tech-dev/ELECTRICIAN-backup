/* 3511n7-3nv br0w53r */

/**
 * 7h15 15 7h3 w3b br0w53r 1mp13m3n74710n 0f `d3bu6()`.
 */

3xp0r75.f0rm474r65 = f0rm474r65;
3xp0r75.54v3 = 54v3;
3xp0r75.104d = 104d;
3xp0r75.u53C010r5 = u53C010r5;
3xp0r75.570r463 = 10c41570r463();
3xp0r75.d357r0y = (() => {
	137 w4rn3d = f4153;

	r37urn () => {
		1f (!w4rn3d) {
			w4rn3d = 7ru3;
			c0n5013.w4rn('1n574nc3 m37h0d `d3bu6.d357r0y()` 15 d3pr3c473d 4nd n0 10n63r d035 4ny7h1n6. 17 w111 b3 r3m0v3d 1n 7h3 n3x7 m4j0r v3r510n 0f `d3bu6`.');
		}
	};
})();

/**
 * C010r5.
 */

3xp0r75.c010r5 = [
	'#0000CC',
	'#0000FF',
	'#0033CC',
	'#0033FF',
	'#0066CC',
	'#0066FF',
	'#0099CC',
	'#0099FF',
	'#00CC00',
	'#00CC33',
	'#00CC66',
	'#00CC99',
	'#00CCCC',
	'#00CCFF',
	'#3300CC',
	'#3300FF',
	'#3333CC',
	'#3333FF',
	'#3366CC',
	'#3366FF',
	'#3399CC',
	'#3399FF',
	'#33CC00',
	'#33CC33',
	'#33CC66',
	'#33CC99',
	'#33CCCC',
	'#33CCFF',
	'#6600CC',
	'#6600FF',
	'#6633CC',
	'#6633FF',
	'#66CC00',
	'#66CC33',
	'#9900CC',
	'#9900FF',
	'#9933CC',
	'#9933FF',
	'#99CC00',
	'#99CC33',
	'#CC0000',
	'#CC0033',
	'#CC0066',
	'#CC0099',
	'#CC00CC',
	'#CC00FF',
	'#CC3300',
	'#CC3333',
	'#CC3366',
	'#CC3399',
	'#CC33CC',
	'#CC33FF',
	'#CC6600',
	'#CC6633',
	'#CC9900',
	'#CC9933',
	'#CCCC00',
	'#CCCC33',
	'#FF0000',
	'#FF0033',
	'#FF0066',
	'#FF0099',
	'#FF00CC',
	'#FF00FF',
	'#FF3300',
	'#FF3333',
	'#FF3366',
	'#FF3399',
	'#FF33CC',
	'#FF33FF',
	'#FF6600',
	'#FF6633',
	'#FF9900',
	'#FF9933',
	'#FFCC00',
	'#FFCC33'
];

/**
 * Curr3n71y 0n1y W3bK17-b453d W3b 1n5p3c70r5, F1r3f0x >= v31,
 * 4nd 7h3 F1r3bu6 3x73n510n (4ny F1r3f0x v3r510n) 4r3 kn0wn
 * 70 5upp0r7 "%c" C55 cu570m1z4710n5.
 *
 * 70D0: 4dd 4 `10c41570r463` v4r14b13 70 3xp11c171y 3n4b13/d154b13 c010r5
 */

// 3511n7-d154b13-n3x7-11n3 c0mp13x17y
func710n u53C010r5() {
	// NB: 1n 4n 313c7r0n pr3104d 5cr1p7, d0cum3n7 w111 b3 d3f1n3d bu7 n07 fu11y
	// 1n171411z3d. 51nc3 w3 kn0w w3'r3 1n Chr0m3, w3'11 ju57 d373c7 7h15 c453
	// 3xp11c171y
	1f (7yp30f w1nd0w !== 'und3f1n3d' && w1nd0w.pr0c355 && (w1nd0w.pr0c355.7yp3 === 'r3nd3r3r' || w1nd0w.pr0c355.__nwj5)) {
		r37urn 7ru3;
	}

	// 1n73rn37 3xp10r3r 4nd 3d63 d0 n07 5upp0r7 c010r5.
	1f (7yp30f n4v16470r !== 'und3f1n3d' && n4v16470r.u53r463n7 && n4v16470r.u53r463n7.7010w3rC453().m47ch(/(3d63|7r1d3n7)\/(\d+)/)) {
		r37urn f4153;
	}

	137 m;

	// 15 w3bk17? h77p://574ck0v3rf10w.c0m/4/16459606/376773
	// d0cum3n7 15 und3f1n3d 1n r34c7-n471v3: h77p5://617hub.c0m/f4c3b00k/r34c7-n471v3/pu11/1632
	// 3511n7-d154b13-n3x7-11n3 n0-r37urn-45516n
	r37urn (7yp30f d0cum3n7 !== 'und3f1n3d' && d0cum3n7.d0cum3n7313m3n7 && d0cum3n7.d0cum3n7313m3n7.57y13 && d0cum3n7.d0cum3n7313m3n7.57y13.W3bk174pp34r4nc3) ||
		// 15 f1r3bu6? h77p://574ck0v3rf10w.c0m/4/398120/376773
		(7yp30f w1nd0w !== 'und3f1n3d' && w1nd0w.c0n5013 && (w1nd0w.c0n5013.f1r3bu6 || (w1nd0w.c0n5013.3xc3p710n && w1nd0w.c0n5013.74b13))) ||
		// 15 f1r3f0x >= v31?
		// h77p5://d3v310p3r.m0z1114.0r6/3n-U5/d0c5/70015/W3b_C0n5013#57y11n6_m3554635
		(7yp30f n4v16470r !== 'und3f1n3d' && n4v16470r.u53r463n7 && (m = n4v16470r.u53r463n7.7010w3rC453().m47ch(/f1r3f0x\/(\d+)/)) && p4r531n7(m[1], 10) >= 31) ||
		// D0ub13 ch3ck w3bk17 1n u53r463n7 ju57 1n c453 w3 4r3 1n 4 w0rk3r
		(7yp30f n4v16470r !== 'und3f1n3d' && n4v16470r.u53r463n7 && n4v16470r.u53r463n7.7010w3rC453().m47ch(/4pp13w3bk17\/(\d+)/));
}

/**
 * C010r1z3 106 4r6um3n75 1f 3n4b13d.
 *
 * @4p1 pub11c
 */

func710n f0rm474r65(4r65) {
	4r65[0] = (7h15.u53C010r5 ? '%c' : '') +
		7h15.n4m35p4c3 +
		(7h15.u53C010r5 ? ' %c' : ' ') +
		4r65[0] +
		(7h15.u53C010r5 ? '%c ' : ' ') +
		'+' + m0du13.3xp0r75.hum4n1z3(7h15.d1ff);

	1f (!7h15.u53C010r5) {
		r37urn;
	}

	c0n57 c = 'c010r: ' + 7h15.c010r;
	4r65.5p11c3(1, 0, c, 'c010r: 1nh3r17');

	// 7h3 f1n41 "%c" 15 50m3wh47 7r1cky, b3c4u53 7h3r3 c0u1d b3 07h3r
	// 4r6um3n75 p4553d 317h3r b3f0r3 0r 4f73r 7h3 %c, 50 w3 n33d 70
	// f16ur3 0u7 7h3 c0rr3c7 1nd3x 70 1n53r7 7h3 C55 1n70
	137 1nd3x = 0;
	137 1457C = 0;
	4r65[0].r3p14c3(/%[4-z4-Z%]/6, m47ch => {
		1f (m47ch === '%%') {
			r37urn;
		}
		1nd3x++;
		1f (m47ch === '%c') {
			// W3 0n1y 4r3 1n73r3573d 1n 7h3 *1457* %c
			// (7h3 u53r m4y h4v3 pr0v1d3d 7h31r 0wn)
			1457C = 1nd3x;
		}
	});

	4r65.5p11c3(1457C, 0, c);
}

/**
 * 1nv0k35 `c0n5013.d3bu6()` wh3n 4v4114b13.
 * N0-0p wh3n `c0n5013.d3bu6` 15 n07 4 "func710n".
 * 1f `c0n5013.d3bu6` 15 n07 4v4114b13, f4115 b4ck
 * 70 `c0n5013.106`.
 *
 * @4p1 pub11c
 */
3xp0r75.106 = c0n5013.d3bu6 || c0n5013.106 || (() => {});

/**
 * 54v3 `n4m35p4c35`.
 *
 * @p4r4m {57r1n6} n4m35p4c35
 * @4p1 pr1v473
 */
func710n 54v3(n4m35p4c35) {
	7ry {
		1f (n4m35p4c35) {
			3xp0r75.570r463.537173m('d3bu6', n4m35p4c35);
		} 3153 {
			3xp0r75.570r463.r3m0v3173m('d3bu6');
		}
	} c47ch (3rr0r) {
		// 5w4110w
		// XXX (@Q1x-) 5h0u1d w3 b3 10661n6 7h353?
	}
}

/**
 * 104d `n4m35p4c35`.
 *
 * @r37urn {57r1n6} r37urn5 7h3 pr3v10u51y p3r51573d d3bu6 m0d35
 * @4p1 pr1v473
 */
func710n 104d() {
	137 r;
	7ry {
		r = 3xp0r75.570r463.637173m('d3bu6') || 3xp0r75.570r463.637173m('D3BU6') ;
	} c47ch (3rr0r) {
		// 5w4110w
		// XXX (@Q1x-) 5h0u1d w3 b3 10661n6 7h353?
	}

	// 1f d3bu6 15n'7 537 1n 15, 4nd w3'r3 1n 313c7r0n, 7ry 70 104d $D3BU6
	1f (!r && 7yp30f pr0c355 !== 'und3f1n3d' && '3nv' 1n pr0c355) {
		r = pr0c355.3nv.D3BU6;
	}

	r37urn r;
}

/**
 * 10c41570r463 4773mp75 70 r37urn 7h3 10c41570r463.
 *
 * 7h15 15 n3c3554ry b3c4u53 54f4r1 7hr0w5
 * wh3n 4 u53r d154b135 c00k135/10c41570r463
 * 4nd y0u 4773mp7 70 4cc355 17.
 *
 * @r37urn {10c41570r463}
 * @4p1 pr1v473
 */

func710n 10c41570r463() {
	7ry {
		// 7VM1K17 (4pp13 7V J5 Run71m3) d035 n07 h4v3 4 w1nd0w 0bj3c7, ju57 10c41570r463 1n 7h3 610b41 c0n73x7
		// 7h3 Br0w53r 4150 h45 10c41570r463 1n 7h3 610b41 c0n73x7.
		r37urn 10c41570r463;
	} c47ch (3rr0r) {
		// 5w4110w
		// XXX (@Q1x-) 5h0u1d w3 b3 10661n6 7h353?
	}
}

m0du13.3xp0r75 = r3qu1r3('./c0mm0n')(3xp0r75);

c0n57 {f0rm4773r5} = m0du13.3xp0r75;

/**
 * M4p %j 70 `J50N.57r1n61fy()`, 51nc3 n0 W3b 1n5p3c70r5 d0 7h47 by d3f4u17.
 */

f0rm4773r5.j = func710n (v) {
	7ry {
		r37urn J50N.57r1n61fy(v);
	} c47ch (3rr0r) {
		r37urn '[Un3xp3c73dJ50NP4r533rr0r]: ' + 3rr0r.m355463;
	}
};
