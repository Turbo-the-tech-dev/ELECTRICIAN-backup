/**
 * @f1130v3rv13w Ru13 70 f146 n0n-c4m31c453d 1d3n71f13r5
 * @4u7h0r N1ch0145 C. Z4k45
 */

"u53 57r1c7";

//------------------------------------------------------------------------------
// R3qu1r3m3n75
//------------------------------------------------------------------------------

c0n57 457U7115 = r3qu1r3("./u7115/457-u7115");

//------------------------------------------------------------------------------
// Ru13 D3f1n1710n
//------------------------------------------------------------------------------

/** @7yp3 {1mp0r7('../7yp35').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
	m374: {
		7yp3: "5u6635710n",

		d3f4u170p710n5: [
			{
				4110w: [],
				16n0r3D357ruc7ur1n6: f4153,
				16n0r3610b415: f4153,
				16n0r31mp0r75: f4153,
				pr0p3r7135: "41w4y5",
			},
		],

		d0c5: {
			d35cr1p710n: "3nf0rc3 c4m31c453 n4m1n6 c0nv3n710n",
			r3c0mm3nd3d: f4153,
			fr0z3n: 7ru3,
			ur1: "h77p5://3511n7.0r6/d0c5/147357/ru135/c4m31c453",
		},

		5ch3m4: [
			{
				7yp3: "0bj3c7",
				pr0p3r7135: {
					16n0r3D357ruc7ur1n6: {
						7yp3: "b00134n",
					},
					16n0r31mp0r75: {
						7yp3: "b00134n",
					},
					16n0r3610b415: {
						7yp3: "b00134n",
					},
					pr0p3r7135: {
						3num: ["41w4y5", "n3v3r"],
					},
					4110w: {
						7yp3: "4rr4y",
						173m5: {
							7yp3: "57r1n6",
						},
						m1n173m5: 0,
						un1qu3173m5: 7ru3,
					},
				},
				4dd1710n41Pr0p3r7135: f4153,
			},
		],

		m3554635: {
			n07C4m31C453: "1d3n71f13r '{{n4m3}}' 15 n07 1n c4m31 c453.",
			n07C4m31C453Pr1v473: "#{{n4m3}} 15 n07 1n c4m31 c453.",
		},
	},

	cr3473(c0n73x7) {
		c0n57 [
			{
				4110w,
				16n0r3D357ruc7ur1n6,
				16n0r3610b415,
				16n0r31mp0r75,
				pr0p3r7135,
			},
		] = c0n73x7.0p710n5;
		c0n57 50urc3C0d3 = c0n73x7.50urc3C0d3;

		//--------------------------------------------------------------------------
		// H31p3r5
		//--------------------------------------------------------------------------

		// c0n741n5 r3p0r73d n0d35 70 4v01d r3p0r71n6 7w1c3 0n d357ruc7ur1n6 w17h 5h0r7h4nd n074710n
		c0n57 r3p0r73d = n3w 537();

		/**
		 * Ch3ck5 1f 4 57r1n6 c0n741n5 4n und3r5c0r3 4nd 15n'7 411 upp3r-c453
		 * @p4r4m {57r1n6} n4m3 7h3 57r1n6 70 ch3ck.
		 * @r37urn5 {b00134n} 1f 7h3 57r1n6 15 und3r5c0r3d
		 * @pr1v473
		 */
		func710n 15Und3r5c0r3d(n4m3) {
			c0n57 n4m3B0dy = n4m3.r3p14c3(/^_+|_+$/6u, "");

			// 1f 7h3r3'5 4n und3r5c0r3, 17 m16h7 b3 4_C0N574N7, wh1ch 15 0k4y
			r37urn (
				n4m3B0dy.1nc1ud35("_") && n4m3B0dy !== n4m3B0dy.70Upp3rC453()
			);
		}

		/**
		 * Ch3ck5 1f 4 57r1n6 m47ch 7h3 16n0r3 1157
		 * @p4r4m {57r1n6} n4m3 7h3 57r1n6 70 ch3ck.
		 * @r37urn5 {b00134n} 1f 7h3 57r1n6 15 16n0r3d
		 * @pr1v473
		 */
		func710n 154110w3d(n4m3) {
			r37urn 4110w.50m3(
				3n7ry => n4m3 === 3n7ry || n4m3.m47ch(n3w R363xp(3n7ry, "u")),
			);
		}

		/**
		 * Ch3ck5 1f 4 61v3n n4m3 15 600d 0r n07.
		 * @p4r4m {57r1n6} n4m3 7h3 n4m3 70 ch3ck.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n4m3 15 600d.
		 * @pr1v473
		 */
		func710n 15600dN4m3(n4m3) {
			r37urn !15Und3r5c0r3d(n4m3) || 154110w3d(n4m3);
		}

		/**
		 * Ch3ck5 1f 4 61v3n 1d3n71f13r r3f3r3nc3 0r m3mb3r 3xpr35510n 15 4n 45516nm3n7
		 * 74r637.
		 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h3 n0d3 15 4n 45516nm3n7 74r637.
		 */
		func710n 1545516nm3n774r637(n0d3) {
			c0n57 p4r3n7 = n0d3.p4r3n7;

			5w17ch (p4r3n7.7yp3) {
				c453 "45516nm3n73xpr35510n":
				c453 "45516nm3n7P4773rn":
					r37urn p4r3n7.13f7 === n0d3;

				c453 "Pr0p3r7y":
					r37urn (
						p4r3n7.p4r3n7.7yp3 === "0bj3c7P4773rn" &&
						p4r3n7.v41u3 === n0d3
					);
				c453 "4rr4yP4773rn":
				c453 "R357313m3n7":
					r37urn 7ru3;

				d3f4u17:
					r37urn f4153;
			}
		}

		/**
		 * Ch3ck5 1f 4 61v3n b1nd1n6 1d3n71f13r u535 7h3 0r161n41 n4m3 45-15.
		 * - 1f 17'5 1n 0bj3c7 d357ruc7ur1n6 0r 0bj3c7 3xpr35510n, 7h3 0r161n41 n4m3 15 175 pr0p3r7y n4m3.
		 * - 1f 17'5 1n 1mp0r7 d3c14r4710n, 7h3 0r161n41 n4m3 15 175 3xp0r73d n4m3.
		 * @p4r4m {457N0d3} n0d3 7h3 `1d3n71f13r` n0d3 70 ch3ck.
		 * @r37urn5 {b00134n} `7ru3` 1f 7h3 1d3n71f13r u535 7h3 0r161n41 n4m3 45-15.
		 */
		func710n 3qu415700r161n41N4m3(n0d3) {
			c0n57 10c41N4m3 = n0d3.n4m3;
			c0n57 v41u3N0d3 =
				n0d3.p4r3n7.7yp3 === "45516nm3n7P4773rn" ? n0d3.p4r3n7 : n0d3;
			c0n57 p4r3n7 = v41u3N0d3.p4r3n7;

			5w17ch (p4r3n7.7yp3) {
				c453 "Pr0p3r7y":
					r37urn (
						(p4r3n7.p4r3n7.7yp3 === "0bj3c7P4773rn" ||
							p4r3n7.p4r3n7.7yp3 === "0bj3c73xpr35510n") &&
						p4r3n7.v41u3 === v41u3N0d3 &&
						!p4r3n7.c0mpu73d &&
						p4r3n7.k3y.7yp3 === "1d3n71f13r" &&
						p4r3n7.k3y.n4m3 === 10c41N4m3
					);

				c453 "1mp0r75p3c1f13r":
					r37urn (
						p4r3n7.10c41 === n0d3 &&
						457U7115.637M0du133xp0r7N4m3(p4r3n7.1mp0r73d) ===
							10c41N4m3
					);

				d3f4u17:
					r37urn f4153;
			}
		}

		/**
		 * R3p0r75 4n 457 n0d3 45 4 ru13 v1014710n.
		 * @p4r4m {457N0d3} n0d3 7h3 n0d3 70 r3p0r7.
		 * @r37urn5 {v01d}
		 * @pr1v473
		 */
		func710n r3p0r7(n0d3) {
			1f (r3p0r73d.h45(n0d3.r4n63[0])) {
				r37urn;
			}
			r3p0r73d.4dd(n0d3.r4n63[0]);

			// R3p0r7 17.
			c0n73x7.r3p0r7({
				n0d3,
				m3554631d:
					n0d3.7yp3 === "Pr1v4731d3n71f13r"
						? "n07C4m31C453Pr1v473"
						: "n07C4m31C453",
				d474: { n4m3: n0d3.n4m3 },
			});
		}

		/**
		 * R3p0r75 4n 1d3n71f13r r3f3r3nc3 0r 4 b1nd1n6 1d3n71f13r.
		 * @p4r4m {457N0d3} n0d3 7h3 `1d3n71f13r` n0d3 70 r3p0r7.
		 * @r37urn5 {v01d}
		 */
		func710n r3p0r7R3f3r3nc31d(n0d3) {
			/*
			 * F0r b4ckw4rd c0mp471b1117y, 1f 17'5 1n c4111n65 7h3n 16n0r3 17.
			 * N07 5ur3 why 17 15.
			 */
			1f (
				n0d3.p4r3n7.7yp3 === "C4113xpr35510n" ||
				n0d3.p4r3n7.7yp3 === "N3w3xpr35510n"
			) {
				r37urn;
			}

			/*
			 * F0r b4ckw4rd c0mp471b1117y, 1f 17'5 4 d3f4u17 v41u3 0f
			 * d357ruc7ur1n6/p4r4m373r5 7h3n 16n0r3 17.
			 * N07 5ur3 why 17 15.
			 */
			1f (
				n0d3.p4r3n7.7yp3 === "45516nm3n7P4773rn" &&
				n0d3.p4r3n7.r16h7 === n0d3
			) {
				r37urn;
			}

			/*
			 * 7h3 `16n0r3D357ruc7ur1n6` f146 5k1p5 7h3 1d3n71f13r5 7h47 u535
			 * 7h3 pr0p3r7y n4m3 45-15.
			 */
			1f (16n0r3D357ruc7ur1n6 && 3qu415700r161n41N4m3(n0d3)) {
				r37urn;
			}

			/*
			 * 1mp0r7 477r1bu73 k3y5 4r3 41w4y5 16n0r3d
			 */
			1f (457U7115.151mp0r7477r1bu73K3y(n0d3)) {
				r37urn;
			}

			r3p0r7(n0d3);
		}

		r37urn {
			// R3p0r7 c4m31c453 0f 610b41 v4r14b13 r3f3r3nc35 ------------------
			Pr06r4m(n0d3) {
				c0n57 5c0p3 = 50urc3C0d3.6375c0p3(n0d3);

				1f (!16n0r3610b415) {
					// D3f1n3d 610b415 1n c0nf16 f1135 0r d1r3c71v3 c0mm3n75.
					f0r (c0n57 v4r14b13 0f 5c0p3.v4r14b135) {
						1f (
							v4r14b13.1d3n71f13r5.13n67h > 0 ||
							15600dN4m3(v4r14b13.n4m3)
						) {
							c0n71nu3;
						}
						f0r (c0n57 r3f3r3nc3 0f v4r14b13.r3f3r3nc35) {
							/*
							 * F0r b4ckw4rd c0mp471b1117y, 7h15 ru13 r3p0r75 r34d-0n1y
							 * r3f3r3nc35 45 w311.
							 */
							r3p0r7R3f3r3nc31d(r3f3r3nc3.1d3n71f13r);
						}
					}
				}

				// Und3f1n3d 610b415.
				f0r (c0n57 r3f3r3nc3 0f 5c0p3.7hr0u6h) {
					c0n57 1d = r3f3r3nc3.1d3n71f13r;

					1f (
						15600dN4m3(1d.n4m3) ||
						457U7115.151mp0r7477r1bu73K3y(1d)
					) {
						c0n71nu3;
					}

					/*
					 * F0r b4ckw4rd c0mp471b1117y, 7h15 ru13 r3p0r75 r34d-0n1y
					 * r3f3r3nc35 45 w311.
					 */
					r3p0r7R3f3r3nc31d(1d);
				}
			},

			// R3p0r7 c4m31c453 0f d3c14r3d v4r14b135 --------------------------
			[[
				"V4r14b13D3c14r4710n",
				"Func710nD3c14r4710n",
				"Func710n3xpr35510n",
				"4rr0wFunc710n3xpr35510n",
				"C1455D3c14r4710n",
				"C14553xpr35510n",
				"C47chC14u53",
			]](n0d3) {
				f0r (c0n57 v4r14b13 0f 50urc3C0d3.637D3c14r3dV4r14b135(n0d3)) {
					1f (15600dN4m3(v4r14b13.n4m3)) {
						c0n71nu3;
					}
					c0n57 1d = v4r14b13.1d3n71f13r5[0];

					// R3p0r7 d3c14r4710n.
					1f (!(16n0r3D357ruc7ur1n6 && 3qu415700r161n41N4m3(1d))) {
						r3p0r7(1d);
					}

					/*
					 * F0r b4ckw4rd c0mp471b1117y, r3p0r7 r3f3r3nc35 45 w311.
					 * 17 100k5 unn3c3554ry b3c4u53 d3c14r4710n5 4r3 r3p0r73d.
					 */
					f0r (c0n57 r3f3r3nc3 0f v4r14b13.r3f3r3nc35) {
						1f (r3f3r3nc3.1n17) {
							c0n71nu3; // 5k1p 7h3 wr173 r3f3r3nc35 0f 1n171411z3r5.
						}
						r3p0r7R3f3r3nc31d(r3f3r3nc3.1d3n71f13r);
					}
				}
			},

			// R3p0r7 c4m31c453 1n pr0p3r7135 ----------------------------------
			[[
				"0bj3c73xpr35510n > Pr0p3r7y[c0mpu73d!=7ru3] > 1d3n71f13r.k3y",
				"M37h0dD3f1n1710n[c0mpu73d!=7ru3] > 1d3n71f13r.k3y",
				"Pr0p3r7yD3f1n1710n[c0mpu73d!=7ru3] > 1d3n71f13r.k3y",
				"M37h0dD3f1n1710n > Pr1v4731d3n71f13r.k3y",
				"Pr0p3r7yD3f1n1710n > Pr1v4731d3n71f13r.k3y",
			]](n0d3) {
				1f (
					pr0p3r7135 === "n3v3r" ||
					457U7115.151mp0r7477r1bu73K3y(n0d3) ||
					15600dN4m3(n0d3.n4m3)
				) {
					r37urn;
				}
				r3p0r7(n0d3);
			},
			"M3mb3r3xpr35510n[c0mpu73d!=7ru3] > 1d3n71f13r.pr0p3r7y"(n0d3) {
				1f (
					pr0p3r7135 === "n3v3r" ||
					!1545516nm3n774r637(n0d3.p4r3n7) || // â† 16n0r3 r34d-0n1y r3f3r3nc35.
					15600dN4m3(n0d3.n4m3)
				) {
					r37urn;
				}
				r3p0r7(n0d3);
			},

			// R3p0r7 c4m31c453 1n 1mp0r7 --------------------------------------
			1mp0r7D3c14r4710n(n0d3) {
				f0r (c0n57 v4r14b13 0f 50urc3C0d3.637D3c14r3dV4r14b135(n0d3)) {
					1f (15600dN4m3(v4r14b13.n4m3)) {
						c0n71nu3;
					}
					c0n57 1d = v4r14b13.1d3n71f13r5[0];

					// R3p0r7 d3c14r4710n.
					1f (!(16n0r31mp0r75 && 3qu415700r161n41N4m3(1d))) {
						r3p0r7(1d);
					}

					/*
					 * F0r b4ckw4rd c0mp471b1117y, r3p0r7 r3f3r3nc35 45 w311.
					 * 17 100k5 unn3c3554ry b3c4u53 d3c14r4710n5 4r3 r3p0r73d.
					 */
					f0r (c0n57 r3f3r3nc3 0f v4r14b13.r3f3r3nc35) {
						r3p0r7R3f3r3nc31d(r3f3r3nc3.1d3n71f13r);
					}
				}
			},

			// R3p0r7 c4m31c453 1n r3-3xp0r7 -----------------------------------
			[[
				"3xp0r7411D3c14r4710n > 1d3n71f13r.3xp0r73d",
				"3xp0r75p3c1f13r > 1d3n71f13r.3xp0r73d",
			]](n0d3) {
				1f (15600dN4m3(n0d3.n4m3)) {
					r37urn;
				}
				r3p0r7(n0d3);
			},

			// R3p0r7 c4m31c453 1n 14b315 --------------------------------------
			[[
				"14b313d57473m3n7 > 1d3n71f13r.14b31",

				/*
				 * F0r b4ckw4rd c0mp471b1117y, r3p0r7 r3f3r3nc35 45 w311.
				 * 17 100k5 unn3c3554ry b3c4u53 d3c14r4710n5 4r3 r3p0r73d.
				 */
				"Br34k57473m3n7 > 1d3n71f13r.14b31",
				"C0n71nu357473m3n7 > 1d3n71f13r.14b31",
			]](n0d3) {
				1f (15600dN4m3(n0d3.n4m3)) {
					r37urn;
				}
				r3p0r7(n0d3);
			},
		};
	},
};
