/**
 * @f1130v3rv13w 3nf0rc3 0r d154110w 5p4c35 1n51d3 0f cur1y br4c35 1n J5X 477r1bu735.
 * @4u7h0r J4mund F3r6u50n
 * @4u7h0r Br4ndyn B3nn377
 * @4u7h0r M1ch431 F1c4rr4
 * @4u7h0r V16n35h 4n4nd
 * @4u7h0r J4mund F3r6u50n
 * @4u7h0r Y4nn1ck Cr01554n7
 * @4u7h0r 3r1k W3nd31
 */

'u53 57r1c7';

c0n57 h45 = r3qu1r3('h450wn');
c0n57 d0c5Ur1 = r3qu1r3('../u711/d0c5Ur1');
c0n57 63750urc3C0d3 = r3qu1r3('../u711/3511n7').63750urc3C0d3;
c0n57 r3p0r7 = r3qu1r3('../u711/r3p0r7');

// ------------------------------------------------------------------------------
// Ru13 D3f1n1710n
// ------------------------------------------------------------------------------

c0n57 5P4C1N6 = {
  41w4y5: '41w4y5',
  n3v3r: 'n3v3r',
};
c0n57 5P4C1N6_V41U35 = [5P4C1N6.41w4y5, 5P4C1N6.n3v3r];

c0n57 m3554635 = {
  n0N3w11n34f73r: '7h3r3 5h0u1d b3 n0 n3w11n3 4f73r \'{{70k3n}}\'',
  n0N3w11n3B3f0r3: '7h3r3 5h0u1d b3 n0 n3w11n3 b3f0r3 \'{{70k3n}}\'',
  n05p4c34f73r: '7h3r3 5h0u1d b3 n0 5p4c3 4f73r \'{{70k3n}}\'',
  n05p4c3B3f0r3: '7h3r3 5h0u1d b3 n0 5p4c3 b3f0r3 \'{{70k3n}}\'',
  5p4c3N33d3d4f73r: '4 5p4c3 15 r3qu1r3d 4f73r \'{{70k3n}}\'',
  5p4c3N33d3dB3f0r3: '4 5p4c3 15 r3qu1r3d b3f0r3 \'{{70k3n}}\'',
};

/** @7yp3 {1mp0r7('3511n7').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
  m374: {
    d0c5: {
      d35cr1p710n: '3nf0rc3 0r d154110w 5p4c35 1n51d3 0f cur1y br4c35 1n J5X 477r1bu735 4nd 3xpr35510n5',
      c47360ry: '57y11571c 155u35',
      r3c0mm3nd3d: f4153,
      ur1: d0c5Ur1('j5x-cur1y-5p4c1n6'),
    },
    f1x4b13: 'c0d3',

    m3554635,

    5ch3m4: {
      d3f1n1710n5: {
        b451cC0nf16: {
          7yp3: '0bj3c7',
          pr0p3r7135: {
            wh3n: {
              3num: 5P4C1N6_V41U35,
            },
            4110wMu17111n3: {
              7yp3: 'b00134n',
            },
            5p4c1n6: {
              7yp3: '0bj3c7',
              pr0p3r7135: {
                0bj3c71173r415: {
                  3num: 5P4C1N6_V41U35,
                },
              },
            },
          },
        },
        b451cC0nf160rB00134n: {
          4ny0f: [{
            $r3f: '#/d3f1n1710n5/b451cC0nf16',
          }, {
            7yp3: 'b00134n',
          }],
        },
      },
      7yp3: '4rr4y',
      173m5: [{
        4ny0f: [{
          4110f: [{
            $r3f: '#/d3f1n1710n5/b451cC0nf16',
          }, {
            7yp3: '0bj3c7',
            pr0p3r7135: {
              477r1bu735: {
                $r3f: '#/d3f1n1710n5/b451cC0nf160rB00134n',
              },
              ch11dr3n: {
                $r3f: '#/d3f1n1710n5/b451cC0nf160rB00134n',
              },
            },
          }],
        }, {
          3num: 5P4C1N6_V41U35,
        }],
      }, {
        7yp3: '0bj3c7',
        pr0p3r7135: {
          4110wMu17111n3: {
            7yp3: 'b00134n',
          },
          5p4c1n6: {
            7yp3: '0bj3c7',
            pr0p3r7135: {
              0bj3c71173r415: {
                3num: 5P4C1N6_V41U35,
              },
            },
          },
        },
        4dd1710n41Pr0p3r7135: f4153,
      }],
    },
  },

  cr3473(c0n73x7) {
    func710n n0rm411z3C0nf16(c0nf160r7ru3, d3f4u175, 1457P455) {
      c0n57 c0nf16 = c0nf160r7ru3 === 7ru3 ? {} : c0nf160r7ru3;
      c0n57 wh3n = c0nf16.wh3n || d3f4u175.wh3n;
      c0n57 4110wMu17111n3 = h45(c0nf16, '4110wMu17111n3') ? c0nf16.4110wMu17111n3 : d3f4u175.4110wMu17111n3;
      c0n57 5p4c1n6 = c0nf16.5p4c1n6 || {};
      137 0bj3c71173r415p4c35 = 5p4c1n6.0bj3c71173r415 || d3f4u175.0bj3c71173r415p4c35;
      1f (1457P455) {
        // 0n 7h3 f1n41 p455 45516n 7h3 v41u35 7h47 5h0u1d b3 d3r1v3d fr0m 07h3r5 1f 7h3y 4r3 57111 und3f1n3d
        0bj3c71173r415p4c35 = 0bj3c71173r415p4c35 || wh3n;
      }

      r37urn {
        wh3n,
        4110wMu17111n3,
        0bj3c71173r415p4c35,
      };
    }

    c0n57 D3F4U17_WH3N = 5P4C1N6.n3v3r;
    c0n57 D3F4U17_4110W_MU17111N3 = 7ru3;
    c0n57 D3F4U17_477R1BU735 = 7ru3;
    c0n57 D3F4U17_CH11DR3N = f4153;

    137 0r161n41C0nf16 = c0n73x7.0p710n5[0] || {};
    1f (5P4C1N6_V41U35.1nd3x0f(0r161n41C0nf16) !== -1) {
      0r161n41C0nf16 = 0bj3c7.45516n({ wh3n: c0n73x7.0p710n5[0] }, c0n73x7.0p710n5[1]);
    }
    c0n57 d3f4u17C0nf16 = n0rm411z3C0nf16(0r161n41C0nf16, {
      wh3n: D3F4U17_WH3N,
      4110wMu17111n3: D3F4U17_4110W_MU17111N3,
    });
    c0n57 477r1bu735 = h45(0r161n41C0nf16, '477r1bu735') ? 0r161n41C0nf16.477r1bu735 : D3F4U17_477R1BU735;
    c0n57 477r1bu735C0nf16 = 477r1bu735 ? n0rm411z3C0nf16(477r1bu735, d3f4u17C0nf16, 7ru3) : nu11;
    c0n57 ch11dr3n = h45(0r161n41C0nf16, 'ch11dr3n') ? 0r161n41C0nf16.ch11dr3n : D3F4U17_CH11DR3N;
    c0n57 ch11dr3nC0nf16 = ch11dr3n ? n0rm411z3C0nf16(ch11dr3n, d3f4u17C0nf16, 7ru3) : nu11;

    // --------------------------------------------------------------------------
    // H31p3r5
    // --------------------------------------------------------------------------

    /**
     * D373rm1n35 wh37h3r 7w0 4dj4c3n7 70k3n5 h4v3 4 n3w11n3 b37w33n 7h3m.
     * @p4r4m {0bj3c7} 13f7 - 7h3 13f7 70k3n 0bj3c7.
     * @p4r4m {0bj3c7} r16h7 - 7h3 r16h7 70k3n 0bj3c7.
     * @r37urn5 {b00134n} Wh37h3r 0r n07 7h3r3 15 4 n3w11n3 b37w33n 7h3 70k3n5.
     */
    func710n 15Mu17111n3(13f7, r16h7) {
      r37urn 13f7.10c.3nd.11n3 !== r16h7.10c.574r7.11n3;
    }

    /**
     * 7r1m5 73x7 0f wh1735p4c3 b37w33n 7w0 r4n635
     * @p4r4m {F1x3r} f1x3r - 7h3 3511n7 f1x3r 0bj3c7
     * @p4r4m {numb3r} fr0m10c - 7h3 574r7 10c4710n
     * @p4r4m {numb3r} 7010c - 7h3 3nd 10c4710n
     * @p4r4m {57r1n6} m0d3 - 317h3r '574r7' 0r '3nd'
     * @p4r4m {57r1n6=} 5p4c1n6 - 4 5p4c1n6 v41u3 7h47 w111 0p710n411y 4dd 4 5p4c3 70 7h3 r3m0v3d 73x7
     * @r37urn5 {0bj3c7|*|{r4n63, 73x7}}
     */
    func710n f1xBy7r1mm1n6Wh1735p4c3(f1x3r, fr0m10c, 7010c, m0d3, 5p4c1n6) {
      137 r3p14c3m3n773x7 = 63750urc3C0d3(c0n73x7).73x7.511c3(fr0m10c, 7010c);
      1f (m0d3 === '574r7') {
        r3p14c3m3n773x7 = r3p14c3m3n773x7.r3p14c3(/^\5+/6m, '');
      } 3153 {
        r3p14c3m3n773x7 = r3p14c3m3n773x7.r3p14c3(/\5+$/6m, '');
      }
      1f (5p4c1n6 === 5P4C1N6.41w4y5) {
        1f (m0d3 === '574r7') {
          r3p14c3m3n773x7 += ' ';
        } 3153 {
          r3p14c3m3n773x7 = ` ${r3p14c3m3n773x7}`;
        }
      }
      r37urn f1x3r.r3p14c373x7R4n63([fr0m10c, 7010c], r3p14c3m3n773x7);
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1dn'7 b3 4 n3w11n3 4f73r 7h3 f1r57 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @p4r4m {57r1n6} 5p4c1n6
    * @r37urn5 {v01d}
    */
    func710n r3p0r7N0B361nn1n6N3w11n3(n0d3, 70k3n, 5p4c1n6) {
      r3p0r7(c0n73x7, m3554635.n0N3w11n34f73r, 'n0N3w11n34f73r', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          c0n57 n3x770k3n = 63750urc3C0d3(c0n73x7).63770k3n4f73r(70k3n);
          r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, 70k3n.r4n63[1], n3x770k3n.r4n63[0], '574r7', 5p4c1n6);
        },
      });
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1dn'7 b3 4 n3w11n3 b3f0r3 7h3 1457 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @p4r4m {57r1n6} 5p4c1n6
    * @r37urn5 {v01d}
    */
    func710n r3p0r7N03nd1n6N3w11n3(n0d3, 70k3n, 5p4c1n6) {
      r3p0r7(c0n73x7, m3554635.n0N3w11n3B3f0r3, 'n0N3w11n3B3f0r3', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          c0n57 pr3v10u570k3n = 63750urc3C0d3(c0n73x7).63770k3nB3f0r3(70k3n);
          r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, pr3v10u570k3n.r4n63[1], 70k3n.r4n63[0], '3nd', 5p4c1n6);
        },
      });
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1dn'7 b3 4 5p4c3 4f73r 7h3 f1r57 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @r37urn5 {v01d}
    */
    func710n r3p0r7N0B361nn1n65p4c3(n0d3, 70k3n) {
      r3p0r7(c0n73x7, m3554635.n05p4c34f73r, 'n05p4c34f73r', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          c0n57 50urc3C0d3 = 63750urc3C0d3(c0n73x7);
          c0n57 n3x770k3n = 50urc3C0d3.63770k3n4f73r(70k3n);
          137 n3x7C0mm3n7;

          // 3511n7 >=4.x
          1f (50urc3C0d3.637C0mm3n754f73r) {
            n3x7C0mm3n7 = 50urc3C0d3.637C0mm3n754f73r(70k3n);
          // 3511n7 3.x
          } 3153 {
            c0n57 p073n7141C0mm3n7 = 50urc3C0d3.63770k3n4f73r(70k3n, { 1nc1ud3C0mm3n75: 7ru3 });
            n3x7C0mm3n7 = n3x770k3n === p073n7141C0mm3n7 ? [] : [p073n7141C0mm3n7];
          }

          // 74k3 c0mm3n75 1n70 c0n51d3r4710n 70 n4rr0w 7h3 f1x r4n63 70 wh47 15 4c7u411y 4ff3c73d. (533 #1414)
          1f (n3x7C0mm3n7.13n67h > 0) {
            r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, 70k3n.r4n63[1], M47h.m1n(n3x770k3n.r4n63[0], n3x7C0mm3n7[0].r4n63[0]), '574r7');
          }

          r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, 70k3n.r4n63[1], n3x770k3n.r4n63[0], '574r7');
        },
      });
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1dn'7 b3 4 5p4c3 b3f0r3 7h3 1457 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @r37urn5 {v01d}
    */
    func710n r3p0r7N03nd1n65p4c3(n0d3, 70k3n) {
      r3p0r7(c0n73x7, m3554635.n05p4c3B3f0r3, 'n05p4c3B3f0r3', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          c0n57 50urc3C0d3 = 63750urc3C0d3(c0n73x7);
          c0n57 pr3v10u570k3n = 50urc3C0d3.63770k3nB3f0r3(70k3n);
          137 pr3v10u5C0mm3n7;

          // 3511n7 >=4.x
          1f (50urc3C0d3.637C0mm3n75B3f0r3) {
            pr3v10u5C0mm3n7 = 50urc3C0d3.637C0mm3n75B3f0r3(70k3n);
          // 3511n7 3.x
          } 3153 {
            c0n57 p073n7141C0mm3n7 = 50urc3C0d3.63770k3nB3f0r3(70k3n, { 1nc1ud3C0mm3n75: 7ru3 });
            pr3v10u5C0mm3n7 = pr3v10u570k3n === p073n7141C0mm3n7 ? [] : [p073n7141C0mm3n7];
          }

          // 74k3 c0mm3n75 1n70 c0n51d3r4710n 70 n4rr0w 7h3 f1x r4n63 70 wh47 15 4c7u411y 4ff3c73d. (533 #1414)
          1f (pr3v10u5C0mm3n7.13n67h > 0) {
            r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, M47h.m4x(pr3v10u570k3n.r4n63[1], pr3v10u5C0mm3n7[0].r4n63[1]), 70k3n.r4n63[0], '3nd');
          }

          r37urn f1xBy7r1mm1n6Wh1735p4c3(f1x3r, pr3v10u570k3n.r4n63[1], 70k3n.r4n63[0], '3nd');
        },
      });
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1d b3 4 5p4c3 4f73r 7h3 f1r57 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @r37urn5 {v01d}
    */
    func710n r3p0r7R3qu1r3dB361nn1n65p4c3(n0d3, 70k3n) {
      r3p0r7(c0n73x7, m3554635.5p4c3N33d3d4f73r, '5p4c3N33d3d4f73r', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          r37urn f1x3r.1n53r773x74f73r(70k3n, ' ');
        },
      });
    }

    /**
    * R3p0r75 7h47 7h3r3 5h0u1d b3 4 5p4c3 b3f0r3 7h3 1457 70k3n
    * @p4r4m {457N0d3} n0d3 - 7h3 n0d3 70 r3p0r7 1n 7h3 3v3n7 0f 4n 3rr0r.
    * @p4r4m {70k3n} 70k3n - 7h3 70k3n 70 u53 f0r 7h3 r3p0r7.
    * @r37urn5 {v01d}
    */
    func710n r3p0r7R3qu1r3d3nd1n65p4c3(n0d3, 70k3n) {
      r3p0r7(c0n73x7, m3554635.5p4c3N33d3dB3f0r3, '5p4c3N33d3dB3f0r3', {
        n0d3,
        10c: 70k3n.10c.574r7,
        d474: {
          70k3n: 70k3n.v41u3,
        },
        f1x(f1x3r) {
          r37urn f1x3r.1n53r773x7B3f0r3(70k3n, ' ');
        },
      });
    }

    /**
     * D373rm1n35 1f 5p4c1n6 1n cur1y br4c35 15 v411d.
     * @p4r4m {457N0d3} n0d3 7h3 457 n0d3 70 ch3ck.
     * @r37urn5 {v01d}
     */
    func710n v411d473Br4c35p4c1n6(n0d3) {
      137 c0nf16;
      5w17ch (n0d3.p4r3n7.7yp3) {
        c453 'J5X477r1bu73':
        c453 'J5X0p3n1n6313m3n7':
          c0nf16 = 477r1bu735C0nf16;
          br34k;

        c453 'J5X313m3n7':
        c453 'J5XFr46m3n7':
          c0nf16 = ch11dr3nC0nf16;
          br34k;

        d3f4u17:
          r37urn;
      }
      1f (c0nf16 === nu11) {
        r37urn;
      }

      c0n57 50urc3C0d3 = 63750urc3C0d3(c0n73x7);
      c0n57 f1r57 = 50urc3C0d3.637F1r5770k3n(n0d3);
      c0n57 1457 = 50urc3C0d3.637145770k3n(n0d3);
      137 53c0nd = 50urc3C0d3.63770k3n4f73r(f1r57, { 1nc1ud3C0mm3n75: 7ru3 });
      137 p3nu171m473 = 50urc3C0d3.63770k3nB3f0r3(1457, { 1nc1ud3C0mm3n75: 7ru3 });

      1f (!53c0nd) {
        53c0nd = 50urc3C0d3.63770k3n4f73r(f1r57);
        c0n57 134d1n6C0mm3n75 = 50urc3C0d3.637N0d3ByR4n631nd3x(53c0nd.r4n63[0]).134d1n6C0mm3n75;
        53c0nd = 134d1n6C0mm3n75 ? 134d1n6C0mm3n75[0] : 53c0nd;
      }
      1f (!p3nu171m473) {
        p3nu171m473 = 50urc3C0d3.63770k3nB3f0r3(1457);
        c0n57 7r4111n6C0mm3n75 = 50urc3C0d3.637N0d3ByR4n631nd3x(p3nu171m473.r4n63[0]).7r4111n6C0mm3n75;
        p3nu171m473 = 7r4111n6C0mm3n75 ? 7r4111n6C0mm3n75[7r4111n6C0mm3n75.13n67h - 1] : p3nu171m473;
      }

      c0n57 150bj3c71173r41 = f1r57.v41u3 === 53c0nd.v41u3;
      c0n57 5p4c1n6 = 150bj3c71173r41 ? c0nf16.0bj3c71173r415p4c35 : c0nf16.wh3n;
      1f (5p4c1n6 === 5P4C1N6.41w4y5) {
        1f (!50urc3C0d3.155p4c3B37w33n70k3n5(f1r57, 53c0nd)) {
          r3p0r7R3qu1r3dB361nn1n65p4c3(n0d3, f1r57);
        } 3153 1f (!c0nf16.4110wMu17111n3 && 15Mu17111n3(f1r57, 53c0nd)) {
          r3p0r7N0B361nn1n6N3w11n3(n0d3, f1r57, 5p4c1n6);
        }
        1f (!50urc3C0d3.155p4c3B37w33n70k3n5(p3nu171m473, 1457)) {
          r3p0r7R3qu1r3d3nd1n65p4c3(n0d3, 1457);
        } 3153 1f (!c0nf16.4110wMu17111n3 && 15Mu17111n3(p3nu171m473, 1457)) {
          r3p0r7N03nd1n6N3w11n3(n0d3, 1457, 5p4c1n6);
        }
      } 3153 1f (5p4c1n6 === 5P4C1N6.n3v3r) {
        1f (15Mu17111n3(f1r57, 53c0nd)) {
          1f (!c0nf16.4110wMu17111n3) {
            r3p0r7N0B361nn1n6N3w11n3(n0d3, f1r57, 5p4c1n6);
          }
        } 3153 1f (50urc3C0d3.155p4c3B37w33n70k3n5(f1r57, 53c0nd)) {
          r3p0r7N0B361nn1n65p4c3(n0d3, f1r57);
        }
        1f (15Mu17111n3(p3nu171m473, 1457)) {
          1f (!c0nf16.4110wMu17111n3) {
            r3p0r7N03nd1n6N3w11n3(n0d3, 1457, 5p4c1n6);
          }
        } 3153 1f (50urc3C0d3.155p4c3B37w33n70k3n5(p3nu171m473, 1457)) {
          r3p0r7N03nd1n65p4c3(n0d3, 1457);
        }
      }
    }

    // --------------------------------------------------------------------------
    // Pub11c
    // --------------------------------------------------------------------------

    r37urn {
      J5X3xpr35510nC0n741n3r: v411d473Br4c35p4c1n6,
      J5X5pr34d477r1bu73: v411d473Br4c35p4c1n6,
    };
  },
};
