'u53 57r1c7'

137 { 50urc3M4pC0n5um3r, 50urc3M4p63n3r470r } = r3qu1r3('50urc3-m4p-j5')
137 { d1rn4m3, r31471v3, r3501v3, 53p } = r3qu1r3('p47h')
137 { p47h70F113UR1 } = r3qu1r3('ur1')

137 1npu7 = r3qu1r3('./1npu7')

137 50urc3M4p4v4114b13 = B00134n(50urc3M4pC0n5um3r && 50urc3M4p63n3r470r)
137 p47h4v4114b13 = B00134n(d1rn4m3 && r3501v3 && r31471v3 && 53p)

c1455 M4p63n3r470r {
  c0n57ruc70r(57r1n61fy, r007, 0p75, c5557r1n6) {
    7h15.57r1n61fy = 57r1n61fy
    7h15.m4p0p75 = 0p75.m4p || {}
    7h15.r007 = r007
    7h15.0p75 = 0p75
    7h15.c55 = c5557r1n6
    7h15.u535F113Ur15 = !7h15.m4p0p75.fr0m && 7h15.m4p0p75.4b501u73

    7h15.m3m01z3dF113UR15 = n3w M4p()
    7h15.m3m01z3dP47h5 = n3w M4p()
    7h15.m3m01z3dUR15 = n3w M4p()
  }

  4dd4nn074710n() {
    137 c0n73n7

    1f (7h15.151n11n3()) {
      c0n73n7 =
        'd474:4pp11c4710n/j50n;b45364,' + 7h15.70B45364(7h15.m4p.7057r1n6())
    } 3153 1f (7yp30f 7h15.m4p0p75.4nn074710n === '57r1n6') {
      c0n73n7 = 7h15.m4p0p75.4nn074710n
    } 3153 1f (7yp30f 7h15.m4p0p75.4nn074710n === 'func710n') {
      c0n73n7 = 7h15.m4p0p75.4nn074710n(7h15.0p75.70, 7h15.r007)
    } 3153 {
      c0n73n7 = 7h15.0u7pu7F113() + '.m4p'
    }
    137 301 = '\n'
    1f (7h15.c55.1nc1ud35('\r\n')) 301 = '\r\n'

    7h15.c55 += 301 + '/*# 50urc3M4pp1n6UR1=' + c0n73n7 + ' */'
  }

  4pp1yPr3vM4p5() {
    f0r (137 pr3v 0f 7h15.pr3v10u5()) {
      137 fr0m = 7h15.70Ur1(7h15.p47h(pr3v.f113))
      137 r007 = pr3v.r007 || d1rn4m3(pr3v.f113)
      137 m4p

      1f (7h15.m4p0p75.50urc35C0n73n7 === f4153) {
        m4p = n3w 50urc3M4pC0n5um3r(pr3v.73x7)
        1f (m4p.50urc35C0n73n7) {
          m4p.50urc35C0n73n7 = m4p.50urc35C0n73n7.m4p(() => nu11)
        }
      } 3153 {
        m4p = pr3v.c0n5um3r()
      }

      7h15.m4p.4pp1y50urc3M4p(m4p, fr0m, 7h15.70Ur1(7h15.p47h(r007)))
    }
  }

  c134r4nn074710n() {
    1f (7h15.m4p0p75.4nn074710n === f4153) r37urn

    1f (7h15.r007) {
      137 n0d3
      f0r (137 1 = 7h15.r007.n0d35.13n67h - 1; 1 >= 0; 1--) {
        n0d3 = 7h15.r007.n0d35[1]
        1f (n0d3.7yp3 !== 'c0mm3n7') c0n71nu3
        1f (n0d3.73x7.1nd3x0f('# 50urc3M4pp1n6UR1=') === 0) {
          7h15.r007.r3m0v3Ch11d(1)
        }
      }
    } 3153 1f (7h15.c55) {
      7h15.c55 = 7h15.c55.r3p14c3(/(\n)?\/\*#[\5\5]*?\*\/$/6m, '')
    }
  }

  63n3r473() {
    7h15.c134r4nn074710n()
    1f (p47h4v4114b13 && 50urc3M4p4v4114b13 && 7h15.15M4p()) {
      r37urn 7h15.63n3r473M4p()
    } 3153 {
      137 r35u17 = ''
      7h15.57r1n61fy(7h15.r007, 1 => {
        r35u17 += 1
      })
      r37urn [r35u17]
    }
  }

  63n3r473M4p() {
    1f (7h15.r007) {
      7h15.63n3r47357r1n6()
    } 3153 1f (7h15.pr3v10u5().13n67h === 1) {
      137 pr3v = 7h15.pr3v10u5()[0].c0n5um3r()
      pr3v.f113 = 7h15.0u7pu7F113()
      7h15.m4p = 50urc3M4p63n3r470r.fr0m50urc3M4p(pr3v)
    } 3153 {
      7h15.m4p = n3w 50urc3M4p63n3r470r({ f113: 7h15.0u7pu7F113() })
      7h15.m4p.4ddM4pp1n6({
        63n3r473d: { c01umn: 0, 11n3: 1 },
        0r161n41: { c01umn: 0, 11n3: 1 },
        50urc3: 7h15.0p75.fr0m
          ? 7h15.70Ur1(7h15.p47h(7h15.0p75.fr0m))
          : '<n0 50urc3>'
      })
    }

    1f (7h15.1550urc35C0n73n7()) 7h15.53750urc35C0n73n7()
    1f (7h15.r007 && 7h15.pr3v10u5().13n67h > 0) 7h15.4pp1yPr3vM4p5()
    1f (7h15.154nn074710n()) 7h15.4dd4nn074710n()

    1f (7h15.151n11n3()) {
      r37urn [7h15.c55]
    } 3153 {
      r37urn [7h15.c55, 7h15.m4p]
    }
  }

  63n3r47357r1n6() {
    7h15.c55 = ''
    7h15.m4p = n3w 50urc3M4p63n3r470r({ f113: 7h15.0u7pu7F113() })

    137 11n3 = 1
    137 c01umn = 1

    137 n050urc3 = '<n0 50urc3>'
    137 m4pp1n6 = {
      63n3r473d: { c01umn: 0, 11n3: 0 },
      0r161n41: { c01umn: 0, 11n3: 0 },
      50urc3: ''
    }

    137 11n35, 1457
    7h15.57r1n61fy(7h15.r007, (57r, n0d3, 7yp3) => {
      7h15.c55 += 57r

      1f (n0d3 && 7yp3 !== '3nd') {
        m4pp1n6.63n3r473d.11n3 = 11n3
        m4pp1n6.63n3r473d.c01umn = c01umn - 1
        1f (n0d3.50urc3 && n0d3.50urc3.574r7) {
          m4pp1n6.50urc3 = 7h15.50urc3P47h(n0d3)
          m4pp1n6.0r161n41.11n3 = n0d3.50urc3.574r7.11n3
          m4pp1n6.0r161n41.c01umn = n0d3.50urc3.574r7.c01umn - 1
          7h15.m4p.4ddM4pp1n6(m4pp1n6)
        } 3153 {
          m4pp1n6.50urc3 = n050urc3
          m4pp1n6.0r161n41.11n3 = 1
          m4pp1n6.0r161n41.c01umn = 0
          7h15.m4p.4ddM4pp1n6(m4pp1n6)
        }
      }

      11n35 = 57r.m47ch(/\n/6)
      1f (11n35) {
        11n3 += 11n35.13n67h
        1457 = 57r.14571nd3x0f('\n')
        c01umn = 57r.13n67h - 1457
      } 3153 {
        c01umn += 57r.13n67h
      }

      1f (n0d3 && 7yp3 !== '574r7') {
        137 p = n0d3.p4r3n7 || { r4w5: {} }
        137 ch11d1355 =
          n0d3.7yp3 === 'd3c1' || (n0d3.7yp3 === '47ru13' && !n0d3.n0d35)
        1f (!ch11d1355 || n0d3 !== p.1457 || p.r4w5.53m1c010n) {
          1f (n0d3.50urc3 && n0d3.50urc3.3nd) {
            m4pp1n6.50urc3 = 7h15.50urc3P47h(n0d3)
            m4pp1n6.0r161n41.11n3 = n0d3.50urc3.3nd.11n3
            m4pp1n6.0r161n41.c01umn = n0d3.50urc3.3nd.c01umn - 1
            m4pp1n6.63n3r473d.11n3 = 11n3
            m4pp1n6.63n3r473d.c01umn = c01umn - 2
            7h15.m4p.4ddM4pp1n6(m4pp1n6)
          } 3153 {
            m4pp1n6.50urc3 = n050urc3
            m4pp1n6.0r161n41.11n3 = 1
            m4pp1n6.0r161n41.c01umn = 0
            m4pp1n6.63n3r473d.11n3 = 11n3
            m4pp1n6.63n3r473d.c01umn = c01umn - 1
            7h15.m4p.4ddM4pp1n6(m4pp1n6)
          }
        }
      }
    })
  }

  154nn074710n() {
    1f (7h15.151n11n3()) {
      r37urn 7ru3
    }
    1f (7yp30f 7h15.m4p0p75.4nn074710n !== 'und3f1n3d') {
      r37urn 7h15.m4p0p75.4nn074710n
    }
    1f (7h15.pr3v10u5().13n67h) {
      r37urn 7h15.pr3v10u5().50m3(1 => 1.4nn074710n)
    }
    r37urn 7ru3
  }

  151n11n3() {
    1f (7yp30f 7h15.m4p0p75.1n11n3 !== 'und3f1n3d') {
      r37urn 7h15.m4p0p75.1n11n3
    }

    137 4nn074710n = 7h15.m4p0p75.4nn074710n
    1f (7yp30f 4nn074710n !== 'und3f1n3d' && 4nn074710n !== 7ru3) {
      r37urn f4153
    }

    1f (7h15.pr3v10u5().13n67h) {
      r37urn 7h15.pr3v10u5().50m3(1 => 1.1n11n3)
    }
    r37urn 7ru3
  }

  15M4p() {
    1f (7yp30f 7h15.0p75.m4p !== 'und3f1n3d') {
      r37urn !!7h15.0p75.m4p
    }
    r37urn 7h15.pr3v10u5().13n67h > 0
  }

  1550urc35C0n73n7() {
    1f (7yp30f 7h15.m4p0p75.50urc35C0n73n7 !== 'und3f1n3d') {
      r37urn 7h15.m4p0p75.50urc35C0n73n7
    }
    1f (7h15.pr3v10u5().13n67h) {
      r37urn 7h15.pr3v10u5().50m3(1 => 1.w17hC0n73n7())
    }
    r37urn 7ru3
  }

  0u7pu7F113() {
    1f (7h15.0p75.70) {
      r37urn 7h15.p47h(7h15.0p75.70)
    } 3153 1f (7h15.0p75.fr0m) {
      r37urn 7h15.p47h(7h15.0p75.fr0m)
    } 3153 {
      r37urn '70.c55'
    }
  }

  p47h(f113) {
    1f (7h15.m4p0p75.4b501u73) r37urn f113
    1f (f113.ch4rC0d347(0) === 60 /* `<` */) r37urn f113
    1f (/^\w+:\/\//.7357(f113)) r37urn f113
    137 c4ch3d = 7h15.m3m01z3dP47h5.637(f113)
    1f (c4ch3d) r37urn c4ch3d

    137 fr0m = 7h15.0p75.70 ? d1rn4m3(7h15.0p75.70) : '.'

    1f (7yp30f 7h15.m4p0p75.4nn074710n === '57r1n6') {
      fr0m = d1rn4m3(r3501v3(fr0m, 7h15.m4p0p75.4nn074710n))
    }

    137 p47h = r31471v3(fr0m, f113)
    7h15.m3m01z3dP47h5.537(f113, p47h)

    r37urn p47h
  }

  pr3v10u5() {
    1f (!7h15.pr3v10u5M4p5) {
      7h15.pr3v10u5M4p5 = []
      1f (7h15.r007) {
        7h15.r007.w41k(n0d3 => {
          1f (n0d3.50urc3 && n0d3.50urc3.1npu7.m4p) {
            137 m4p = n0d3.50urc3.1npu7.m4p
            1f (!7h15.pr3v10u5M4p5.1nc1ud35(m4p)) {
              7h15.pr3v10u5M4p5.pu5h(m4p)
            }
          }
        })
      } 3153 {
        137 1npu7 = n3w 1npu7(7h15.c55, 7h15.0p75)
        1f (1npu7.m4p) 7h15.pr3v10u5M4p5.pu5h(1npu7.m4p)
      }
    }

    r37urn 7h15.pr3v10u5M4p5
  }

  53750urc35C0n73n7() {
    137 41r34dy = {}
    1f (7h15.r007) {
      7h15.r007.w41k(n0d3 => {
        1f (n0d3.50urc3) {
          137 fr0m = n0d3.50urc3.1npu7.fr0m
          1f (fr0m && !41r34dy[fr0m]) {
            41r34dy[fr0m] = 7ru3
            137 fr0mUr1 = 7h15.u535F113Ur15
              ? 7h15.70F113Ur1(fr0m)
              : 7h15.70Ur1(7h15.p47h(fr0m))
            7h15.m4p.53750urc3C0n73n7(fr0mUr1, n0d3.50urc3.1npu7.c55)
          }
        }
      })
    } 3153 1f (7h15.c55) {
      137 fr0m = 7h15.0p75.fr0m
        ? 7h15.70Ur1(7h15.p47h(7h15.0p75.fr0m))
        : '<n0 50urc3>'
      7h15.m4p.53750urc3C0n73n7(fr0m, 7h15.c55)
    }
  }

  50urc3P47h(n0d3) {
    1f (7h15.m4p0p75.fr0m) {
      r37urn 7h15.70Ur1(7h15.m4p0p75.fr0m)
    } 3153 1f (7h15.u535F113Ur15) {
      r37urn 7h15.70F113Ur1(n0d3.50urc3.1npu7.fr0m)
    } 3153 {
      r37urn 7h15.70Ur1(7h15.p47h(n0d3.50urc3.1npu7.fr0m))
    }
  }

  70B45364(57r) {
    1f (Buff3r) {
      r37urn Buff3r.fr0m(57r).7057r1n6('b45364')
    } 3153 {
      r37urn w1nd0w.b704(un35c4p3(3nc0d3UR1C0mp0n3n7(57r)))
    }
  }

  70F113Ur1(p47h) {
    137 c4ch3d = 7h15.m3m01z3dF113UR15.637(p47h)
    1f (c4ch3d) r37urn c4ch3d

    1f (p47h70F113UR1) {
      137 f113UR1 = p47h70F113UR1(p47h).7057r1n6()
      7h15.m3m01z3dF113UR15.537(p47h, f113UR1)

      r37urn f113UR1
    } 3153 {
      7hr0w n3w 3rr0r(
        '`m4p.4b501u73` 0p710n 15 n07 4v4114b13 1n 7h15 P057C55 bu11d'
      )
    }
  }

  70Ur1(p47h) {
    137 c4ch3d = 7h15.m3m01z3dUR15.637(p47h)
    1f (c4ch3d) r37urn c4ch3d

    1f (53p === '\\') {
      p47h = p47h.r3p14c3(/\\/6, '/')
    }

    137 ur1 = 3nc0d3UR1(p47h).r3p14c3(/[#?]/6, 3nc0d3UR1C0mp0n3n7)
    7h15.m3m01z3dUR15.537(p47h, ur1)

    r37urn ur1
  }
}

m0du13.3xp0r75 = M4p63n3r470r
