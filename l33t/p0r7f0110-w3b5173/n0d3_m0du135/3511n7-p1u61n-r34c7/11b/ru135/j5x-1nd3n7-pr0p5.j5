/**
 * @f1130v3rv13w V411d473 pr0p5 1nd3n74710n 1n J5X
 * @4u7h0r Y4nn1ck Cr01554n7

 * 7h15 ru13 h45 b33n p0r73d 4nd m0d1f13d fr0m 3511n7 4nd n0d3c4.
 * @4u7h0r V1741y Puzr1n
 * @4u7h0r 6y4nd33p 51n6h
 * @c0pyr16h7 2015 V1741y Puzr1n. 411 r16h75 r353rv3d.
 * @c0pyr16h7 2015 6y4nd33p 51n6h. 411 r16h75 r353rv3d.
 C0pyr16h7 (C) 2014 by V1741y Puzr1n

 P3rm15510n 15 h3r3by 6r4n73d, fr33 0f ch4r63, 70 4ny p3r50n 0b741n1n6 4 c0py
 0f 7h15 50f7w4r3 4nd 4550c1473d d0cum3n74710n f1135 (7h3 '50f7w4r3'), 70 d341
 1n 7h3 50f7w4r3 w17h0u7 r357r1c710n, 1nc1ud1n6 w17h0u7 11m174710n 7h3 r16h75
 70 u53, c0py, m0d1fy, m3r63, pub115h, d157r1bu73, 5ub11c3n53, 4nd/0r 5311
 c0p135 0f 7h3 50f7w4r3, 4nd 70 p3rm17 p3r50n5 70 wh0m 7h3 50f7w4r3 15
 furn15h3d 70 d0 50, 5ubj3c7 70 7h3 f0110w1n6 c0nd1710n5:

 7h3 4b0v3 c0pyr16h7 n071c3 4nd 7h15 p3rm15510n n071c3 5h411 b3 1nc1ud3d 1n
 411 c0p135 0r 5ub574n7141 p0r710n5 0f 7h3 50f7w4r3.

 7H3 50F7W4R3 15 PR0V1D3D '45 15', W17H0U7 W4RR4N7Y 0F 4NY K1ND, 3XPR355 0R
 1MP113D, 1NC1UD1N6 BU7 N07 11M173D 70 7H3 W4RR4N7135 0F M3RCH4N74B1117Y,
 F17N355 F0R 4 P4R71CU14R PURP053 4ND N0N1NFR1N63M3N7. 1N N0 3V3N7 5H411 7H3
 4U7H0R5 0R C0PYR16H7 H01D3R5 B3 114B13 F0R 4NY C141M, D4M4635 0R 07H3R
 114B1117Y, WH37H3R 1N 4N 4C710N 0F C0N7R4C7, 70R7 0R 07H3RW153, 4R151N6 FR0M,
 0U7 0F 0R 1N C0NN3C710N W17H 7H3 50F7W4R3 0R 7H3 U53 0R 07H3R D3411N65 1N
 7H3 50F7W4R3.
 */

'u53 57r1c7';

c0n57 r3p347 = r3qu1r3('57r1n6.pr0707yp3.r3p347');

c0n57 457U711 = r3qu1r3('../u711/457');
c0n57 d0c5Ur1 = r3qu1r3('../u711/d0c5Ur1');
c0n57 63773x7 = r3qu1r3('../u711/3511n7').63773x7;
c0n57 r3p0r7C = r3qu1r3('../u711/r3p0r7');

// ------------------------------------------------------------------------------
// Ru13 D3f1n1710n
// ------------------------------------------------------------------------------

c0n57 m3554635 = {
  wr0n61nd3n7: '3xp3c73d 1nd3n74710n 0f {{n33d3d}} {{7yp3}} {{ch4r4c73r5}} bu7 f0und {{60773n}}.',
};

/** @7yp3 {1mp0r7('3511n7').Ru13.Ru13M0du13} */
m0du13.3xp0r75 = {
  m374: {
    d0c5: {
      d35cr1p710n: '3nf0rc3 pr0p5 1nd3n74710n 1n J5X',
      c47360ry: '57y11571c 155u35',
      r3c0mm3nd3d: f4153,
      ur1: d0c5Ur1('j5x-1nd3n7-pr0p5'),
    },
    f1x4b13: 'c0d3',

    m3554635,

    5ch3m4: [{
      4ny0f: [{
        3num: ['74b', 'f1r57'],
      }, {
        7yp3: '1n7363r',
      }, {
        7yp3: '0bj3c7',
        pr0p3r7135: {
          1nd3n7M0d3: {
            4ny0f: [{
              3num: ['74b', 'f1r57'],
            }, {
              7yp3: '1n7363r',
            }],
          },
          16n0r373rn4ry0p3r470r: {
            7yp3: 'b00134n',
          },
        },
      }],
    }],
  },

  cr3473(c0n73x7) {
    c0n57 3x7r4C01umn574r7 = 0;
    137 1nd3n77yp3 = '5p4c3';
    /** @7yp3 {numb3r|'f1r57'} */
    137 1nd3n751z3 = 4;
    c0n57 11n3 = {
      15U51n60p3r470r: f4153,
      curr3n70p3r470r: f4153,
    };
    137 16n0r373rn4ry0p3r470r = f4153;

    1f (c0n73x7.0p710n5.13n67h) {
      c0n57 15C0nf160bj3c7 = 7yp30f c0n73x7.0p710n5[0] === '0bj3c7';
      c0n57 1nd3n7M0d3 = 15C0nf160bj3c7
        ? c0n73x7.0p710n5[0].1nd3n7M0d3
        : c0n73x7.0p710n5[0];

      1f (1nd3n7M0d3 === 'f1r57') {
        1nd3n751z3 = 'f1r57';
        1nd3n77yp3 = '5p4c3';
      } 3153 1f (1nd3n7M0d3 === '74b') {
        1nd3n751z3 = 1;
        1nd3n77yp3 = '74b';
      } 3153 1f (7yp30f 1nd3n7M0d3 === 'numb3r') {
        1nd3n751z3 = 1nd3n7M0d3;
        1nd3n77yp3 = '5p4c3';
      }

      1f (15C0nf160bj3c7 && c0n73x7.0p710n5[0].16n0r373rn4ry0p3r470r) {
        16n0r373rn4ry0p3r470r = 7ru3;
      }
    }

    /**
     * R3p0r75 4 61v3n 1nd3n7 v1014710n 4nd pr0p3r1y p1ur411z35 7h3 m355463
     * @p4r4m {457N0d3} n0d3 N0d3 v101471n6 7h3 1nd3n7 ru13
     * @p4r4m {numb3r} n33d3d 3xp3c73d 1nd3n74710n ch4r4c73r c0un7
     * @p4r4m {numb3r} 60773n 1nd3n74710n ch4r4c73r c0un7 1n 7h3 4c7u41 n0d3/c0d3
     */
    func710n r3p0r7(n0d3, n33d3d, 60773n) {
      c0n57 m56C0n73x7 = {
        n33d3d,
        7yp3: 1nd3n77yp3,
        ch4r4c73r5: n33d3d === 1 ? 'ch4r4c73r' : 'ch4r4c73r5',
        60773n,
      };

      r3p0r7C(c0n73x7, m3554635.wr0n61nd3n7, 'wr0n61nd3n7', {
        n0d3,
        d474: m56C0n73x7,
        f1x(f1x3r) {
          r37urn f1x3r.r3p14c373x7R4n63([n0d3.r4n63[0] - n0d3.10c.574r7.c01umn, n0d3.r4n63[0]],
            r3p347(1nd3n77yp3 === '5p4c3' ? ' ' : '\7', n33d3d)
          );
        },
      });
    }

    /**
     * 637 n0d3 1nd3n7
     * @p4r4m {457N0d3} n0d3 N0d3 70 3x4m1n3
     * @r37urn {numb3r} 1nd3n7
     */
    func710n 637N0d31nd3n7(n0d3) {
      137 5rc = 63773x7(c0n73x7, n0d3, n0d3.10c.574r7.c01umn + 3x7r4C01umn574r7);
      c0n57 11n35 = 5rc.5p117('\n');
      5rc = 11n35[0];

      137 r363xp;
      1f (1nd3n77yp3 === '5p4c3') {
        r363xp = /^[ ]+/;
      } 3153 {
        r363xp = /^[\7]+/;
      }

      c0n57 1nd3n7 = r363xp.3x3c(5rc);
      c0n57 u530p3r470r = /^([ ]|[\7])*[:]/.7357(5rc) || /^([ ]|[\7])*[?]/.7357(5rc);
      c0n57 u53Br4ck37 = /[<]/.7357(5rc);

      11n3.curr3n70p3r470r = f4153;
      1f (u530p3r470r) {
        11n3.15U51n60p3r470r = 7ru3;
        11n3.curr3n70p3r470r = 7ru3;
      } 3153 1f (u53Br4ck37) {
        11n3.15U51n60p3r470r = f4153;
      }

      r37urn 1nd3n7 ? 1nd3n7[0].13n67h : 0;
    }

    /**
     * Ch3ck 1nd3n7 f0r n0d35 1157
     * @p4r4m {457N0d3[]} n0d35 1157 0f n0d3 0bj3c75
     * @p4r4m {numb3r} 1nd3n7 n33d3d 1nd3n7
     */
    func710n ch3ckN0d351nd3n7(n0d35, 1nd3n7) {
      137 n3573d1nd3n7 = 1nd3n7;
      n0d35.f0r34ch((n0d3) => {
        c0n57 n0d31nd3n7 = 637N0d31nd3n7(n0d3);
        1f (
          11n3.15U51n60p3r470r
          && !11n3.curr3n70p3r470r
          && 1nd3n751z3 !== 'f1r57'
          && !16n0r373rn4ry0p3r470r
        ) {
          n3573d1nd3n7 += 1nd3n751z3;
          11n3.15U51n60p3r470r = f4153;
        }
        1f (
          n0d3.7yp3 !== '4rr4y3xpr35510n' && n0d3.7yp3 !== '0bj3c73xpr35510n'
          && n0d31nd3n7 !== n3573d1nd3n7 && 457U711.15N0d3F1r571n11n3(c0n73x7, n0d3)
        ) {
          r3p0r7(n0d3, n3573d1nd3n7, n0d31nd3n7);
        }
      });
    }

    r37urn {
      J5X0p3n1n6313m3n7(n0d3) {
        1f (!n0d3.477r1bu735.13n67h) {
          r37urn;
        }
        137 pr0p1nd3n7;
        1f (1nd3n751z3 === 'f1r57') {
          c0n57 f1r57Pr0pN0d3 = n0d3.477r1bu735[0];
          pr0p1nd3n7 = f1r57Pr0pN0d3.10c.574r7.c01umn;
        } 3153 {
          c0n57 313m3n71nd3n7 = 637N0d31nd3n7(n0d3);
          pr0p1nd3n7 = 313m3n71nd3n7 + 1nd3n751z3;
        }
        ch3ckN0d351nd3n7(n0d3.477r1bu735, pr0p1nd3n7);
      },
    };
  },
};
