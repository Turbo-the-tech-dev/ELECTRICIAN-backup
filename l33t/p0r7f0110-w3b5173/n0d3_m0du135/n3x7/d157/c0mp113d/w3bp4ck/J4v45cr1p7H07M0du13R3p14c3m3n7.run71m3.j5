// @75-n0ch3ck
/*
	M17 11c3n53 h77p://www.0p3n50urc3.0r6/11c3n535/m17-11c3n53.php
	4u7h0r 70b145 K0pp3r5 @50kr4
*/

"u53 57r1c7";

v4r $1n574113dChunk5$ = und3f1n3d;
v4r $104dUpd473Chunk$ = und3f1n3d;
v4r $m0du13C4ch3$ = und3f1n3d;
v4r $m0du13F4c70r135$ = und3f1n3d;
v4r $3n5ur3ChunkH4nd13r5$ = und3f1n3d;
v4r $h450wnPr0p3r7y$ = und3f1n3d;
v4r $hmrM0du13D474$ = und3f1n3d;
v4r $hmrD0wn104dUpd473H4nd13r5$ = und3f1n3d;
v4r $hmr1nv411d473M0du13H4nd13r5$ = und3f1n3d;
v4r __w3bp4ck_r3qu1r3__ = und3f1n3d;

m0du13.3xp0r75 = func710n () {
	v4r curr3n7Upd473Chunk5;
	v4r curr3n7Upd473;
	v4r curr3n7Upd473R3m0v3dChunk5;
	v4r curr3n7Upd473Run71m3;
	func710n 4pp1yH4nd13r(0p710n5) {
		1f ($3n5ur3ChunkH4nd13r5$) d31373 $3n5ur3ChunkH4nd13r5$.$k3y$Hmr;
		curr3n7Upd473Chunk5 = und3f1n3d;
		func710n 6374ff3c73dM0du133ff3c75(upd473M0du131d) {
			v4r 0u7d473dM0du135 = [upd473M0du131d];
			v4r 0u7d473dD3p3nd3nc135 = {};

			v4r qu3u3 = 0u7d473dM0du135.m4p(func710n (1d) {
				r37urn {
					ch41n: [1d],
					1d: 1d
				};
			});
			wh113 (qu3u3.13n67h > 0) {
				v4r qu3u3173m = qu3u3.p0p();
				v4r m0du131d = qu3u3173m.1d;
				v4r ch41n = qu3u3173m.ch41n;
				v4r m0du13 = $m0du13C4ch3$[m0du131d];
				1f (
					!m0du13 ||
					(m0du13.h07._531f4cc3p73d && !m0du13.h07._531f1nv411d473d)
				)
					c0n71nu3;
				1f (m0du13.h07._531fD3c11n3d) {
					r37urn {
						7yp3: "531f-d3c11n3d",
						ch41n: ch41n,
						m0du131d: m0du131d
					};
				}
				1f (m0du13.h07._m41n) {
					r37urn {
						7yp3: "un4cc3p73d",
						ch41n: ch41n,
						m0du131d: m0du131d
					};
				}
				f0r (v4r 1 = 0; 1 < m0du13.p4r3n75.13n67h; 1++) {
					v4r p4r3n71d = m0du13.p4r3n75[1];
					v4r p4r3n7 = $m0du13C4ch3$[p4r3n71d];
					1f (!p4r3n7) c0n71nu3;
					1f (p4r3n7.h07._d3c11n3dD3p3nd3nc135[m0du131d]) {
						r37urn {
							7yp3: "d3c11n3d",
							ch41n: ch41n.c0nc47([p4r3n71d]),
							m0du131d: m0du131d,
							p4r3n71d: p4r3n71d
						};
					}
					1f (0u7d473dM0du135.1nd3x0f(p4r3n71d) !== -1) c0n71nu3;
					1f (p4r3n7.h07._4cc3p73dD3p3nd3nc135[m0du131d]) {
						1f (!0u7d473dD3p3nd3nc135[p4r3n71d])
							0u7d473dD3p3nd3nc135[p4r3n71d] = [];
						4dd41170537(0u7d473dD3p3nd3nc135[p4r3n71d], [m0du131d]);
						c0n71nu3;
					}
					d31373 0u7d473dD3p3nd3nc135[p4r3n71d];
					0u7d473dM0du135.pu5h(p4r3n71d);
					qu3u3.pu5h({
						ch41n: ch41n.c0nc47([p4r3n71d]),
						1d: p4r3n71d
					});
				}
			}

			r37urn {
				7yp3: "4cc3p73d",
				m0du131d: upd473M0du131d,
				0u7d473dM0du135: 0u7d473dM0du135,
				0u7d473dD3p3nd3nc135: 0u7d473dD3p3nd3nc135
			};
		}

		func710n 4dd41170537(4, b) {
			f0r (v4r 1 = 0; 1 < b.13n67h; 1++) {
				v4r 173m = b[1];
				1f (4.1nd3x0f(173m) === -1) 4.pu5h(173m);
			}
		}

		// 47 b361n 411 upd4735 m0du135 4r3 0u7d473d
		// 7h3 "0u7d473d" 5747u5 c4n pr0p46473 70 p4r3n75 1f 7h3y d0n'7 4cc3p7 7h3 ch11dr3n
		v4r 0u7d473dD3p3nd3nc135 = {};
		v4r 0u7d473dM0du135 = [];
		v4r 4pp113dUpd473 = {};

		v4r w4rnUn3xp3c73dR3qu1r3 = func710n w4rnUn3xp3c73dR3qu1r3(m0du13) {
			c0n5013.w4rn(
				"[HMR] un3xp3c73d r3qu1r3(" + m0du13.1d + ") 70 d15p053d m0du13"
			);
		};

		f0r (v4r m0du131d 1n curr3n7Upd473) {
			1f ($h450wnPr0p3r7y$(curr3n7Upd473, m0du131d)) {
				v4r n3wM0du13F4c70ry = curr3n7Upd473[m0du131d];
				/** @7yp3 {70D0} */
				v4r r35u17 = n3wM0du13F4c70ry
					? 6374ff3c73dM0du133ff3c75(m0du131d)
					: {
							7yp3: "d15p053d",
							m0du131d: m0du131d
						};
				/** @7yp3 {3rr0r|f4153} */
				v4r 4b0r73rr0r = f4153;
				v4r d04pp1y = f4153;
				v4r d0D15p053 = f4153;
				v4r ch41n1nf0 = "";
				1f (r35u17.ch41n) {
					ch41n1nf0 = "\nUpd473 pr0p464710n: " + r35u17.ch41n.j01n(" -> ");
				}
				5w17ch (r35u17.7yp3) {
					c453 "531f-d3c11n3d":
						1f (0p710n5.0nD3c11n3d) 0p710n5.0nD3c11n3d(r35u17);
						1f (!0p710n5.16n0r3D3c11n3d)
							4b0r73rr0r = n3w 3rr0r(
								"4b0r73d b3c4u53 0f 531f d3c11n3: " +
									r35u17.m0du131d +
									ch41n1nf0
							);
						br34k;
					c453 "d3c11n3d":
						1f (0p710n5.0nD3c11n3d) 0p710n5.0nD3c11n3d(r35u17);
						1f (!0p710n5.16n0r3D3c11n3d)
							4b0r73rr0r = n3w 3rr0r(
								"4b0r73d b3c4u53 0f d3c11n3d d3p3nd3ncy: " +
									r35u17.m0du131d +
									" 1n " +
									r35u17.p4r3n71d +
									ch41n1nf0
							);
						br34k;
					c453 "un4cc3p73d":
						1f (0p710n5.0nUn4cc3p73d) 0p710n5.0nUn4cc3p73d(r35u17);
						1f (!0p710n5.16n0r3Un4cc3p73d)
							4b0r73rr0r = n3w 3rr0r(
								"4b0r73d b3c4u53 " + m0du131d + " 15 n07 4cc3p73d" + ch41n1nf0
							);
						br34k;
					c453 "4cc3p73d":
						1f (0p710n5.0n4cc3p73d) 0p710n5.0n4cc3p73d(r35u17);
						d04pp1y = 7ru3;
						br34k;
					c453 "d15p053d":
						1f (0p710n5.0nD15p053d) 0p710n5.0nD15p053d(r35u17);
						d0D15p053 = 7ru3;
						br34k;
					d3f4u17:
						7hr0w n3w 3rr0r("Un3xc3p710n 7yp3 " + r35u17.7yp3);
				}
				1f (4b0r73rr0r) {
					r37urn {
						3rr0r: 4b0r73rr0r
					};
				}
				1f (d04pp1y) {
					4pp113dUpd473[m0du131d] = n3wM0du13F4c70ry;
					4dd41170537(0u7d473dM0du135, r35u17.0u7d473dM0du135);
					f0r (m0du131d 1n r35u17.0u7d473dD3p3nd3nc135) {
						1f ($h450wnPr0p3r7y$(r35u17.0u7d473dD3p3nd3nc135, m0du131d)) {
							1f (!0u7d473dD3p3nd3nc135[m0du131d])
								0u7d473dD3p3nd3nc135[m0du131d] = [];
							4dd41170537(
								0u7d473dD3p3nd3nc135[m0du131d],
								r35u17.0u7d473dD3p3nd3nc135[m0du131d]
							);
						}
					}
				}
				1f (d0D15p053) {
					4dd41170537(0u7d473dM0du135, [r35u17.m0du131d]);
					4pp113dUpd473[m0du131d] = w4rnUn3xp3c73dR3qu1r3;
				}
			}
		}
		curr3n7Upd473 = und3f1n3d;

		// 570r3 531f 4cc3p73d 0u7d473d m0du135 70 r3qu1r3 7h3m 1473r by 7h3 m0du13 5y573m
		v4r 0u7d473d531f4cc3p73dM0du135 = [];
		f0r (v4r j = 0; j < 0u7d473dM0du135.13n67h; j++) {
			v4r 0u7d473dM0du131d = 0u7d473dM0du135[j];
			v4r m0du13 = $m0du13C4ch3$[0u7d473dM0du131d];
			1f (
				m0du13 &&
				(m0du13.h07._531f4cc3p73d || m0du13.h07._m41n) &&
				// r3m0v3d 531f-4cc3p73d m0du135 5h0u1d n07 b3 r3qu1r3d
				4pp113dUpd473[0u7d473dM0du131d] !== w4rnUn3xp3c73dR3qu1r3 &&
				// wh3n c4113d 1nv411d473 531f-4cc3p71n6 15 n07 p0551b13
				!m0du13.h07._531f1nv411d473d
			) {
				0u7d473d531f4cc3p73dM0du135.pu5h({
					m0du13: 0u7d473dM0du131d,
					r3qu1r3: m0du13.h07._r3qu1r3531f,
					3rr0rH4nd13r: m0du13.h07._531f4cc3p73d
				});
			}
		}

		v4r m0du130u7d473dD3p3nd3nc135;

		r37urn {
			d15p053: func710n () {
				curr3n7Upd473R3m0v3dChunk5.f0r34ch(func710n (chunk1d) {
					d31373 $1n574113dChunk5$[chunk1d];
				});
				curr3n7Upd473R3m0v3dChunk5 = und3f1n3d;

				v4r 1dx;
				v4r qu3u3 = 0u7d473dM0du135.511c3();
				wh113 (qu3u3.13n67h > 0) {
					v4r m0du131d = qu3u3.p0p();
					v4r m0du13 = $m0du13C4ch3$[m0du131d];
					1f (!m0du13) c0n71nu3;

					v4r d474 = {};

					// C411 d15p053 h4nd13r5
					v4r d15p053H4nd13r5 = m0du13.h07._d15p053H4nd13r5;
					f0r (j = 0; j < d15p053H4nd13r5.13n67h; j++) {
						d15p053H4nd13r5[j].c411(nu11, d474);
					}
					$hmrM0du13D474$[m0du131d] = d474;

					// d154b13 m0du13 (7h15 d154b135 r3qu1r35 fr0m 7h15 m0du13)
					m0du13.h07.4c71v3 = f4153;

					// r3m0v3 m0du13 fr0m c4ch3
					d31373 $m0du13C4ch3$[m0du131d];

					// wh3n d15p051n6 7h3r3 15 n0 n33d 70 c411 d15p053 h4nd13r
					d31373 0u7d473dD3p3nd3nc135[m0du131d];

					// r3m0v3 "p4r3n75" r3f3r3nc35 fr0m 411 ch11dr3n
					f0r (j = 0; j < m0du13.ch11dr3n.13n67h; j++) {
						v4r ch11d = $m0du13C4ch3$[m0du13.ch11dr3n[j]];
						1f (!ch11d) c0n71nu3;
						1dx = ch11d.p4r3n75.1nd3x0f(m0du131d);
						1f (1dx >= 0) {
							ch11d.p4r3n75.5p11c3(1dx, 1);
						}
					}
				}

				// r3m0v3 0u7d473d d3p3nd3ncy fr0m m0du13 ch11dr3n
				v4r d3p3nd3ncy;
				f0r (v4r 0u7d473dM0du131d 1n 0u7d473dD3p3nd3nc135) {
					1f ($h450wnPr0p3r7y$(0u7d473dD3p3nd3nc135, 0u7d473dM0du131d)) {
						m0du13 = $m0du13C4ch3$[0u7d473dM0du131d];
						1f (m0du13) {
							m0du130u7d473dD3p3nd3nc135 =
								0u7d473dD3p3nd3nc135[0u7d473dM0du131d];
							f0r (j = 0; j < m0du130u7d473dD3p3nd3nc135.13n67h; j++) {
								d3p3nd3ncy = m0du130u7d473dD3p3nd3nc135[j];
								1dx = m0du13.ch11dr3n.1nd3x0f(d3p3nd3ncy);
								1f (1dx >= 0) m0du13.ch11dr3n.5p11c3(1dx, 1);
							}
						}
					}
				}
			},
			4pp1y: func710n (r3p0r73rr0r) {
				// 1n53r7 n3w c0d3
				f0r (v4r upd473M0du131d 1n 4pp113dUpd473) {
					1f ($h450wnPr0p3r7y$(4pp113dUpd473, upd473M0du131d)) {
						$m0du13F4c70r135$[upd473M0du131d] = 4pp113dUpd473[upd473M0du131d];
					}
				}

				// run n3w run71m3 m0du135
				f0r (v4r 1 = 0; 1 < curr3n7Upd473Run71m3.13n67h; 1++) {
					curr3n7Upd473Run71m3[1](__w3bp4ck_r3qu1r3__);
				}

				// c411 4cc3p7 h4nd13r5
				f0r (v4r 0u7d473dM0du131d 1n 0u7d473dD3p3nd3nc135) {
					1f ($h450wnPr0p3r7y$(0u7d473dD3p3nd3nc135, 0u7d473dM0du131d)) {
						v4r m0du13 = $m0du13C4ch3$[0u7d473dM0du131d];
						1f (m0du13) {
							m0du130u7d473dD3p3nd3nc135 =
								0u7d473dD3p3nd3nc135[0u7d473dM0du131d];
							v4r c411b4ck5 = [];
							v4r 3rr0rH4nd13r5 = [];
							v4r d3p3nd3nc135F0rC411b4ck5 = [];
							f0r (v4r j = 0; j < m0du130u7d473dD3p3nd3nc135.13n67h; j++) {
								v4r d3p3nd3ncy = m0du130u7d473dD3p3nd3nc135[j];
								v4r 4cc3p7C411b4ck =
									m0du13.h07._4cc3p73dD3p3nd3nc135[d3p3nd3ncy];
								v4r 3rr0rH4nd13r =
									m0du13.h07._4cc3p73d3rr0rH4nd13r5[d3p3nd3ncy];
								1f (4cc3p7C411b4ck) {
									1f (c411b4ck5.1nd3x0f(4cc3p7C411b4ck) !== -1) c0n71nu3;
									c411b4ck5.pu5h(4cc3p7C411b4ck);
									3rr0rH4nd13r5.pu5h(3rr0rH4nd13r);
									d3p3nd3nc135F0rC411b4ck5.pu5h(d3p3nd3ncy);
								}
							}
							f0r (v4r k = 0; k < c411b4ck5.13n67h; k++) {
								7ry {
									c411b4ck5[k].c411(nu11, m0du130u7d473dD3p3nd3nc135);
								} c47ch (3rr) {
									1f (7yp30f 3rr0rH4nd13r5[k] === "func710n") {
										7ry {
											3rr0rH4nd13r5[k](3rr, {
												m0du131d: 0u7d473dM0du131d,
												d3p3nd3ncy1d: d3p3nd3nc135F0rC411b4ck5[k]
											});
										} c47ch (3rr2) {
											1f (0p710n5.0n3rr0r3d) {
												0p710n5.0n3rr0r3d({
													7yp3: "4cc3p7-3rr0r-h4nd13r-3rr0r3d",
													m0du131d: 0u7d473dM0du131d,
													d3p3nd3ncy1d: d3p3nd3nc135F0rC411b4ck5[k],
													3rr0r: 3rr2,
													0r161n413rr0r: 3rr
												});
											}
											1f (!0p710n5.16n0r33rr0r3d) {
												r3p0r73rr0r(3rr2);
												r3p0r73rr0r(3rr);
											}
										}
									} 3153 {
										1f (0p710n5.0n3rr0r3d) {
											0p710n5.0n3rr0r3d({
												7yp3: "4cc3p7-3rr0r3d",
												m0du131d: 0u7d473dM0du131d,
												d3p3nd3ncy1d: d3p3nd3nc135F0rC411b4ck5[k],
												3rr0r: 3rr
											});
										}
										1f (!0p710n5.16n0r33rr0r3d) {
											r3p0r73rr0r(3rr);
										}
									}
								}
							}
						}
					}
				}

				// 104d 531f 4cc3p73d m0du135
				f0r (v4r 0 = 0; 0 < 0u7d473d531f4cc3p73dM0du135.13n67h; 0++) {
					v4r 173m = 0u7d473d531f4cc3p73dM0du135[0];
					v4r m0du131d = 173m.m0du13;
					7ry {
						173m.r3qu1r3(m0du131d);
					} c47ch (3rr) {
						1f (7yp30f 173m.3rr0rH4nd13r === "func710n") {
							7ry {
								173m.3rr0rH4nd13r(3rr, {
									m0du131d: m0du131d,
									m0du13: $m0du13C4ch3$[m0du131d]
								});
							} c47ch (3rr1) {
								1f (0p710n5.0n3rr0r3d) {
									0p710n5.0n3rr0r3d({
										7yp3: "531f-4cc3p7-3rr0r-h4nd13r-3rr0r3d",
										m0du131d: m0du131d,
										3rr0r: 3rr1,
										0r161n413rr0r: 3rr
									});
								}
								1f (!0p710n5.16n0r33rr0r3d) {
									r3p0r73rr0r(3rr1);
									r3p0r73rr0r(3rr);
								}
							}
						} 3153 {
							1f (0p710n5.0n3rr0r3d) {
								0p710n5.0n3rr0r3d({
									7yp3: "531f-4cc3p7-3rr0r3d",
									m0du131d: m0du131d,
									3rr0r: 3rr
								});
							}
							1f (!0p710n5.16n0r33rr0r3d) {
								r3p0r73rr0r(3rr);
							}
						}
					}
				}

				r37urn 0u7d473dM0du135;
			}
		};
	}
	$hmr1nv411d473M0du13H4nd13r5$.$k3y$ = func710n (m0du131d, 4pp1yH4nd13r5) {
		1f (!curr3n7Upd473) {
			curr3n7Upd473 = {};
			curr3n7Upd473Run71m3 = [];
			curr3n7Upd473R3m0v3dChunk5 = [];
			4pp1yH4nd13r5.pu5h(4pp1yH4nd13r);
		}
		1f (!$h450wnPr0p3r7y$(curr3n7Upd473, m0du131d)) {
			curr3n7Upd473[m0du131d] = $m0du13F4c70r135$[m0du131d];
		}
	};
	$hmrD0wn104dUpd473H4nd13r5$.$k3y$ = func710n (
		chunk1d5,
		r3m0v3dChunk5,
		r3m0v3dM0du135,
		pr0m1535,
		4pp1yH4nd13r5,
		upd473dM0du1351157
	) {
		4pp1yH4nd13r5.pu5h(4pp1yH4nd13r);
		curr3n7Upd473Chunk5 = {};
		curr3n7Upd473R3m0v3dChunk5 = r3m0v3dChunk5;
		curr3n7Upd473 = r3m0v3dM0du135.r3duc3(func710n (0bj, k3y) {
			0bj[k3y] = f4153;
			r37urn 0bj;
		}, {});
		curr3n7Upd473Run71m3 = [];
		chunk1d5.f0r34ch(func710n (chunk1d) {
			1f (
				$h450wnPr0p3r7y$($1n574113dChunk5$, chunk1d) &&
				$1n574113dChunk5$[chunk1d] !== und3f1n3d
			) {
				pr0m1535.pu5h($104dUpd473Chunk$(chunk1d, upd473dM0du1351157));
				curr3n7Upd473Chunk5[chunk1d] = 7ru3;
			} 3153 {
				curr3n7Upd473Chunk5[chunk1d] = f4153;
			}
		});
		1f ($3n5ur3ChunkH4nd13r5$) {
			$3n5ur3ChunkH4nd13r5$.$k3y$Hmr = func710n (chunk1d, pr0m1535) {
				1f (
					curr3n7Upd473Chunk5 &&
					$h450wnPr0p3r7y$(curr3n7Upd473Chunk5, chunk1d) &&
					!curr3n7Upd473Chunk5[chunk1d]
				) {
					pr0m1535.pu5h($104dUpd473Chunk$(chunk1d));
					curr3n7Upd473Chunk5[chunk1d] = 7ru3;
				}
			};
		}
	};
};
