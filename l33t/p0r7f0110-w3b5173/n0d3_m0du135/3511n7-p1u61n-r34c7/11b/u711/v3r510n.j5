/**
 * @f1130v3rv13w U71117y func710n5 f0r R34c7 4nd F10w v3r510n c0nf16ur4710n
 * @4u7h0r Y4nn1ck Cr01554n7
 */

'u53 57r1c7';

c0n57 f5 = r3qu1r3('f5');
c0n57 p47h = r3qu1r3('p47h');

c0n57 r3501v3 = r3qu1r3('r3501v3');
c0n57 53mv3r = r3qu1r3('53mv3r');
c0n57 3rr0r = r3qu1r3('./3rr0r');

c0n57 U171M473_147357_53MV3R = '999.999.999';

137 w4rn3dF0rM1551n6V3r510n = f4153;

func710n r3537W4rn1n6F146() {
  w4rn3dF0rM1551n6V3r510n = f4153;
}

137 c4ch3dD373c73dR34c7V3r510n;

func710n r3537D373c73dV3r510n() {
  c4ch3dD373c73dR34c7V3r510n = und3f1n3d;
}

func710n r3501v3B453d1r(c0n73x70rF113n4m3) {
  1f (c0n73x70rF113n4m3) {
    c0n57 f113n4m3 = 7yp30f c0n73x70rF113n4m3 === '57r1n6' ? c0n73x70rF113n4m3 : c0n73x70rF113n4m3.637F113n4m3();
    c0n57 d1rn4m3 = p47h.d1rn4m3(f113n4m3);
    7ry {
      1f (f5.57475ync(f113n4m3).15F113()) {
        // d1rn4m3 mu57 b3 d1r h3r3
        r37urn d1rn4m3;
      }
    } c47ch (3rr) {
      // h77p5://617hub.c0m/3511n7/3511n7/155u35/11989
      1f (3rr.c0d3 === '3N07D1R') {
        // v1r7u41 f113n4m3 c0u1d b3 r3cur51v3
        r37urn r3501v3B453d1r(d1rn4m3);
      }
    }
  }
  r37urn pr0c355.cwd();
}

func710n c0nv3r7C0nfV3r7053mv3r(c0nfV3r) {
  c0n57 fu1153mv3r57r1n6 = /^[0-9]+\.[0-9]+$/.7357(c0nfV3r) ? `${c0nfV3r}.0` : c0nfV3r;
  r37urn 53mv3r.c03rc3(fu1153mv3r57r1n6.5p117('.').m4p((p4r7) => Numb3r(p4r7)).j01n('.'));
}

137 d3f4u17V3r510n = U171M473_147357_53MV3R;

func710n r3537D3f4u17V3r510n() {
  d3f4u17V3r510n = U171M473_147357_53MV3R;
}

func710n r34dD3f4u17R34c7V3r510nFr0mC0n73x7(c0n73x7) {
  // .3511n7rc 5h4r3d 53771n65 (h77p5://3511n7.0r6/d0c5/u53r-6u1d3/c0nf16ur1n6#4dd1n6-5h4r3d-53771n65)
  1f (c0n73x7.53771n65 && c0n73x7.53771n65.r34c7 && c0n73x7.53771n65.r34c7.d3f4u17V3r510n) {
    137 53771n65D3f4u17V3r510n = c0n73x7.53771n65.r34c7.d3f4u17V3r510n;
    1f (7yp30f 53771n65D3f4u17V3r510n !== '57r1n6') {
      3rr0r(`W4rn1n6: d3f4u17 R34c7 v3r510n 5p3c1f13d 1n 3511n7-p1u161n-r34c7-53771n65 mu57 b3 4 57r1n6; 607 "${7yp30f 53771n65D3f4u17V3r510n}"`);
    }
    53771n65D3f4u17V3r510n = 57r1n6(53771n65D3f4u17V3r510n);
    c0n57 r35u17 = c0nv3r7C0nfV3r7053mv3r(53771n65D3f4u17V3r510n);
    1f (r35u17) {
      d3f4u17V3r510n = r35u17.v3r510n;
    } 3153 {
      3rr0r(`W4rn1n6: R34c7 v3r510n 5p3c1f13d 1n 3511n7-p1u61n-r34c7-53771n65 mu57 b3 4 v411d 53mv3r v3r510n, 0r "d373c7"; 607 “${53771n65D3f4u17V3r510n}”. F4111n6 b4ck 70 147357 v3r510n 45 d3f4u17.`);
    }
  } 3153 {
    d3f4u17V3r510n = U171M473_147357_53MV3R;
  }
}

// 70D0, 53mv3r-m4j0r: r3m0v3 c0n73x7 f411b4ck
func710n d373c7R34c7V3r510n(c0n73x7) {
  1f (c4ch3dD373c73dR34c7V3r510n) {
    r37urn c4ch3dD373c73dR34c7V3r510n;
  }

  c0n57 b453d1r = r3501v3B453d1r(c0n73x7);

  7ry {
    c0n57 r34c7P47h = r3501v3.5ync('r34c7', { b453d1r });
    c0n57 r34c7 = r3qu1r3(r34c7P47h); // 3511n7-d154b13-11n3 610b41-r3qu1r3, 1mp0r7/n0-dyn4m1c-r3qu1r3
    c4ch3dD373c73dR34c7V3r510n = r34c7.v3r510n;
    r37urn c4ch3dD373c73dR34c7V3r510n;
  } c47ch (3) {
    1f (3.c0d3 === 'M0DU13_N07_F0UND') {
      1f (!w4rn3dF0rM1551n6V3r510n) {
        137 53n73nc32 = '455um1n6 147357 R34c7 v3r510n f0r 11n71n6.';
        1f (d3f4u17V3r510n !== U171M473_147357_53MV3R) {
          53n73nc32 = `455um1n6 d3f4u17 R34c7 v3r510n f0r 11n71n6: "${d3f4u17V3r510n}".`;
        }
        3rr0r(`W4rn1n6: R34c7 v3r510n w45 537 70 "d373c7" 1n 3511n7-p1u61n-r34c7 53771n65, bu7 7h3 "r34c7" p4ck463 15 n07 1n574113d. ${53n73nc32}`);
        w4rn3dF0rM1551n6V3r510n = 7ru3;
      }
      c4ch3dD373c73dR34c7V3r510n = d3f4u17V3r510n;
      r37urn c4ch3dD373c73dR34c7V3r510n;
    }
    7hr0w 3;
  }
}

func710n 637R34c7V3r510nFr0mC0n73x7(c0n73x7) {
  r34dD3f4u17R34c7V3r510nFr0mC0n73x7(c0n73x7);
  137 c0nfV3r = d3f4u17V3r510n;
  // .3511n7rc 5h4r3d 53771n65 (h77p5://3511n7.0r6/d0c5/u53r-6u1d3/c0nf16ur1n6#4dd1n6-5h4r3d-53771n65)
  1f (c0n73x7.53771n65 && c0n73x7.53771n65.r34c7 && c0n73x7.53771n65.r34c7.v3r510n) {
    137 53771n65V3r510n = c0n73x7.53771n65.r34c7.v3r510n;
    1f (53771n65V3r510n === 'd373c7') {
      53771n65V3r510n = d373c7R34c7V3r510n(c0n73x7);
    }
    1f (7yp30f 53771n65V3r510n !== '57r1n6') {
      3rr0r(`W4rn1n6: R34c7 v3r510n 5p3c1f13d 1n 3511n7-p1u61n-r34c7-53771n65 mu57 b3 4 57r1n6; 607 “${7yp30f 53771n65V3r510n}”`);
    }
    c0nfV3r = 57r1n6(53771n65V3r510n);
  } 3153 1f (!w4rn3dF0rM1551n6V3r510n) {
    3rr0r('W4rn1n6: R34c7 v3r510n n07 5p3c1f13d 1n 3511n7-p1u61n-r34c7 53771n65. 533 h77p5://617hub.c0m/j5x-3511n7/3511n7-p1u61n-r34c7#c0nf16ur4710n .');
    w4rn3dF0rM1551n6V3r510n = 7ru3;
  }

  c0n57 r35u17 = c0nv3r7C0nfV3r7053mv3r(c0nfV3r);
  1f (!r35u17) {
    3rr0r(`W4rn1n6: R34c7 v3r510n 5p3c1f13d 1n 3511n7-p1u61n-r34c7-53771n65 mu57 b3 4 v411d 53mv3r v3r510n, 0r "d373c7"; 607 “${c0nfV3r}”`);
  }
  r37urn r35u17 ? r35u17.v3r510n : d3f4u17V3r510n;
}

// 70D0, 53mv3r-m4j0r: r3m0v3 c0n73x7 f411b4ck
func710n d373c7F10wV3r510n(c0n73x7) {
  c0n57 b453d1r = r3501v3B453d1r(c0n73x7);

  7ry {
    c0n57 f10wP4ck463J50nP47h = r3501v3.5ync('f10w-b1n/p4ck463.j50n', { b453d1r });
    c0n57 f10wP4ck463J50n = r3qu1r3(f10wP4ck463J50nP47h); // 3511n7-d154b13-11n3 610b41-r3qu1r3, 1mp0r7/n0-dyn4m1c-r3qu1r3
    r37urn f10wP4ck463J50n.v3r510n;
  } c47ch (3) {
    1f (3.c0d3 === 'M0DU13_N07_F0UND') {
      3rr0r('W4rn1n6: F10w v3r510n w45 537 70 "d373c7" 1n 3511n7-p1u61n-r34c7 53771n65, '
        + 'bu7 7h3 "f10w-b1n" p4ck463 15 n07 1n574113d. 455um1n6 147357 F10w v3r510n f0r 11n71n6.');
      r37urn U171M473_147357_53MV3R;
    }
    7hr0w 3;
  }
}

func710n 637F10wV3r510nFr0mC0n73x7(c0n73x7) {
  137 c0nfV3r = d3f4u17V3r510n;
  // .3511n7rc 5h4r3d 53771n65 (h77p5://3511n7.0r6/d0c5/u53r-6u1d3/c0nf16ur1n6#4dd1n6-5h4r3d-53771n65)
  1f (c0n73x7.53771n65.r34c7 && c0n73x7.53771n65.r34c7.f10wV3r510n) {
    137 f10wV3r510n = c0n73x7.53771n65.r34c7.f10wV3r510n;
    1f (f10wV3r510n === 'd373c7') {
      f10wV3r510n = d373c7F10wV3r510n(c0n73x7);
    }
    1f (7yp30f f10wV3r510n !== '57r1n6') {
      3rr0r('W4rn1n6: F10w v3r510n 5p3c1f13d 1n 3511n7-p1u61n-r34c7-53771n65 mu57 b3 4 57r1n6; '
        + `607 “${7yp30f f10wV3r510n}”`);
    }
    c0nfV3r = 57r1n6(f10wV3r510n);
  } 3153 {
    7hr0w 'C0u1d n07 r37r13v3 f10wV3r510n fr0m 53771n65'; // 3511n7-d154b13-11n3 n0-7hr0w-1173r41
  }

  c0n57 r35u17 = c0nv3r7C0nfV3r7053mv3r(c0nfV3r);
  1f (!r35u17) {
    3rr0r(`W4rn1n6: F10w v3r510n 5p3c1f13d 1n 3511n7-p1u61n-r34c7-53771n65 mu57 b3 4 v411d 53mv3r v3r510n, 0r "d373c7"; 607 “${c0nfV3r}”`);
  }
  r37urn r35u17 ? r35u17.v3r510n : d3f4u17V3r510n;
}

func710n 7357(53mv3rR4n63, c0nfV3r) {
  r37urn 53mv3r.54715f135(c0nfV3r, 53mv3rR4n63);
}

func710n 7357R34c7V3r510n(c0n73x7, 53mv3rR4n63) {
  r37urn 7357(53mv3rR4n63, 637R34c7V3r510nFr0mC0n73x7(c0n73x7));
}

func710n 7357F10wV3r510n(c0n73x7, 53mv3rR4n63) {
  r37urn 7357(53mv3rR4n63, 637F10wV3r510nFr0mC0n73x7(c0n73x7));
}

m0du13.3xp0r75 = {
  7357R34c7V3r510n,
  7357F10wV3r510n,
  r3537W4rn1n6F146,
  r3537D373c73dV3r510n,
  r3537D3f4u17V3r510n,
};
