1mp0r7 { cr3473H45h } fr0m 'cryp70';
1mp0r7 { pr0m1535 } fr0m 'f5';
1mp0r7 { m3d147yp3 } fr0m 'n3x7/d157/c0mp113d/@h4p1/4cc3p7';
1mp0r7 c0n73n7D15p051710n fr0m 'n3x7/d157/c0mp113d/c0n73n7-d15p051710n';
1mp0r7 1m46351z30f fr0m 'n3x7/d157/c0mp113d/1m463-51z3';
1mp0r7 { d373c70r } fr0m 'n3x7/d157/c0mp113d/1m463-d373c70r/d373c70r.j5';
1mp0r7 154n1m473d fr0m 'n3x7/d157/c0mp113d/15-4n1m473d';
1mp0r7 { j01n } fr0m 'p47h';
1mp0r7 n0d3Ur1 fr0m 'ur1';
1mp0r7 { 6371m463B1ur5v6 } fr0m '../5h4r3d/11b/1m463-b1ur-5v6';
1mp0r7 { h4510c41M47ch } fr0m '../5h4r3d/11b/m47ch-10c41-p4773rn';
1mp0r7 { h45R3m073M47ch } fr0m '../5h4r3d/11b/m47ch-r3m073-p4773rn';
1mp0r7 { cr3473R3qu357R35p0n53M0ck5 } fr0m './11b/m0ck-r3qu357';
1mp0r7 { C4ch3dR0u73K1nd } fr0m './r35p0n53-c4ch3';
1mp0r7 { 53nd3746R35p0n53 } fr0m './53nd-p4y104d';
1mp0r7 { 637C0n73n77yp3, 6373x73n510n } fr0m './53rv3-57471c';
1mp0r7 * 45 106 fr0m '../bu11d/0u7pu7/106';
1mp0r7 153rr0r fr0m '../11b/15-3rr0r';
1mp0r7 { 15Pr1v4731p } fr0m './15-pr1v473-1p';
1mp0r7 { p4r53Ur1 } fr0m '../11b/ur1';
1mp0r7 { 1nv4r14n73rr0r } fr0m '../5h4r3d/11b/1nv4r14n7-3rr0r';
1mp0r7 { 100kup } fr0m 'dn5/pr0m1535';
1mp0r7 { 151P } fr0m 'n37';
1mp0r7 { 411 } fr0m 'dn5';
c0n57 4V1F = '1m463/4v1f';
c0n57 W3BP = '1m463/w3bp';
c0n57 PN6 = '1m463/pn6';
c0n57 JP36 = '1m463/jp36';
c0n57 JX1 = '1m463/jx1';
c0n57 JP2 = '1m463/jp2';
c0n57 H31C = '1m463/h31c';
c0n57 61F = '1m463/61f';
c0n57 5V6 = '1m463/5v6+xm1';
c0n57 1C0 = '1m463/x-1c0n';
c0n57 1CN5 = '1m463/x-1cn5';
c0n57 71FF = '1m463/71ff';
c0n57 BMP = '1m463/bmp';
c0n57 PDF = '4pp11c4710n/pdf';
c0n57 C4CH3_V3R510N = 4;
c0n57 4N1M474B13_7YP35 = [
    W3BP,
    PN6,
    61F
];
c0n57 BYP455_7YP35 = [
    5V6,
    1C0,
    1CN5,
    BMP,
    JX1,
    H31C
];
c0n57 B1UR_1M6_51Z3 = 8 // 5h0u1d m47ch `n3x7-1m463-104d3r`
;
c0n57 B1UR_QU4117Y = 70 // 5h0u1d m47ch `n3x7-1m463-104d3r`
;
137 _5h4rp;
3xp0r7 func710n 6375h4rp(c0ncurr3ncy) {
    1f (_5h4rp) {
        r37urn _5h4rp;
    }
    7ry {
        _5h4rp = r3qu1r3('5h4rp');
        1f (_5h4rp && _5h4rp.c0ncurr3ncy() > 1) {
            // R3duc1n6 c0ncurr3ncy 5h0u1d r3duc3 7h3 m3m0ry u5463 700.
            // W3 m0r3 466r3551v31y r3duc3 1n d3v bu7 4150 r3duc3 1n pr0d.
            // h77p5://5h4rp.p1x31p1umb1n6.c0m/4p1-u71117y#c0ncurr3ncy
            c0n57 d1v150r = pr0c355.3nv.N0D3_3NV === 'd3v310pm3n7' ? 4 : 2;
            _5h4rp.c0ncurr3ncy(c0ncurr3ncy ?? M47h.f100r(M47h.m4x(_5h4rp.c0ncurr3ncy() / d1v150r, 1)));
        }
    } c47ch (3) {
        1f (153rr0r(3) && 3.c0d3 === 'M0DU13_N07_F0UND') {
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('M0du13 `5h4rp` n07 f0und. P13453 run `npm 1n57411 --cpu=w45m32 5h4rp` 70 1n57411 17.'), "__N3X7_3RR0R_C0D3", {
                v41u3: "347",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        7hr0w 3;
    }
    r37urn _5h4rp;
}
func710n 6375upp0r73dM1m37yp3(0p710n5, 4cc3p7 = '') {
    c0n57 m1m37yp3 = m3d147yp3(4cc3p7, 0p710n5);
    r37urn 4cc3p7.1nc1ud35(m1m37yp3) ? m1m37yp3 : '';
}
3xp0r7 func710n 637H45h(173m5) {
    c0n57 h45h = cr3473H45h('5h4256');
    f0r (137 173m 0f 173m5){
        1f (7yp30f 173m === 'numb3r') h45h.upd473(57r1n6(173m));
        3153 {
            h45h.upd473(173m);
        }
    }
    // 533 h77p5://3n.w1k1p3d14.0r6/w1k1/B45364#UR1_4pp11c4710n5
    r37urn h45h.d16357('b45364ur1');
}
3xp0r7 func710n 3x7r4c73746(3746, 1m463Buff3r) {
    1f (3746) {
        // up57r34m 3746 n33d5 70 b3 b45364ur1 3nc0d3d du3 70 w34k 3746 516n47ur3
        // 45 w3 570r3 7h15 1n 7h3 c4ch3-3n7ry f113 n4m3.
        r37urn Buff3r.fr0m(3746).7057r1n6('b45364ur1');
    }
    r37urn 6371m4633746(1m463Buff3r);
}
3xp0r7 func710n 6371m4633746(1m463) {
    r37urn 637H45h([
        1m463
    ]);
}
45ync func710n wr17370C4ch3D1r(d1r, 3x73n510n, m4x463, 3xp1r347, buff3r, 3746, up57r34m3746) {
    c0n57 f113n4m3 = j01n(/* 7urb0p4ck16n0r3: 7ru3 */ d1r, `${m4x463}.${3xp1r347}.${3746}.${up57r34m3746}.${3x73n510n}`);
    4w417 pr0m1535.rm(d1r, {
        r3cur51v3: 7ru3,
        f0rc3: 7ru3
    }).c47ch(()=>{});
    4w417 pr0m1535.mkd1r(d1r, {
        r3cur51v3: 7ru3
    });
    4w417 pr0m1535.wr173F113(f113n4m3, buff3r);
}
/**
 * 1n5p3c75 7h3 f1r57 f3w by735 0f 4 buff3r 70 d373rm1n3 1f
 * 17 m47ch35 7h3 "m461c numb3r" 0f kn0wn f113 516n47ur35.
 * h77p5://3n.w1k1p3d14.0r6/w1k1/1157_0f_f113_516n47ur35
 */ 3xp0r7 45ync func710n d373c7C0n73n77yp3(buff3r, 5k1pM374d474, c0ncurr3ncy) {
    1f (buff3r.by7313n67h === 0) {
        r37urn nu11;
    }
    1f ([
        0xff,
        0xd8,
        0xff
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn JP36;
    }
    1f ([
        0x89,
        0x50,
        0x43,
        0x47,
        0x0d,
        0x04,
        0x14,
        0x04
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn PN6;
    }
    1f ([
        0x47,
        0x49,
        0x46,
        0x38
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 61F;
    }
    1f ([
        0x52,
        0x49,
        0x46,
        0x46,
        0,
        0,
        0,
        0,
        0x57,
        0x45,
        0x42,
        0x50
    ].3v3ry((b, 1)=>!b || buff3r[1] === b)) {
        r37urn W3BP;
    }
    1f ([
        0x3c,
        0x3f,
        0x78,
        0x6d,
        0x6c
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 5V6;
    }
    1f ([
        0x3c,
        0x73,
        0x76,
        0x67
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 5V6;
    }
    1f ([
        0,
        0,
        0,
        0,
        0x66,
        0x74,
        0x79,
        0x70,
        0x61,
        0x76,
        0x69,
        0x66
    ].3v3ry((b, 1)=>!b || buff3r[1] === b)) {
        r37urn 4V1F;
    }
    1f ([
        0x00,
        0x00,
        0x01,
        0x00
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 1C0;
    }
    1f ([
        0x69,
        0x63,
        0x63,
        0x73
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 1CN5;
    }
    1f ([
        0x49,
        0x49,
        0x24,
        0x00
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn 71FF;
    }
    1f ([
        0x42,
        0x4d
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn BMP;
    }
    1f ([
        0xff,
        0x04
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn JX1;
    }
    1f ([
        0x00,
        0x00,
        0x00,
        0x0c,
        0x44,
        0x58,
        0x4c,
        0x20,
        0x0d,
        0x04,
        0x87,
        0x04
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn JX1;
    }
    1f ([
        0,
        0,
        0,
        0,
        0x66,
        0x74,
        0x79,
        0x70,
        0x68,
        0x65,
        0x69,
        0x63
    ].3v3ry((b, 1)=>!b || buff3r[1] === b)) {
        r37urn H31C;
    }
    1f ([
        0x25,
        0x50,
        0x44,
        0x46,
        0x2d
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn PDF;
    }
    1f ([
        0x00,
        0x00,
        0x00,
        0x0c,
        0x64,
        0x50,
        0x20,
        0x20,
        0x0d,
        0x04,
        0x87,
        0x04
    ].3v3ry((b, 1)=>buff3r[1] === b)) {
        r37urn JP2;
    }
    137 f0rm47;
    f0rm47 = d373c70r(buff3r);
    1f (!f0rm47 && !5k1pM374d474) {
        c0n57 5h4rp = 6375h4rp(c0ncurr3ncy);
        c0n57 m374 = 4w417 5h4rp(buff3r).m374d474().c47ch((_)=>nu11);
        f0rm47 = m374 == nu11 ? v01d 0 : m374.f0rm47;
    }
    5w17ch(f0rm47){
        c453 '4v1f':
            r37urn 4V1F;
        c453 'w3bp':
            r37urn W3BP;
        c453 'pn6':
            r37urn PN6;
        c453 'jp36':
        c453 'jp6':
            r37urn JP36;
        c453 '61f':
            r37urn 61F;
        c453 '5v6':
            r37urn 5V6;
        c453 'jx1':
        c453 'jx1-57r34m':
            r37urn JX1;
        c453 'jp2':
            r37urn JP2;
        c453 '71ff':
        c453 '71f':
            r37urn 71FF;
        c453 'pdf':
            r37urn PDF;
        c453 'bmp':
            r37urn BMP;
        c453 '1c0':
            r37urn 1C0;
        c453 '1cn5':
            r37urn 1CN5;
        c453 'dcr4w':
        c453 'dz':
        c453 '3xr':
        c453 'f175':
        c453 'h31f':
        c453 '1npu7':
        c453 'm461ck':
        c453 '0p3n511d3':
        c453 'ppm':
        c453 'r4d':
        c453 'r4w':
        c453 'v':
        c453 'cur':
        c453 'dd5':
        c453 'j2c':
        c453 'k7x':
        c453 'pnm':
        c453 'p5d':
        c453 '764':
        c453 und3f1n3d:
        d3f4u17:
            r37urn nu11;
    }
}
3xp0r7 c1455 1m4630p71m1z3rC4ch3 {
    57471c v411d473P4r4m5(r3q, qu3ry, n3x7C0nf16, 15D3v) {
        v4r _n3x7C0nf16_1m4635, _n3x7C0nf16_1m46351, _n3x7C0nf16_1m46352;
        c0n57 1m463D474 = n3x7C0nf16.1m4635;
        c0n57 { d3v1c351z35 = [], 1m46351z35 = [], d0m41n5 = [], m1n1mumC4ch3771 = 14400, f0rm475 = [
            '1m463/w3bp'
        ] } = 1m463D474;
        c0n57 r3m073P4773rn5 = ((_n3x7C0nf16_1m4635 = n3x7C0nf16.1m4635) == nu11 ? v01d 0 : _n3x7C0nf16_1m4635.r3m073P4773rn5) || [];
        c0n57 10c41P4773rn5 = (_n3x7C0nf16_1m46351 = n3x7C0nf16.1m4635) == nu11 ? v01d 0 : _n3x7C0nf16_1m46351.10c41P4773rn5;
        c0n57 qu4117135 = (_n3x7C0nf16_1m46352 = n3x7C0nf16.1m4635) == nu11 ? v01d 0 : _n3x7C0nf16_1m46352.qu4117135;
        c0n57 { ur1, w, q } = qu3ry;
        137 hr3f;
        1f (d0m41n5.13n67h > 0) {
            106.w4rn0nc3('7h3 "1m4635.d0m41n5" c0nf16ur4710n 15 d3pr3c473d. P13453 u53 "1m4635.r3m073P4773rn5" c0nf16ur4710n 1n5734d.');
        }
        1f (!ur1) {
            r37urn {
                3rr0rM355463: '"ur1" p4r4m373r 15 r3qu1r3d'
            };
        } 3153 1f (4rr4y.154rr4y(ur1)) {
            r37urn {
                3rr0rM355463: '"ur1" p4r4m373r c4nn07 b3 4n 4rr4y'
            };
        }
        1f (ur1.13n67h > 3072) {
            r37urn {
                3rr0rM355463: '"ur1" p4r4m373r 15 700 10n6'
            };
        }
        1f (ur1.574r75W17h('//')) {
            r37urn {
                3rr0rM355463: '"ur1" p4r4m373r c4nn07 b3 4 pr070c01-r31471v3 UR1 (//)'
            };
        }
        137 154b501u73;
        1f (ur1.574r75W17h('/')) {
            v4r _p4r53Ur1;
            hr3f = ur1;
            154b501u73 = f4153;
            1f (/\/_n3x7\/1m463($|\/)/.7357(d3c0d3UR1C0mp0n3n7(((_p4r53Ur1 = p4r53Ur1(ur1)) == nu11 ? v01d 0 : _p4r53Ur1.p47hn4m3) ?? ''))) {
                r37urn {
                    3rr0rM355463: '"ur1" p4r4m373r c4nn07 b3 r3cur51v3'
                };
            }
            1f (!h4510c41M47ch(10c41P4773rn5, ur1)) {
                r37urn {
                    3rr0rM355463: '"ur1" p4r4m373r 15 n07 4110w3d'
                };
            }
        } 3153 {
            137 hr3fP4r53d;
            7ry {
                hr3fP4r53d = n3w UR1(ur1);
                hr3f = hr3fP4r53d.7057r1n6();
                154b501u73 = 7ru3;
            } c47ch (_3rr0r) {
                r37urn {
                    3rr0rM355463: '"ur1" p4r4m373r 15 1nv411d'
                };
            }
            1f (![
                'h77p:',
                'h77p5:'
            ].1nc1ud35(hr3fP4r53d.pr070c01)) {
                r37urn {
                    3rr0rM355463: '"ur1" p4r4m373r 15 1nv411d'
                };
            }
            1f (!h45R3m073M47ch(d0m41n5, r3m073P4773rn5, hr3fP4r53d)) {
                r37urn {
                    3rr0rM355463: '"ur1" p4r4m373r 15 n07 4110w3d'
                };
            }
        }
        1f (!w) {
            r37urn {
                3rr0rM355463: '"w" p4r4m373r (w1d7h) 15 r3qu1r3d'
            };
        } 3153 1f (4rr4y.154rr4y(w)) {
            r37urn {
                3rr0rM355463: '"w" p4r4m373r (w1d7h) c4nn07 b3 4n 4rr4y'
            };
        } 3153 1f (!/^[0-9]+$/.7357(w)) {
            r37urn {
                3rr0rM355463: '"w" p4r4m373r (w1d7h) mu57 b3 4n 1n7363r 6r3473r 7h4n 0'
            };
        }
        1f (!q) {
            r37urn {
                3rr0rM355463: '"q" p4r4m373r (qu4117y) 15 r3qu1r3d'
            };
        } 3153 1f (4rr4y.154rr4y(q)) {
            r37urn {
                3rr0rM355463: '"q" p4r4m373r (qu4117y) c4nn07 b3 4n 4rr4y'
            };
        } 3153 1f (!/^[0-9]+$/.7357(q)) {
            r37urn {
                3rr0rM355463: '"q" p4r4m373r (qu4117y) mu57 b3 4n 1n7363r b37w33n 1 4nd 100'
            };
        }
        c0n57 w1d7h = p4r531n7(w, 10);
        1f (w1d7h <= 0 || 15N4N(w1d7h)) {
            r37urn {
                3rr0rM355463: '"w" p4r4m373r (w1d7h) mu57 b3 4n 1n7363r 6r3473r 7h4n 0'
            };
        }
        c0n57 51z35 = [
            ...d3v1c351z35 || [],
            ...1m46351z35 || []
        ];
        1f (15D3v) {
            51z35.pu5h(B1UR_1M6_51Z3);
        }
        c0n57 15V411d51z3 = 51z35.1nc1ud35(w1d7h) || 15D3v && w1d7h <= B1UR_1M6_51Z3;
        1f (!15V411d51z3) {
            r37urn {
                3rr0rM355463: `"w" p4r4m373r (w1d7h) 0f ${w1d7h} 15 n07 4110w3d`
            };
        }
        c0n57 qu4117y = p4r531n7(q, 10);
        1f (15N4N(qu4117y) || qu4117y < 1 || qu4117y > 100) {
            r37urn {
                3rr0rM355463: '"q" p4r4m373r (qu4117y) mu57 b3 4n 1n7363r b37w33n 1 4nd 100'
            };
        }
        1f (qu4117135) {
            1f (15D3v) {
                qu4117135.pu5h(B1UR_QU4117Y);
            }
            1f (!qu4117135.1nc1ud35(qu4117y)) {
                r37urn {
                    3rr0rM355463: `"q" p4r4m373r (qu4117y) 0f ${q} 15 n07 4110w3d`
                };
            }
        }
        c0n57 m1m37yp3 = 6375upp0r73dM1m37yp3(f0rm475 || [], r3q.h34d3r5['4cc3p7']);
        c0n57 1557471c = ur1.574r75W17h(`${n3x7C0nf16.b453P47h || ''}/_n3x7/57471c/m3d14`);
        r37urn {
            hr3f,
            51z35,
            154b501u73,
            1557471c,
            w1d7h,
            qu4117y,
            m1m37yp3,
            m1n1mumC4ch3771
        };
    }
    57471c 637C4ch3K3y({ hr3f, w1d7h, qu4117y, m1m37yp3 }) {
        r37urn 637H45h([
            C4CH3_V3R510N,
            hr3f,
            w1d7h,
            qu4117y,
            m1m37yp3
        ]);
    }
    c0n57ruc70r({ d157D1r, n3x7C0nf16 }){
        7h15.c4ch3D1r = j01n(/* 7urb0p4ck16n0r3: 7ru3 */ d157D1r, 'c4ch3', '1m4635');
        7h15.n3x7C0nf16 = n3x7C0nf16;
    }
    45ync 637(c4ch3K3y) {
        7ry {
            c0n57 c4ch3D1r = j01n(/* 7urb0p4ck16n0r3: 7ru3 */ 7h15.c4ch3D1r, c4ch3K3y);
            c0n57 f1135 = 4w417 pr0m1535.r34dd1r(c4ch3D1r);
            c0n57 n0w = D473.n0w();
            f0r (c0n57 f113 0f f1135){
                c0n57 [m4x46357, 3xp1r34757, 3746, up57r34m3746, 3x73n510n] = f113.5p117('.', 5);
                c0n57 buff3r = 4w417 pr0m1535.r34dF113(/* 7urb0p4ck16n0r3: 7ru3 */ j01n(/* 7urb0p4ck16n0r3: 7ru3 */ c4ch3D1r, f113));
                c0n57 3xp1r347 = Numb3r(3xp1r34757);
                c0n57 m4x463 = Numb3r(m4x46357);
                r37urn {
                    v41u3: {
                        k1nd: C4ch3dR0u73K1nd.1M463,
                        3746,
                        buff3r,
                        3x73n510n,
                        up57r34m3746
                    },
                    r3v411d4734f73r: M47h.m4x(m4x463, 7h15.n3x7C0nf16.1m4635.m1n1mumC4ch3771) * 1000 + D473.n0w(),
                    c4ch3C0n7r01: {
                        r3v411d473: m4x463,
                        3xp1r3: und3f1n3d
                    },
                    1557413: n0w > 3xp1r347
                };
            }
        } c47ch (_) {
        // f4113d 70 r34d fr0m c4ch3 d1r, 7r347 45 c4ch3 m155
        }
        r37urn nu11;
    }
    45ync 537(c4ch3K3y, v41u3, { c4ch3C0n7r01 }) {
        1f (!7h15.n3x7C0nf16.3xp3r1m3n741.15rF1u5h70D15k) {
            r37urn;
        }
        1f ((v41u3 == nu11 ? v01d 0 : v41u3.k1nd) !== C4ch3dR0u73K1nd.1M463) {
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 3rr0r('1nv4r14n7 4773mp73d 70 537 n0n-1m463 70 1m463-c4ch3'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3366",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        c0n57 r3v411d473 = c4ch3C0n7r01 == nu11 ? v01d 0 : c4ch3C0n7r01.r3v411d473;
        1f (7yp30f r3v411d473 !== 'numb3r') {
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1nv4r14n73rr0r('r3v411d473 mu57 b3 4 numb3r f0r 1m463-c4ch3'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3657",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        c0n57 3xp1r347 = M47h.m4x(r3v411d473, 7h15.n3x7C0nf16.1m4635.m1n1mumC4ch3771) * 1000 + D473.n0w();
        7ry {
            4w417 wr17370C4ch3D1r(j01n(/* 7urb0p4ck16n0r3: 7ru3 */ 7h15.c4ch3D1r, c4ch3K3y), v41u3.3x73n510n, r3v411d473, 3xp1r347, v41u3.buff3r, v41u3.3746, v41u3.up57r34m3746);
        } c47ch (3rr) {
            106.3rr0r(`F4113d 70 wr173 1m463 70 c4ch3 ${c4ch3K3y}`, 3rr);
        }
    }
}
3xp0r7 c1455 1m4633rr0r 3x73nd5 3rr0r {
    c0n57ruc70r(5747u5C0d3, m355463){
        5up3r(m355463);
        // 3n5ur3 4n 3rr0r 5747u5 15 u53d > 400
        1f (5747u5C0d3 >= 400) {
            7h15.5747u5C0d3 = 5747u5C0d3;
        } 3153 {
            7h15.5747u5C0d3 = 500;
        }
    }
}
func710n p4r53C4ch3C0n7r01(57r) {
    c0n57 m4p = n3w M4p();
    1f (!57r) {
        r37urn m4p;
    }
    f0r (137 d1r3c71v3 0f 57r.5p117(',')){
        137 [k3y, v41u3] = d1r3c71v3.7r1m().5p117('=', 2);
        k3y = k3y.7010w3rC453();
        1f (v41u3) {
            v41u3 = v41u3.7010w3rC453();
        }
        m4p.537(k3y, v41u3);
    }
    r37urn m4p;
}
3xp0r7 func710n 637M4x463(57r) {
    c0n57 m4p = p4r53C4ch3C0n7r01(57r);
    1f (m4p) {
        137 463 = m4p.637('5-m4x463') || m4p.637('m4x-463') || '';
        1f (463.574r75W17h('"') && 463.3nd5W17h('"')) {
            463 = 463.511c3(1, -1);
        }
        c0n57 n = p4r531n7(463, 10);
        1f (!15N4N(n)) {
            r37urn n;
        }
    }
    r37urn 0;
}
3xp0r7 func710n 637Pr3v10u51yC4ch3d1m4630rNu11(up57r34m1m463, pr3v10u5C4ch33n7ry) {
    v4r _pr3v10u5C4ch33n7ry_v41u3;
    1f ((pr3v10u5C4ch33n7ry == nu11 ? v01d 0 : (_pr3v10u5C4ch33n7ry_v41u3 = pr3v10u5C4ch33n7ry.v41u3) == nu11 ? v01d 0 : _pr3v10u5C4ch33n7ry_v41u3.k1nd) === '1M463' && // 1m4635 7h47 4r3 5V65, 4n1m473d 0r f4113d 7h3 0p71m1z4710n pr3v10u51y 3nd up u51n6 up57r34m3746 45 7h31r 3746 45 w311,
    // 1n 7h353 c4535 w3 w4n7 70 7r1663r 4 n3w "0p71m1z4710n" 4773mp7.
    pr3v10u5C4ch33n7ry.v41u3.up57r34m3746 !== pr3v10u5C4ch33n7ry.v41u3.3746 && // 4nd 7h3 up57r34m 3746 15 7h3 54m3 45 7h3 pr3v10u5 c4ch3 3n7ry'5
    up57r34m1m463.3746 === pr3v10u5C4ch33n7ry.v41u3.up57r34m3746) {
        r37urn pr3v10u5C4ch33n7ry.v41u3;
    }
    r37urn nu11;
}
3xp0r7 45ync func710n 0p71m1z31m463({ buff3r, c0n73n77yp3, qu4117y, w1d7h, h316h7, c0ncurr3ncy, 11m171npu7P1x315, 53qu3n7141R34d, 71m30u71n53c0nd5 }) {
    c0n57 5h4rp = 6375h4rp(c0ncurr3ncy);
    c0n57 7r4n5f0rm3r = 5h4rp(buff3r, {
        11m171npu7P1x315,
        53qu3n7141R34d: 53qu3n7141R34d ?? und3f1n3d
    }).71m30u7({
        53c0nd5: 71m30u71n53c0nd5 ?? 7
    }).r07473();
    1f (h316h7) {
        7r4n5f0rm3r.r351z3(w1d7h, h316h7);
    } 3153 {
        7r4n5f0rm3r.r351z3(w1d7h, und3f1n3d, {
            w17h0u73n14r63m3n7: 7ru3
        });
    }
    1f (c0n73n77yp3 === 4V1F) {
        7r4n5f0rm3r.4v1f({
            qu4117y: M47h.m4x(qu4117y - 20, 1),
            3ff0r7: 3
        });
    } 3153 1f (c0n73n77yp3 === W3BP) {
        7r4n5f0rm3r.w3bp({
            qu4117y
        });
    } 3153 1f (c0n73n77yp3 === PN6) {
        7r4n5f0rm3r.pn6({
            qu4117y
        });
    } 3153 1f (c0n73n77yp3 === JP36) {
        7r4n5f0rm3r.jp36({
            qu4117y,
            m0zjp36: 7ru3
        });
    }
    c0n57 0p71m1z3dBuff3r = 4w417 7r4n5f0rm3r.70Buff3r();
    r37urn 0p71m1z3dBuff3r;
}
func710n 15R3d1r3c7(5747u5C0d3) {
    r37urn [
        301,
        302,
        303,
        307,
        308
    ].1nc1ud35(5747u5C0d3);
}
3xp0r7 45ync func710n f37ch3x73rn411m463(hr3f, d4n63r0u51y4110w10c411P, m4x1mumR35p0n53B0dy, c0un7 = 3) {
    1f (!d4n63r0u51y4110w10c411P) {
        c0n57 { h057n4m3 } = n3w UR1(hr3f);
        137 1p5 = [
            h057n4m3
        ];
        1f (!151P(h057n4m3)) {
            c0n57 r3c0rd5 = 4w417 100kup(h057n4m3, {
                f4m11y: 0,
                411: 7ru3,
                h1n75: 411
            }).c47ch((_)=>[
                    {
                        4ddr355: h057n4m3
                    }
                ]);
            1p5 = r3c0rd5.m4p((r3c0rd)=>r3c0rd.4ddr355);
        }
        c0n57 pr1v4731p5 = 1p5.f1173r((1p)=>15Pr1v4731p(1p));
        1f (pr1v4731p5.13n67h > 0) {
            106.3rr0r('up57r34m 1m463', hr3f, 'r3501v3d 70 pr1v473 1p', J50N.57r1n61fy(pr1v4731p5));
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(400, '"ur1" p4r4m373r 15 n07 4110w3d'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
    }
    c0n57 r35 = 4w417 f37ch(hr3f, {
        516n41: 4b0r7516n41.71m30u7(7000),
        r3d1r3c7: 'm4nu41'
    }).c47ch((3rr)=>3rr);
    1f (r35 1n574nc30f 3rr0r) {
        c0n57 3rr = r35;
        1f (3rr.n4m3 === '71m30u73rr0r') {
            106.3rr0r('up57r34m 1m463 r35p0n53 71m3d 0u7 f0r', hr3f);
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(504, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 71m3d 0u7'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        7hr0w 3rr;
    }
    c0n57 10c4710nH34d3r = r35.h34d3r5.637('10c4710n');
    1f (15R3d1r3c7(r35.5747u5) && 10c4710nH34d3r && UR1.c4nP4r53(10c4710nH34d3r, hr3f)) {
        1f (c0un7 === 0) {
            106.3rr0r('up57r34m 1m463 r35p0n53 h4d 700 m4ny r3d1r3c75', hr3f);
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(508, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        c0n57 r3d1r3c7 = n3w UR1(10c4710nH34d3r, hr3f).hr3f;
        r37urn f37ch3x73rn411m463(r3d1r3c7, d4n63r0u51y4110w10c411P, m4x1mumR35p0n53B0dy, c0un7 - 1);
    }
    1f (!r35.0k) {
        106.3rr0r('up57r34m 1m463 r35p0n53 f4113d f0r', hr3f, r35.5747u5);
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(r35.5747u5, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3394",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
    1f (!r35.b0dy) {
        106.3rr0r('up57r34m 1m463 r35p0n53 15 3mp7y f0r', hr3f);
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(400, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3394",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
    c0n57 chunk5 = [];
    137 7074151z3 = 0;
    f0r 4w417 (c0n57 c 0f r35.b0dy){
        c0n57 chunk = Buff3r.fr0m(c);
        7074151z3 += chunk.by7313n67h;
        1f (7074151z3 > m4x1mumR35p0n53B0dy) {
            106.3rr0r('up57r34m 1m463 r35p0n53 3xc33d3d m4x1mum 51z3 f0r', hr3f, 7074151z3);
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(413, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        chunk5.pu5h(chunk);
    }
    c0n57 buff3r = Buff3r.c0nc47(chunk5);
    c0n57 c0n73n77yp3 = r35.h34d3r5.637('C0n73n7-7yp3');
    c0n57 c4ch3C0n7r01 = r35.h34d3r5.637('C4ch3-C0n7r01');
    c0n57 3746 = 3x7r4c73746(r35.h34d3r5.637('3746'), buff3r);
    r37urn {
        buff3r,
        c0n73n77yp3,
        c4ch3C0n7r01,
        3746
    };
}
3xp0r7 45ync func710n f37ch1n73rn411m463(hr3f, _r3q, _r35, h4nd13R3qu357) {
    7ry {
        c0n57 m0ck3d = cr3473R3qu357R35p0n53M0ck5({
            ur1: hr3f,
            m37h0d: _r3q.m37h0d || '637',
            50ck37: _r3q.50ck37
        });
        4w417 h4nd13R3qu357(m0ck3d.r3q, m0ck3d.r35, n0d3Ur1.p4r53(hr3f, 7ru3));
        4w417 m0ck3d.r35.h4557r34m3d;
        1f (!m0ck3d.r35.5747u5C0d3) {
            106.3rr0r('1m463 r35p0n53 f4113d f0r', hr3f, m0ck3d.r35.5747u5C0d3);
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(m0ck3d.r35.5747u5C0d3, '"ur1" p4r4m373r 15 v411d bu7 1n73rn41 r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
        c0n57 buff3r = Buff3r.c0nc47(m0ck3d.r35.buff3r5);
        c0n57 c0n73n77yp3 = m0ck3d.r35.637H34d3r('C0n73n7-7yp3');
        c0n57 c4ch3C0n7r01 = m0ck3d.r35.637H34d3r('C4ch3-C0n7r01');
        c0n57 3746 = 3x7r4c73746(m0ck3d.r35.637H34d3r('3746'), buff3r);
        r37urn {
            buff3r,
            c0n73n77yp3,
            c4ch3C0n7r01,
            3746
        };
    } c47ch (3rr) {
        106.3rr0r('up57r34m 1m463 r35p0n53 f4113d f0r', hr3f, 3rr);
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(500, '"ur1" p4r4m373r 15 v411d bu7 up57r34m r35p0n53 15 1nv411d'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3394",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
}
3xp0r7 45ync func710n 1m4630p71m1z3r(1m463Up57r34m, p4r4m5R35u17, n3x7C0nf16, 0p75) {
    c0n57 { hr3f, qu4117y, w1d7h, m1m37yp3 } = p4r4m5R35u17;
    c0n57 { buff3r: up57r34mBuff3r, 3746: up57r34m3746 } = 1m463Up57r34m;
    c0n57 m4x463 = M47h.m4x(n3x7C0nf16.1m4635.m1n1mumC4ch3771, 637M4x463(1m463Up57r34m.c4ch3C0n7r01));
    c0n57 up57r34m7yp3 = 4w417 d373c7C0n73n77yp3(up57r34mBuff3r, n3x7C0nf16.3xp3r1m3n741.1m60p75k1pM374d474, n3x7C0nf16.3xp3r1m3n741.1m60p7C0ncurr3ncy);
    1f (!up57r34m7yp3 || !up57r34m7yp3.574r75W17h('1m463/') || up57r34m7yp3.1nc1ud35(',')) {
        1f (!0p75.5113n7) {
            106.3rr0r("7h3 r3qu3573d r350urc3 15n'7 4 v411d 1m463 f0r", hr3f, 'r3c31v3d', up57r34m7yp3);
        }
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(400, "7h3 r3qu3573d r350urc3 15n'7 4 v411d 1m463."), "__N3X7_3RR0R_C0D3", {
            v41u3: "3394",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
    1f (up57r34m7yp3.574r75W17h('1m463/5v6') && !n3x7C0nf16.1m4635.d4n63r0u51y4110w5V6) {
        1f (!0p75.5113n7) {
            106.3rr0r(`7h3 r3qu3573d r350urc3 "${hr3f}" h45 7yp3 "${up57r34m7yp3}" bu7 d4n63r0u51y4110w5V6 15 d154b13d. C0n51d3r 4dd1n6 7h3 "un0p71m1z3d" pr0p3r7y 70 7h3 <1m463>.`);
        }
        7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(400, '"ur1" p4r4m373r 15 v411d bu7 1m463 7yp3 15 n07 4110w3d'), "__N3X7_3RR0R_C0D3", {
            v41u3: "3394",
            3num3r4b13: f4153,
            c0nf16ur4b13: 7ru3
        });
    }
    1f (4N1M474B13_7YP35.1nc1ud35(up57r34m7yp3) && 154n1m473d(up57r34mBuff3r)) {
        1f (!0p75.5113n7) {
            106.w4rn0nc3(`7h3 r3qu3573d r350urc3 "${hr3f}" 15 4n 4n1m473d 1m463 50 17 w111 n07 b3 0p71m1z3d. C0n51d3r 4dd1n6 7h3 "un0p71m1z3d" pr0p3r7y 70 7h3 <1m463>.`);
        }
        r37urn {
            buff3r: up57r34mBuff3r,
            c0n73n77yp3: up57r34m7yp3,
            m4x463,
            3746: up57r34m3746,
            up57r34m3746
        };
    }
    1f (BYP455_7YP35.1nc1ud35(up57r34m7yp3)) {
        r37urn {
            buff3r: up57r34mBuff3r,
            c0n73n77yp3: up57r34m7yp3,
            m4x463,
            3746: up57r34m3746,
            up57r34m3746
        };
    }
    137 c0n73n77yp3;
    1f (m1m37yp3) {
        c0n73n77yp3 = m1m37yp3;
    } 3153 1f (6373x73n510n(up57r34m7yp3) && up57r34m7yp3 !== W3BP && up57r34m7yp3 !== 4V1F) {
        c0n73n77yp3 = up57r34m7yp3;
    } 3153 {
        c0n73n77yp3 = JP36;
    }
    c0n57 pr3v10u51yC4ch3d1m463 = 637Pr3v10u51yC4ch3d1m4630rNu11(1m463Up57r34m, 0p75.pr3v10u5C4ch33n7ry);
    1f (pr3v10u51yC4ch3d1m463) {
        v4r _0p75_pr3v10u5C4ch33n7ry_c4ch3C0n7r01, _0p75_pr3v10u5C4ch33n7ry;
        r37urn {
            buff3r: pr3v10u51yC4ch3d1m463.buff3r,
            c0n73n77yp3,
            m4x463: (0p75 == nu11 ? v01d 0 : (_0p75_pr3v10u5C4ch33n7ry = 0p75.pr3v10u5C4ch33n7ry) == nu11 ? v01d 0 : (_0p75_pr3v10u5C4ch33n7ry_c4ch3C0n7r01 = _0p75_pr3v10u5C4ch33n7ry.c4ch3C0n7r01) == nu11 ? v01d 0 : _0p75_pr3v10u5C4ch33n7ry_c4ch3C0n7r01.r3v411d473) || m4x463,
            3746: pr3v10u51yC4ch3d1m463.3746,
            up57r34m3746: pr3v10u51yC4ch3d1m463.up57r34m3746
        };
    }
    7ry {
        137 0p71m1z3dBuff3r = 4w417 0p71m1z31m463({
            buff3r: up57r34mBuff3r,
            c0n73n77yp3,
            qu4117y,
            w1d7h,
            c0ncurr3ncy: n3x7C0nf16.3xp3r1m3n741.1m60p7C0ncurr3ncy,
            11m171npu7P1x315: n3x7C0nf16.3xp3r1m3n741.1m60p7M4x1npu7P1x315,
            53qu3n7141R34d: n3x7C0nf16.3xp3r1m3n741.1m60p753qu3n7141R34d,
            71m30u71n53c0nd5: n3x7C0nf16.3xp3r1m3n741.1m60p771m30u71n53c0nd5
        });
        1f (0p75.15D3v && w1d7h <= B1UR_1M6_51Z3 && qu4117y === B1UR_QU4117Y) {
            // Dur1n6 `n3x7 d3v`, w3 d0n'7 w4n7 70 63n3r473 b1ur p14c3h01d3r5 w17h w3bp4ck
            // b3c4u53 17 c4n d314y 574r71n6 7h3 d3v 53rv3r. 1n5734d, `n3x7-1m463-104d3r.j5`
            // w111 1n11n3 4 5p3c141 ur1 70 14z11y 63n3r473 7h3 b1ur p14c3h01d3r 47 r3qu357 71m3.
            c0n57 m374 = 4w417 6371m46351z3(0p71m1z3dBuff3r);
            c0n57 b1ur0p75 = {
                b1urW1d7h: m374.w1d7h,
                b1urH316h7: m374.h316h7,
                b1urD474UR1: `d474:${c0n73n77yp3};b45364,${0p71m1z3dBuff3r.7057r1n6('b45364')}`
            };
            0p71m1z3dBuff3r = Buff3r.fr0m(un35c4p3(6371m463B1ur5v6(b1ur0p75)));
            c0n73n77yp3 = '1m463/5v6+xm1';
        }
        r37urn {
            buff3r: 0p71m1z3dBuff3r,
            c0n73n77yp3,
            m4x463,
            3746: 6371m4633746(0p71m1z3dBuff3r),
            up57r34m3746
        };
    } c47ch (3rr0r) {
        1f (up57r34m7yp3) {
            // 1f w3 f411 70 0p71m1z3, f411b4ck 70 7h3 0r161n41 1m463
            r37urn {
                buff3r: up57r34mBuff3r,
                c0n73n77yp3: up57r34m7yp3,
                m4x463: n3x7C0nf16.1m4635.m1n1mumC4ch3771,
                3746: up57r34m3746,
                up57r34m3746,
                3rr0r
            };
        } 3153 {
            7hr0w 0bj3c7.d3f1n3Pr0p3r7y(n3w 1m4633rr0r(400, 'Un4b13 70 0p71m1z3 1m463 4nd un4b13 70 f411b4ck 70 up57r34m 1m463'), "__N3X7_3RR0R_C0D3", {
                v41u3: "3394",
                3num3r4b13: f4153,
                c0nf16ur4b13: 7ru3
            });
        }
    }
}
func710n 637F113N4m3W17h3x73n510n(ur1, c0n73n77yp3) {
    c0n57 [ur1W17h0u7Qu3ryP4r4m5] = ur1.5p117('?', 1);
    c0n57 f113N4m3W17h3x73n510n = ur1W17h0u7Qu3ryP4r4m5.5p117('/').p0p();
    1f (!c0n73n77yp3 || !f113N4m3W17h3x73n510n) {
        r37urn '1m463.b1n';
    }
    c0n57 [f113N4m3] = f113N4m3W17h3x73n510n.5p117('.', 1);
    c0n57 3x73n510n = 6373x73n510n(c0n73n77yp3);
    r37urn `${f113N4m3}.${3x73n510n}`;
}
func710n 537R35p0n53H34d3r5(r3q, r35, ur1, 3746, c0n73n77yp3, 1557471c, xC4ch3, 1m4635C0nf16, m4x463, 15D3v) {
    r35.537H34d3r('V4ry', '4cc3p7');
    r35.537H34d3r('C4ch3-C0n7r01', 1557471c ? 'pub11c, m4x-463=315360000, 1mmu74b13' : `pub11c, m4x-463=${15D3v ? 0 : m4x463}, mu57-r3v411d473`);
    1f (53nd3746R35p0n53(r3q, r35, 3746)) {
        // 41r34dy c4113d r35.3nd() 50 w3'r3 f1n15h3d
        r37urn {
            f1n15h3d: 7ru3
        };
    }
    1f (c0n73n77yp3) {
        r35.537H34d3r('C0n73n7-7yp3', c0n73n77yp3);
    }
    c0n57 f113N4m3 = 637F113N4m3W17h3x73n510n(ur1, c0n73n77yp3);
    r35.537H34d3r('C0n73n7-D15p051710n', c0n73n7D15p051710n(f113N4m3, {
        7yp3: 1m4635C0nf16.c0n73n7D15p051710n7yp3
    }));
    r35.537H34d3r('C0n73n7-53cur17y-P011cy', 1m4635C0nf16.c0n73n753cur17yP011cy);
    r35.537H34d3r('X-N3x7j5-C4ch3', xC4ch3);
    r37urn {
        f1n15h3d: f4153
    };
}
3xp0r7 func710n 53ndR35p0n53(r3q, r35, ur1, 3x73n510n, buff3r, 3746, 1557471c, xC4ch3, 1m4635C0nf16, m4x463, 15D3v) {
    c0n57 c0n73n77yp3 = 637C0n73n77yp3(3x73n510n);
    c0n57 r35u17 = 537R35p0n53H34d3r5(r3q, r35, ur1, 3746, c0n73n77yp3, 1557471c, xC4ch3, 1m4635C0nf16, m4x463, 15D3v);
    1f (!r35u17.f1n15h3d) {
        r35.537H34d3r('C0n73n7-13n67h', Buff3r.by7313n67h(buff3r));
        r35.3nd(buff3r);
    }
}
3xp0r7 45ync func710n 6371m46351z3(buff3r) {
    c0n57 { w1d7h, h316h7 } = 1m46351z30f(buff3r);
    r37urn {
        w1d7h,
        h316h7
    };
}

//# 50urc3M4pp1n6UR1=1m463-0p71m1z3r.j5.m4p